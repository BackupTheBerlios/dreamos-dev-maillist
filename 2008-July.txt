From finarfin at mail.berlios.de  Sun Jul  6 17:19:32 2008
From: finarfin at mail.berlios.de (finarfin at BerliOS)
Date: Sun, 6 Jul 2008 17:19:32 +0200
Subject: [Dreamos-dev] r10 - in trunk: . drivers hardware mem processore
Message-ID: <200807061519.m66FJWI8026786@sheep.berlios.de>

Author: finarfin
Date: 2008-07-06 17:19:25 +0200 (Sun, 06 Jul 2008)
New Revision: 10

Modified:
   trunk/.bochsrc
   trunk/dreamos.img
   trunk/drivers/keyboard.c
   trunk/hardware/8253.c
   trunk/hardware/pic8259.c
   trunk/kernel.c
   trunk/kernel.lds
   trunk/kernel.map
   trunk/mem/fismem.c
   trunk/processore/handlers.c
Log:
Risolto (con una soluzione tampone) problema nella shell (se si premeva troppe volte invio, si 
riceveva un messaggio di interrupt non gestibile, ma non bloccante per l'os)
Modificato script per il linker.
Pulizia del codice.


Modified: trunk/.bochsrc
===================================================================
--- trunk/.bochsrc	2008-06-29 21:43:10 UTC (rev 9)
+++ trunk/.bochsrc	2008-07-06 15:19:25 UTC (rev 10)
@@ -428,7 +428,7 @@
 #   parport2: enabled=1, file="/dev/lp0"
 #   parport1: enabled=0
 #=======================================================================
-parport1: enabled=1, file="parport.out"
+#parport1: enabled=1, file="parport.out"
 
 #=======================================================================
 # SB16:
@@ -490,7 +490,7 @@
 # Examples:
 #   keyboard_serial_delay: 200
 #=======================================================================
-keyboard_serial_delay: 250
+keyboard_serial_delay: 200
 
 #=======================================================================
 # KEYBOARD_PASTE_DELAY:

Modified: trunk/dreamos.img
===================================================================
(Binary files differ)

Modified: trunk/drivers/keyboard.c
===================================================================
--- trunk/drivers/keyboard.c	2008-06-29 21:43:10 UTC (rev 9)
+++ trunk/drivers/keyboard.c	2008-07-06 15:19:25 UTC (rev 10)
@@ -83,8 +83,7 @@
 void keyboard_isr (void)
 {
     int control;
-    sc = inportb (0x60); // take scancode from the port
-
+    sc = inportb (0x60); // take scancode from the port    
     /* error handling */
     if (sc == 0x00 || sc == 0xFF) {
 	_kputs ("Keyboard error\n");
@@ -102,8 +101,11 @@
 	curmap = key_it_map;
 
     /* In case of useless break codes, switch controls...*/
-    if (sc > CODE_BREAK && sc != (KEY_LSHIFT|CODE_BREAK) && sc != (KEY_RSHIFT|CODE_BREAK))
-	goto end;
+    if (sc > CODE_BREAK && sc != (KEY_LSHIFT|CODE_BREAK) && sc != (KEY_RSHIFT|CODE_BREAK)){
+        if (sc==KEY_ENTER+128)
+            outportb(EOI,MASTER_PORT);
+	    goto end;
+        }
 
     switch (sc) {
     case KEY_LSHIFT:
@@ -170,6 +172,7 @@
 	buf_w = STEP(buf_w);
 	_knewline();
 	_ksetcursauto();
+    outportb(EOI, MASTER_PORT);
 	break;
 
     /*case KEY_PGUP:

Modified: trunk/hardware/8253.c
===================================================================
--- trunk/hardware/8253.c	2008-06-29 21:43:10 UTC (rev 9)
+++ trunk/hardware/8253.c	2008-07-06 15:19:25 UTC (rev 10)
@@ -27,9 +27,8 @@
 {
     if (++ticks % 100 == 0) {
 	ticks = 0;
-	if (++seconds > 86400)
-	  seconds = 0;
-      //printf("buh\n");
+	if (++seconds > 864000)
+	  seconds = 0;     
     }
     
     outportb(EOI, MASTER_PORT);
@@ -41,7 +40,7 @@
 
     asm ("cli");
     ticks = seconds = 0;
-    outportb (0x36, PIT_COMREG);
+    outportb (0x37, PIT_COMREG);
     outportb (divisor & 0xFF, PIT_DATAREG0);
     outportb (divisor >> 8, PIT_DATAREG0);
     asm ("sti");

Modified: trunk/hardware/pic8259.c
===================================================================
--- trunk/hardware/pic8259.c	2008-06-29 21:43:10 UTC (rev 9)
+++ trunk/hardware/pic8259.c	2008-07-06 15:19:25 UTC (rev 10)
@@ -78,10 +78,11 @@
 
     outportb(0xFF,MASTER_PORT_1);
     enable_IRQ(KEYBOARD);
+    enable_IRQ(TIMER);
     outportb(0xFF,SLAVE_PORT_1);
 
     outportb (0xFC, MASTER_PORT_1);
-    enable_IRQ (0);
+ //     enable_IRQ (0);
 
     setup_IRQ();
     asm("sti");
@@ -177,7 +178,7 @@
     int cur_irq;
     outportb(GET_IRR_STATUS, MASTER_PORT);
     cur_irq = inportb(MASTER_PORT);
-//     printf("%d\n", cur_irq);
+//     if(cur_irq!=1) printf("%d\n", cur_irq);
     return cur_irq;
 }
 

Modified: trunk/kernel.c
===================================================================
--- trunk/kernel.c	2008-06-29 21:43:10 UTC (rev 9)
+++ trunk/kernel.c	2008-07-06 15:19:25 UTC (rev 10)
@@ -74,13 +74,14 @@
     init_idt();
     _kprintOK();
     calcola_memoria();
+    init_mem();
     _kputs(LNG_PIC8259);
     init_IRQ();
     asm("sti");
     _kprintOK();   
     init_paging();    
     get_cpuid();
-    init_mem();
+//     init_mem();
     printf(LNG_PIT8253);
     configure_PIT ();    
     _kprintOK();
@@ -92,6 +93,7 @@
     printf("----\n");
     printf("Loading the shell..\n");
     printf("[+] Loading complete!!\n\n");    
+    printf("End: %d\n", end);
     shell();
     
 /*    if ( (shell()) != NULL)

Modified: trunk/kernel.lds
===================================================================
--- trunk/kernel.lds	2008-06-29 21:43:10 UTC (rev 9)
+++ trunk/kernel.lds	2008-07-06 15:19:25 UTC (rev 10)
@@ -1,13 +1,15 @@
 OUTPUT_FORMAT("binary")
 OUTPUT_ARCH(i386)
 ENTRY(start)
-
 SECTIONS
 {
-	. = 0x100000;
 
-	.text : { *(.text) }
-	.rodata : { *(.rodata) }
-	.data : { *(.data) *(.bss) *(COMMON) }
-    
+    . = 0x100000;
+
+    .text : { *(.text) }
+    .rodata : { *(.rodata) }
+    .data : { *(.data) *(.bss) *(COMMON) }
+
+    end = .; _end = .; __end = .;
 }
+

Modified: trunk/kernel.map
===================================================================
--- trunk/kernel.map	2008-06-29 21:43:10 UTC (rev 9)
+++ trunk/kernel.map	2008-07-06 15:19:25 UTC (rev 10)
@@ -28,249 +28,250 @@
 
                 0x0000000000100000                . = 0x100000
 
-.text           0x0000000000100000     0x3ee9
+.text           0x0000000000100000     0x3f19
  *(.text)
  .text          0x0000000000100000       0x1d bl.img
                 0x0000000000100000                mboot
                 0x0000000000100014                start
  *fill*         0x000000000010001d        0x3 00
- .text          0x0000000000100020      0x1b2 kernel.o
+ .text          0x0000000000100020      0x1c8 kernel.o
                 0x0000000000100034                main_loop
                 0x0000000000100020                _start
- *fill*         0x00000000001001d2        0x2 00
- .text          0x00000000001001d4      0x9d1 io/video.o
-                0x0000000000100b2a                _kscrolldown
-                0x00000000001001d4                _kputc
-                0x0000000000100216                _kputs
-                0x00000000001002b0                _kbackspace
-                0x00000000001009ff                _krotate_buffer
-                0x00000000001003ed                _ksetcursauto
-                0x000000000010029a                _kcolor
-                0x00000000001004fd                _kdecbin
-                0x00000000001003bc                _ksetcursor
-                0x000000000010044f                _kprintOK
-                0x00000000001002c6                _ktab
-                0x00000000001002d4                _kgoto
-                0x0000000000100369                _knewline
-                0x0000000000100a80                _kscrollup
-                0x0000000000100302                _kclear
-                0x00000000001004c3                _kgetline
-                0x0000000000100841                _kntos
-                0x0000000000100479                _kgetcolumn
-                0x00000000001005d4                _kntohex
-                0x0000000000100930                _kshiftAll
- *fill*         0x0000000000100ba5        0x3 00
- .text          0x0000000000100ba8      0x5b5 drivers/keyboard.o
-                0x0000000000100fd9                _ksetleds
-                0x0000000000101105                _kgetch
-                0x00000000001010ec                keyboard_disable
-                0x00000000001010d3                keyboard_enable
-                0x0000000000100ba8                keyboard_isr
- *fill*         0x000000000010115d        0x3 00
- .text          0x0000000000101160      0x19a libc/ctype.o
-                0x0000000000101230                islower
-                0x0000000000101280                tolower
-                0x00000000001011f8                isxdigit
-                0x0000000000101258                isupper
-                0x0000000000101188                isalpha
-                0x00000000001011be                isalnum
-                0x0000000000101160                isdigit
-                0x00000000001012bd                toupper
- *fill*         0x00000000001012fa        0x2 00
- .text          0x00000000001012fc      0x2eb libc/string.o
-                0x0000000000101477                strstr
-                0x00000000001012fc                strncpy
-                0x00000000001014f3                strtok
-                0x000000000010157d                strncat
-                0x0000000000101406                strdup
-                0x00000000001013d0                memset
-                0x000000000010135c                _kstrncmp
-                0x0000000000101335                strlen
-                0x0000000000101456                strchr
- *fill*         0x00000000001015e7        0x1 00
- .text          0x00000000001015e8       0x23 io/io.o
-                0x00000000001015e8                inportb
-                0x0000000000101601                outportb
- *fill*         0x000000000010160b        0x1 00
- .text          0x000000000010160c      0x632 libc/stdio.o
-                0x000000000010160c                putchar
-                0x0000000000101716                printf
-                0x0000000000101aea                gets
-                0x0000000000101acf                getchar
-                0x0000000000101b5d                scanf
-                0x0000000000101626                atoi
- *fill*         0x0000000000101c3e        0x2 00
- .text          0x0000000000101c40      0x18c hardware/cpuid.o
-                0x0000000000101c40                get_cpuid
- .text          0x0000000000101dcc       0x67 hardware/keyboard.o
-                0x0000000000101dcc                keyboard_irq
- *fill*         0x0000000000101e33        0x1 00
- .text          0x0000000000101e34      0x1d0 processore/gdt.o
-                0x0000000000101f10                add_GDTseg
-                0x0000000000101e34                init_gdt
-                0x0000000000101fbb                set_gdtr
- .text          0x0000000000102004      0x65d processore/idt.o
-                0x00000000001025c5                add_IDTseg
-                0x0000000000102339                init_idt
-                0x0000000000102639                set_idtr
- *fill*         0x0000000000102661        0x3 00
- .text          0x0000000000102664      0x39f processore/handlers.o
-                0x0000000000102664                init_funcTable
-                0x000000000010295c                _irqinterrupt
-                0x00000000001026e6                _globalException
-                0x00000000001026d6                add_Interrupt
-                0x00000000001029ee                _int_rsv
- *fill*         0x0000000000102a03        0x1 00
- .text          0x0000000000102a04      0x747 hardware/pic8259.o
-                0x0000000000102c35                init_IRQ
-                0x0000000000102d71                setup_IRQ
-                0x0000000000102fac                disable_IRQ
-                0x000000000010308c                add_IRQ_handler
-                0x0000000000102ed8                enable_IRQ
-                0x000000000010305e                get_current_irq
- *fill*         0x000000000010314b        0x1 00
- .text          0x000000000010314c      0x628 mem/fismem.o
-                0x000000000010314c                init_mem
-                0x0000000000103210                request_pages
-                0x00000000001035d0                add_memarea_element
-                0x00000000001036e6                get_numpages
-                0x00000000001036e0                get_memsize
-                0x000000000010370c                malloc
-                0x00000000001036f9                get_bmpelements
-                0x000000000010336b                release_pages
-                0x00000000001036c4                calcola_memoria
-                0x000000000010374a                free
- .text          0x0000000000103774      0x2ca mem/paging.o
-                0x0000000000103882                create_pageTable
-                0x0000000000103774                init_paging
-                0x00000000001039b1                get_pagedir_entry
-                0x000000000010386c                create_pageDir
-                0x00000000001039f8                load_pdbr
-                0x000000000010395f                set_pagetable_entry_ric
-                0x00000000001039ce                get_pagetable_entry
-                0x0000000000103898                set_pagedir_entry
-                0x00000000001038d9                set_pagedir_entry_ric
-                0x000000000010391e                set_pagetable_entry
- *fill*         0x0000000000103a3e        0x2 00
- .text          0x0000000000103a40       0xba system/syscall.o
-                0x0000000000103a40                sysputch
-                0x0000000000103a66                syscall_handler
- *fill*         0x0000000000103afa        0x2 00
- .text          0x0000000000103afc       0xfa hardware/8253.o
-                0x0000000000103bc7                sleep
-                0x0000000000103afc                PIT_handler
-                0x0000000000103b67                configure_PIT
- *fill*         0x0000000000103bf6        0x2 00
- .text          0x0000000000103bf8      0x2f1 shell/shell.o
-                0x0000000000103c4c                info
-                0x0000000000103dfa                shell
-                0x0000000000103c36                poweroff
-                0x0000000000103c1f                help
-                0x0000000000103bf8                logo
+ .text          0x00000000001001e8      0x9d1 io/video.o
+                0x0000000000100b3e                _kscrolldown
+                0x00000000001001e8                _kputc
+                0x000000000010022a                _kputs
+                0x00000000001002c4                _kbackspace
+                0x0000000000100a13                _krotate_buffer
+                0x0000000000100401                _ksetcursauto
+                0x00000000001002ae                _kcolor
+                0x0000000000100511                _kdecbin
+                0x00000000001003d0                _ksetcursor
+                0x0000000000100463                _kprintOK
+                0x00000000001002da                _ktab
+                0x00000000001002e8                _kgoto
+                0x000000000010037d                _knewline
+                0x0000000000100a94                _kscrollup
+                0x0000000000100316                _kclear
+                0x00000000001004d7                _kgetline
+                0x0000000000100855                _kntos
+                0x000000000010048d                _kgetcolumn
+                0x00000000001005e8                _kntohex
+                0x0000000000100944                _kshiftAll
+ *fill*         0x0000000000100bb9        0x3 00
+ .text          0x0000000000100bbc      0x5e4 drivers/keyboard.o
+                0x000000000010101c                _ksetleds
+                0x0000000000101148                _kgetch
+                0x000000000010112f                keyboard_disable
+                0x0000000000101116                keyboard_enable
+                0x0000000000100bbc                keyboard_isr
+ .text          0x00000000001011a0      0x19a libc/ctype.o
+                0x0000000000101270                islower
+                0x00000000001012c0                tolower
+                0x0000000000101238                isxdigit
+                0x0000000000101298                isupper
+                0x00000000001011c8                isalpha
+                0x00000000001011fe                isalnum
+                0x00000000001011a0                isdigit
+                0x00000000001012fd                toupper
+ *fill*         0x000000000010133a        0x2 00
+ .text          0x000000000010133c      0x2eb libc/string.o
+                0x00000000001014b7                strstr
+                0x000000000010133c                strncpy
+                0x0000000000101533                strtok
+                0x00000000001015bd                strncat
+                0x0000000000101446                strdup
+                0x0000000000101410                memset
+                0x000000000010139c                _kstrncmp
+                0x0000000000101375                strlen
+                0x0000000000101496                strchr
+ *fill*         0x0000000000101627        0x1 00
+ .text          0x0000000000101628       0x23 io/io.o
+                0x0000000000101628                inportb
+                0x0000000000101641                outportb
+ *fill*         0x000000000010164b        0x1 00
+ .text          0x000000000010164c      0x632 libc/stdio.o
+                0x000000000010164c                putchar
+                0x0000000000101756                printf
+                0x0000000000101b2a                gets
+                0x0000000000101b0f                getchar
+                0x0000000000101b9d                scanf
+                0x0000000000101666                atoi
+ *fill*         0x0000000000101c7e        0x2 00
+ .text          0x0000000000101c80      0x18c hardware/cpuid.o
+                0x0000000000101c80                get_cpuid
+ .text          0x0000000000101e0c       0x67 hardware/keyboard.o
+                0x0000000000101e0c                keyboard_irq
+ *fill*         0x0000000000101e73        0x1 00
+ .text          0x0000000000101e74      0x1d0 processore/gdt.o
+                0x0000000000101f50                add_GDTseg
+                0x0000000000101e74                init_gdt
+                0x0000000000101ffb                set_gdtr
+ .text          0x0000000000102044      0x65d processore/idt.o
+                0x0000000000102605                add_IDTseg
+                0x0000000000102379                init_idt
+                0x0000000000102679                set_idtr
+ *fill*         0x00000000001026a1        0x3 00
+ .text          0x00000000001026a4      0x38d processore/handlers.o
+                0x00000000001026a4                init_funcTable
+                0x000000000010299c                _irqinterrupt
+                0x0000000000102726                _globalException
+                0x0000000000102716                add_Interrupt
+                0x0000000000102a1c                _int_rsv
+ *fill*         0x0000000000102a31        0x3 00
+ .text          0x0000000000102a34      0x747 hardware/pic8259.o
+                0x0000000000102c65                init_IRQ
+                0x0000000000102da1                setup_IRQ
+                0x0000000000102fdc                disable_IRQ
+                0x00000000001030bc                add_IRQ_handler
+                0x0000000000102f08                enable_IRQ
+                0x000000000010308e                get_current_irq
+ *fill*         0x000000000010317b        0x1 00
+ .text          0x000000000010317c      0x628 mem/fismem.o
+                0x000000000010317c                init_mem
+                0x0000000000103240                request_pages
+                0x0000000000103600                add_memarea_element
+                0x0000000000103716                get_numpages
+                0x0000000000103710                get_memsize
+                0x000000000010373c                malloc
+                0x0000000000103729                get_bmpelements
+                0x000000000010339b                release_pages
+                0x00000000001036f4                calcola_memoria
+                0x000000000010377a                free
+ .text          0x00000000001037a4      0x2ca mem/paging.o
+                0x00000000001038b2                create_pageTable
+                0x00000000001037a4                init_paging
+                0x00000000001039e1                get_pagedir_entry
+                0x000000000010389c                create_pageDir
+                0x0000000000103a28                load_pdbr
+                0x000000000010398f                set_pagetable_entry_ric
+                0x00000000001039fe                get_pagetable_entry
+                0x00000000001038c8                set_pagedir_entry
+                0x0000000000103909                set_pagedir_entry_ric
+                0x000000000010394e                set_pagetable_entry
+ *fill*         0x0000000000103a6e        0x2 00
+ .text          0x0000000000103a70       0xba system/syscall.o
+                0x0000000000103a70                sysputch
+                0x0000000000103a96                syscall_handler
+ *fill*         0x0000000000103b2a        0x2 00
+ .text          0x0000000000103b2c       0xfa hardware/8253.o
+                0x0000000000103bf7                sleep
+                0x0000000000103b2c                PIT_handler
+                0x0000000000103b97                configure_PIT
+ *fill*         0x0000000000103c26        0x2 00
+ .text          0x0000000000103c28      0x2f1 shell/shell.o
+                0x0000000000103c7c                info
+                0x0000000000103e2a                shell
+                0x0000000000103c66                poweroff
+                0x0000000000103c4f                help
+                0x0000000000103c28                logo
 
-.rodata         0x0000000000103eec      0x789
+.rodata         0x0000000000103f1c      0x765
  *(.rodata)
- .rodata        0x0000000000103eec       0xd9 kernel.o
- .rodata        0x0000000000103fc5       0x70 io/video.o
- .rodata        0x0000000000104035       0x10 drivers/keyboard.o
- .rodata        0x0000000000104045        0x2 libc/stdio.o
- .rodata        0x0000000000104047       0x3e hardware/cpuid.o
- .rodata        0x0000000000104085       0x1d hardware/keyboard.o
- *fill*         0x00000000001040a2        0x2 00
- .rodata        0x00000000001040a4      0x269 processore/handlers.o
- *fill*         0x000000000010430d        0x3 00
- .rodata        0x0000000000104310       0x8a mem/fismem.o
- *fill*         0x000000000010439a        0x2 00
- .rodata        0x000000000010439c       0x23 mem/paging.o
- *fill*         0x00000000001043bf        0x1 00
- .rodata        0x00000000001043c0        0xc system/syscall.o
- .rodata        0x00000000001043cc      0x2a9 shell/shell.o
+ .rodata        0x0000000000103f1c       0xe2 kernel.o
+ .rodata        0x0000000000103ffe       0x70 io/video.o
+ .rodata        0x000000000010406e       0x10 drivers/keyboard.o
+ .rodata        0x000000000010407e        0x2 libc/stdio.o
+ .rodata        0x0000000000104080       0x3e hardware/cpuid.o
+ .rodata        0x00000000001040be       0x1d hardware/keyboard.o
+ *fill*         0x00000000001040db        0x1 00
+ .rodata        0x00000000001040dc      0x23e processore/handlers.o
+ *fill*         0x000000000010431a        0x2 00
+ .rodata        0x000000000010431c       0x8a mem/fismem.o
+ *fill*         0x00000000001043a6        0x2 00
+ .rodata        0x00000000001043a8       0x23 mem/paging.o
+ *fill*         0x00000000001043cb        0x1 00
+ .rodata        0x00000000001043cc        0xc system/syscall.o
+ .rodata        0x00000000001043d8      0x2a9 shell/shell.o
 
-.rel.dyn        0x0000000000104678        0x0 load address 0x0000000000104675
+.rel.dyn        0x0000000000104684        0x0 load address 0x0000000000104681
  .rel.text      0x0000000000000000        0x0 bl.img
 
-.data           0x0000000000104680    0x3376c
+.data           0x00000000001046a0    0x3376c
  *(.data)
- .data          0x0000000000104680        0x0 kernel.o
- .data          0x0000000000104680        0x9 io/video.o
-                0x0000000000104684                VIDEO_PTR
-                0x0000000000104688                VIDEO_CLR
-                0x0000000000104680                VIDEO_MEM
- *fill*         0x0000000000104689       0x17 00
- .data          0x00000000001046a0      0x2f8 drivers/keyboard.o
- .data          0x0000000000104998        0x0 libc/ctype.o
- .data          0x0000000000104998        0x0 libc/string.o
- .data          0x0000000000104998        0x0 io/io.o
- .data          0x0000000000104998        0x0 libc/stdio.o
- .data          0x0000000000104998        0x0 hardware/cpuid.o
- .data          0x0000000000104998        0x0 hardware/keyboard.o
- .data          0x0000000000104998        0x0 processore/gdt.o
- .data          0x0000000000104998        0x0 processore/idt.o
- .data          0x0000000000104998        0x0 processore/handlers.o
- .data          0x0000000000104998        0x0 hardware/pic8259.o
- .data          0x0000000000104998        0xc mem/fismem.o
-                0x0000000000104998                prova2
-                0x000000000010499c                mem_info_root
-                0x00000000001049a0                mem_info
- .data          0x00000000001049a4        0x0 mem/paging.o
- .data          0x00000000001049a4        0x4 system/syscall.o
-                0x00000000001049a4                syscall_table
- .data          0x00000000001049a8        0x0 hardware/8253.o
- .data          0x00000000001049a8        0x0 shell/shell.o
+ .data          0x00000000001046a0        0x0 kernel.o
+ .data          0x00000000001046a0        0x9 io/video.o
+                0x00000000001046a4                VIDEO_PTR
+                0x00000000001046a8                VIDEO_CLR
+                0x00000000001046a0                VIDEO_MEM
+ *fill*         0x00000000001046a9       0x17 00
+ .data          0x00000000001046c0      0x2f8 drivers/keyboard.o
+ .data          0x00000000001049b8        0x0 libc/ctype.o
+ .data          0x00000000001049b8        0x0 libc/string.o
+ .data          0x00000000001049b8        0x0 io/io.o
+ .data          0x00000000001049b8        0x0 libc/stdio.o
+ .data          0x00000000001049b8        0x0 hardware/cpuid.o
+ .data          0x00000000001049b8        0x0 hardware/keyboard.o
+ .data          0x00000000001049b8        0x0 processore/gdt.o
+ .data          0x00000000001049b8        0x0 processore/idt.o
+ .data          0x00000000001049b8        0x0 processore/handlers.o
+ .data          0x00000000001049b8        0x0 hardware/pic8259.o
+ .data          0x00000000001049b8        0xc mem/fismem.o
+                0x00000000001049b8                prova2
+                0x00000000001049bc                mem_info_root
+                0x00000000001049c0                mem_info
+ .data          0x00000000001049c4        0x0 mem/paging.o
+ .data          0x00000000001049c4        0x4 system/syscall.o
+                0x00000000001049c4                syscall_table
+ .data          0x00000000001049c8        0x0 hardware/8253.o
+ .data          0x00000000001049c8        0x0 shell/shell.o
  *(.bss)
- .bss           0x00000000001049a8        0x0 kernel.o
- .bss           0x00000000001049a8       0x10 io/video.o
-                0x00000000001049ac                is_shifted_once
-                0x00000000001049a8                is_scrolled
-                0x00000000001049b4                resulthex
-                0x00000000001049b0                binlen
- *fill*         0x00000000001049b8        0x8 00
- .bss           0x00000000001049c0      0x434 drivers/keyboard.o
- .bss           0x0000000000104df4        0x0 libc/ctype.o
- .bss           0x0000000000104df4        0x4 libc/string.o
- .bss           0x0000000000104df8        0x0 io/io.o
- .bss           0x0000000000104df8        0x0 libc/stdio.o
- .bss           0x0000000000104df8        0x0 hardware/cpuid.o
- .bss           0x0000000000104df8        0x0 hardware/keyboard.o
- .bss           0x0000000000104df8        0x0 processore/gdt.o
- .bss           0x0000000000104df8        0x0 processore/idt.o
- .bss           0x0000000000104df8        0x0 processore/handlers.o
- .bss           0x0000000000104df8        0x0 hardware/pic8259.o
- .bss           0x0000000000104df8        0x4 mem/fismem.o
-                0x0000000000104df8                num_pages
- .bss           0x0000000000104dfc        0x0 mem/paging.o
- .bss           0x0000000000104dfc        0x0 system/syscall.o
- .bss           0x0000000000104dfc        0x8 hardware/8253.o
- .bss           0x0000000000104e04        0x0 shell/shell.o
+ .bss           0x00000000001049c8        0x0 kernel.o
+ .bss           0x00000000001049c8       0x10 io/video.o
+                0x00000000001049cc                is_shifted_once
+                0x00000000001049c8                is_scrolled
+                0x00000000001049d4                resulthex
+                0x00000000001049d0                binlen
+ *fill*         0x00000000001049d8        0x8 00
+ .bss           0x00000000001049e0      0x434 drivers/keyboard.o
+ .bss           0x0000000000104e14        0x0 libc/ctype.o
+ .bss           0x0000000000104e14        0x4 libc/string.o
+ .bss           0x0000000000104e18        0x0 io/io.o
+ .bss           0x0000000000104e18        0x0 libc/stdio.o
+ .bss           0x0000000000104e18        0x0 hardware/cpuid.o
+ .bss           0x0000000000104e18        0x0 hardware/keyboard.o
+ .bss           0x0000000000104e18        0x0 processore/gdt.o
+ .bss           0x0000000000104e18        0x0 processore/idt.o
+ .bss           0x0000000000104e18        0x0 processore/handlers.o
+ .bss           0x0000000000104e18        0x0 hardware/pic8259.o
+ .bss           0x0000000000104e18        0x4 mem/fismem.o
+                0x0000000000104e18                num_pages
+ .bss           0x0000000000104e1c        0x0 mem/paging.o
+ .bss           0x0000000000104e1c        0x0 system/syscall.o
+ .bss           0x0000000000104e1c        0x8 hardware/8253.o
+ .bss           0x0000000000104e24        0x0 shell/shell.o
  *(COMMON)
- COMMON         0x0000000000104e04       0x10 kernel.o
-                0x0000000000104e04                cpu_vendor
-                0x0000000000104e10                current_page_table
- *fill*         0x0000000000104e14        0xc 00
- COMMON         0x0000000000104e20     0x233c io/video.o
-                0x0000000000104e20                downbuffer
-                0x0000000000105dc0                upbuffer
-                0x0000000000106d60                binvp
- *fill*         0x000000000010715c        0x4 00
- COMMON         0x0000000000107160    0x10004 processore/gdt.o
-                0x0000000000107160                Gdt_Table
-                0x0000000000117160                current_pos
- *fill*         0x0000000000117164       0x1c 00
- COMMON         0x0000000000117180      0xc00 processore/idt.o
-                0x0000000000117180                IntTable
-                0x0000000000117580                IDT_Table
- COMMON         0x0000000000117d80       0x40 processore/handlers.o
-                0x0000000000117d80                shareHandler
- COMMON         0x0000000000117dc0        0x2 hardware/pic8259.o
-                0x0000000000117dc0                slave_cur_mask
-                0x0000000000117dc1                master_cur_mask
- *fill*         0x0000000000117dc2       0x1e 00
- COMMON         0x0000000000117de0    0x20008 mem/fismem.o
-                0x0000000000117de0                mem_bitmap
-                0x0000000000137de0                tot_mem
-                0x0000000000137de4                bmp_elements
- COMMON         0x0000000000137de8        0x4 mem/paging.o
-                0x0000000000137de8                current_page_dir
+ COMMON         0x0000000000104e24       0x10 kernel.o
+                0x0000000000104e24                cpu_vendor
+                0x0000000000104e30                current_page_table
+ *fill*         0x0000000000104e34        0xc 00
+ COMMON         0x0000000000104e40     0x233c io/video.o
+                0x0000000000104e40                downbuffer
+                0x0000000000105de0                upbuffer
+                0x0000000000106d80                binvp
+ *fill*         0x000000000010717c        0x4 00
+ COMMON         0x0000000000107180    0x10004 processore/gdt.o
+                0x0000000000107180                Gdt_Table
+                0x0000000000117180                current_pos
+ *fill*         0x0000000000117184       0x1c 00
+ COMMON         0x00000000001171a0      0xc00 processore/idt.o
+                0x00000000001171a0                IntTable
+                0x00000000001175a0                IDT_Table
+ COMMON         0x0000000000117da0       0x40 processore/handlers.o
+                0x0000000000117da0                shareHandler
+ COMMON         0x0000000000117de0        0x2 hardware/pic8259.o
+                0x0000000000117de0                slave_cur_mask
+                0x0000000000117de1                master_cur_mask
+ *fill*         0x0000000000117de2       0x1e 00
+ COMMON         0x0000000000117e00    0x20008 mem/fismem.o
+                0x0000000000117e00                mem_bitmap
+                0x0000000000137e00                tot_mem
+                0x0000000000137e04                bmp_elements
+ COMMON         0x0000000000137e08        0x4 mem/paging.o
+                0x0000000000137e08                current_page_dir
+                0x0000000000137e0c                end = .
+                0x0000000000137e0c                _end = .
+                0x0000000000137e0c                __end = .
 LOAD bl.img
 LOAD kernel.o
 LOAD io/video.o

Modified: trunk/mem/fismem.c
===================================================================
--- trunk/mem/fismem.c	2008-06-29 21:43:10 UTC (rev 9)
+++ trunk/mem/fismem.c	2008-07-06 15:19:25 UTC (rev 10)
@@ -31,8 +31,8 @@
 size_t tot_mem;
 size_t num_pages=0;
 size_t bmp_elements;
-byte master_cur_mask;
-byte slave_cur_mask;
+// byte master_cur_mask;
+// byte slave_cur_mask;
 mem_struct mem_bitmap;
 int prova2 = 35;
 

Modified: trunk/processore/handlers.c
===================================================================
--- trunk/processore/handlers.c	2008-06-29 21:43:10 UTC (rev 9)
+++ trunk/processore/handlers.c	2008-07-06 15:19:25 UTC (rev 10)
@@ -30,6 +30,7 @@
 #include <keyboard.h>
 #include <video.h>
 
+// #define DEBUG 1
 void (*IntTable[IDT_SIZE])();
 IRQ_s *shareHandler[16];
 // IRQ_s *tmpHandler;
@@ -101,13 +102,13 @@
 
 void _irqinterrupt(){
     int irqn;
-    irqn = get_current_irq();
-    IRQ_s* tmpHandler;
-    tmpHandler = shareHandler[irqn-1];
+    irqn = get_current_irq();  
+    IRQ_s* tmpHandler; 
     #ifdef DEBUG
     printf("Next shareHandler: %d\n", tmpHandler->next);
     #endif
     if(irqn>0) {
+        tmpHandler = shareHandler[irqn-1];
         tmpHandler->IRQ_func();
         #ifdef DEBUG
         printf("2 - IRQ_func: %d, %d\n", tmpHandler->IRQ_func, tmpHandler);
@@ -119,7 +120,8 @@
             #endif
             tmpHandler->IRQ_func();
         }
-    } else _kputs("E' arrivato qualcosa che non so gestire");
+    }
+//  else printf("IRQ N: %d E' arrivato qualcosa che non so gestire ", irqn);
     if(irqn<=8) outportb(0x20, MASTER_PORT);
     else if(irqn<=16)outportb(0x20, SLAVE_PORT);
 }



From finarfin at mail.berlios.de  Mon Jul 14 00:03:54 2008
From: finarfin at mail.berlios.de (finarfin at BerliOS)
Date: Mon, 14 Jul 2008 00:03:54 +0200
Subject: [Dreamos-dev] r11 - in trunk: . boot hardware include/mem mem
Message-ID: <200807132203.m6DM3sLV013553@sheep.berlios.de>

Author: finarfin
Date: 2008-07-14 00:03:52 +0200 (Mon, 14 Jul 2008)
New Revision: 11

Added:
   trunk/include/mem/kheap.h
   trunk/mem/kheap.c
Modified:
   trunk/.bochsrc
   trunk/Makefile
   trunk/bl.img
   trunk/boot/multicatcher.S
   trunk/dreamos.img
   trunk/hardware/8253.c
   trunk/kernel.c
   trunk/kernel.lds
   trunk/kernel.map
Log:
Aggiunti files:
 * include/mem/kheap.h
 * mem/kheap.c
Aggiornato il Makefile
Aggiunto l'EOI all'handler del PIT.
Modificato il file .bochsrc con 64mb di ram.
Modificato lo script kernel.lds


Modified: trunk/.bochsrc
===================================================================
--- trunk/.bochsrc	2008-07-06 15:19:25 UTC (rev 10)
+++ trunk/.bochsrc	2008-07-13 22:03:52 UTC (rev 11)
@@ -87,9 +87,9 @@
 #=======================================================================
 #megs: 256
 #megs: 128
-#megs: 64
+megs: 64
 #megs: 32
-megs: 16
+#megs: 16
 #megs: 8
 
 #=======================================================================
@@ -428,7 +428,7 @@
 #   parport2: enabled=1, file="/dev/lp0"
 #   parport1: enabled=0
 #=======================================================================
-#parport1: enabled=1, file="parport.out"
+parport1: enabled=1, file="parport.out"
 
 #=======================================================================
 # SB16:

Modified: trunk/Makefile
===================================================================
--- trunk/Makefile	2008-07-06 15:19:25 UTC (rev 10)
+++ trunk/Makefile	2008-07-13 22:03:52 UTC (rev 11)
@@ -1,5 +1,5 @@
 CFLAGS = -nostdlib -fomit-frame-pointer -fno-builtin -fno-stack-protector -Wall -march=i386 -I./include -I./include/io -I./include/drivers -I./include/libc -I./include/processore -I./include/hardware -I./include/mem -I./include/system -I./include/shell
-OBJ = kernel.o io/video.o drivers/keyboard.o libc/ctype.o libc/string.o io/io.o libc/stdio.o hardware/cpuid.o hardware/keyboard.o processore/gdt.o processore/idt.o processore/handlers.o hardware/pic8259.o mem/fismem.o mem/paging.o system/syscall.o hardware/8253.o shell/shell.o
+OBJ = kernel.o io/video.o drivers/keyboard.o libc/ctype.o libc/string.o io/io.o libc/stdio.o hardware/cpuid.o hardware/keyboard.o processore/gdt.o processore/idt.o processore/handlers.o hardware/pic8259.o mem/fismem.o mem/paging.o mem/kheap.o system/syscall.o hardware/8253.o shell/shell.o
 
 dreamos.img: bl.img kernel.bin
 	mv kernel.bin dreamos.img
@@ -24,6 +24,7 @@
 libc/string.o : libc/string.c
 mem/fismem.o : mem/fismem.c
 mem/paging.o : mem/paging.c
+mem/kheap.o : mem/kheap.c
 drivers/keyboard.o : drivers/keyboard.c
 system/syscall.o : system/syscall.c
 hardware/8253.o : hardware/8253.c

Modified: trunk/bl.img
===================================================================
(Binary files differ)

Modified: trunk/boot/multicatcher.S
===================================================================
--- trunk/boot/multicatcher.S	2008-07-06 15:19:25 UTC (rev 10)
+++ trunk/boot/multicatcher.S	2008-07-13 22:03:52 UTC (rev 11)
@@ -17,6 +17,9 @@
 [BITS 32]
 
 [GLOBAL mboot]
+[EXTERN code]                   ; Start of the '.text' section.
+[EXTERN bss]                    ; Start of the .bss section.
+[EXTERN end]                    ; End of the last loadable section.
 
 mboot:
   dd  MBOOT_HEADER_MAGIC
@@ -24,6 +27,9 @@
   dd  MBOOT_CHECKSUM            ; Check the other values
    
   dd  mboot
+  dd  code                    ; Start of kernel '.text' (code) section.
+  dd  bss                     ; End of kernel '.data' section.
+  dd  end                     ; End of kernel.
   dd  start                     ; Kernel start point
 
 [GLOBAL start]

Modified: trunk/dreamos.img
===================================================================
(Binary files differ)

Modified: trunk/hardware/8253.c
===================================================================
--- trunk/hardware/8253.c	2008-07-06 15:19:25 UTC (rev 10)
+++ trunk/hardware/8253.c	2008-07-13 22:03:52 UTC (rev 11)
@@ -27,7 +27,7 @@
 {
     if (++ticks % 100 == 0) {
 	ticks = 0;
-	if (++seconds > 864000)
+	if (++seconds > 86400)
 	  seconds = 0;     
     }
     

Added: trunk/include/mem/kheap.h
===================================================================
--- trunk/include/mem/kheap.h	2008-07-06 15:19:25 UTC (rev 10)
+++ trunk/include/mem/kheap.h	2008-07-13 22:03:52 UTC (rev 11)
@@ -0,0 +1,32 @@
+/***************************************************************************
+ *            kheap.h
+ *
+ *  Sat Mar 31 07:47:17 2007
+ *  Copyright  2007  Ivan Gualandri
+ *  Email
+ ****************************************************************************/
+
+/*
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
+
+#ifndef KHEAP_H
+#define KHEAP_H
+
+extern unsigned int address_cur;
+
+unsigned int _kmalloc(int);
+
+#endif
\ No newline at end of file

Modified: trunk/kernel.c
===================================================================
--- trunk/kernel.c	2008-07-06 15:19:25 UTC (rev 10)
+++ trunk/kernel.c	2008-07-13 22:03:52 UTC (rev 11)
@@ -50,8 +50,8 @@
 }
 
 int main_loop(struct multiboot_info *boot_info)
-{
-    int a;
+{    
+
     _kclear();
 
     _kcolor('\012');
@@ -70,32 +70,37 @@
     outportb(0xFF, MASTER_PORT_1);
     outportb(0xFF, SLAVE_PORT_1);
     _kputs(LNG_IDT);
+
     asm("cli");   
     init_idt();
     _kprintOK();
-    calcola_memoria();
-    init_mem();
+    
+    calcola_memoria();    
+    init_mem();    
     _kputs(LNG_PIC8259);
     init_IRQ();
     asm("sti");
     _kprintOK();   
+    printf("End: %d\n", end);
     init_paging();    
-    get_cpuid();
-//     init_mem();
+
     printf(LNG_PIT8253);
     configure_PIT ();    
     _kprintOK();
+
     asm ("movl $0, %eax\n"
      "movl $35, %ebx\n"
      "int $80");
-    printf("\n");
     printf("\nMemory (upper) amount-> %d kb \n", boot_info->mem_upper);
+    get_cpuid();    
+    printf("\n");    
     printf("----\n");
     printf("Loading the shell..\n");
     printf("[+] Loading complete!!\n\n");    
-    printf("End: %d\n", end);
+    printf("End: %d Address: 0x%x\n", end, &end);
+
     shell();
-    
+
 /*    if ( (shell()) != NULL)
     {	printf("[+] Loading compleate!!\n\n\n");	}
 */

Modified: trunk/kernel.lds
===================================================================
--- trunk/kernel.lds	2008-07-06 15:19:25 UTC (rev 10)
+++ trunk/kernel.lds	2008-07-13 22:03:52 UTC (rev 11)
@@ -4,12 +4,28 @@
 SECTIONS
 {
 
-    . = 0x100000;
+    .text 0x100000 :
+    {
+        code = .; _code = .; __code = .;
+        *(.text)
+        . = ALIGN(4096);
+    }
 
-    .text : { *(.text) }
-    .rodata : { *(.rodata) }
-    .data : { *(.data) *(.bss) *(COMMON) }
+    .data :
+    {
+        data = .; _data = .; __data = .;
+        *(.data)
+        *(.rodata)
+        . = ALIGN(4096);
+    }
 
+    .bss :
+    {
+        bss = .; _bss = .; __bss = .;
+        *(.bss)
+        . = ALIGN(4096);
+    }
+
     end = .; _end = .; __end = .;
 }
 

Modified: trunk/kernel.map
===================================================================
--- trunk/kernel.map	2008-07-06 15:19:25 UTC (rev 10)
+++ trunk/kernel.map	2008-07-13 22:03:52 UTC (rev 11)
@@ -16,6 +16,7 @@
 current_page_table  0x4               kernel.o
 master_cur_mask     0x1               hardware/pic8259.o
 bmp_elements        0x4               mem/fismem.o
+address_cur         0x4               mem/kheap.o
 binvp               0x3fc             io/video.o
 shareHandler        0x40              processore/handlers.o
 
@@ -26,252 +27,273 @@
 
 Linker script and memory map
 
-                0x0000000000100000                . = 0x100000
 
-.text           0x0000000000100000     0x3f19
+.text           0x0000000000100000     0x4000
+                0x0000000000100000                code = .
+                0x0000000000100000                _code = .
+                0x0000000000100000                __code = .
  *(.text)
- .text          0x0000000000100000       0x1d bl.img
+ .text          0x0000000000100000       0x29 bl.img
                 0x0000000000100000                mboot
-                0x0000000000100014                start
- *fill*         0x000000000010001d        0x3 00
- .text          0x0000000000100020      0x1c8 kernel.o
-                0x0000000000100034                main_loop
-                0x0000000000100020                _start
- .text          0x00000000001001e8      0x9d1 io/video.o
-                0x0000000000100b3e                _kscrolldown
-                0x00000000001001e8                _kputc
-                0x000000000010022a                _kputs
-                0x00000000001002c4                _kbackspace
-                0x0000000000100a13                _krotate_buffer
-                0x0000000000100401                _ksetcursauto
-                0x00000000001002ae                _kcolor
-                0x0000000000100511                _kdecbin
-                0x00000000001003d0                _ksetcursor
-                0x0000000000100463                _kprintOK
-                0x00000000001002da                _ktab
-                0x00000000001002e8                _kgoto
-                0x000000000010037d                _knewline
-                0x0000000000100a94                _kscrollup
-                0x0000000000100316                _kclear
-                0x00000000001004d7                _kgetline
-                0x0000000000100855                _kntos
-                0x000000000010048d                _kgetcolumn
-                0x00000000001005e8                _kntohex
-                0x0000000000100944                _kshiftAll
- *fill*         0x0000000000100bb9        0x3 00
- .text          0x0000000000100bbc      0x5e4 drivers/keyboard.o
-                0x000000000010101c                _ksetleds
-                0x0000000000101148                _kgetch
-                0x000000000010112f                keyboard_disable
-                0x0000000000101116                keyboard_enable
-                0x0000000000100bbc                keyboard_isr
- .text          0x00000000001011a0      0x19a libc/ctype.o
-                0x0000000000101270                islower
-                0x00000000001012c0                tolower
-                0x0000000000101238                isxdigit
-                0x0000000000101298                isupper
-                0x00000000001011c8                isalpha
-                0x00000000001011fe                isalnum
-                0x00000000001011a0                isdigit
-                0x00000000001012fd                toupper
- *fill*         0x000000000010133a        0x2 00
- .text          0x000000000010133c      0x2eb libc/string.o
-                0x00000000001014b7                strstr
-                0x000000000010133c                strncpy
-                0x0000000000101533                strtok
-                0x00000000001015bd                strncat
-                0x0000000000101446                strdup
-                0x0000000000101410                memset
-                0x000000000010139c                _kstrncmp
-                0x0000000000101375                strlen
-                0x0000000000101496                strchr
- *fill*         0x0000000000101627        0x1 00
- .text          0x0000000000101628       0x23 io/io.o
-                0x0000000000101628                inportb
-                0x0000000000101641                outportb
- *fill*         0x000000000010164b        0x1 00
- .text          0x000000000010164c      0x632 libc/stdio.o
-                0x000000000010164c                putchar
-                0x0000000000101756                printf
-                0x0000000000101b2a                gets
-                0x0000000000101b0f                getchar
-                0x0000000000101b9d                scanf
-                0x0000000000101666                atoi
- *fill*         0x0000000000101c7e        0x2 00
- .text          0x0000000000101c80      0x18c hardware/cpuid.o
-                0x0000000000101c80                get_cpuid
- .text          0x0000000000101e0c       0x67 hardware/keyboard.o
-                0x0000000000101e0c                keyboard_irq
- *fill*         0x0000000000101e73        0x1 00
- .text          0x0000000000101e74      0x1d0 processore/gdt.o
-                0x0000000000101f50                add_GDTseg
-                0x0000000000101e74                init_gdt
-                0x0000000000101ffb                set_gdtr
- .text          0x0000000000102044      0x65d processore/idt.o
-                0x0000000000102605                add_IDTseg
-                0x0000000000102379                init_idt
-                0x0000000000102679                set_idtr
- *fill*         0x00000000001026a1        0x3 00
- .text          0x00000000001026a4      0x38d processore/handlers.o
-                0x00000000001026a4                init_funcTable
-                0x000000000010299c                _irqinterrupt
-                0x0000000000102726                _globalException
-                0x0000000000102716                add_Interrupt
-                0x0000000000102a1c                _int_rsv
- *fill*         0x0000000000102a31        0x3 00
- .text          0x0000000000102a34      0x747 hardware/pic8259.o
-                0x0000000000102c65                init_IRQ
-                0x0000000000102da1                setup_IRQ
-                0x0000000000102fdc                disable_IRQ
-                0x00000000001030bc                add_IRQ_handler
-                0x0000000000102f08                enable_IRQ
-                0x000000000010308e                get_current_irq
- *fill*         0x000000000010317b        0x1 00
- .text          0x000000000010317c      0x628 mem/fismem.o
-                0x000000000010317c                init_mem
-                0x0000000000103240                request_pages
-                0x0000000000103600                add_memarea_element
-                0x0000000000103716                get_numpages
-                0x0000000000103710                get_memsize
-                0x000000000010373c                malloc
-                0x0000000000103729                get_bmpelements
-                0x000000000010339b                release_pages
-                0x00000000001036f4                calcola_memoria
-                0x000000000010377a                free
- .text          0x00000000001037a4      0x2ca mem/paging.o
-                0x00000000001038b2                create_pageTable
-                0x00000000001037a4                init_paging
-                0x00000000001039e1                get_pagedir_entry
-                0x000000000010389c                create_pageDir
-                0x0000000000103a28                load_pdbr
-                0x000000000010398f                set_pagetable_entry_ric
-                0x00000000001039fe                get_pagetable_entry
-                0x00000000001038c8                set_pagedir_entry
-                0x0000000000103909                set_pagedir_entry_ric
-                0x000000000010394e                set_pagetable_entry
- *fill*         0x0000000000103a6e        0x2 00
- .text          0x0000000000103a70       0xba system/syscall.o
-                0x0000000000103a70                sysputch
-                0x0000000000103a96                syscall_handler
- *fill*         0x0000000000103b2a        0x2 00
- .text          0x0000000000103b2c       0xfa hardware/8253.o
-                0x0000000000103bf7                sleep
-                0x0000000000103b2c                PIT_handler
-                0x0000000000103b97                configure_PIT
- *fill*         0x0000000000103c26        0x2 00
- .text          0x0000000000103c28      0x2f1 shell/shell.o
-                0x0000000000103c7c                info
-                0x0000000000103e2a                shell
-                0x0000000000103c66                poweroff
-                0x0000000000103c4f                help
-                0x0000000000103c28                logo
+                0x0000000000100020                start
+ *fill*         0x0000000000100029        0x3 00
+ .text          0x000000000010002c      0x1e3 kernel.o
+                0x0000000000100040                main_loop
+                0x000000000010002c                _start
+ *fill*         0x000000000010020f        0x1 00
+ .text          0x0000000000100210      0x9d1 io/video.o
+                0x0000000000100b66                _kscrolldown
+                0x0000000000100210                _kputc
+                0x0000000000100252                _kputs
+                0x00000000001002ec                _kbackspace
+                0x0000000000100a3b                _krotate_buffer
+                0x0000000000100429                _ksetcursauto
+                0x00000000001002d6                _kcolor
+                0x0000000000100539                _kdecbin
+                0x00000000001003f8                _ksetcursor
+                0x000000000010048b                _kprintOK
+                0x0000000000100302                _ktab
+                0x0000000000100310                _kgoto
+                0x00000000001003a5                _knewline
+                0x0000000000100abc                _kscrollup
+                0x000000000010033e                _kclear
+                0x00000000001004ff                _kgetline
+                0x000000000010087d                _kntos
+                0x00000000001004b5                _kgetcolumn
+                0x0000000000100610                _kntohex
+                0x000000000010096c                _kshiftAll
+ *fill*         0x0000000000100be1        0x3 00
+ .text          0x0000000000100be4      0x5e4 drivers/keyboard.o
+                0x0000000000101044                _ksetleds
+                0x0000000000101170                _kgetch
+                0x0000000000101157                keyboard_disable
+                0x000000000010113e                keyboard_enable
+                0x0000000000100be4                keyboard_isr
+ .text          0x00000000001011c8      0x19a libc/ctype.o
+                0x0000000000101298                islower
+                0x00000000001012e8                tolower
+                0x0000000000101260                isxdigit
+                0x00000000001012c0                isupper
+                0x00000000001011f0                isalpha
+                0x0000000000101226                isalnum
+                0x00000000001011c8                isdigit
+                0x0000000000101325                toupper
+ *fill*         0x0000000000101362        0x2 00
+ .text          0x0000000000101364      0x2eb libc/string.o
+                0x00000000001014df                strstr
+                0x0000000000101364                strncpy
+                0x000000000010155b                strtok
+                0x00000000001015e5                strncat
+                0x000000000010146e                strdup
+                0x0000000000101438                memset
+                0x00000000001013c4                _kstrncmp
+                0x000000000010139d                strlen
+                0x00000000001014be                strchr
+ *fill*         0x000000000010164f        0x1 00
+ .text          0x0000000000101650       0x23 io/io.o
+                0x0000000000101650                inportb
+                0x0000000000101669                outportb
+ *fill*         0x0000000000101673        0x1 00
+ .text          0x0000000000101674      0x632 libc/stdio.o
+                0x0000000000101674                putchar
+                0x000000000010177e                printf
+                0x0000000000101b52                gets
+                0x0000000000101b37                getchar
+                0x0000000000101bc5                scanf
+                0x000000000010168e                atoi
+ *fill*         0x0000000000101ca6        0x2 00
+ .text          0x0000000000101ca8      0x18c hardware/cpuid.o
+                0x0000000000101ca8                get_cpuid
+ .text          0x0000000000101e34       0x67 hardware/keyboard.o
+                0x0000000000101e34                keyboard_irq
+ *fill*         0x0000000000101e9b        0x1 00
+ .text          0x0000000000101e9c      0x1d0 processore/gdt.o
+                0x0000000000101f78                add_GDTseg
+                0x0000000000101e9c                init_gdt
+                0x0000000000102023                set_gdtr
+ .text          0x000000000010206c      0x65d processore/idt.o
+                0x000000000010262d                add_IDTseg
+                0x00000000001023a1                init_idt
+                0x00000000001026a1                set_idtr
+ *fill*         0x00000000001026c9        0x3 00
+ .text          0x00000000001026cc      0x38d processore/handlers.o
+                0x00000000001026cc                init_funcTable
+                0x00000000001029c4                _irqinterrupt
+                0x000000000010274e                _globalException
+                0x000000000010273e                add_Interrupt
+                0x0000000000102a44                _int_rsv
+ *fill*         0x0000000000102a59        0x3 00
+ .text          0x0000000000102a5c      0x747 hardware/pic8259.o
+                0x0000000000102c8d                init_IRQ
+                0x0000000000102dc9                setup_IRQ
+                0x0000000000103004                disable_IRQ
+                0x00000000001030e4                add_IRQ_handler
+                0x0000000000102f30                enable_IRQ
+                0x00000000001030b6                get_current_irq
+ *fill*         0x00000000001031a3        0x1 00
+ .text          0x00000000001031a4      0x628 mem/fismem.o
+                0x00000000001031a4                init_mem
+                0x0000000000103268                request_pages
+                0x0000000000103628                add_memarea_element
+                0x000000000010373e                get_numpages
+                0x0000000000103738                get_memsize
+                0x0000000000103764                malloc
+                0x0000000000103751                get_bmpelements
+                0x00000000001033c3                release_pages
+                0x000000000010371c                calcola_memoria
+                0x00000000001037a2                free
+ .text          0x00000000001037cc      0x2ca mem/paging.o
+                0x00000000001038da                create_pageTable
+                0x00000000001037cc                init_paging
+                0x0000000000103a09                get_pagedir_entry
+                0x00000000001038c4                create_pageDir
+                0x0000000000103a50                load_pdbr
+                0x00000000001039b7                set_pagetable_entry_ric
+                0x0000000000103a26                get_pagetable_entry
+                0x00000000001038f0                set_pagedir_entry
+                0x0000000000103931                set_pagedir_entry_ric
+                0x0000000000103976                set_pagetable_entry
+ *fill*         0x0000000000103a96        0x2 00
+ .text          0x0000000000103a98       0x17 mem/kheap.o
+                0x0000000000103a98                _kmalloc
+ *fill*         0x0000000000103aaf        0x1 00
+ .text          0x0000000000103ab0       0xba system/syscall.o
+                0x0000000000103ab0                sysputch
+                0x0000000000103ad6                syscall_handler
+ *fill*         0x0000000000103b6a        0x2 00
+ .text          0x0000000000103b6c       0xfa hardware/8253.o
+                0x0000000000103c37                sleep
+                0x0000000000103b6c                PIT_handler
+                0x0000000000103bd7                configure_PIT
+ *fill*         0x0000000000103c66        0x2 00
+ .text          0x0000000000103c68      0x2f1 shell/shell.o
+                0x0000000000103cbc                info
+                0x0000000000103e6a                shell
+                0x0000000000103ca6                poweroff
+                0x0000000000103c8f                help
+                0x0000000000103c68                logo
+                0x0000000000104000                . = ALIGN (0x1000)
+ *fill*         0x0000000000103f59       0xa7 00
 
-.rodata         0x0000000000103f1c      0x765
- *(.rodata)
- .rodata        0x0000000000103f1c       0xe2 kernel.o
- .rodata        0x0000000000103ffe       0x70 io/video.o
- .rodata        0x000000000010406e       0x10 drivers/keyboard.o
- .rodata        0x000000000010407e        0x2 libc/stdio.o
- .rodata        0x0000000000104080       0x3e hardware/cpuid.o
- .rodata        0x00000000001040be       0x1d hardware/keyboard.o
- *fill*         0x00000000001040db        0x1 00
- .rodata        0x00000000001040dc      0x23e processore/handlers.o
- *fill*         0x000000000010431a        0x2 00
- .rodata        0x000000000010431c       0x8a mem/fismem.o
- *fill*         0x00000000001043a6        0x2 00
- .rodata        0x00000000001043a8       0x23 mem/paging.o
- *fill*         0x00000000001043cb        0x1 00
- .rodata        0x00000000001043cc        0xc system/syscall.o
- .rodata        0x00000000001043d8      0x2a9 shell/shell.o
-
-.rel.dyn        0x0000000000104684        0x0 load address 0x0000000000104681
+.rel.dyn        0x0000000000104000        0x0
  .rel.text      0x0000000000000000        0x0 bl.img
 
-.data           0x00000000001046a0    0x3376c
+.data           0x0000000000104000     0x1000
+                0x0000000000104000                data = .
+                0x0000000000104000                _data = .
+                0x0000000000104000                __data = .
  *(.data)
- .data          0x00000000001046a0        0x0 kernel.o
- .data          0x00000000001046a0        0x9 io/video.o
-                0x00000000001046a4                VIDEO_PTR
-                0x00000000001046a8                VIDEO_CLR
-                0x00000000001046a0                VIDEO_MEM
- *fill*         0x00000000001046a9       0x17 00
- .data          0x00000000001046c0      0x2f8 drivers/keyboard.o
- .data          0x00000000001049b8        0x0 libc/ctype.o
- .data          0x00000000001049b8        0x0 libc/string.o
- .data          0x00000000001049b8        0x0 io/io.o
- .data          0x00000000001049b8        0x0 libc/stdio.o
- .data          0x00000000001049b8        0x0 hardware/cpuid.o
- .data          0x00000000001049b8        0x0 hardware/keyboard.o
- .data          0x00000000001049b8        0x0 processore/gdt.o
- .data          0x00000000001049b8        0x0 processore/idt.o
- .data          0x00000000001049b8        0x0 processore/handlers.o
- .data          0x00000000001049b8        0x0 hardware/pic8259.o
- .data          0x00000000001049b8        0xc mem/fismem.o
-                0x00000000001049b8                prova2
-                0x00000000001049bc                mem_info_root
-                0x00000000001049c0                mem_info
- .data          0x00000000001049c4        0x0 mem/paging.o
- .data          0x00000000001049c4        0x4 system/syscall.o
-                0x00000000001049c4                syscall_table
- .data          0x00000000001049c8        0x0 hardware/8253.o
- .data          0x00000000001049c8        0x0 shell/shell.o
+ .data          0x0000000000104000        0x0 kernel.o
+ .data          0x0000000000104000        0x9 io/video.o
+                0x0000000000104004                VIDEO_PTR
+                0x0000000000104008                VIDEO_CLR
+                0x0000000000104000                VIDEO_MEM
+ *fill*         0x0000000000104009       0x17 00
+ .data          0x0000000000104020      0x2f8 drivers/keyboard.o
+ .data          0x0000000000104318        0x0 libc/ctype.o
+ .data          0x0000000000104318        0x0 libc/string.o
+ .data          0x0000000000104318        0x0 io/io.o
+ .data          0x0000000000104318        0x0 libc/stdio.o
+ .data          0x0000000000104318        0x0 hardware/cpuid.o
+ .data          0x0000000000104318        0x0 hardware/keyboard.o
+ .data          0x0000000000104318        0x0 processore/gdt.o
+ .data          0x0000000000104318        0x0 processore/idt.o
+ .data          0x0000000000104318        0x0 processore/handlers.o
+ .data          0x0000000000104318        0x0 hardware/pic8259.o
+ .data          0x0000000000104318        0xc mem/fismem.o
+                0x0000000000104318                prova2
+                0x000000000010431c                mem_info_root
+                0x0000000000104320                mem_info
+ .data          0x0000000000104324        0x0 mem/paging.o
+ .data          0x0000000000104324        0x0 mem/kheap.o
+ .data          0x0000000000104324        0x4 system/syscall.o
+                0x0000000000104324                syscall_table
+ .data          0x0000000000104328        0x0 hardware/8253.o
+ .data          0x0000000000104328        0x0 shell/shell.o
+ *(.rodata)
+ .rodata        0x0000000000104328       0xf8 kernel.o
+ .rodata        0x0000000000104420       0x70 io/video.o
+ .rodata        0x0000000000104490       0x10 drivers/keyboard.o
+ .rodata        0x00000000001044a0        0x2 libc/stdio.o
+ .rodata        0x00000000001044a2       0x3e hardware/cpuid.o
+ .rodata        0x00000000001044e0       0x1d hardware/keyboard.o
+ *fill*         0x00000000001044fd        0x3 00
+ .rodata        0x0000000000104500      0x23e processore/handlers.o
+ *fill*         0x000000000010473e        0x2 00
+ .rodata        0x0000000000104740       0x8a mem/fismem.o
+ *fill*         0x00000000001047ca        0x2 00
+ .rodata        0x00000000001047cc       0x23 mem/paging.o
+ *fill*         0x00000000001047ef        0x1 00
+ .rodata        0x00000000001047f0        0xc system/syscall.o
+ .rodata        0x00000000001047fc      0x2a9 shell/shell.o
+                0x0000000000105000                . = ALIGN (0x1000)
+ *fill*         0x0000000000104aa5      0x55b 00
+
+.bss            0x0000000000105000    0x33ff0
+                0x0000000000105000                bss = .
+                0x0000000000105000                _bss = .
+                0x0000000000105000                __bss = .
  *(.bss)
- .bss           0x00000000001049c8        0x0 kernel.o
- .bss           0x00000000001049c8       0x10 io/video.o
-                0x00000000001049cc                is_shifted_once
-                0x00000000001049c8                is_scrolled
-                0x00000000001049d4                resulthex
-                0x00000000001049d0                binlen
- *fill*         0x00000000001049d8        0x8 00
- .bss           0x00000000001049e0      0x434 drivers/keyboard.o
- .bss           0x0000000000104e14        0x0 libc/ctype.o
- .bss           0x0000000000104e14        0x4 libc/string.o
- .bss           0x0000000000104e18        0x0 io/io.o
- .bss           0x0000000000104e18        0x0 libc/stdio.o
- .bss           0x0000000000104e18        0x0 hardware/cpuid.o
- .bss           0x0000000000104e18        0x0 hardware/keyboard.o
- .bss           0x0000000000104e18        0x0 processore/gdt.o
- .bss           0x0000000000104e18        0x0 processore/idt.o
- .bss           0x0000000000104e18        0x0 processore/handlers.o
- .bss           0x0000000000104e18        0x0 hardware/pic8259.o
- .bss           0x0000000000104e18        0x4 mem/fismem.o
-                0x0000000000104e18                num_pages
- .bss           0x0000000000104e1c        0x0 mem/paging.o
- .bss           0x0000000000104e1c        0x0 system/syscall.o
- .bss           0x0000000000104e1c        0x8 hardware/8253.o
- .bss           0x0000000000104e24        0x0 shell/shell.o
- *(COMMON)
- COMMON         0x0000000000104e24       0x10 kernel.o
-                0x0000000000104e24                cpu_vendor
-                0x0000000000104e30                current_page_table
- *fill*         0x0000000000104e34        0xc 00
- COMMON         0x0000000000104e40     0x233c io/video.o
-                0x0000000000104e40                downbuffer
-                0x0000000000105de0                upbuffer
-                0x0000000000106d80                binvp
- *fill*         0x000000000010717c        0x4 00
- COMMON         0x0000000000107180    0x10004 processore/gdt.o
-                0x0000000000107180                Gdt_Table
-                0x0000000000117180                current_pos
- *fill*         0x0000000000117184       0x1c 00
- COMMON         0x00000000001171a0      0xc00 processore/idt.o
-                0x00000000001171a0                IntTable
-                0x00000000001175a0                IDT_Table
- COMMON         0x0000000000117da0       0x40 processore/handlers.o
-                0x0000000000117da0                shareHandler
- COMMON         0x0000000000117de0        0x2 hardware/pic8259.o
-                0x0000000000117de0                slave_cur_mask
-                0x0000000000117de1                master_cur_mask
- *fill*         0x0000000000117de2       0x1e 00
- COMMON         0x0000000000117e00    0x20008 mem/fismem.o
-                0x0000000000117e00                mem_bitmap
-                0x0000000000137e00                tot_mem
-                0x0000000000137e04                bmp_elements
- COMMON         0x0000000000137e08        0x4 mem/paging.o
-                0x0000000000137e08                current_page_dir
-                0x0000000000137e0c                end = .
-                0x0000000000137e0c                _end = .
-                0x0000000000137e0c                __end = .
+ .bss           0x0000000000105000        0x0 kernel.o
+ .bss           0x0000000000105000       0x10 io/video.o
+                0x0000000000105004                is_shifted_once
+                0x0000000000105000                is_scrolled
+                0x000000000010500c                resulthex
+                0x0000000000105008                binlen
+ *fill*         0x0000000000105010       0x10 00
+ .bss           0x0000000000105020      0x434 drivers/keyboard.o
+ .bss           0x0000000000105454        0x0 libc/ctype.o
+ .bss           0x0000000000105454        0x4 libc/string.o
+ .bss           0x0000000000105458        0x0 io/io.o
+ .bss           0x0000000000105458        0x0 libc/stdio.o
+ .bss           0x0000000000105458        0x0 hardware/cpuid.o
+ .bss           0x0000000000105458        0x0 hardware/keyboard.o
+ .bss           0x0000000000105458        0x0 processore/gdt.o
+ .bss           0x0000000000105458        0x0 processore/idt.o
+ .bss           0x0000000000105458        0x0 processore/handlers.o
+ .bss           0x0000000000105458        0x0 hardware/pic8259.o
+ .bss           0x0000000000105458        0x4 mem/fismem.o
+                0x0000000000105458                num_pages
+ .bss           0x000000000010545c        0x0 mem/paging.o
+ .bss           0x000000000010545c        0x0 mem/kheap.o
+ .bss           0x000000000010545c        0x0 system/syscall.o
+ .bss           0x000000000010545c        0x8 hardware/8253.o
+ .bss           0x0000000000105464        0x0 shell/shell.o
+                0x0000000000106000                . = ALIGN (0x1000)
+ *fill*         0x0000000000105464      0xb9c 00
+ COMMON         0x0000000000106000       0x10 kernel.o
+                0x0000000000106000                cpu_vendor
+                0x000000000010600c                current_page_table
+ *fill*         0x0000000000106010       0x10 00
+ COMMON         0x0000000000106020     0x233c io/video.o
+                0x0000000000106020                downbuffer
+                0x0000000000106fc0                upbuffer
+                0x0000000000107f60                binvp
+ *fill*         0x000000000010835c        0x4 00
+ COMMON         0x0000000000108360    0x10004 processore/gdt.o
+                0x0000000000108360                Gdt_Table
+                0x0000000000118360                current_pos
+ *fill*         0x0000000000118364       0x1c 00
+ COMMON         0x0000000000118380      0xc00 processore/idt.o
+                0x0000000000118380                IntTable
+                0x0000000000118780                IDT_Table
+ COMMON         0x0000000000118f80       0x40 processore/handlers.o
+                0x0000000000118f80                shareHandler
+ COMMON         0x0000000000118fc0        0x2 hardware/pic8259.o
+                0x0000000000118fc0                slave_cur_mask
+                0x0000000000118fc1                master_cur_mask
+ *fill*         0x0000000000118fc2       0x1e 00
+ COMMON         0x0000000000118fe0    0x20008 mem/fismem.o
+                0x0000000000118fe0                mem_bitmap
+                0x0000000000138fe0                tot_mem
+                0x0000000000138fe4                bmp_elements
+ COMMON         0x0000000000138fe8        0x4 mem/paging.o
+                0x0000000000138fe8                current_page_dir
+ COMMON         0x0000000000138fec        0x4 mem/kheap.o
+                0x0000000000138fec                address_cur
+                0x0000000000138ff0                end = .
+                0x0000000000138ff0                _end = .
+                0x0000000000138ff0                __end = .
 LOAD bl.img
 LOAD kernel.o
 LOAD io/video.o
@@ -288,13 +310,14 @@
 LOAD hardware/pic8259.o
 LOAD mem/fismem.o
 LOAD mem/paging.o
+LOAD mem/kheap.o
 LOAD system/syscall.o
 LOAD hardware/8253.o
 LOAD shell/shell.o
 Address of section .text set to 0x100000
 OUTPUT(kernel.bin elf32-i386)
 
-.comment        0x0000000000000000      0x229
+.comment        0x0000000000000000      0x246
  .comment       0x0000000000000000       0x1f bl.img
  .comment       0x000000000000001f       0x1d kernel.o
  .comment       0x000000000000003c       0x1d io/video.o
@@ -311,9 +334,10 @@
  .comment       0x000000000000017b       0x1d hardware/pic8259.o
  .comment       0x0000000000000198       0x1d mem/fismem.o
  .comment       0x00000000000001b5       0x1d mem/paging.o
- .comment       0x00000000000001d2       0x1d system/syscall.o
- .comment       0x00000000000001ef       0x1d hardware/8253.o
- .comment       0x000000000000020c       0x1d shell/shell.o
+ .comment       0x00000000000001d2       0x1d mem/kheap.o
+ .comment       0x00000000000001ef       0x1d system/syscall.o
+ .comment       0x000000000000020c       0x1d hardware/8253.o
+ .comment       0x0000000000000229       0x1d shell/shell.o
 
 .note.GNU-stack
                 0x0000000000000000        0x0
@@ -348,6 +372,8 @@
  .note.GNU-stack
                 0x0000000000000000        0x0 mem/paging.o
  .note.GNU-stack
+                0x0000000000000000        0x0 mem/kheap.o
+ .note.GNU-stack
                 0x0000000000000000        0x0 system/syscall.o
  .note.GNU-stack
                 0x0000000000000000        0x0 hardware/8253.o

Added: trunk/mem/kheap.c
===================================================================
--- trunk/mem/kheap.c	2008-07-06 15:19:25 UTC (rev 10)
+++ trunk/mem/kheap.c	2008-07-13 22:03:52 UTC (rev 11)
@@ -0,0 +1,33 @@
+/***************************************************************************
+ *            kheap.c
+ *
+ *  Sat Mar 31 07:47:17 2007
+ *  Copyright  2007  Ivan Gualandri
+ *  Email
+ ****************************************************************************/
+
+/*
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
+
+#include <kernel.h>
+#include <kheap.h>
+#include <paging.h>
+
+unsigned int address_cur;
+
+unsigned int _kmalloc(int size){
+    address_cur+=size;
+}
\ No newline at end of file



From finarfin at mail.berlios.de  Wed Jul 16 23:51:37 2008
From: finarfin at mail.berlios.de (finarfin at BerliOS)
Date: Wed, 16 Jul 2008 23:51:37 +0200
Subject: [Dreamos-dev] r12 - in trunk: . include include/mem include/shell
	mem processore shell system
Message-ID: <200807162151.m6GLpb5D031618@sheep.berlios.de>

Author: finarfin
Date: 2008-07-16 23:51:35 +0200 (Wed, 16 Jul 2008)
New Revision: 12

Modified:
   trunk/Makefile
   trunk/TODO
   trunk/dreamos.img
   trunk/include/mem/kheap.h
   trunk/include/multiboot.h
   trunk/include/shell/shell.h
   trunk/kernel.c
   trunk/kernel.map
   trunk/mem/kheap.c
   trunk/processore/handlers.c
   trunk/shell/shell.c
   trunk/start.sh
   trunk/system/syscall.c
Log:
Aggiunto Header GPL a multiboot.h
Aggiunto comando kmalloc per testare la prima bozza di kmalloc.
Sistemata kmalloc (ora torna un indirizzo)
Aggiunta funzione syscall_init per inizializzare il gestore di syscall
Modificato layout file start.sh
Pulizia codice di Makefile


Modified: trunk/Makefile
===================================================================
--- trunk/Makefile	2008-07-13 22:03:52 UTC (rev 11)
+++ trunk/Makefile	2008-07-16 21:51:35 UTC (rev 12)
@@ -1,4 +1,4 @@
-CFLAGS = -nostdlib -fomit-frame-pointer -fno-builtin -fno-stack-protector -Wall -march=i386 -I./include -I./include/io -I./include/drivers -I./include/libc -I./include/processore -I./include/hardware -I./include/mem -I./include/system -I./include/shell
+CFLAGS = -nostdlib -fomit-frame-pointer -fno-builtin -fno-stack-protector -Wall -march=i686 -I./include -I./include/io -I./include/drivers -I./include/libc -I./include/processore -I./include/hardware -I./include/mem -I./include/system -I./include/shell
 OBJ = kernel.o io/video.o drivers/keyboard.o libc/ctype.o libc/string.o io/io.o libc/stdio.o hardware/cpuid.o hardware/keyboard.o processore/gdt.o processore/idt.o processore/handlers.o hardware/pic8259.o mem/fismem.o mem/paging.o mem/kheap.o system/syscall.o hardware/8253.o shell/shell.o
 
 dreamos.img: bl.img kernel.bin
@@ -12,22 +12,22 @@
 
 kernel.o: kernel.c
 io/video.o: io/video.c
-io/io.o : io/io.c
+io/io.o: io/io.c
 processore/gdt.o: processore/gdt.c
 processore/idt.o: processore/idt.c
 processore/handlers.o: processore/handlers.c
 hardware/pic8259.o: hardware/pic8259.c
 hardware/cpuid.o: hardware/cpuid.c
 hardware/keyboard.o: hardware/keyboard.c
-libc/stdio.o : libc/stdio.c
-libc/ctype.o : libc/ctype.c
-libc/string.o : libc/string.c
-mem/fismem.o : mem/fismem.c
-mem/paging.o : mem/paging.c
-mem/kheap.o : mem/kheap.c
-drivers/keyboard.o : drivers/keyboard.c
-system/syscall.o : system/syscall.c
-hardware/8253.o : hardware/8253.c
+libc/stdio.o: libc/stdio.c
+libc/ctype.o: libc/ctype.c
+libc/string.o: libc/string.c
+mem/fismem.o: mem/fismem.c
+mem/paging.o: mem/paging.c
+mem/kheap.o: mem/kheap.c
+drivers/keyboard.o: drivers/keyboard.c
+system/syscall.o: system/syscall.c
+hardware/8253.o: hardware/8253.c
 
 # Autonomatizzazione aggiornamento file immagine distro
 # Only root

Modified: trunk/TODO
===================================================================
--- trunk/TODO	2008-07-13 22:03:52 UTC (rev 11)
+++ trunk/TODO	2008-07-16 21:51:35 UTC (rev 12)
@@ -12,6 +12,9 @@
 - Todo rivedere quali sono le eccezioni che hanno un error code e sostituire le relative EXCEPTION(xx) con EXCEPTION_EC(xx)
 - Fare una mega pulizia del codice
 - Eliminare il maggior numero di messaggi di errore dalla compilazione
+-Script che memorizza nei sorci il numero di revisione (genera un file header)
+- fare in modo che quando stampa "root#~" se premo backspace non cancelli quella scritta.
+- Comandi: echo - clear
 
 PROGETTI A LUNGO TERMINE:
 - Implementazione di un migliore scrolling

Modified: trunk/dreamos.img
===================================================================
(Binary files differ)

Modified: trunk/include/mem/kheap.h
===================================================================
--- trunk/include/mem/kheap.h	2008-07-13 22:03:52 UTC (rev 11)
+++ trunk/include/mem/kheap.h	2008-07-16 21:51:35 UTC (rev 12)
@@ -27,6 +27,6 @@
 
 extern unsigned int address_cur;
 
-unsigned int _kmalloc(int);
+unsigned int kmalloc(int);
 
 #endif
\ No newline at end of file

Modified: trunk/include/multiboot.h
===================================================================
--- trunk/include/multiboot.h	2008-07-13 22:03:52 UTC (rev 11)
+++ trunk/include/multiboot.h	2008-07-16 21:51:35 UTC (rev 12)
@@ -1,3 +1,17 @@
+/*  DreamOS
+    multiboot.h
+    This file is part of Foobar.
+    Foobar is free software: you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation, either version 3 of the License, or
+    (at your option) any later version.
+    Foobar is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+    GNU General Public License for more details.
+    You should have received a copy of the GNU General Public License
+    along with Foobar.  If not, see <http://www.gnu.org/licenses/>.
+*/
 
  /* Do not include here in boot.S. */
 

Modified: trunk/include/shell/shell.h
===================================================================
--- trunk/include/shell/shell.h	2008-07-13 22:03:52 UTC (rev 11)
+++ trunk/include/shell/shell.h	2008-07-16 21:51:35 UTC (rev 12)
@@ -1,5 +1,5 @@
 /*  DreamOS
-    shell.c
+    shell.h
     This file is part of Foobar.
     Foobar is free software: you can redistribute it and/or modify
     it under the terms of the GNU General Public License as published by

Modified: trunk/kernel.c
===================================================================
--- trunk/kernel.c	2008-07-13 22:03:52 UTC (rev 11)
+++ trunk/kernel.c	2008-07-16 21:51:35 UTC (rev 12)
@@ -53,7 +53,7 @@
 {    
 
     _kclear();
-
+    syscall_init();
     _kcolor('\012');
     _kputs(DREAMOS_VER);
     _kcolor('\007');
@@ -89,7 +89,7 @@
     _kprintOK();
 
     asm ("movl $0, %eax\n"
-     "movl $35, %ebx\n"
+     "movl $37, %ebx\n"
      "int $80");
     printf("\nMemory (upper) amount-> %d kb \n", boot_info->mem_upper);
     get_cpuid();    
@@ -100,8 +100,4 @@
     printf("End: %d Address: 0x%x\n", end, &end);
 
     shell();
-
-/*    if ( (shell()) != NULL)
-    {	printf("[+] Loading compleate!!\n\n\n");	}
-*/
 }

Modified: trunk/kernel.map
===================================================================
--- trunk/kernel.map	2008-07-13 22:03:52 UTC (rev 11)
+++ trunk/kernel.map	2008-07-16 21:51:35 UTC (rev 12)
@@ -16,7 +16,6 @@
 current_page_table  0x4               kernel.o
 master_cur_mask     0x1               hardware/pic8259.o
 bmp_elements        0x4               mem/fismem.o
-address_cur         0x4               mem/kheap.o
 binvp               0x3fc             io/video.o
 shareHandler        0x40              processore/handlers.o
 
@@ -28,7 +27,7 @@
 Linker script and memory map
 
 
-.text           0x0000000000100000     0x4000
+.text           0x0000000000100000     0x5000
                 0x0000000000100000                code = .
                 0x0000000000100000                _code = .
                 0x0000000000100000                __code = .
@@ -37,263 +36,257 @@
                 0x0000000000100000                mboot
                 0x0000000000100020                start
  *fill*         0x0000000000100029        0x3 00
- .text          0x000000000010002c      0x1e3 kernel.o
-                0x0000000000100040                main_loop
+ .text          0x000000000010002c      0x1ae kernel.o
+                0x000000000010003d                main_loop
                 0x000000000010002c                _start
- *fill*         0x000000000010020f        0x1 00
- .text          0x0000000000100210      0x9d1 io/video.o
-                0x0000000000100b66                _kscrolldown
-                0x0000000000100210                _kputc
-                0x0000000000100252                _kputs
-                0x00000000001002ec                _kbackspace
-                0x0000000000100a3b                _krotate_buffer
-                0x0000000000100429                _ksetcursauto
-                0x00000000001002d6                _kcolor
-                0x0000000000100539                _kdecbin
-                0x00000000001003f8                _ksetcursor
-                0x000000000010048b                _kprintOK
-                0x0000000000100302                _ktab
-                0x0000000000100310                _kgoto
-                0x00000000001003a5                _knewline
-                0x0000000000100abc                _kscrollup
-                0x000000000010033e                _kclear
-                0x00000000001004ff                _kgetline
-                0x000000000010087d                _kntos
-                0x00000000001004b5                _kgetcolumn
-                0x0000000000100610                _kntohex
-                0x000000000010096c                _kshiftAll
- *fill*         0x0000000000100be1        0x3 00
- .text          0x0000000000100be4      0x5e4 drivers/keyboard.o
-                0x0000000000101044                _ksetleds
-                0x0000000000101170                _kgetch
-                0x0000000000101157                keyboard_disable
-                0x000000000010113e                keyboard_enable
-                0x0000000000100be4                keyboard_isr
- .text          0x00000000001011c8      0x19a libc/ctype.o
-                0x0000000000101298                islower
-                0x00000000001012e8                tolower
-                0x0000000000101260                isxdigit
-                0x00000000001012c0                isupper
-                0x00000000001011f0                isalpha
-                0x0000000000101226                isalnum
-                0x00000000001011c8                isdigit
-                0x0000000000101325                toupper
- *fill*         0x0000000000101362        0x2 00
- .text          0x0000000000101364      0x2eb libc/string.o
-                0x00000000001014df                strstr
-                0x0000000000101364                strncpy
-                0x000000000010155b                strtok
-                0x00000000001015e5                strncat
-                0x000000000010146e                strdup
-                0x0000000000101438                memset
-                0x00000000001013c4                _kstrncmp
-                0x000000000010139d                strlen
-                0x00000000001014be                strchr
- *fill*         0x000000000010164f        0x1 00
- .text          0x0000000000101650       0x23 io/io.o
-                0x0000000000101650                inportb
-                0x0000000000101669                outportb
- *fill*         0x0000000000101673        0x1 00
- .text          0x0000000000101674      0x632 libc/stdio.o
-                0x0000000000101674                putchar
-                0x000000000010177e                printf
-                0x0000000000101b52                gets
-                0x0000000000101b37                getchar
-                0x0000000000101bc5                scanf
-                0x000000000010168e                atoi
- *fill*         0x0000000000101ca6        0x2 00
- .text          0x0000000000101ca8      0x18c hardware/cpuid.o
-                0x0000000000101ca8                get_cpuid
- .text          0x0000000000101e34       0x67 hardware/keyboard.o
-                0x0000000000101e34                keyboard_irq
- *fill*         0x0000000000101e9b        0x1 00
- .text          0x0000000000101e9c      0x1d0 processore/gdt.o
-                0x0000000000101f78                add_GDTseg
-                0x0000000000101e9c                init_gdt
-                0x0000000000102023                set_gdtr
- .text          0x000000000010206c      0x65d processore/idt.o
-                0x000000000010262d                add_IDTseg
-                0x00000000001023a1                init_idt
-                0x00000000001026a1                set_idtr
- *fill*         0x00000000001026c9        0x3 00
- .text          0x00000000001026cc      0x38d processore/handlers.o
-                0x00000000001026cc                init_funcTable
-                0x00000000001029c4                _irqinterrupt
-                0x000000000010274e                _globalException
-                0x000000000010273e                add_Interrupt
-                0x0000000000102a44                _int_rsv
- *fill*         0x0000000000102a59        0x3 00
- .text          0x0000000000102a5c      0x747 hardware/pic8259.o
-                0x0000000000102c8d                init_IRQ
-                0x0000000000102dc9                setup_IRQ
-                0x0000000000103004                disable_IRQ
-                0x00000000001030e4                add_IRQ_handler
-                0x0000000000102f30                enable_IRQ
-                0x00000000001030b6                get_current_irq
- *fill*         0x00000000001031a3        0x1 00
- .text          0x00000000001031a4      0x628 mem/fismem.o
-                0x00000000001031a4                init_mem
-                0x0000000000103268                request_pages
-                0x0000000000103628                add_memarea_element
-                0x000000000010373e                get_numpages
-                0x0000000000103738                get_memsize
-                0x0000000000103764                malloc
-                0x0000000000103751                get_bmpelements
-                0x00000000001033c3                release_pages
-                0x000000000010371c                calcola_memoria
-                0x00000000001037a2                free
- .text          0x00000000001037cc      0x2ca mem/paging.o
-                0x00000000001038da                create_pageTable
-                0x00000000001037cc                init_paging
-                0x0000000000103a09                get_pagedir_entry
-                0x00000000001038c4                create_pageDir
-                0x0000000000103a50                load_pdbr
-                0x00000000001039b7                set_pagetable_entry_ric
-                0x0000000000103a26                get_pagetable_entry
-                0x00000000001038f0                set_pagedir_entry
-                0x0000000000103931                set_pagedir_entry_ric
-                0x0000000000103976                set_pagetable_entry
- *fill*         0x0000000000103a96        0x2 00
- .text          0x0000000000103a98       0x17 mem/kheap.o
-                0x0000000000103a98                _kmalloc
- *fill*         0x0000000000103aaf        0x1 00
- .text          0x0000000000103ab0       0xba system/syscall.o
-                0x0000000000103ab0                sysputch
-                0x0000000000103ad6                syscall_handler
- *fill*         0x0000000000103b6a        0x2 00
- .text          0x0000000000103b6c       0xfa hardware/8253.o
-                0x0000000000103c37                sleep
-                0x0000000000103b6c                PIT_handler
-                0x0000000000103bd7                configure_PIT
- *fill*         0x0000000000103c66        0x2 00
- .text          0x0000000000103c68      0x2f1 shell/shell.o
-                0x0000000000103cbc                info
-                0x0000000000103e6a                shell
-                0x0000000000103ca6                poweroff
-                0x0000000000103c8f                help
-                0x0000000000103c68                logo
-                0x0000000000104000                . = ALIGN (0x1000)
- *fill*         0x0000000000103f59       0xa7 00
+ *fill*         0x00000000001001da        0x2 00
+ .text          0x00000000001001dc      0xa2c io/video.o
+                0x0000000000100b89                _kscrolldown
+                0x00000000001001dc                _kputc
+                0x0000000000100221                _kputs
+                0x00000000001002bd                _kbackspace
+                0x0000000000100a52                _krotate_buffer
+                0x0000000000100407                _ksetcursauto
+                0x00000000001002a6                _kcolor
+                0x0000000000100545                _kdecbin
+                0x00000000001003d6                _ksetcursor
+                0x0000000000100499                _kprintOK
+                0x00000000001002d3                _ktab
+                0x00000000001002e1                _kgoto
+                0x000000000010037c                _knewline
+                0x0000000000100ad6                _kscrollup
+                0x000000000010030f                _kclear
+                0x000000000010050b                _kgetline
+                0x0000000000100887                _kntos
+                0x00000000001004c1                _kgetcolumn
+                0x000000000010060e                _kntohex
+                0x0000000000100978                _kshiftAll
+ .text          0x0000000000100c08      0x658 drivers/keyboard.o
+                0x00000000001010cb                _ksetleds
+                0x0000000000101206                _kgetch
+                0x00000000001011eb                keyboard_disable
+                0x00000000001011d0                keyboard_enable
+                0x0000000000100c08                keyboard_isr
+ .text          0x0000000000101260      0x1a6 libc/ctype.o
+                0x0000000000101336                islower
+                0x0000000000101386                tolower
+                0x00000000001012fb                isxdigit
+                0x000000000010135e                isupper
+                0x0000000000101288                isalpha
+                0x00000000001012be                isalnum
+                0x0000000000101260                isdigit
+                0x00000000001013c6                toupper
+ *fill*         0x0000000000101406        0x2 00
+ .text          0x0000000000101408      0x318 libc/string.o
+                0x000000000010159a                strstr
+                0x0000000000101408                strncpy
+                0x0000000000101621                strtok
+                0x00000000001016b3                strncat
+                0x0000000000101523                strdup
+                0x00000000001014ec                memset
+                0x000000000010146d                _kstrncmp
+                0x0000000000101443                strlen
+                0x0000000000101576                strchr
+ .text          0x0000000000101720       0x24 io/io.o
+                0x0000000000101720                inportb
+                0x000000000010173a                outportb
+ .text          0x0000000000101744      0x655 libc/stdio.o
+                0x0000000000101744                putchar
+                0x0000000000101853                printf
+                0x0000000000101c43                gets
+                0x0000000000101c28                getchar
+                0x0000000000101cb8                scanf
+                0x000000000010175f                atoi
+ *fill*         0x0000000000101d99        0x3 00
+ .text          0x0000000000101d9c      0x18c hardware/cpuid.o
+                0x0000000000101d9c                get_cpuid
+ .text          0x0000000000101f28       0x61 hardware/keyboard.o
+                0x0000000000101f28                keyboard_irq
+ *fill*         0x0000000000101f89        0x3 00
+ .text          0x0000000000101f8c      0x214 processore/gdt.o
+                0x00000000001020aa                add_GDTseg
+                0x0000000000101f8c                init_gdt
+                0x0000000000102156                set_gdtr
+ .text          0x00000000001021a0      0x790 processore/idt.o
+                0x0000000000102893                add_IDTseg
+                0x00000000001024d5                init_idt
+                0x0000000000102908                set_idtr
+ .text          0x0000000000102930      0x33c processore/handlers.o
+                0x0000000000102930                init_funcTable
+                0x0000000000102bd2                _irqinterrupt
+                0x00000000001029b3                _globalException
+                0x00000000001029a3                add_Interrupt
+                0x0000000000102c5b                _int_rsv
+ .text          0x0000000000102c6c      0x859 hardware/pic8259.o
+                0x0000000000102e9d                init_IRQ
+                0x0000000000102ffb                setup_IRQ
+                0x000000000010331a                disable_IRQ
+                0x00000000001033fc                add_IRQ_handler
+                0x0000000000103242                enable_IRQ
+                0x00000000001033ca                get_current_irq
+ *fill*         0x00000000001034c5        0x3 00
+ .text          0x00000000001034c8      0x610 mem/fismem.o
+                0x00000000001034c8                init_mem
+                0x000000000010358f                request_pages
+                0x000000000010392f                add_memarea_element
+                0x0000000000103a4c                get_numpages
+                0x0000000000103a46                get_memsize
+                0x0000000000103a72                malloc
+                0x0000000000103a5f                get_bmpelements
+                0x00000000001036f1                release_pages
+                0x0000000000103a2a                calcola_memoria
+                0x0000000000103ab5                free
+ .text          0x0000000000103ad8      0x2fd mem/paging.o
+                0x0000000000103c14                create_pageTable
+                0x0000000000103ad8                init_paging
+                0x0000000000103d48                get_pagedir_entry
+                0x0000000000103bf9                create_pageDir
+                0x0000000000103d8f                load_pdbr
+                0x0000000000103cf6                set_pagetable_entry_ric
+                0x0000000000103d65                get_pagetable_entry
+                0x0000000000103c2f                set_pagedir_entry
+                0x0000000000103c70                set_pagedir_entry_ric
+                0x0000000000103cb5                set_pagetable_entry
+ *fill*         0x0000000000103dd5        0x3 00
+ .text          0x0000000000103dd8       0x26 mem/kheap.o
+                0x0000000000103dd8                kmalloc
+ *fill*         0x0000000000103dfe        0x2 00
+ .text          0x0000000000103e00       0xdd system/syscall.o
+                0x0000000000103e22                syscall_init
+                0x0000000000103e00                sysputch
+                0x0000000000103e58                syscall_handler
+ *fill*         0x0000000000103edd        0x3 00
+ .text          0x0000000000103ee0      0x11e hardware/8253.o
+                0x0000000000103fcf                sleep
+                0x0000000000103ee0                PIT_handler
+                0x0000000000103f66                configure_PIT
+ *fill*         0x0000000000103ffe        0x2 00
+ .text          0x0000000000104000      0x3ea shell/shell.o
+                0x0000000000104044                info
+                0x00000000001041d7                shell
+                0x0000000000104032                poweroff
+                0x000000000010401f                help
+                0x0000000000104000                logo
+                0x0000000000105000                . = ALIGN (0x1000)
+ *fill*         0x00000000001043ea      0xc16 00
 
-.rel.dyn        0x0000000000104000        0x0
+.rel.dyn        0x0000000000105000        0x0
  .rel.text      0x0000000000000000        0x0 bl.img
+ .rel.data      0x0000000000000000        0x0 bl.img
 
-.data           0x0000000000104000     0x1000
-                0x0000000000104000                data = .
-                0x0000000000104000                _data = .
-                0x0000000000104000                __data = .
+.data           0x0000000000105000     0x1000
+                0x0000000000105000                data = .
+                0x0000000000105000                _data = .
+                0x0000000000105000                __data = .
  *(.data)
- .data          0x0000000000104000        0x0 kernel.o
- .data          0x0000000000104000        0x9 io/video.o
-                0x0000000000104004                VIDEO_PTR
-                0x0000000000104008                VIDEO_CLR
-                0x0000000000104000                VIDEO_MEM
- *fill*         0x0000000000104009       0x17 00
- .data          0x0000000000104020      0x2f8 drivers/keyboard.o
- .data          0x0000000000104318        0x0 libc/ctype.o
- .data          0x0000000000104318        0x0 libc/string.o
- .data          0x0000000000104318        0x0 io/io.o
- .data          0x0000000000104318        0x0 libc/stdio.o
- .data          0x0000000000104318        0x0 hardware/cpuid.o
- .data          0x0000000000104318        0x0 hardware/keyboard.o
- .data          0x0000000000104318        0x0 processore/gdt.o
- .data          0x0000000000104318        0x0 processore/idt.o
- .data          0x0000000000104318        0x0 processore/handlers.o
- .data          0x0000000000104318        0x0 hardware/pic8259.o
- .data          0x0000000000104318        0xc mem/fismem.o
-                0x0000000000104318                prova2
-                0x000000000010431c                mem_info_root
-                0x0000000000104320                mem_info
- .data          0x0000000000104324        0x0 mem/paging.o
- .data          0x0000000000104324        0x0 mem/kheap.o
- .data          0x0000000000104324        0x4 system/syscall.o
-                0x0000000000104324                syscall_table
- .data          0x0000000000104328        0x0 hardware/8253.o
- .data          0x0000000000104328        0x0 shell/shell.o
+ .data          0x0000000000105000        0x0 kernel.o
+ .data          0x0000000000105000        0x9 io/video.o
+                0x0000000000105004                VIDEO_PTR
+                0x0000000000105008                VIDEO_CLR
+                0x0000000000105000                VIDEO_MEM
+ *fill*         0x0000000000105009       0x17 00
+ .data          0x0000000000105020      0x2f8 drivers/keyboard.o
+ .data          0x0000000000105318        0x0 libc/ctype.o
+ .data          0x0000000000105318        0x0 libc/string.o
+ .data          0x0000000000105318        0x0 io/io.o
+ .data          0x0000000000105318        0x0 libc/stdio.o
+ .data          0x0000000000105318        0x0 hardware/cpuid.o
+ .data          0x0000000000105318        0x0 hardware/keyboard.o
+ .data          0x0000000000105318        0x0 processore/gdt.o
+ .data          0x0000000000105318        0x0 processore/idt.o
+ .data          0x0000000000105318        0x0 processore/handlers.o
+ .data          0x0000000000105318        0x0 hardware/pic8259.o
+ .data          0x0000000000105318        0xc mem/fismem.o
+                0x0000000000105318                prova2
+                0x000000000010531c                mem_info_root
+                0x0000000000105320                mem_info
+ .data          0x0000000000105324        0x0 mem/paging.o
+ .data          0x0000000000105324        0x4 mem/kheap.o
+                0x0000000000105324                address_cur
+ .data          0x0000000000105328        0x4 system/syscall.o
+                0x0000000000105328                syscall_table
+ .data          0x000000000010532c        0x0 hardware/8253.o
+ .data          0x000000000010532c        0x0 shell/shell.o
  *(.rodata)
- .rodata        0x0000000000104328       0xf8 kernel.o
- .rodata        0x0000000000104420       0x70 io/video.o
- .rodata        0x0000000000104490       0x10 drivers/keyboard.o
- .rodata        0x00000000001044a0        0x2 libc/stdio.o
- .rodata        0x00000000001044a2       0x3e hardware/cpuid.o
- .rodata        0x00000000001044e0       0x1d hardware/keyboard.o
- *fill*         0x00000000001044fd        0x3 00
- .rodata        0x0000000000104500      0x23e processore/handlers.o
- *fill*         0x000000000010473e        0x2 00
- .rodata        0x0000000000104740       0x8a mem/fismem.o
- *fill*         0x00000000001047ca        0x2 00
- .rodata        0x00000000001047cc       0x23 mem/paging.o
- *fill*         0x00000000001047ef        0x1 00
- .rodata        0x00000000001047f0        0xc system/syscall.o
- .rodata        0x00000000001047fc      0x2a9 shell/shell.o
-                0x0000000000105000                . = ALIGN (0x1000)
- *fill*         0x0000000000104aa5      0x55b 00
+ .rodata        0x000000000010532c       0xf8 kernel.o
+ .rodata        0x0000000000105424       0x5f io/video.o
+ .rodata        0x0000000000105483       0x10 drivers/keyboard.o
+ .rodata        0x0000000000105493        0x2 libc/stdio.o
+ .rodata        0x0000000000105495       0x3e hardware/cpuid.o
+ .rodata        0x00000000001054d3       0x1d hardware/keyboard.o
+ .rodata        0x00000000001054f0      0x23e processore/handlers.o
+ *fill*         0x000000000010572e        0x2 00
+ .rodata        0x0000000000105730       0x8a mem/fismem.o
+ *fill*         0x00000000001057ba        0x2 00
+ .rodata        0x00000000001057bc       0x23 mem/paging.o
+ *fill*         0x00000000001057df        0x1 00
+ .rodata        0x00000000001057e0      0x31a shell/shell.o
+                0x0000000000106000                . = ALIGN (0x1000)
+ *fill*         0x0000000000105afa      0x506 00
 
-.bss            0x0000000000105000    0x33ff0
-                0x0000000000105000                bss = .
-                0x0000000000105000                _bss = .
-                0x0000000000105000                __bss = .
+.bss            0x0000000000106000    0x33fec
+                0x0000000000106000                bss = .
+                0x0000000000106000                _bss = .
+                0x0000000000106000                __bss = .
  *(.bss)
- .bss           0x0000000000105000        0x0 kernel.o
- .bss           0x0000000000105000       0x10 io/video.o
-                0x0000000000105004                is_shifted_once
-                0x0000000000105000                is_scrolled
-                0x000000000010500c                resulthex
-                0x0000000000105008                binlen
- *fill*         0x0000000000105010       0x10 00
- .bss           0x0000000000105020      0x434 drivers/keyboard.o
- .bss           0x0000000000105454        0x0 libc/ctype.o
- .bss           0x0000000000105454        0x4 libc/string.o
- .bss           0x0000000000105458        0x0 io/io.o
- .bss           0x0000000000105458        0x0 libc/stdio.o
- .bss           0x0000000000105458        0x0 hardware/cpuid.o
- .bss           0x0000000000105458        0x0 hardware/keyboard.o
- .bss           0x0000000000105458        0x0 processore/gdt.o
- .bss           0x0000000000105458        0x0 processore/idt.o
- .bss           0x0000000000105458        0x0 processore/handlers.o
- .bss           0x0000000000105458        0x0 hardware/pic8259.o
- .bss           0x0000000000105458        0x4 mem/fismem.o
-                0x0000000000105458                num_pages
- .bss           0x000000000010545c        0x0 mem/paging.o
- .bss           0x000000000010545c        0x0 mem/kheap.o
- .bss           0x000000000010545c        0x0 system/syscall.o
- .bss           0x000000000010545c        0x8 hardware/8253.o
- .bss           0x0000000000105464        0x0 shell/shell.o
-                0x0000000000106000                . = ALIGN (0x1000)
- *fill*         0x0000000000105464      0xb9c 00
- COMMON         0x0000000000106000       0x10 kernel.o
-                0x0000000000106000                cpu_vendor
-                0x000000000010600c                current_page_table
+ .bss           0x0000000000106000        0x0 kernel.o
+ .bss           0x0000000000106000       0x10 io/video.o
+                0x0000000000106004                is_shifted_once
+                0x0000000000106000                is_scrolled
+                0x000000000010600c                resulthex
+                0x0000000000106008                binlen
  *fill*         0x0000000000106010       0x10 00
- COMMON         0x0000000000106020     0x233c io/video.o
-                0x0000000000106020                downbuffer
-                0x0000000000106fc0                upbuffer
-                0x0000000000107f60                binvp
- *fill*         0x000000000010835c        0x4 00
- COMMON         0x0000000000108360    0x10004 processore/gdt.o
-                0x0000000000108360                Gdt_Table
-                0x0000000000118360                current_pos
- *fill*         0x0000000000118364       0x1c 00
- COMMON         0x0000000000118380      0xc00 processore/idt.o
-                0x0000000000118380                IntTable
-                0x0000000000118780                IDT_Table
- COMMON         0x0000000000118f80       0x40 processore/handlers.o
-                0x0000000000118f80                shareHandler
- COMMON         0x0000000000118fc0        0x2 hardware/pic8259.o
-                0x0000000000118fc0                slave_cur_mask
-                0x0000000000118fc1                master_cur_mask
- *fill*         0x0000000000118fc2       0x1e 00
- COMMON         0x0000000000118fe0    0x20008 mem/fismem.o
-                0x0000000000118fe0                mem_bitmap
-                0x0000000000138fe0                tot_mem
-                0x0000000000138fe4                bmp_elements
- COMMON         0x0000000000138fe8        0x4 mem/paging.o
-                0x0000000000138fe8                current_page_dir
- COMMON         0x0000000000138fec        0x4 mem/kheap.o
-                0x0000000000138fec                address_cur
-                0x0000000000138ff0                end = .
-                0x0000000000138ff0                _end = .
-                0x0000000000138ff0                __end = .
+ .bss           0x0000000000106020      0x434 drivers/keyboard.o
+ .bss           0x0000000000106454        0x0 libc/ctype.o
+ .bss           0x0000000000106454        0x4 libc/string.o
+ .bss           0x0000000000106458        0x0 io/io.o
+ .bss           0x0000000000106458        0x0 libc/stdio.o
+ .bss           0x0000000000106458        0x0 hardware/cpuid.o
+ .bss           0x0000000000106458        0x0 hardware/keyboard.o
+ .bss           0x0000000000106458        0x0 processore/gdt.o
+ .bss           0x0000000000106458        0x0 processore/idt.o
+ .bss           0x0000000000106458        0x0 processore/handlers.o
+ .bss           0x0000000000106458        0x0 hardware/pic8259.o
+ .bss           0x0000000000106458        0x4 mem/fismem.o
+                0x0000000000106458                num_pages
+ .bss           0x000000000010645c        0x0 mem/paging.o
+ .bss           0x000000000010645c        0x0 mem/kheap.o
+ .bss           0x000000000010645c        0x0 system/syscall.o
+ .bss           0x000000000010645c        0x8 hardware/8253.o
+ .bss           0x0000000000106464        0x0 shell/shell.o
+                0x0000000000107000                . = ALIGN (0x1000)
+ *fill*         0x0000000000106464      0xb9c 00
+ COMMON         0x0000000000107000       0x10 kernel.o
+                0x0000000000107000                cpu_vendor
+                0x000000000010700c                current_page_table
+ *fill*         0x0000000000107010       0x10 00
+ COMMON         0x0000000000107020     0x233c io/video.o
+                0x0000000000107020                downbuffer
+                0x0000000000107fc0                upbuffer
+                0x0000000000108f60                binvp
+ *fill*         0x000000000010935c        0x4 00
+ COMMON         0x0000000000109360    0x10004 processore/gdt.o
+                0x0000000000109360                Gdt_Table
+                0x0000000000119360                current_pos
+ *fill*         0x0000000000119364       0x1c 00
+ COMMON         0x0000000000119380      0xc00 processore/idt.o
+                0x0000000000119380                IntTable
+                0x0000000000119780                IDT_Table
+ COMMON         0x0000000000119f80       0x40 processore/handlers.o
+                0x0000000000119f80                shareHandler
+ COMMON         0x0000000000119fc0        0x2 hardware/pic8259.o
+                0x0000000000119fc0                slave_cur_mask
+                0x0000000000119fc1                master_cur_mask
+ *fill*         0x0000000000119fc2       0x1e 00
+ COMMON         0x0000000000119fe0    0x20008 mem/fismem.o
+                0x0000000000119fe0                mem_bitmap
+                0x0000000000139fe0                tot_mem
+                0x0000000000139fe4                bmp_elements
+ COMMON         0x0000000000139fe8        0x4 mem/paging.o
+                0x0000000000139fe8                current_page_dir
+                0x0000000000139fec                end = .
+                0x0000000000139fec                _end = .
+                0x0000000000139fec                __end = .
 LOAD bl.img
 LOAD kernel.o
 LOAD io/video.o

Modified: trunk/mem/kheap.c
===================================================================
--- trunk/mem/kheap.c	2008-07-13 22:03:52 UTC (rev 11)
+++ trunk/mem/kheap.c	2008-07-16 21:51:35 UTC (rev 12)
@@ -26,8 +26,13 @@
 #include <kheap.h>
 #include <paging.h>
 
-unsigned int address_cur;
+extern unsigned int end;
+unsigned int address_cur = (unsigned int) &end;
 
-unsigned int _kmalloc(int size){
+unsigned int kmalloc(int size){
+    int temp;
+    
+    temp = address_cur;
     address_cur+=size;
+    return temp;
 }
\ No newline at end of file

Modified: trunk/processore/handlers.c
===================================================================
--- trunk/processore/handlers.c	2008-07-13 22:03:52 UTC (rev 11)
+++ trunk/processore/handlers.c	2008-07-16 21:51:35 UTC (rev 12)
@@ -86,7 +86,7 @@
     else if(n==PAGE_FAULT) {
         unsigned int fault_addr;
         asm ("movl %%cr2, %0":"=r" (fault_addr));    
-        printf("Page Fault Exception- Fault address is: %d error code: %d\n", fault_addr,error);        
+        printf("Page Fault Exception- Fault address is: %d error code: %d\n", fault_addr,error);    
     }
     else if(n==INT_RSV) _kputs("Intel Reserved\n");
     else if(n==FLOATING_POINT_ERR) _kputs("Floating Point Exception\n");

Modified: trunk/shell/shell.c
===================================================================
--- trunk/shell/shell.c	2008-07-13 22:03:52 UTC (rev 11)
+++ trunk/shell/shell.c	2008-07-16 21:51:35 UTC (rev 12)
@@ -35,6 +35,7 @@
 #include <paging.h>
 #include <use.h>
 #include <shell.h>
+#include <kheap.h>
 
 void logo()
 {
@@ -50,6 +51,7 @@
 	printf("help     - See the 'help' list to learn the DreamOS command now avaible\n"
 	       "poweroff - Turn off the machine\n"
 	       "info     - See the system info about Memory and other staffs like that\n"
+           "kmalloc  - Test a basic kmalloc function\n"
 		);
 }
 
@@ -101,7 +103,7 @@
 	        scanf("%s",cmd);
 		if (!(_kstrncmp(cmd,"help",4) ) )
 		{
-			printf("Avaible command: \n");
+			printf("Available command: \n");
 			help();
 			cmd[a]=NULL;
 		}
@@ -118,7 +120,28 @@
 			info();
 			cmd[a]=NULL;
 		}
-		
+		else if (!(_kstrncmp(cmd,"answer",4)))
+        {
+            printf("42\n");
+            cmd[a]=NULL;
+        }
+        else if (!(_kstrncmp(cmd,"kmalloc",4)))
+        {
+            printf("kmalloc try: ...\n");
+            int *a;
+            a = kmalloc(10*sizeof(int));
+            int i = 0;
+            while(i<10){
+                a[i] = i*2;
+                i++;
+            }
+            i=0;
+            while(i<10) {
+                printf("a[%d] = %d\n",i, a[i]);
+                i++;
+            }
+            printf("Address of a: %d\n", a);
+        }
 	}
 
 }

Modified: trunk/start.sh
===================================================================
--- trunk/start.sh	2008-07-13 22:03:52 UTC (rev 11)
+++ trunk/start.sh	2008-07-16 21:51:35 UTC (rev 12)
@@ -1 +1,4 @@
-make clean && make && make img && qemu -fda boot/grub.img
+make clean 
+make 
+make img 
+qemu -fda boot/grub.img

Modified: trunk/system/syscall.c
===================================================================
--- trunk/system/syscall.c	2008-07-13 22:03:52 UTC (rev 11)
+++ trunk/system/syscall.c	2008-07-16 21:51:35 UTC (rev 12)
@@ -38,9 +38,17 @@
     _kputs (s);
 }
 
+void syscall_init(){
+    int i=0;
+    while(i<SYSCALL_NUMBER){
+        syscall_table[i]=0;
+        i++;
+    }
+    syscall_table[0] = sysputch;
+}
+
 /*
  * Gestore principale
- * DA CORREGGERE: Non riesco a pushare i registri perch? mi sballa i valori
  */
 void syscall_handler()
 {
@@ -57,8 +65,7 @@
      arguments[0] = ebx;
      arguments[1] = ecx;
      arguments[2] = edx;
-     
-//      (*syscall_table[eax])(arguments);
-    sysputch(arguments);
+         
+     (*syscall_table[eax])(arguments);
 }
 



From finarfin at mail.berlios.de  Thu Jul 17 23:31:22 2008
From: finarfin at mail.berlios.de (finarfin at BerliOS)
Date: Thu, 17 Jul 2008 23:31:22 +0200
Subject: [Dreamos-dev] r13 - in trunk: . include/mem include/shell mem shell
Message-ID: <200807172131.m6HLVMN8013781@sheep.berlios.de>

Author: finarfin
Date: 2008-07-17 23:31:21 +0200 (Thu, 17 Jul 2008)
New Revision: 13

Modified:
   trunk/Makefile
   trunk/TODO
   trunk/dreamos.img
   trunk/include/mem/kheap.h
   trunk/include/shell/shell.h
   trunk/kernel.map
   trunk/mem/kheap.c
   trunk/shell/shell.c
Log:
Aggiunto un parametro di compilazione al Makefile
Aggiunto comando do_fault per testare i fault in scrittura.
Corretto un errore sull'header della licenza in shell.h
Aggiunte le prime strutture dati utili per la gestione della memoria dinamica.
Modificata funzione kmalloc (il return value ora e' quello corretto). Anche se entro le 
prossime revisioni verra riscritta completamente.


Modified: trunk/Makefile
===================================================================
--- trunk/Makefile	2008-07-16 21:51:35 UTC (rev 12)
+++ trunk/Makefile	2008-07-17 21:31:21 UTC (rev 13)
@@ -1,4 +1,4 @@
-CFLAGS = -nostdlib -fomit-frame-pointer -fno-builtin -fno-stack-protector -Wall -march=i686 -I./include -I./include/io -I./include/drivers -I./include/libc -I./include/processore -I./include/hardware -I./include/mem -I./include/system -I./include/shell
+CFLAGS = -nostdlib -fomit-frame-pointer -fno-builtin -fno-stack-protector -Wall -march=i686 -m32 -I./include -I./include/io -I./include/drivers -I./include/libc -I./include/processore -I./include/hardware -I./include/mem -I./include/system -I./include/shell
 OBJ = kernel.o io/video.o drivers/keyboard.o libc/ctype.o libc/string.o io/io.o libc/stdio.o hardware/cpuid.o hardware/keyboard.o processore/gdt.o processore/idt.o processore/handlers.o hardware/pic8259.o mem/fismem.o mem/paging.o mem/kheap.o system/syscall.o hardware/8253.o shell/shell.o
 
 dreamos.img: bl.img kernel.bin
@@ -28,6 +28,7 @@
 drivers/keyboard.o: drivers/keyboard.c
 system/syscall.o: system/syscall.c
 hardware/8253.o: hardware/8253.c
+shell/shell.o: shell/shell.c
 
 # Autonomatizzazione aggiornamento file immagine distro
 # Only root

Modified: trunk/TODO
===================================================================
--- trunk/TODO	2008-07-16 21:51:35 UTC (rev 12)
+++ trunk/TODO	2008-07-17 21:31:21 UTC (rev 13)
@@ -12,9 +12,11 @@
 - Todo rivedere quali sono le eccezioni che hanno un error code e sostituire le relative EXCEPTION(xx) con EXCEPTION_EC(xx)
 - Fare una mega pulizia del codice
 - Eliminare il maggior numero di messaggi di errore dalla compilazione
--Script che memorizza nei sorci il numero di revisione (genera un file header)
+- Script che memorizza nei sorci il numero di revisione (genera un file header)
 - fare in modo che quando stampa "root#~" se premo backspace non cancelli quella scritta.
 - Comandi: echo - clear
+- bitmasks per interpretare errori del pagefault.
+- Makefile -m32 da aggiungere?
 
 PROGETTI A LUNGO TERMINE:
 - Implementazione di un migliore scrolling

Modified: trunk/dreamos.img
===================================================================
(Binary files differ)

Modified: trunk/include/mem/kheap.h
===================================================================
--- trunk/include/mem/kheap.h	2008-07-16 21:51:35 UTC (rev 12)
+++ trunk/include/mem/kheap.h	2008-07-17 21:31:21 UTC (rev 13)
@@ -27,6 +27,22 @@
 
 extern unsigned int address_cur;
 
-unsigned int kmalloc(int);
+typedef struct{
+    unsigned int magic;
+    unsigned int hole;
+    unsigned int size;
+} header_t;
 
+typedef struct{
+    unsigned int magic;
+    unsigned int *header;
+} footer_t;
+
+void* kmalloc(unsigned int);
+void kfree(unsigned int);
+
+void *alloc(unsigned int);
+// void free(unsigned int);
+
+
 #endif
\ No newline at end of file

Modified: trunk/include/shell/shell.h
===================================================================
--- trunk/include/shell/shell.h	2008-07-16 21:51:35 UTC (rev 12)
+++ trunk/include/shell/shell.h	2008-07-17 21:31:21 UTC (rev 13)
@@ -1,6 +1,6 @@
 /*  DreamOS
     shell.h
-    This file is part of Foobar.
+    This file is part of DreamOS.
     Foobar is free software: you can redistribute it and/or modify
     it under the terms of the GNU General Public License as published by
     the Free Software Foundation, either version 3 of the License, or

Modified: trunk/kernel.map
===================================================================
--- trunk/kernel.map	2008-07-16 21:51:35 UTC (rev 12)
+++ trunk/kernel.map	2008-07-17 21:31:21 UTC (rev 13)
@@ -148,27 +148,27 @@
                 0x0000000000103c70                set_pagedir_entry_ric
                 0x0000000000103cb5                set_pagetable_entry
  *fill*         0x0000000000103dd5        0x3 00
- .text          0x0000000000103dd8       0x26 mem/kheap.o
+ .text          0x0000000000103dd8       0x22 mem/kheap.o
                 0x0000000000103dd8                kmalloc
- *fill*         0x0000000000103dfe        0x2 00
- .text          0x0000000000103e00       0xdd system/syscall.o
-                0x0000000000103e22                syscall_init
-                0x0000000000103e00                sysputch
-                0x0000000000103e58                syscall_handler
- *fill*         0x0000000000103edd        0x3 00
- .text          0x0000000000103ee0      0x11e hardware/8253.o
-                0x0000000000103fcf                sleep
-                0x0000000000103ee0                PIT_handler
-                0x0000000000103f66                configure_PIT
- *fill*         0x0000000000103ffe        0x2 00
- .text          0x0000000000104000      0x3ea shell/shell.o
-                0x0000000000104044                info
-                0x00000000001041d7                shell
-                0x0000000000104032                poweroff
-                0x000000000010401f                help
-                0x0000000000104000                logo
+ *fill*         0x0000000000103dfa        0x2 00
+ .text          0x0000000000103dfc       0xdd system/syscall.o
+                0x0000000000103e1e                syscall_init
+                0x0000000000103dfc                sysputch
+                0x0000000000103e54                syscall_handler
+ *fill*         0x0000000000103ed9        0x3 00
+ .text          0x0000000000103edc      0x11e hardware/8253.o
+                0x0000000000103fcb                sleep
+                0x0000000000103edc                PIT_handler
+                0x0000000000103f62                configure_PIT
+ *fill*         0x0000000000103ffa        0x2 00
+ .text          0x0000000000103ffc      0x440 shell/shell.o
+                0x0000000000104040                info
+                0x00000000001041d3                shell
+                0x000000000010402e                poweroff
+                0x000000000010401b                help
+                0x0000000000103ffc                logo
                 0x0000000000105000                . = ALIGN (0x1000)
- *fill*         0x00000000001043ea      0xc16 00
+ *fill*         0x000000000010443c      0xbc4 00
 
 .rel.dyn        0x0000000000105000        0x0
  .rel.text      0x0000000000000000        0x0 bl.img
@@ -220,9 +220,9 @@
  *fill*         0x00000000001057ba        0x2 00
  .rodata        0x00000000001057bc       0x23 mem/paging.o
  *fill*         0x00000000001057df        0x1 00
- .rodata        0x00000000001057e0      0x31a shell/shell.o
+ .rodata        0x00000000001057e0      0x35b shell/shell.o
                 0x0000000000106000                . = ALIGN (0x1000)
- *fill*         0x0000000000105afa      0x506 00
+ *fill*         0x0000000000105b3b      0x4c5 00
 
 .bss            0x0000000000106000    0x33fec
                 0x0000000000106000                bss = .

Modified: trunk/mem/kheap.c
===================================================================
--- trunk/mem/kheap.c	2008-07-16 21:51:35 UTC (rev 12)
+++ trunk/mem/kheap.c	2008-07-17 21:31:21 UTC (rev 13)
@@ -22,14 +22,13 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-#include <kernel.h>
 #include <kheap.h>
 #include <paging.h>
 
 extern unsigned int end;
 unsigned int address_cur = (unsigned int) &end;
 
-unsigned int kmalloc(int size){
+void* kmalloc(unsigned int size){
     int temp;
     
     temp = address_cur;

Modified: trunk/shell/shell.c
===================================================================
--- trunk/shell/shell.c	2008-07-16 21:51:35 UTC (rev 12)
+++ trunk/shell/shell.c	2008-07-17 21:31:21 UTC (rev 13)
@@ -1,6 +1,6 @@
 /*  DreamOS
     shell.c
-    This file is part of Foobar.
+    This file is part of DreamOSr.
     Foobar is free software: you can redistribute it and/or modify
     it under the terms of the GNU General Public License as published by
     the Free Software Foundation, either version 3 of the License, or
@@ -52,6 +52,7 @@
 	       "poweroff - Turn off the machine\n"
 	       "info     - See the system info about Memory and other staffs like that\n"
            "kmalloc  - Test a basic kmalloc function\n"
+           "do_fault - Test a page_fault (WARNING: This hang the OS)\n"
 		);
 }
 
@@ -120,28 +121,35 @@
 			info();
 			cmd[a]=NULL;
 		}
-		else if (!(_kstrncmp(cmd,"answer",4)))
+		else if (!(_kstrncmp(cmd,"answer",6)))
         {
             printf("42\n");
             cmd[a]=NULL;
         }
-        else if (!(_kstrncmp(cmd,"kmalloc",4)))
+        else if (!(_kstrncmp(cmd,"kmalloc",7)))
         {
             printf("kmalloc try: ...\n");
-            int *a;
-            a = kmalloc(10*sizeof(int));
+            int *b;
+            b = (int) kmalloc(10*sizeof(int));
             int i = 0;
             while(i<10){
-                a[i] = i*2;
+                b[i] = i*2;
                 i++;
             }
             i=0;
             while(i<10) {
-                printf("a[%d] = %d\n",i, a[i]);
+                printf("b[%d] = %d\n",i, b[i]);
                 i++;
             }
-            printf("Address of a: %d\n", a);
+            printf("Address of a: %d\n", b);
+            cmd[a]=NULL;
         }
+        else if (!(_kstrncmp(cmd,"do_fault",8))){  
+            char *prova;
+            prova = 0xa0000000;
+            *prova = 10;
+cmd[a]=NULL;
+        }
 	}
 
 }



From finarfin at mail.berlios.de  Sat Jul 26 21:54:25 2008
From: finarfin at mail.berlios.de (finarfin at BerliOS)
Date: Sat, 26 Jul 2008 21:54:25 +0200
Subject: [Dreamos-dev] r14 - in trunk: . include include/mem include/misc
	mem misc
Message-ID: <200807261954.m6QJsPVE025306@sheep.berlios.de>

Author: finarfin
Date: 2008-07-26 21:54:23 +0200 (Sat, 26 Jul 2008)
New Revision: 14

Added:
   trunk/include/misc/
   trunk/include/misc/ordered_array.h
   trunk/misc/
   trunk/misc/ordered_array.c
Modified:
   trunk/Makefile
   trunk/TODO
   trunk/dreamos.img
   trunk/include/mem/kheap.h
   trunk/kernel.c
   trunk/kernel.map
   trunk/mem/kheap.c
   trunk/mem/paging.c
Log:
Aggiunte cartelle misc/ e include/misc/
Aggiunti files ordered_array.h e ordered_array.c
Modificato file kheap.h 
Aggiornato il Makefile per compilare il file ordered_array.c


Modified: trunk/Makefile
===================================================================
--- trunk/Makefile	2008-07-17 21:31:21 UTC (rev 13)
+++ trunk/Makefile	2008-07-26 19:54:23 UTC (rev 14)
@@ -1,5 +1,5 @@
-CFLAGS = -nostdlib -fomit-frame-pointer -fno-builtin -fno-stack-protector -Wall -march=i686 -m32 -I./include -I./include/io -I./include/drivers -I./include/libc -I./include/processore -I./include/hardware -I./include/mem -I./include/system -I./include/shell
-OBJ = kernel.o io/video.o drivers/keyboard.o libc/ctype.o libc/string.o io/io.o libc/stdio.o hardware/cpuid.o hardware/keyboard.o processore/gdt.o processore/idt.o processore/handlers.o hardware/pic8259.o mem/fismem.o mem/paging.o mem/kheap.o system/syscall.o hardware/8253.o shell/shell.o
+CFLAGS = -nostdlib -fomit-frame-pointer -fno-builtin -fno-stack-protector -Wall -march=i686 -m32 -I./include -I./include/io -I./include/drivers -I./include/libc -I./include/processore -I./include/hardware -I./include/mem -I./include/system -I./include/shell -I./include/misc
+OBJ = kernel.o io/video.o drivers/keyboard.o libc/ctype.o libc/string.o io/io.o libc/stdio.o hardware/cpuid.o hardware/keyboard.o processore/gdt.o processore/idt.o processore/handlers.o hardware/pic8259.o mem/fismem.o mem/paging.o mem/kheap.o misc/ordered_array.o system/syscall.o hardware/8253.o shell/shell.o
 
 dreamos.img: bl.img kernel.bin
 	mv kernel.bin dreamos.img
@@ -25,6 +25,7 @@
 mem/fismem.o: mem/fismem.c
 mem/paging.o: mem/paging.c
 mem/kheap.o: mem/kheap.c
+misc/ordered_array.o: misc/ordered_array.c
 drivers/keyboard.o: drivers/keyboard.c
 system/syscall.o: system/syscall.c
 hardware/8253.o: hardware/8253.c

Modified: trunk/TODO
===================================================================
--- trunk/TODO	2008-07-17 21:31:21 UTC (rev 13)
+++ trunk/TODO	2008-07-26 19:54:23 UTC (rev 14)
@@ -16,7 +16,9 @@
 - fare in modo che quando stampa "root#~" se premo backspace non cancelli quella scritta.
 - Comandi: echo - clear
 - bitmasks per interpretare errori del pagefault.
-- Makefile -m32 da aggiungere?
+- Rivedere il comando info della shell, probabilmente stampa alcune informazioni sbagliate
+- Script per generare automaticamente il file immagine grub.img
 
+
 PROGETTI A LUNGO TERMINE:
 - Implementazione di un migliore scrolling

Modified: trunk/dreamos.img
===================================================================
(Binary files differ)

Modified: trunk/include/mem/kheap.h
===================================================================
--- trunk/include/mem/kheap.h	2008-07-17 21:31:21 UTC (rev 13)
+++ trunk/include/mem/kheap.h	2008-07-26 19:54:23 UTC (rev 14)
@@ -1,8 +1,8 @@
 /***************************************************************************
  *            kheap.h
  *
- *  Sat Mar 31 07:47:17 2007
- *  Copyright  2007  Ivan Gualandri
+ *  Sun 18 07 08 07:47:17 2007
+ *  Copyright  2008  Ivan Gualandri
  *  Email
  ****************************************************************************/
 
@@ -25,6 +25,7 @@
 #ifndef KHEAP_H
 #define KHEAP_H
 
+#include <ordered_array.h>
 extern unsigned int address_cur;
 
 typedef struct{
@@ -38,11 +39,22 @@
     unsigned int *header;
 } footer_t;
 
+/*!  \struct heap_t
+     \brief Struttura dati che mantiene le informazioni su un singolo heap
+ */
+typedef struct{
+    ordered_array_t hole_index; /**< La lista degli holes controllare il tipo*/
+    unsigned int start_address; /**< L'indirizzo di partenza dell'heap*/
+    unsigned int end_address; /**< Fino a dove arriva l'heap attualmente*/
+    unsigned int max_size; /**< quanto massimo si puo' espandere*/
+} heap_t;
+
+heap_t* make_heap(unsigned int, unsigned int, unsigned int); //Rivedere il return value
 void* kmalloc(unsigned int);
 void kfree(unsigned int);
 
-void *alloc(unsigned int);
-// void free(unsigned int);
+void* alloc(unsigned int);
 
 
+
 #endif
\ No newline at end of file

Added: trunk/include/misc/ordered_array.h
===================================================================
--- trunk/include/misc/ordered_array.h	2008-07-17 21:31:21 UTC (rev 13)
+++ trunk/include/misc/ordered_array.h	2008-07-26 19:54:23 UTC (rev 14)
@@ -0,0 +1,44 @@
+/***************************************************************************
+ *            ordered_array.h
+ *
+ *  Sun 18 07 08 07:47:17 2007
+ *  Copyright  2008  Ivan Gualandri
+ *  Email
+ ****************************************************************************/
+
+/*
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
+
+#ifndef ORDERED_ARRAY_H
+#define ORDERED_ARRAY_H
+
+#include <ordered_array.h>
+
+typedef void* void_t;
+
+/*!  \struct ordered_array_t
+     \brief Struttura dati che un vettore ordinato.
+ */
+typedef struct {
+    void_t *array; /**< Il vettore che sara' ordinato*/
+    unsigned int size; /**< La dimensione attuale*/
+    unsigned int size_max; /**< La dimensione massima*/
+}ordered_array_t;
+
+ordered_array_t new_array(void_t, unsigned int, unsigned int);
+void insert_array(void_t, ordered_array_t*);
+
+#endif
\ No newline at end of file

Modified: trunk/kernel.c
===================================================================
--- trunk/kernel.c	2008-07-17 21:31:21 UTC (rev 13)
+++ trunk/kernel.c	2008-07-26 19:54:23 UTC (rev 14)
@@ -88,10 +88,10 @@
     configure_PIT ();    
     _kprintOK();
 
-    asm ("movl $0, %eax\n"
+    /*asm ("movl $0, %eax\n"
      "movl $37, %ebx\n"
-     "int $80");
-    printf("\nMemory (upper) amount-> %d kb \n", boot_info->mem_upper);
+     "int $80");    */
+    printf("Memory (upper) amount-> %d kb \n", boot_info->mem_upper);
     get_cpuid();    
     printf("\n");    
     printf("----\n");

Modified: trunk/kernel.map
===================================================================
--- trunk/kernel.map	2008-07-17 21:31:21 UTC (rev 13)
+++ trunk/kernel.map	2008-07-26 19:54:23 UTC (rev 14)
@@ -36,139 +36,143 @@
                 0x0000000000100000                mboot
                 0x0000000000100020                start
  *fill*         0x0000000000100029        0x3 00
- .text          0x000000000010002c      0x1ae kernel.o
+ .text          0x000000000010002c      0x1a2 kernel.o
                 0x000000000010003d                main_loop
                 0x000000000010002c                _start
- *fill*         0x00000000001001da        0x2 00
- .text          0x00000000001001dc      0xa2c io/video.o
-                0x0000000000100b89                _kscrolldown
-                0x00000000001001dc                _kputc
-                0x0000000000100221                _kputs
-                0x00000000001002bd                _kbackspace
-                0x0000000000100a52                _krotate_buffer
-                0x0000000000100407                _ksetcursauto
-                0x00000000001002a6                _kcolor
-                0x0000000000100545                _kdecbin
-                0x00000000001003d6                _ksetcursor
-                0x0000000000100499                _kprintOK
-                0x00000000001002d3                _ktab
-                0x00000000001002e1                _kgoto
-                0x000000000010037c                _knewline
-                0x0000000000100ad6                _kscrollup
-                0x000000000010030f                _kclear
-                0x000000000010050b                _kgetline
-                0x0000000000100887                _kntos
-                0x00000000001004c1                _kgetcolumn
-                0x000000000010060e                _kntohex
-                0x0000000000100978                _kshiftAll
- .text          0x0000000000100c08      0x658 drivers/keyboard.o
-                0x00000000001010cb                _ksetleds
-                0x0000000000101206                _kgetch
-                0x00000000001011eb                keyboard_disable
-                0x00000000001011d0                keyboard_enable
-                0x0000000000100c08                keyboard_isr
- .text          0x0000000000101260      0x1a6 libc/ctype.o
-                0x0000000000101336                islower
-                0x0000000000101386                tolower
-                0x00000000001012fb                isxdigit
-                0x000000000010135e                isupper
-                0x0000000000101288                isalpha
-                0x00000000001012be                isalnum
-                0x0000000000101260                isdigit
-                0x00000000001013c6                toupper
- *fill*         0x0000000000101406        0x2 00
- .text          0x0000000000101408      0x318 libc/string.o
-                0x000000000010159a                strstr
-                0x0000000000101408                strncpy
-                0x0000000000101621                strtok
-                0x00000000001016b3                strncat
-                0x0000000000101523                strdup
-                0x00000000001014ec                memset
-                0x000000000010146d                _kstrncmp
-                0x0000000000101443                strlen
-                0x0000000000101576                strchr
- .text          0x0000000000101720       0x24 io/io.o
-                0x0000000000101720                inportb
-                0x000000000010173a                outportb
- .text          0x0000000000101744      0x655 libc/stdio.o
-                0x0000000000101744                putchar
-                0x0000000000101853                printf
-                0x0000000000101c43                gets
-                0x0000000000101c28                getchar
-                0x0000000000101cb8                scanf
-                0x000000000010175f                atoi
- *fill*         0x0000000000101d99        0x3 00
- .text          0x0000000000101d9c      0x18c hardware/cpuid.o
-                0x0000000000101d9c                get_cpuid
- .text          0x0000000000101f28       0x61 hardware/keyboard.o
-                0x0000000000101f28                keyboard_irq
- *fill*         0x0000000000101f89        0x3 00
- .text          0x0000000000101f8c      0x214 processore/gdt.o
-                0x00000000001020aa                add_GDTseg
-                0x0000000000101f8c                init_gdt
-                0x0000000000102156                set_gdtr
- .text          0x00000000001021a0      0x790 processore/idt.o
-                0x0000000000102893                add_IDTseg
-                0x00000000001024d5                init_idt
-                0x0000000000102908                set_idtr
- .text          0x0000000000102930      0x33c processore/handlers.o
-                0x0000000000102930                init_funcTable
-                0x0000000000102bd2                _irqinterrupt
-                0x00000000001029b3                _globalException
-                0x00000000001029a3                add_Interrupt
-                0x0000000000102c5b                _int_rsv
- .text          0x0000000000102c6c      0x859 hardware/pic8259.o
-                0x0000000000102e9d                init_IRQ
-                0x0000000000102ffb                setup_IRQ
-                0x000000000010331a                disable_IRQ
-                0x00000000001033fc                add_IRQ_handler
-                0x0000000000103242                enable_IRQ
-                0x00000000001033ca                get_current_irq
- *fill*         0x00000000001034c5        0x3 00
- .text          0x00000000001034c8      0x610 mem/fismem.o
-                0x00000000001034c8                init_mem
-                0x000000000010358f                request_pages
-                0x000000000010392f                add_memarea_element
-                0x0000000000103a4c                get_numpages
-                0x0000000000103a46                get_memsize
-                0x0000000000103a72                malloc
-                0x0000000000103a5f                get_bmpelements
-                0x00000000001036f1                release_pages
-                0x0000000000103a2a                calcola_memoria
-                0x0000000000103ab5                free
- .text          0x0000000000103ad8      0x2fd mem/paging.o
-                0x0000000000103c14                create_pageTable
-                0x0000000000103ad8                init_paging
-                0x0000000000103d48                get_pagedir_entry
-                0x0000000000103bf9                create_pageDir
-                0x0000000000103d8f                load_pdbr
-                0x0000000000103cf6                set_pagetable_entry_ric
-                0x0000000000103d65                get_pagetable_entry
-                0x0000000000103c2f                set_pagedir_entry
-                0x0000000000103c70                set_pagedir_entry_ric
-                0x0000000000103cb5                set_pagetable_entry
- *fill*         0x0000000000103dd5        0x3 00
- .text          0x0000000000103dd8       0x22 mem/kheap.o
-                0x0000000000103dd8                kmalloc
- *fill*         0x0000000000103dfa        0x2 00
- .text          0x0000000000103dfc       0xdd system/syscall.o
-                0x0000000000103e1e                syscall_init
-                0x0000000000103dfc                sysputch
-                0x0000000000103e54                syscall_handler
- *fill*         0x0000000000103ed9        0x3 00
- .text          0x0000000000103edc      0x11e hardware/8253.o
-                0x0000000000103fcb                sleep
-                0x0000000000103edc                PIT_handler
-                0x0000000000103f62                configure_PIT
- *fill*         0x0000000000103ffa        0x2 00
- .text          0x0000000000103ffc      0x440 shell/shell.o
-                0x0000000000104040                info
-                0x00000000001041d3                shell
-                0x000000000010402e                poweroff
-                0x000000000010401b                help
-                0x0000000000103ffc                logo
+ *fill*         0x00000000001001ce        0x2 00
+ .text          0x00000000001001d0      0xa2c io/video.o
+                0x0000000000100b7d                _kscrolldown
+                0x00000000001001d0                _kputc
+                0x0000000000100215                _kputs
+                0x00000000001002b1                _kbackspace
+                0x0000000000100a46                _krotate_buffer
+                0x00000000001003fb                _ksetcursauto
+                0x000000000010029a                _kcolor
+                0x0000000000100539                _kdecbin
+                0x00000000001003ca                _ksetcursor
+                0x000000000010048d                _kprintOK
+                0x00000000001002c7                _ktab
+                0x00000000001002d5                _kgoto
+                0x0000000000100370                _knewline
+                0x0000000000100aca                _kscrollup
+                0x0000000000100303                _kclear
+                0x00000000001004ff                _kgetline
+                0x000000000010087b                _kntos
+                0x00000000001004b5                _kgetcolumn
+                0x0000000000100602                _kntohex
+                0x000000000010096c                _kshiftAll
+ .text          0x0000000000100bfc      0x658 drivers/keyboard.o
+                0x00000000001010bf                _ksetleds
+                0x00000000001011fa                _kgetch
+                0x00000000001011df                keyboard_disable
+                0x00000000001011c4                keyboard_enable
+                0x0000000000100bfc                keyboard_isr
+ .text          0x0000000000101254      0x1a6 libc/ctype.o
+                0x000000000010132a                islower
+                0x000000000010137a                tolower
+                0x00000000001012ef                isxdigit
+                0x0000000000101352                isupper
+                0x000000000010127c                isalpha
+                0x00000000001012b2                isalnum
+                0x0000000000101254                isdigit
+                0x00000000001013ba                toupper
+ *fill*         0x00000000001013fa        0x2 00
+ .text          0x00000000001013fc      0x318 libc/string.o
+                0x000000000010158e                strstr
+                0x00000000001013fc                strncpy
+                0x0000000000101615                strtok
+                0x00000000001016a7                strncat
+                0x0000000000101517                strdup
+                0x00000000001014e0                memset
+                0x0000000000101461                _kstrncmp
+                0x0000000000101437                strlen
+                0x000000000010156a                strchr
+ .text          0x0000000000101714       0x24 io/io.o
+                0x0000000000101714                inportb
+                0x000000000010172e                outportb
+ .text          0x0000000000101738      0x655 libc/stdio.o
+                0x0000000000101738                putchar
+                0x0000000000101847                printf
+                0x0000000000101c37                gets
+                0x0000000000101c1c                getchar
+                0x0000000000101cac                scanf
+                0x0000000000101753                atoi
+ *fill*         0x0000000000101d8d        0x3 00
+ .text          0x0000000000101d90      0x18c hardware/cpuid.o
+                0x0000000000101d90                get_cpuid
+ .text          0x0000000000101f1c       0x61 hardware/keyboard.o
+                0x0000000000101f1c                keyboard_irq
+ *fill*         0x0000000000101f7d        0x3 00
+ .text          0x0000000000101f80      0x214 processore/gdt.o
+                0x000000000010209e                add_GDTseg
+                0x0000000000101f80                init_gdt
+                0x000000000010214a                set_gdtr
+ .text          0x0000000000102194      0x790 processore/idt.o
+                0x0000000000102887                add_IDTseg
+                0x00000000001024c9                init_idt
+                0x00000000001028fc                set_idtr
+ .text          0x0000000000102924      0x33c processore/handlers.o
+                0x0000000000102924                init_funcTable
+                0x0000000000102bc6                _irqinterrupt
+                0x00000000001029a7                _globalException
+                0x0000000000102997                add_Interrupt
+                0x0000000000102c4f                _int_rsv
+ .text          0x0000000000102c60      0x859 hardware/pic8259.o
+                0x0000000000102e91                init_IRQ
+                0x0000000000102fef                setup_IRQ
+                0x000000000010330e                disable_IRQ
+                0x00000000001033f0                add_IRQ_handler
+                0x0000000000103236                enable_IRQ
+                0x00000000001033be                get_current_irq
+ *fill*         0x00000000001034b9        0x3 00
+ .text          0x00000000001034bc      0x610 mem/fismem.o
+                0x00000000001034bc                init_mem
+                0x0000000000103583                request_pages
+                0x0000000000103923                add_memarea_element
+                0x0000000000103a40                get_numpages
+                0x0000000000103a3a                get_memsize
+                0x0000000000103a66                malloc
+                0x0000000000103a53                get_bmpelements
+                0x00000000001036e5                release_pages
+                0x0000000000103a1e                calcola_memoria
+                0x0000000000103aa9                free
+ .text          0x0000000000103acc      0x31e mem/paging.o
+                0x0000000000103c29                create_pageTable
+                0x0000000000103acc                init_paging
+                0x0000000000103d5d                get_pagedir_entry
+                0x0000000000103c0e                create_pageDir
+                0x0000000000103da4                load_pdbr
+                0x0000000000103d0b                set_pagetable_entry_ric
+                0x0000000000103d7a                get_pagetable_entry
+                0x0000000000103c44                set_pagedir_entry
+                0x0000000000103c85                set_pagedir_entry_ric
+                0x0000000000103cca                set_pagetable_entry
+ *fill*         0x0000000000103dea        0x2 00
+ .text          0x0000000000103dec       0x9f mem/kheap.o
+                0x0000000000103dec                kmalloc
+                0x0000000000103e0e                make_heap
+ *fill*         0x0000000000103e8b        0x1 00
+ .text          0x0000000000103e8c       0xcc misc/ordered_array.o
+                0x0000000000103f0a                insert_array
+                0x0000000000103e8c                new_array
+ .text          0x0000000000103f58       0xdd system/syscall.o
+                0x0000000000103f7a                syscall_init
+                0x0000000000103f58                sysputch
+                0x0000000000103fb0                syscall_handler
+ *fill*         0x0000000000104035        0x3 00
+ .text          0x0000000000104038      0x11e hardware/8253.o
+                0x0000000000104127                sleep
+                0x0000000000104038                PIT_handler
+                0x00000000001040be                configure_PIT
+ *fill*         0x0000000000104156        0x2 00
+ .text          0x0000000000104158      0x440 shell/shell.o
+                0x000000000010419c                info
+                0x000000000010432f                shell
+                0x000000000010418a                poweroff
+                0x0000000000104177                help
+                0x0000000000104158                logo
                 0x0000000000105000                . = ALIGN (0x1000)
- *fill*         0x000000000010443c      0xbc4 00
+ *fill*         0x0000000000104598      0xa68 00
 
 .rel.dyn        0x0000000000105000        0x0
  .rel.text      0x0000000000000000        0x0 bl.img
@@ -203,26 +207,29 @@
  .data          0x0000000000105324        0x0 mem/paging.o
  .data          0x0000000000105324        0x4 mem/kheap.o
                 0x0000000000105324                address_cur
+ .data          0x0000000000105328        0x0 misc/ordered_array.o
  .data          0x0000000000105328        0x4 system/syscall.o
                 0x0000000000105328                syscall_table
  .data          0x000000000010532c        0x0 hardware/8253.o
  .data          0x000000000010532c        0x0 shell/shell.o
  *(.rodata)
- .rodata        0x000000000010532c       0xf8 kernel.o
- .rodata        0x0000000000105424       0x5f io/video.o
- .rodata        0x0000000000105483       0x10 drivers/keyboard.o
- .rodata        0x0000000000105493        0x2 libc/stdio.o
- .rodata        0x0000000000105495       0x3e hardware/cpuid.o
- .rodata        0x00000000001054d3       0x1d hardware/keyboard.o
+ .rodata        0x000000000010532c       0xf7 kernel.o
+ .rodata        0x0000000000105423       0x5f io/video.o
+ .rodata        0x0000000000105482       0x10 drivers/keyboard.o
+ .rodata        0x0000000000105492        0x2 libc/stdio.o
+ .rodata        0x0000000000105494       0x3e hardware/cpuid.o
+ .rodata        0x00000000001054d2       0x1d hardware/keyboard.o
+ *fill*         0x00000000001054ef        0x1 00
  .rodata        0x00000000001054f0      0x23e processore/handlers.o
  *fill*         0x000000000010572e        0x2 00
  .rodata        0x0000000000105730       0x8a mem/fismem.o
  *fill*         0x00000000001057ba        0x2 00
  .rodata        0x00000000001057bc       0x23 mem/paging.o
- *fill*         0x00000000001057df        0x1 00
- .rodata        0x00000000001057e0      0x35b shell/shell.o
+ .rodata        0x00000000001057df       0x1e misc/ordered_array.o
+ *fill*         0x00000000001057fd        0x3 00
+ .rodata        0x0000000000105800      0x35b shell/shell.o
                 0x0000000000106000                . = ALIGN (0x1000)
- *fill*         0x0000000000105b3b      0x4c5 00
+ *fill*         0x0000000000105b5b      0x4a5 00
 
 .bss            0x0000000000106000    0x33fec
                 0x0000000000106000                bss = .
@@ -250,12 +257,14 @@
  .bss           0x0000000000106458        0x4 mem/fismem.o
                 0x0000000000106458                num_pages
  .bss           0x000000000010645c        0x0 mem/paging.o
- .bss           0x000000000010645c        0x0 mem/kheap.o
- .bss           0x000000000010645c        0x0 system/syscall.o
- .bss           0x000000000010645c        0x8 hardware/8253.o
- .bss           0x0000000000106464        0x0 shell/shell.o
+ .bss           0x000000000010645c        0x4 mem/kheap.o
+                0x000000000010645c                kheap
+ .bss           0x0000000000106460        0x0 misc/ordered_array.o
+ .bss           0x0000000000106460        0x0 system/syscall.o
+ .bss           0x0000000000106460        0x8 hardware/8253.o
+ .bss           0x0000000000106468        0x0 shell/shell.o
                 0x0000000000107000                . = ALIGN (0x1000)
- *fill*         0x0000000000106464      0xb9c 00
+ *fill*         0x0000000000106468      0xb98 00
  COMMON         0x0000000000107000       0x10 kernel.o
                 0x0000000000107000                cpu_vendor
                 0x000000000010700c                current_page_table
@@ -304,13 +313,14 @@
 LOAD mem/fismem.o
 LOAD mem/paging.o
 LOAD mem/kheap.o
+LOAD misc/ordered_array.o
 LOAD system/syscall.o
 LOAD hardware/8253.o
 LOAD shell/shell.o
 Address of section .text set to 0x100000
 OUTPUT(kernel.bin elf32-i386)
 
-.comment        0x0000000000000000      0x246
+.comment        0x0000000000000000      0x263
  .comment       0x0000000000000000       0x1f bl.img
  .comment       0x000000000000001f       0x1d kernel.o
  .comment       0x000000000000003c       0x1d io/video.o
@@ -328,9 +338,10 @@
  .comment       0x0000000000000198       0x1d mem/fismem.o
  .comment       0x00000000000001b5       0x1d mem/paging.o
  .comment       0x00000000000001d2       0x1d mem/kheap.o
- .comment       0x00000000000001ef       0x1d system/syscall.o
- .comment       0x000000000000020c       0x1d hardware/8253.o
- .comment       0x0000000000000229       0x1d shell/shell.o
+ .comment       0x00000000000001ef       0x1d misc/ordered_array.o
+ .comment       0x000000000000020c       0x1d system/syscall.o
+ .comment       0x0000000000000229       0x1d hardware/8253.o
+ .comment       0x0000000000000246       0x1d shell/shell.o
 
 .note.GNU-stack
                 0x0000000000000000        0x0
@@ -367,6 +378,8 @@
  .note.GNU-stack
                 0x0000000000000000        0x0 mem/kheap.o
  .note.GNU-stack
+                0x0000000000000000        0x0 misc/ordered_array.o
+ .note.GNU-stack
                 0x0000000000000000        0x0 system/syscall.o
  .note.GNU-stack
                 0x0000000000000000        0x0 hardware/8253.o

Modified: trunk/mem/kheap.c
===================================================================
--- trunk/mem/kheap.c	2008-07-17 21:31:21 UTC (rev 13)
+++ trunk/mem/kheap.c	2008-07-26 19:54:23 UTC (rev 14)
@@ -1,11 +1,10 @@
 /***************************************************************************
  *            kheap.c
  *
- *  Sat Mar 31 07:47:17 2007
- *  Copyright  2007  Ivan Gualandri
- *  Email
+ *  Sun 18 07 08 07:47:17 2007
+ *  Copyright  2008  Ivan Gualandri
+ *  Email finarfin at elenhost.org
  ****************************************************************************/
-
 /*
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -24,14 +23,34 @@
 
 #include <kheap.h>
 #include <paging.h>
+#include <ordered_array.h>
 
 extern unsigned int end;
+heap_t *kheap = 0;
 unsigned int address_cur = (unsigned int) &end;
 
 void* kmalloc(unsigned int size){
-    int temp;
+    unsigned int temp;
     
     temp = address_cur;
     address_cur+=size;
-    return temp;
+    return (void *) temp;
+}
+/**
+  * Crea un nuov heap
+  * @author Ivan Gualandri
+  * @version 1.0
+  * @param start Indirizzo di inizio del nostro heap
+  * @param end Indirizzo di fine dell'heap
+  * @param size grandezza massima dell'heap
+  * @return Pointer to a new heap
+  */
+heap_t* make_heap(unsigned int start, unsigned int end, unsigned int size){
+    heap_t* new_heap;
+    new_heap = (heap_t*)kmalloc(sizeof(heap_t));
+    new_heap->hole_index = new_array(10,10,10); //decidere i valori
+    new_heap->start_address = start;
+    new_heap->end_address = end;
+    new_heap->max_size = size;
+    return (heap_t*) new_heap;
 }
\ No newline at end of file

Modified: trunk/mem/paging.c
===================================================================
--- trunk/mem/paging.c	2008-07-17 21:31:21 UTC (rev 13)
+++ trunk/mem/paging.c	2008-07-26 19:54:23 UTC (rev 14)
@@ -27,10 +27,12 @@
 #include <stdio.h>
 #include <video.h>
 #include <stddef.h>
+#include <kheap.h>
 // #define DEBUG 1
+
 unsigned int *current_page_dir;
 unsigned int *current_page_table;
-
+extern heap_t *kheap;
 void init_paging(){
     int i;
     printf("Abilito Paging: In lavorazione....");
@@ -61,10 +63,11 @@
         i++;
     }        
     load_pdbr((unsigned int)current_page_dir);
+    kheap = make_heap(10,10,10);
 }
 
 /**
-  * Crea una nuova page_dir
+  * Crea una nuova page_dir in modalita' lineare (non paginata)
   * @author Ivan Gualandri
   * @version 1.0
   * @return page_dir address

Added: trunk/misc/ordered_array.c
===================================================================
--- trunk/misc/ordered_array.c	2008-07-17 21:31:21 UTC (rev 13)
+++ trunk/misc/ordered_array.c	2008-07-26 19:54:23 UTC (rev 14)
@@ -0,0 +1,62 @@
+/***************************************************************************
+ *            ordered_array.c
+ *
+ *  Sun 18 07 08 07:47:17 2007
+ *  Copyright  2008  Ivan Gualandri
+ *  Email
+ ****************************************************************************/
+
+/*
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
+
+#include <ordered_array.h>
+#include <kheap.h>
+#include <stdio.h>
+
+/**
+  * Crea un nuovo ordered_array
+  * @author Ivan Gualandri
+  * @version 1.0
+  * @param start Indirizzo di inizio del nostro array 
+  * @param size grandezza massima dell'array
+  * @return Pointer to a new ordered_array_t
+  */
+ordered_array_t new_array(void_t address,unsigned int start, unsigned int size){
+    int i;
+    i=0;
+    printf("Make array code goes here...\n");        
+    ordered_array_t tmp_array;
+    tmp_array.size_max = size;
+    tmp_array.size = 0;
+    tmp_array.array = (void_t)start;    
+    /* Questa parte e' memsettbile dopo che sara' fatta */
+    while(i<size){
+        tmp_array.array[i]= (void_t) 0x0;
+        i++;
+    }
+    return tmp_array;
+}
+
+void insert_array(void_t elem, ordered_array_t* array){
+    int i;
+    i=0;
+    //Qui va un ciclo tipo: che termina o quando l'elemento va inserito in coda, o quando trova
+    //la sua posizione dove mettersi. && array->array[i].size>=elem->size Questa e' l'idea, ma va 
+    //sistemato il codice.
+    while(i<array->size)
+        i++;
+    if(i==array->size) array->array[++i] = elem;
+}
\ No newline at end of file



From shainer at mail.berlios.de  Sun Jul 27 18:29:01 2008
From: shainer at mail.berlios.de (shainer at BerliOS)
Date: Sun, 27 Jul 2008 18:29:01 +0200
Subject: [Dreamos-dev] r15 - in trunk: . drivers hardware include/io
	include/shell io shell
Message-ID: <200807271629.m6RGT1cu023194@sheep.berlios.de>

Author: shainer
Date: 2008-07-27 18:28:58 +0200 (Sun, 27 Jul 2008)
New Revision: 15

Modified:
   trunk/dreamos.img
   trunk/drivers/keyboard.c
   trunk/hardware/pic8259.c
   trunk/include/io/video.h
   trunk/include/shell/shell.h
   trunk/io/video.c
   trunk/kernel.c
   trunk/kernel.map
   trunk/shell/shell.c
Log:
Aggiunto logo in ASCII art; sistemato il problema del backspace, ora si limita a cancellare i comandi della shell

Modified: trunk/dreamos.img
===================================================================
(Binary files differ)

Modified: trunk/drivers/keyboard.c
===================================================================
--- trunk/drivers/keyboard.c	2008-07-26 19:54:23 UTC (rev 14)
+++ trunk/drivers/keyboard.c	2008-07-27 16:28:58 UTC (rev 15)
@@ -201,6 +201,7 @@
 
 end:
     /* Send acknowledge */
+    //printf ("Prego");
     outportb (EOI, MASTER_PORT);
     return;
 }

Modified: trunk/hardware/pic8259.c
===================================================================
--- trunk/hardware/pic8259.c	2008-07-26 19:54:23 UTC (rev 14)
+++ trunk/hardware/pic8259.c	2008-07-27 16:28:58 UTC (rev 15)
@@ -82,7 +82,11 @@
     outportb(0xFF,SLAVE_PORT_1);
 
     outportb (0xFC, MASTER_PORT_1);
+//<<<<<<< .mine
+    //enable_IRQ (0);
+//=======
  //     enable_IRQ (0);
+//>>>>>>> .r13
 
     setup_IRQ();
     asm("sti");

Modified: trunk/include/io/video.h
===================================================================
--- trunk/include/io/video.h	2008-07-26 19:54:23 UTC (rev 14)
+++ trunk/include/io/video.h	2008-07-27 16:28:58 UTC (rev 15)
@@ -51,5 +51,7 @@
 void _kntohex (unsigned int);
 void _kdecbin (int);
 
+unsigned short shell_mess;
 
+
 #endif /* _VIDEO_H */

Modified: trunk/include/shell/shell.h
===================================================================
--- trunk/include/shell/shell.h	2008-07-26 19:54:23 UTC (rev 14)
+++ trunk/include/shell/shell.h	2008-07-27 16:28:58 UTC (rev 15)
@@ -23,5 +23,7 @@
 #define __SHELL_H
 
 void shell();
+void logo();
+void aalogo();
 
 #endif

Modified: trunk/io/video.c
===================================================================
--- trunk/io/video.c	2008-07-26 19:54:23 UTC (rev 14)
+++ trunk/io/video.c	2008-07-27 16:28:58 UTC (rev 15)
@@ -85,8 +85,10 @@
  */
 void _kbackspace()
 {
-  VIDEO_PTR -= 2;
-  *VIDEO_PTR = 0x20; // delete the character
+    if (_kgetcolumn() > shell_mess) {
+      VIDEO_PTR -= 2;
+      *VIDEO_PTR = 0x20; // delete the character
+    }
 }
 
 /*

Modified: trunk/kernel.c
===================================================================
--- trunk/kernel.c	2008-07-26 19:54:23 UTC (rev 14)
+++ trunk/kernel.c	2008-07-27 16:28:58 UTC (rev 15)
@@ -85,7 +85,7 @@
     init_paging();    
 
     printf(LNG_PIT8253);
-    configure_PIT ();    
+    //configure_PIT ();
     _kprintOK();
 
     /*asm ("movl $0, %eax\n"

Modified: trunk/kernel.map
===================================================================
--- trunk/kernel.map	2008-07-26 19:54:23 UTC (rev 14)
+++ trunk/kernel.map	2008-07-27 16:28:58 UTC (rev 15)
@@ -8,6 +8,7 @@
 upbuffer            0xfa0             io/video.o
 IDT_Table           0x800             processore/idt.o
 cpu_vendor          0xc               kernel.o
+shell_mess          0x2               kernel.o
 tot_mem             0x4               mem/fismem.o
 slave_cur_mask      0x1               hardware/pic8259.o
 current_page_dir    0x4               mem/paging.o
@@ -36,143 +37,145 @@
                 0x0000000000100000                mboot
                 0x0000000000100020                start
  *fill*         0x0000000000100029        0x3 00
- .text          0x000000000010002c      0x1a2 kernel.o
+ .text          0x000000000010002c      0x19d kernel.o
                 0x000000000010003d                main_loop
                 0x000000000010002c                _start
- *fill*         0x00000000001001ce        0x2 00
- .text          0x00000000001001d0      0xa2c io/video.o
-                0x0000000000100b7d                _kscrolldown
-                0x00000000001001d0                _kputc
-                0x0000000000100215                _kputs
-                0x00000000001002b1                _kbackspace
-                0x0000000000100a46                _krotate_buffer
-                0x00000000001003fb                _ksetcursauto
-                0x000000000010029a                _kcolor
-                0x0000000000100539                _kdecbin
-                0x00000000001003ca                _ksetcursor
-                0x000000000010048d                _kprintOK
-                0x00000000001002c7                _ktab
-                0x00000000001002d5                _kgoto
-                0x0000000000100370                _knewline
-                0x0000000000100aca                _kscrollup
-                0x0000000000100303                _kclear
-                0x00000000001004ff                _kgetline
-                0x000000000010087b                _kntos
-                0x00000000001004b5                _kgetcolumn
-                0x0000000000100602                _kntohex
-                0x000000000010096c                _kshiftAll
- .text          0x0000000000100bfc      0x658 drivers/keyboard.o
-                0x00000000001010bf                _ksetleds
-                0x00000000001011fa                _kgetch
-                0x00000000001011df                keyboard_disable
-                0x00000000001011c4                keyboard_enable
-                0x0000000000100bfc                keyboard_isr
- .text          0x0000000000101254      0x1a6 libc/ctype.o
-                0x000000000010132a                islower
-                0x000000000010137a                tolower
-                0x00000000001012ef                isxdigit
-                0x0000000000101352                isupper
-                0x000000000010127c                isalpha
-                0x00000000001012b2                isalnum
-                0x0000000000101254                isdigit
-                0x00000000001013ba                toupper
- *fill*         0x00000000001013fa        0x2 00
- .text          0x00000000001013fc      0x318 libc/string.o
-                0x000000000010158e                strstr
-                0x00000000001013fc                strncpy
-                0x0000000000101615                strtok
-                0x00000000001016a7                strncat
-                0x0000000000101517                strdup
-                0x00000000001014e0                memset
-                0x0000000000101461                _kstrncmp
-                0x0000000000101437                strlen
-                0x000000000010156a                strchr
- .text          0x0000000000101714       0x24 io/io.o
-                0x0000000000101714                inportb
-                0x000000000010172e                outportb
- .text          0x0000000000101738      0x655 libc/stdio.o
-                0x0000000000101738                putchar
-                0x0000000000101847                printf
-                0x0000000000101c37                gets
-                0x0000000000101c1c                getchar
-                0x0000000000101cac                scanf
-                0x0000000000101753                atoi
- *fill*         0x0000000000101d8d        0x3 00
- .text          0x0000000000101d90      0x18c hardware/cpuid.o
-                0x0000000000101d90                get_cpuid
- .text          0x0000000000101f1c       0x61 hardware/keyboard.o
-                0x0000000000101f1c                keyboard_irq
- *fill*         0x0000000000101f7d        0x3 00
- .text          0x0000000000101f80      0x214 processore/gdt.o
-                0x000000000010209e                add_GDTseg
-                0x0000000000101f80                init_gdt
-                0x000000000010214a                set_gdtr
- .text          0x0000000000102194      0x790 processore/idt.o
-                0x0000000000102887                add_IDTseg
-                0x00000000001024c9                init_idt
-                0x00000000001028fc                set_idtr
- .text          0x0000000000102924      0x33c processore/handlers.o
-                0x0000000000102924                init_funcTable
-                0x0000000000102bc6                _irqinterrupt
-                0x00000000001029a7                _globalException
-                0x0000000000102997                add_Interrupt
-                0x0000000000102c4f                _int_rsv
- .text          0x0000000000102c60      0x859 hardware/pic8259.o
-                0x0000000000102e91                init_IRQ
-                0x0000000000102fef                setup_IRQ
-                0x000000000010330e                disable_IRQ
-                0x00000000001033f0                add_IRQ_handler
-                0x0000000000103236                enable_IRQ
-                0x00000000001033be                get_current_irq
- *fill*         0x00000000001034b9        0x3 00
- .text          0x00000000001034bc      0x610 mem/fismem.o
-                0x00000000001034bc                init_mem
-                0x0000000000103583                request_pages
-                0x0000000000103923                add_memarea_element
-                0x0000000000103a40                get_numpages
-                0x0000000000103a3a                get_memsize
-                0x0000000000103a66                malloc
-                0x0000000000103a53                get_bmpelements
-                0x00000000001036e5                release_pages
-                0x0000000000103a1e                calcola_memoria
-                0x0000000000103aa9                free
- .text          0x0000000000103acc      0x31e mem/paging.o
-                0x0000000000103c29                create_pageTable
-                0x0000000000103acc                init_paging
-                0x0000000000103d5d                get_pagedir_entry
-                0x0000000000103c0e                create_pageDir
-                0x0000000000103da4                load_pdbr
-                0x0000000000103d0b                set_pagetable_entry_ric
-                0x0000000000103d7a                get_pagetable_entry
-                0x0000000000103c44                set_pagedir_entry
-                0x0000000000103c85                set_pagedir_entry_ric
-                0x0000000000103cca                set_pagetable_entry
- *fill*         0x0000000000103dea        0x2 00
- .text          0x0000000000103dec       0x9f mem/kheap.o
-                0x0000000000103dec                kmalloc
-                0x0000000000103e0e                make_heap
- *fill*         0x0000000000103e8b        0x1 00
- .text          0x0000000000103e8c       0xcc misc/ordered_array.o
-                0x0000000000103f0a                insert_array
-                0x0000000000103e8c                new_array
- .text          0x0000000000103f58       0xdd system/syscall.o
-                0x0000000000103f7a                syscall_init
-                0x0000000000103f58                sysputch
-                0x0000000000103fb0                syscall_handler
- *fill*         0x0000000000104035        0x3 00
- .text          0x0000000000104038      0x11e hardware/8253.o
-                0x0000000000104127                sleep
-                0x0000000000104038                PIT_handler
-                0x00000000001040be                configure_PIT
- *fill*         0x0000000000104156        0x2 00
- .text          0x0000000000104158      0x440 shell/shell.o
-                0x000000000010419c                info
-                0x000000000010432f                shell
-                0x000000000010418a                poweroff
-                0x0000000000104177                help
-                0x0000000000104158                logo
+ *fill*         0x00000000001001c9        0x3 00
+ .text          0x00000000001001cc      0xa45 io/video.o
+                0x0000000000100b92                _kscrolldown
+                0x00000000001001cc                _kputc
+                0x0000000000100211                _kputs
+                0x00000000001002ad                _kbackspace
+                0x0000000000100a5b                _krotate_buffer
+                0x0000000000100410                _ksetcursauto
+                0x0000000000100296                _kcolor
+                0x000000000010054e                _kdecbin
+                0x00000000001003df                _ksetcursor
+                0x00000000001004a2                _kprintOK
+                0x00000000001002dc                _ktab
+                0x00000000001002ea                _kgoto
+                0x0000000000100385                _knewline
+                0x0000000000100adf                _kscrollup
+                0x0000000000100318                _kclear
+                0x0000000000100514                _kgetline
+                0x0000000000100890                _kntos
+                0x00000000001004ca                _kgetcolumn
+                0x0000000000100617                _kntohex
+                0x0000000000100981                _kshiftAll
+ *fill*         0x0000000000100c11        0x3 00
+ .text          0x0000000000100c14      0x658 drivers/keyboard.o
+                0x00000000001010d7                _ksetleds
+                0x0000000000101212                _kgetch
+                0x00000000001011f7                keyboard_disable
+                0x00000000001011dc                keyboard_enable
+                0x0000000000100c14                keyboard_isr
+ .text          0x000000000010126c      0x1a6 libc/ctype.o
+                0x0000000000101342                islower
+                0x0000000000101392                tolower
+                0x0000000000101307                isxdigit
+                0x000000000010136a                isupper
+                0x0000000000101294                isalpha
+                0x00000000001012ca                isalnum
+                0x000000000010126c                isdigit
+                0x00000000001013d2                toupper
+ *fill*         0x0000000000101412        0x2 00
+ .text          0x0000000000101414      0x318 libc/string.o
+                0x00000000001015a6                strstr
+                0x0000000000101414                strncpy
+                0x000000000010162d                strtok
+                0x00000000001016bf                strncat
+                0x000000000010152f                strdup
+                0x00000000001014f8                memset
+                0x0000000000101479                _kstrncmp
+                0x000000000010144f                strlen
+                0x0000000000101582                strchr
+ .text          0x000000000010172c       0x24 io/io.o
+                0x000000000010172c                inportb
+                0x0000000000101746                outportb
+ .text          0x0000000000101750      0x655 libc/stdio.o
+                0x0000000000101750                putchar
+                0x000000000010185f                printf
+                0x0000000000101c4f                gets
+                0x0000000000101c34                getchar
+                0x0000000000101cc4                scanf
+                0x000000000010176b                atoi
+ *fill*         0x0000000000101da5        0x3 00
+ .text          0x0000000000101da8      0x18c hardware/cpuid.o
+                0x0000000000101da8                get_cpuid
+ .text          0x0000000000101f34       0x61 hardware/keyboard.o
+                0x0000000000101f34                keyboard_irq
+ *fill*         0x0000000000101f95        0x3 00
+ .text          0x0000000000101f98      0x214 processore/gdt.o
+                0x00000000001020b6                add_GDTseg
+                0x0000000000101f98                init_gdt
+                0x0000000000102162                set_gdtr
+ .text          0x00000000001021ac      0x790 processore/idt.o
+                0x000000000010289f                add_IDTseg
+                0x00000000001024e1                init_idt
+                0x0000000000102914                set_idtr
+ .text          0x000000000010293c      0x33c processore/handlers.o
+                0x000000000010293c                init_funcTable
+                0x0000000000102bde                _irqinterrupt
+                0x00000000001029bf                _globalException
+                0x00000000001029af                add_Interrupt
+                0x0000000000102c67                _int_rsv
+ .text          0x0000000000102c78      0x859 hardware/pic8259.o
+                0x0000000000102ea9                init_IRQ
+                0x0000000000103007                setup_IRQ
+                0x0000000000103326                disable_IRQ
+                0x0000000000103408                add_IRQ_handler
+                0x000000000010324e                enable_IRQ
+                0x00000000001033d6                get_current_irq
+ *fill*         0x00000000001034d1        0x3 00
+ .text          0x00000000001034d4      0x610 mem/fismem.o
+                0x00000000001034d4                init_mem
+                0x000000000010359b                request_pages
+                0x000000000010393b                add_memarea_element
+                0x0000000000103a58                get_numpages
+                0x0000000000103a52                get_memsize
+                0x0000000000103a7e                malloc
+                0x0000000000103a6b                get_bmpelements
+                0x00000000001036fd                release_pages
+                0x0000000000103a36                calcola_memoria
+                0x0000000000103ac1                free
+ .text          0x0000000000103ae4      0x31e mem/paging.o
+                0x0000000000103c41                create_pageTable
+                0x0000000000103ae4                init_paging
+                0x0000000000103d75                get_pagedir_entry
+                0x0000000000103c26                create_pageDir
+                0x0000000000103dbc                load_pdbr
+                0x0000000000103d23                set_pagetable_entry_ric
+                0x0000000000103d92                get_pagetable_entry
+                0x0000000000103c5c                set_pagedir_entry
+                0x0000000000103c9d                set_pagedir_entry_ric
+                0x0000000000103ce2                set_pagetable_entry
+ *fill*         0x0000000000103e02        0x2 00
+ .text          0x0000000000103e04       0x9f mem/kheap.o
+                0x0000000000103e04                kmalloc
+                0x0000000000103e26                make_heap
+ *fill*         0x0000000000103ea3        0x1 00
+ .text          0x0000000000103ea4       0xcc misc/ordered_array.o
+                0x0000000000103f22                insert_array
+                0x0000000000103ea4                new_array
+ .text          0x0000000000103f70       0xdd system/syscall.o
+                0x0000000000103f92                syscall_init
+                0x0000000000103f70                sysputch
+                0x0000000000103fc8                syscall_handler
+ *fill*         0x000000000010404d        0x3 00
+ .text          0x0000000000104050      0x11e hardware/8253.o
+                0x000000000010413f                sleep
+                0x0000000000104050                PIT_handler
+                0x00000000001040d6                configure_PIT
+ *fill*         0x000000000010416e        0x2 00
+ .text          0x0000000000104170      0x4b6 shell/shell.o
+                0x00000000001041b4                info
+                0x0000000000104347                shell
+                0x00000000001045e3                aalogo
+                0x00000000001041a2                poweroff
+                0x000000000010418f                help
+                0x0000000000104170                logo
                 0x0000000000105000                . = ALIGN (0x1000)
- *fill*         0x0000000000104598      0xa68 00
+ *fill*         0x0000000000104626      0x9da 00
 
 .rel.dyn        0x0000000000105000        0x0
  .rel.text      0x0000000000000000        0x0 bl.img
@@ -227,9 +230,9 @@
  .rodata        0x00000000001057bc       0x23 mem/paging.o
  .rodata        0x00000000001057df       0x1e misc/ordered_array.o
  *fill*         0x00000000001057fd        0x3 00
- .rodata        0x0000000000105800      0x35b shell/shell.o
+ .rodata        0x0000000000105800      0x42f shell/shell.o
                 0x0000000000106000                . = ALIGN (0x1000)
- *fill*         0x0000000000105b5b      0x4a5 00
+ *fill*         0x0000000000105c2f      0x3d1 00
 
 .bss            0x0000000000106000    0x33fec
                 0x0000000000106000                bss = .
@@ -265,10 +268,11 @@
  .bss           0x0000000000106468        0x0 shell/shell.o
                 0x0000000000107000                . = ALIGN (0x1000)
  *fill*         0x0000000000106468      0xb98 00
- COMMON         0x0000000000107000       0x10 kernel.o
+ COMMON         0x0000000000107000       0x14 kernel.o
                 0x0000000000107000                cpu_vendor
-                0x000000000010700c                current_page_table
- *fill*         0x0000000000107010       0x10 00
+                0x000000000010700c                shell_mess
+                0x0000000000107010                current_page_table
+ *fill*         0x0000000000107014        0xc 00
  COMMON         0x0000000000107020     0x233c io/video.o
                 0x0000000000107020                downbuffer
                 0x0000000000107fc0                upbuffer

Modified: trunk/shell/shell.c
===================================================================
--- trunk/shell/shell.c	2008-07-26 19:54:23 UTC (rev 14)
+++ trunk/shell/shell.c	2008-07-27 16:28:58 UTC (rev 15)
@@ -50,9 +50,10 @@
 {
 	printf("help     - See the 'help' list to learn the DreamOS command now avaible\n"
 	       "poweroff - Turn off the machine\n"
-	       "info     - See the system info about Memory and other staffs like that\n"
+	       "info     - See the system info about Memory and other stuffs like that\n"
            "kmalloc  - Test a basic kmalloc function\n"
            "do_fault - Test a page_fault (WARNING: This hang the OS)\n"
+           "aalogo - Show an ascii art logo\n"
 		);
 }
 
@@ -98,6 +99,8 @@
 	//char *cmd=malloc(256); Dio maiale, Page Fault con il puntatore...
 	int a = 1;
 	logo();
+
+        shell_mess = 7;
 	for (;;)
 	{
 		_kputs("root~# ");
@@ -148,9 +151,17 @@
             char *prova;
             prova = 0xa0000000;
             *prova = 10;
-cmd[a]=NULL;
+            cmd[a]=NULL;
         }
+        else if (!(_kstrncmp(cmd,"aalogo",6))) aalogo();        
 	}
 
 }
 
+void aalogo() {
+printf("\t____                     _____ _____\n");
+printf("\t|    \\ ___ ___ ___ _____|     |   __|\n");
+printf("\t|  |  |  _| -_| = |     |  |  |__   |\n");
+printf("\t|____/|_| |___|__||_|_|_|_____|_____|\n");
+printf("\t Rev15\n\n\n");
+}
\ No newline at end of file



From finarfin at mail.berlios.de  Mon Jul 28 00:04:49 2008
From: finarfin at mail.berlios.de (finarfin at BerliOS)
Date: Mon, 28 Jul 2008 00:04:49 +0200
Subject: [Dreamos-dev] r16 - in trunk: . include/mem mem shell
Message-ID: <200807272204.m6RM4nN4022996@sheep.berlios.de>

Author: finarfin
Date: 2008-07-28 00:04:48 +0200 (Mon, 28 Jul 2008)
New Revision: 16

Added:
   trunk/include/mem/buddy.h
   trunk/mem/buddy.c
Modified:
   trunk/Makefile
   trunk/dreamos.img
   trunk/kernel.map
   trunk/mem/paging.c
   trunk/shell/shell.c
Log:
Aggiunti file buddy.c e buddy.h
Creata funzione di init.
Si e' deciso di usare per ora come MMU il buddy system.
Stampa di alcune informazioni di prova.


Modified: trunk/Makefile
===================================================================
--- trunk/Makefile	2008-07-27 16:28:58 UTC (rev 15)
+++ trunk/Makefile	2008-07-27 22:04:48 UTC (rev 16)
@@ -1,5 +1,5 @@
 CFLAGS = -nostdlib -fomit-frame-pointer -fno-builtin -fno-stack-protector -Wall -march=i686 -m32 -I./include -I./include/io -I./include/drivers -I./include/libc -I./include/processore -I./include/hardware -I./include/mem -I./include/system -I./include/shell -I./include/misc
-OBJ = kernel.o io/video.o drivers/keyboard.o libc/ctype.o libc/string.o io/io.o libc/stdio.o hardware/cpuid.o hardware/keyboard.o processore/gdt.o processore/idt.o processore/handlers.o hardware/pic8259.o mem/fismem.o mem/paging.o mem/kheap.o misc/ordered_array.o system/syscall.o hardware/8253.o shell/shell.o
+OBJ = kernel.o io/video.o drivers/keyboard.o libc/ctype.o libc/string.o io/io.o libc/stdio.o hardware/cpuid.o hardware/keyboard.o processore/gdt.o processore/idt.o processore/handlers.o hardware/pic8259.o mem/fismem.o mem/paging.o mem/kheap.o mem/buddy.o misc/ordered_array.o system/syscall.o hardware/8253.o shell/shell.o
 
 dreamos.img: bl.img kernel.bin
 	mv kernel.bin dreamos.img
@@ -25,6 +25,7 @@
 mem/fismem.o: mem/fismem.c
 mem/paging.o: mem/paging.c
 mem/kheap.o: mem/kheap.c
+mem/buddy.o: mem/buddy.c
 misc/ordered_array.o: misc/ordered_array.c
 drivers/keyboard.o: drivers/keyboard.c
 system/syscall.o: system/syscall.c

Modified: trunk/dreamos.img
===================================================================
(Binary files differ)

Added: trunk/include/mem/buddy.h
===================================================================
--- trunk/include/mem/buddy.h	2008-07-27 16:28:58 UTC (rev 15)
+++ trunk/include/mem/buddy.h	2008-07-27 22:04:48 UTC (rev 16)
@@ -0,0 +1,40 @@
+/***************************************************************************
+ *            buddy.h
+ *
+ *  Sun 18 07 08 07:47:17 2007
+ *  Copyright  2008  Ivan Gualandri
+ *  Email
+ ****************************************************************************/
+
+/*
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
+
+#ifndef BUDDY_H
+#define BUDDY_H
+
+/*!  \struct buddy_t
+     \brief Struttura dati che mantiene le informazioni su un singolo buddy
+ */
+typedef struct {
+    unsigned int start_address; /**< Indirizzo di inizio del buddy*/
+    unsigned int size; /**< Dimensione della memoria da gestire*/
+    struct buddy_t* left; /**< Figlio sinistro*/
+    struct buddy_t* right; /**< Figlio destro*/
+} buddy_t;
+
+buddy_t* new_buddy();
+
+#endif
\ No newline at end of file

Modified: trunk/kernel.map
===================================================================
--- trunk/kernel.map	2008-07-27 16:28:58 UTC (rev 15)
+++ trunk/kernel.map	2008-07-27 22:04:48 UTC (rev 16)
@@ -9,6 +9,7 @@
 IDT_Table           0x800             processore/idt.o
 cpu_vendor          0xc               kernel.o
 shell_mess          0x2               kernel.o
+kbuddy              0x4               mem/buddy.o
 tot_mem             0x4               mem/fismem.o
 slave_cur_mask      0x1               hardware/pic8259.o
 current_page_dir    0x4               mem/paging.o
@@ -138,44 +139,46 @@
                 0x00000000001036fd                release_pages
                 0x0000000000103a36                calcola_memoria
                 0x0000000000103ac1                free
- .text          0x0000000000103ae4      0x31e mem/paging.o
-                0x0000000000103c41                create_pageTable
+ .text          0x0000000000103ae4      0x328 mem/paging.o
+                0x0000000000103c4b                create_pageTable
                 0x0000000000103ae4                init_paging
-                0x0000000000103d75                get_pagedir_entry
-                0x0000000000103c26                create_pageDir
-                0x0000000000103dbc                load_pdbr
-                0x0000000000103d23                set_pagetable_entry_ric
-                0x0000000000103d92                get_pagetable_entry
-                0x0000000000103c5c                set_pagedir_entry
-                0x0000000000103c9d                set_pagedir_entry_ric
-                0x0000000000103ce2                set_pagetable_entry
- *fill*         0x0000000000103e02        0x2 00
- .text          0x0000000000103e04       0x9f mem/kheap.o
-                0x0000000000103e04                kmalloc
-                0x0000000000103e26                make_heap
- *fill*         0x0000000000103ea3        0x1 00
- .text          0x0000000000103ea4       0xcc misc/ordered_array.o
-                0x0000000000103f22                insert_array
-                0x0000000000103ea4                new_array
- .text          0x0000000000103f70       0xdd system/syscall.o
-                0x0000000000103f92                syscall_init
-                0x0000000000103f70                sysputch
-                0x0000000000103fc8                syscall_handler
- *fill*         0x000000000010404d        0x3 00
- .text          0x0000000000104050      0x11e hardware/8253.o
-                0x000000000010413f                sleep
-                0x0000000000104050                PIT_handler
-                0x00000000001040d6                configure_PIT
- *fill*         0x000000000010416e        0x2 00
- .text          0x0000000000104170      0x4b6 shell/shell.o
-                0x00000000001041b4                info
-                0x0000000000104347                shell
-                0x00000000001045e3                aalogo
-                0x00000000001041a2                poweroff
-                0x000000000010418f                help
-                0x0000000000104170                logo
+                0x0000000000103d7f                get_pagedir_entry
+                0x0000000000103c30                create_pageDir
+                0x0000000000103dc6                load_pdbr
+                0x0000000000103d2d                set_pagetable_entry_ric
+                0x0000000000103d9c                get_pagetable_entry
+                0x0000000000103c66                set_pagedir_entry
+                0x0000000000103ca7                set_pagedir_entry_ric
+                0x0000000000103cec                set_pagetable_entry
+ .text          0x0000000000103e0c       0x9f mem/kheap.o
+                0x0000000000103e0c                kmalloc
+                0x0000000000103e2e                make_heap
+ *fill*         0x0000000000103eab        0x1 00
+ .text          0x0000000000103eac       0x65 mem/buddy.o
+                0x0000000000103eac                new_buddy
+ *fill*         0x0000000000103f11        0x3 00
+ .text          0x0000000000103f14       0xcc misc/ordered_array.o
+                0x0000000000103f92                insert_array
+                0x0000000000103f14                new_array
+ .text          0x0000000000103fe0       0xdd system/syscall.o
+                0x0000000000104002                syscall_init
+                0x0000000000103fe0                sysputch
+                0x0000000000104038                syscall_handler
+ *fill*         0x00000000001040bd        0x3 00
+ .text          0x00000000001040c0      0x11e hardware/8253.o
+                0x00000000001041af                sleep
+                0x00000000001040c0                PIT_handler
+                0x0000000000104146                configure_PIT
+ *fill*         0x00000000001041de        0x2 00
+ .text          0x00000000001041e0      0x4b6 shell/shell.o
+                0x0000000000104224                info
+                0x00000000001043b7                shell
+                0x0000000000104653                aalogo
+                0x0000000000104212                poweroff
+                0x00000000001041ff                help
+                0x00000000001041e0                logo
                 0x0000000000105000                . = ALIGN (0x1000)
- *fill*         0x0000000000104626      0x9da 00
+ *fill*         0x0000000000104696      0x96a 00
 
 .rel.dyn        0x0000000000105000        0x0
  .rel.text      0x0000000000000000        0x0 bl.img
@@ -210,6 +213,7 @@
  .data          0x0000000000105324        0x0 mem/paging.o
  .data          0x0000000000105324        0x4 mem/kheap.o
                 0x0000000000105324                address_cur
+ .data          0x0000000000105328        0x0 mem/buddy.o
  .data          0x0000000000105328        0x0 misc/ordered_array.o
  .data          0x0000000000105328        0x4 system/syscall.o
                 0x0000000000105328                syscall_table
@@ -228,13 +232,13 @@
  .rodata        0x0000000000105730       0x8a mem/fismem.o
  *fill*         0x00000000001057ba        0x2 00
  .rodata        0x00000000001057bc       0x23 mem/paging.o
- .rodata        0x00000000001057df       0x1e misc/ordered_array.o
- *fill*         0x00000000001057fd        0x3 00
- .rodata        0x0000000000105800      0x42f shell/shell.o
+ .rodata        0x00000000001057df       0x1b mem/buddy.o
+ .rodata        0x00000000001057fa       0x1e misc/ordered_array.o
+ .rodata        0x0000000000105818      0x42f shell/shell.o
                 0x0000000000106000                . = ALIGN (0x1000)
- *fill*         0x0000000000105c2f      0x3d1 00
+ *fill*         0x0000000000105c47      0x3b9 00
 
-.bss            0x0000000000106000    0x33fec
+.bss            0x0000000000106000    0x33ff0
                 0x0000000000106000                bss = .
                 0x0000000000106000                _bss = .
                 0x0000000000106000                __bss = .
@@ -262,6 +266,7 @@
  .bss           0x000000000010645c        0x0 mem/paging.o
  .bss           0x000000000010645c        0x4 mem/kheap.o
                 0x000000000010645c                kheap
+ .bss           0x0000000000106460        0x0 mem/buddy.o
  .bss           0x0000000000106460        0x0 misc/ordered_array.o
  .bss           0x0000000000106460        0x0 system/syscall.o
  .bss           0x0000000000106460        0x8 hardware/8253.o
@@ -297,9 +302,11 @@
                 0x0000000000139fe4                bmp_elements
  COMMON         0x0000000000139fe8        0x4 mem/paging.o
                 0x0000000000139fe8                current_page_dir
-                0x0000000000139fec                end = .
-                0x0000000000139fec                _end = .
-                0x0000000000139fec                __end = .
+ COMMON         0x0000000000139fec        0x4 mem/buddy.o
+                0x0000000000139fec                kbuddy
+                0x0000000000139ff0                end = .
+                0x0000000000139ff0                _end = .
+                0x0000000000139ff0                __end = .
 LOAD bl.img
 LOAD kernel.o
 LOAD io/video.o
@@ -317,6 +324,7 @@
 LOAD mem/fismem.o
 LOAD mem/paging.o
 LOAD mem/kheap.o
+LOAD mem/buddy.o
 LOAD misc/ordered_array.o
 LOAD system/syscall.o
 LOAD hardware/8253.o
@@ -324,7 +332,7 @@
 Address of section .text set to 0x100000
 OUTPUT(kernel.bin elf32-i386)
 
-.comment        0x0000000000000000      0x263
+.comment        0x0000000000000000      0x280
  .comment       0x0000000000000000       0x1f bl.img
  .comment       0x000000000000001f       0x1d kernel.o
  .comment       0x000000000000003c       0x1d io/video.o
@@ -342,10 +350,11 @@
  .comment       0x0000000000000198       0x1d mem/fismem.o
  .comment       0x00000000000001b5       0x1d mem/paging.o
  .comment       0x00000000000001d2       0x1d mem/kheap.o
- .comment       0x00000000000001ef       0x1d misc/ordered_array.o
- .comment       0x000000000000020c       0x1d system/syscall.o
- .comment       0x0000000000000229       0x1d hardware/8253.o
- .comment       0x0000000000000246       0x1d shell/shell.o
+ .comment       0x00000000000001ef       0x1d mem/buddy.o
+ .comment       0x000000000000020c       0x1d misc/ordered_array.o
+ .comment       0x0000000000000229       0x1d system/syscall.o
+ .comment       0x0000000000000246       0x1d hardware/8253.o
+ .comment       0x0000000000000263       0x1d shell/shell.o
 
 .note.GNU-stack
                 0x0000000000000000        0x0
@@ -382,6 +391,8 @@
  .note.GNU-stack
                 0x0000000000000000        0x0 mem/kheap.o
  .note.GNU-stack
+                0x0000000000000000        0x0 mem/buddy.o
+ .note.GNU-stack
                 0x0000000000000000        0x0 misc/ordered_array.o
  .note.GNU-stack
                 0x0000000000000000        0x0 system/syscall.o

Added: trunk/mem/buddy.c
===================================================================
--- trunk/mem/buddy.c	2008-07-27 16:28:58 UTC (rev 15)
+++ trunk/mem/buddy.c	2008-07-27 22:04:48 UTC (rev 16)
@@ -0,0 +1,43 @@
+/***************************************************************************
+ *            buddy.c
+ *
+ *  Sun 18 07 08 07:47:17 2007
+ *  Copyright  2008  Ivan Gualandri
+ *  Email
+ ****************************************************************************/
+
+/*
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
+
+#include <buddy.h>
+#include <paging.h>
+#include <kheap.h>
+#include <stdio.h>
+#include <stddef.h>
+
+extern unsigned int end;
+extern unsigned int address_cur;
+buddy_t* kbuddy;
+buddy_t* new_buddy(){
+    buddy_t* temp;
+    temp = (buddy_t*) kmalloc(sizeof(buddy_t));
+    printf("end: %x | address_cur: %x\n", &end, address_cur);
+    temp->start_address = address_cur;
+    temp->size = 65536; //da cambiare
+    temp->left = NULL;
+    temp->right = NULL;
+    return temp;
+}
\ No newline at end of file

Modified: trunk/mem/paging.c
===================================================================
--- trunk/mem/paging.c	2008-07-27 16:28:58 UTC (rev 15)
+++ trunk/mem/paging.c	2008-07-27 22:04:48 UTC (rev 16)
@@ -28,11 +28,14 @@
 #include <video.h>
 #include <stddef.h>
 #include <kheap.h>
+#include <buddy.h>
 // #define DEBUG 1
 
 unsigned int *current_page_dir;
 unsigned int *current_page_table;
 extern heap_t *kheap;
+extern buddy_t *kbuddy;
+
 void init_paging(){
     int i;
     printf("Abilito Paging: In lavorazione....");
@@ -64,6 +67,7 @@
     }        
     load_pdbr((unsigned int)current_page_dir);
     kheap = make_heap(10,10,10);
+    kbuddy = new_buddy();
 }
 
 /**

Modified: trunk/shell/shell.c
===================================================================
--- trunk/shell/shell.c	2008-07-27 16:28:58 UTC (rev 15)
+++ trunk/shell/shell.c	2008-07-27 22:04:48 UTC (rev 16)
@@ -163,5 +163,5 @@
 printf("\t|    \\ ___ ___ ___ _____|     |   __|\n");
 printf("\t|  |  |  _| -_| = |     |  |  |__   |\n");
 printf("\t|____/|_| |___|__||_|_|_|_____|_____|\n");
-printf("\t Rev15\n\n\n");
+printf("\t Rev16\n\n\n");
 }
\ No newline at end of file



