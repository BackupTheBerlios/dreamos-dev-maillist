From finarfin at mail.berlios.de  Thu Aug  7 22:40:19 2008
From: finarfin at mail.berlios.de (finarfin at BerliOS)
Date: Thu, 7 Aug 2008 22:40:19 +0200
Subject: [Dreamos-dev] r17 - in trunk: . include/mem mem shell
Message-ID: <200808072040.m77KeJWu014351@sheep.berlios.de>

Author: finarfin
Date: 2008-08-07 22:40:19 +0200 (Thu, 07 Aug 2008)
New Revision: 17

Removed:
   trunk/kernel.map
Modified:
   trunk/TODO
   trunk/include/mem/buddy.h
   trunk/include/mem/fismem.h
   trunk/mem/buddy.c
   trunk/mem/fismem.c
   trunk/mem/paging.c
   trunk/shell/shell.c
Log:
Modifiche non definitive - Potrebbero nelle prossime versioni sparire, o cambiare radicalmente.
Aggiunto comando try_buddy per provare l'allocazione del buddy system.
Aggiunte funzioni alloc_buddy (iniziata una bozza)
		  create_buddy
Rinominata malloc e free di fismem.c in fis_malloc e fis_free
Stampa del logo in ascii art dopo il boot.


Modified: trunk/TODO
===================================================================
--- trunk/TODO	2008-07-27 22:04:48 UTC (rev 16)
+++ trunk/TODO	2008-08-07 20:40:19 UTC (rev 17)
@@ -18,6 +18,7 @@
 - bitmasks per interpretare errori del pagefault.
 - Rivedere il comando info della shell, probabilmente stampa alcune informazioni sbagliate
 - Script per generare automaticamente il file immagine grub.img
+- Quando il comando non esiste stmapre "nome-comando not-found" 
 
 
 PROGETTI A LUNGO TERMINE:

Modified: trunk/include/mem/buddy.h
===================================================================
--- trunk/include/mem/buddy.h	2008-07-27 22:04:48 UTC (rev 16)
+++ trunk/include/mem/buddy.h	2008-08-07 20:40:19 UTC (rev 17)
@@ -25,16 +25,20 @@
 #ifndef BUDDY_H
 #define BUDDY_H
 
+#define BUDDY_BUSY 1
+#define BUDDY_FREE 0
 /*!  \struct buddy_t
      \brief Struttura dati che mantiene le informazioni su un singolo buddy
  */
 typedef struct {
     unsigned int start_address; /**< Indirizzo di inizio del buddy*/
     unsigned int size; /**< Dimensione della memoria da gestire*/
+    short int status; /**< Indica se il nodo e' occupato o meno*/
     struct buddy_t* left; /**< Figlio sinistro*/
     struct buddy_t* right; /**< Figlio destro*/
 } buddy_t;
 
 buddy_t* new_buddy();
-
+buddy_t* create_buddy(int);
+unsigned int alloc_buddy(int, buddy_t*);
 #endif
\ No newline at end of file

Modified: trunk/include/mem/fismem.h
===================================================================
--- trunk/include/mem/fismem.h	2008-07-27 22:04:48 UTC (rev 16)
+++ trunk/include/mem/fismem.h	2008-08-07 20:40:19 UTC (rev 17)
@@ -70,6 +70,6 @@
 size_t get_bmpelements();
 int add_memarea_element(size_t, int);
 
-void *malloc(const size_t);
-void free(void *);
+void *fis_malloc(const size_t);
+void fis_free(void *);
 #endif

Deleted: trunk/kernel.map
===================================================================
--- trunk/kernel.map	2008-07-27 22:04:48 UTC (rev 16)
+++ trunk/kernel.map	2008-08-07 20:40:19 UTC (rev 17)
@@ -1,402 +0,0 @@
-
-Allocating common symbols
-Common symbol       size              file
-
-IntTable            0x400             processore/idt.o
-downbuffer          0xfa0             io/video.o
-mem_bitmap          0x20000           mem/fismem.o
-upbuffer            0xfa0             io/video.o
-IDT_Table           0x800             processore/idt.o
-cpu_vendor          0xc               kernel.o
-shell_mess          0x2               kernel.o
-kbuddy              0x4               mem/buddy.o
-tot_mem             0x4               mem/fismem.o
-slave_cur_mask      0x1               hardware/pic8259.o
-current_page_dir    0x4               mem/paging.o
-Gdt_Table           0x10000           processore/gdt.o
-current_pos         0x4               processore/gdt.o
-current_page_table  0x4               kernel.o
-master_cur_mask     0x1               hardware/pic8259.o
-bmp_elements        0x4               mem/fismem.o
-binvp               0x3fc             io/video.o
-shareHandler        0x40              processore/handlers.o
-
-Memory Configuration
-
-Name             Origin             Length             Attributes
-*default*        0x0000000000000000 0xffffffffffffffff
-
-Linker script and memory map
-
-
-.text           0x0000000000100000     0x5000
-                0x0000000000100000                code = .
-                0x0000000000100000                _code = .
-                0x0000000000100000                __code = .
- *(.text)
- .text          0x0000000000100000       0x29 bl.img
-                0x0000000000100000                mboot
-                0x0000000000100020                start
- *fill*         0x0000000000100029        0x3 00
- .text          0x000000000010002c      0x19d kernel.o
-                0x000000000010003d                main_loop
-                0x000000000010002c                _start
- *fill*         0x00000000001001c9        0x3 00
- .text          0x00000000001001cc      0xa45 io/video.o
-                0x0000000000100b92                _kscrolldown
-                0x00000000001001cc                _kputc
-                0x0000000000100211                _kputs
-                0x00000000001002ad                _kbackspace
-                0x0000000000100a5b                _krotate_buffer
-                0x0000000000100410                _ksetcursauto
-                0x0000000000100296                _kcolor
-                0x000000000010054e                _kdecbin
-                0x00000000001003df                _ksetcursor
-                0x00000000001004a2                _kprintOK
-                0x00000000001002dc                _ktab
-                0x00000000001002ea                _kgoto
-                0x0000000000100385                _knewline
-                0x0000000000100adf                _kscrollup
-                0x0000000000100318                _kclear
-                0x0000000000100514                _kgetline
-                0x0000000000100890                _kntos
-                0x00000000001004ca                _kgetcolumn
-                0x0000000000100617                _kntohex
-                0x0000000000100981                _kshiftAll
- *fill*         0x0000000000100c11        0x3 00
- .text          0x0000000000100c14      0x658 drivers/keyboard.o
-                0x00000000001010d7                _ksetleds
-                0x0000000000101212                _kgetch
-                0x00000000001011f7                keyboard_disable
-                0x00000000001011dc                keyboard_enable
-                0x0000000000100c14                keyboard_isr
- .text          0x000000000010126c      0x1a6 libc/ctype.o
-                0x0000000000101342                islower
-                0x0000000000101392                tolower
-                0x0000000000101307                isxdigit
-                0x000000000010136a                isupper
-                0x0000000000101294                isalpha
-                0x00000000001012ca                isalnum
-                0x000000000010126c                isdigit
-                0x00000000001013d2                toupper
- *fill*         0x0000000000101412        0x2 00
- .text          0x0000000000101414      0x318 libc/string.o
-                0x00000000001015a6                strstr
-                0x0000000000101414                strncpy
-                0x000000000010162d                strtok
-                0x00000000001016bf                strncat
-                0x000000000010152f                strdup
-                0x00000000001014f8                memset
-                0x0000000000101479                _kstrncmp
-                0x000000000010144f                strlen
-                0x0000000000101582                strchr
- .text          0x000000000010172c       0x24 io/io.o
-                0x000000000010172c                inportb
-                0x0000000000101746                outportb
- .text          0x0000000000101750      0x655 libc/stdio.o
-                0x0000000000101750                putchar
-                0x000000000010185f                printf
-                0x0000000000101c4f                gets
-                0x0000000000101c34                getchar
-                0x0000000000101cc4                scanf
-                0x000000000010176b                atoi
- *fill*         0x0000000000101da5        0x3 00
- .text          0x0000000000101da8      0x18c hardware/cpuid.o
-                0x0000000000101da8                get_cpuid
- .text          0x0000000000101f34       0x61 hardware/keyboard.o
-                0x0000000000101f34                keyboard_irq
- *fill*         0x0000000000101f95        0x3 00
- .text          0x0000000000101f98      0x214 processore/gdt.o
-                0x00000000001020b6                add_GDTseg
-                0x0000000000101f98                init_gdt
-                0x0000000000102162                set_gdtr
- .text          0x00000000001021ac      0x790 processore/idt.o
-                0x000000000010289f                add_IDTseg
-                0x00000000001024e1                init_idt
-                0x0000000000102914                set_idtr
- .text          0x000000000010293c      0x33c processore/handlers.o
-                0x000000000010293c                init_funcTable
-                0x0000000000102bde                _irqinterrupt
-                0x00000000001029bf                _globalException
-                0x00000000001029af                add_Interrupt
-                0x0000000000102c67                _int_rsv
- .text          0x0000000000102c78      0x859 hardware/pic8259.o
-                0x0000000000102ea9                init_IRQ
-                0x0000000000103007                setup_IRQ
-                0x0000000000103326                disable_IRQ
-                0x0000000000103408                add_IRQ_handler
-                0x000000000010324e                enable_IRQ
-                0x00000000001033d6                get_current_irq
- *fill*         0x00000000001034d1        0x3 00
- .text          0x00000000001034d4      0x610 mem/fismem.o
-                0x00000000001034d4                init_mem
-                0x000000000010359b                request_pages
-                0x000000000010393b                add_memarea_element
-                0x0000000000103a58                get_numpages
-                0x0000000000103a52                get_memsize
-                0x0000000000103a7e                malloc
-                0x0000000000103a6b                get_bmpelements
-                0x00000000001036fd                release_pages
-                0x0000000000103a36                calcola_memoria
-                0x0000000000103ac1                free
- .text          0x0000000000103ae4      0x328 mem/paging.o
-                0x0000000000103c4b                create_pageTable
-                0x0000000000103ae4                init_paging
-                0x0000000000103d7f                get_pagedir_entry
-                0x0000000000103c30                create_pageDir
-                0x0000000000103dc6                load_pdbr
-                0x0000000000103d2d                set_pagetable_entry_ric
-                0x0000000000103d9c                get_pagetable_entry
-                0x0000000000103c66                set_pagedir_entry
-                0x0000000000103ca7                set_pagedir_entry_ric
-                0x0000000000103cec                set_pagetable_entry
- .text          0x0000000000103e0c       0x9f mem/kheap.o
-                0x0000000000103e0c                kmalloc
-                0x0000000000103e2e                make_heap
- *fill*         0x0000000000103eab        0x1 00
- .text          0x0000000000103eac       0x65 mem/buddy.o
-                0x0000000000103eac                new_buddy
- *fill*         0x0000000000103f11        0x3 00
- .text          0x0000000000103f14       0xcc misc/ordered_array.o
-                0x0000000000103f92                insert_array
-                0x0000000000103f14                new_array
- .text          0x0000000000103fe0       0xdd system/syscall.o
-                0x0000000000104002                syscall_init
-                0x0000000000103fe0                sysputch
-                0x0000000000104038                syscall_handler
- *fill*         0x00000000001040bd        0x3 00
- .text          0x00000000001040c0      0x11e hardware/8253.o
-                0x00000000001041af                sleep
-                0x00000000001040c0                PIT_handler
-                0x0000000000104146                configure_PIT
- *fill*         0x00000000001041de        0x2 00
- .text          0x00000000001041e0      0x4b6 shell/shell.o
-                0x0000000000104224                info
-                0x00000000001043b7                shell
-                0x0000000000104653                aalogo
-                0x0000000000104212                poweroff
-                0x00000000001041ff                help
-                0x00000000001041e0                logo
-                0x0000000000105000                . = ALIGN (0x1000)
- *fill*         0x0000000000104696      0x96a 00
-
-.rel.dyn        0x0000000000105000        0x0
- .rel.text      0x0000000000000000        0x0 bl.img
- .rel.data      0x0000000000000000        0x0 bl.img
-
-.data           0x0000000000105000     0x1000
-                0x0000000000105000                data = .
-                0x0000000000105000                _data = .
-                0x0000000000105000                __data = .
- *(.data)
- .data          0x0000000000105000        0x0 kernel.o
- .data          0x0000000000105000        0x9 io/video.o
-                0x0000000000105004                VIDEO_PTR
-                0x0000000000105008                VIDEO_CLR
-                0x0000000000105000                VIDEO_MEM
- *fill*         0x0000000000105009       0x17 00
- .data          0x0000000000105020      0x2f8 drivers/keyboard.o
- .data          0x0000000000105318        0x0 libc/ctype.o
- .data          0x0000000000105318        0x0 libc/string.o
- .data          0x0000000000105318        0x0 io/io.o
- .data          0x0000000000105318        0x0 libc/stdio.o
- .data          0x0000000000105318        0x0 hardware/cpuid.o
- .data          0x0000000000105318        0x0 hardware/keyboard.o
- .data          0x0000000000105318        0x0 processore/gdt.o
- .data          0x0000000000105318        0x0 processore/idt.o
- .data          0x0000000000105318        0x0 processore/handlers.o
- .data          0x0000000000105318        0x0 hardware/pic8259.o
- .data          0x0000000000105318        0xc mem/fismem.o
-                0x0000000000105318                prova2
-                0x000000000010531c                mem_info_root
-                0x0000000000105320                mem_info
- .data          0x0000000000105324        0x0 mem/paging.o
- .data          0x0000000000105324        0x4 mem/kheap.o
-                0x0000000000105324                address_cur
- .data          0x0000000000105328        0x0 mem/buddy.o
- .data          0x0000000000105328        0x0 misc/ordered_array.o
- .data          0x0000000000105328        0x4 system/syscall.o
-                0x0000000000105328                syscall_table
- .data          0x000000000010532c        0x0 hardware/8253.o
- .data          0x000000000010532c        0x0 shell/shell.o
- *(.rodata)
- .rodata        0x000000000010532c       0xf7 kernel.o
- .rodata        0x0000000000105423       0x5f io/video.o
- .rodata        0x0000000000105482       0x10 drivers/keyboard.o
- .rodata        0x0000000000105492        0x2 libc/stdio.o
- .rodata        0x0000000000105494       0x3e hardware/cpuid.o
- .rodata        0x00000000001054d2       0x1d hardware/keyboard.o
- *fill*         0x00000000001054ef        0x1 00
- .rodata        0x00000000001054f0      0x23e processore/handlers.o
- *fill*         0x000000000010572e        0x2 00
- .rodata        0x0000000000105730       0x8a mem/fismem.o
- *fill*         0x00000000001057ba        0x2 00
- .rodata        0x00000000001057bc       0x23 mem/paging.o
- .rodata        0x00000000001057df       0x1b mem/buddy.o
- .rodata        0x00000000001057fa       0x1e misc/ordered_array.o
- .rodata        0x0000000000105818      0x42f shell/shell.o
-                0x0000000000106000                . = ALIGN (0x1000)
- *fill*         0x0000000000105c47      0x3b9 00
-
-.bss            0x0000000000106000    0x33ff0
-                0x0000000000106000                bss = .
-                0x0000000000106000                _bss = .
-                0x0000000000106000                __bss = .
- *(.bss)
- .bss           0x0000000000106000        0x0 kernel.o
- .bss           0x0000000000106000       0x10 io/video.o
-                0x0000000000106004                is_shifted_once
-                0x0000000000106000                is_scrolled
-                0x000000000010600c                resulthex
-                0x0000000000106008                binlen
- *fill*         0x0000000000106010       0x10 00
- .bss           0x0000000000106020      0x434 drivers/keyboard.o
- .bss           0x0000000000106454        0x0 libc/ctype.o
- .bss           0x0000000000106454        0x4 libc/string.o
- .bss           0x0000000000106458        0x0 io/io.o
- .bss           0x0000000000106458        0x0 libc/stdio.o
- .bss           0x0000000000106458        0x0 hardware/cpuid.o
- .bss           0x0000000000106458        0x0 hardware/keyboard.o
- .bss           0x0000000000106458        0x0 processore/gdt.o
- .bss           0x0000000000106458        0x0 processore/idt.o
- .bss           0x0000000000106458        0x0 processore/handlers.o
- .bss           0x0000000000106458        0x0 hardware/pic8259.o
- .bss           0x0000000000106458        0x4 mem/fismem.o
-                0x0000000000106458                num_pages
- .bss           0x000000000010645c        0x0 mem/paging.o
- .bss           0x000000000010645c        0x4 mem/kheap.o
-                0x000000000010645c                kheap
- .bss           0x0000000000106460        0x0 mem/buddy.o
- .bss           0x0000000000106460        0x0 misc/ordered_array.o
- .bss           0x0000000000106460        0x0 system/syscall.o
- .bss           0x0000000000106460        0x8 hardware/8253.o
- .bss           0x0000000000106468        0x0 shell/shell.o
-                0x0000000000107000                . = ALIGN (0x1000)
- *fill*         0x0000000000106468      0xb98 00
- COMMON         0x0000000000107000       0x14 kernel.o
-                0x0000000000107000                cpu_vendor
-                0x000000000010700c                shell_mess
-                0x0000000000107010                current_page_table
- *fill*         0x0000000000107014        0xc 00
- COMMON         0x0000000000107020     0x233c io/video.o
-                0x0000000000107020                downbuffer
-                0x0000000000107fc0                upbuffer
-                0x0000000000108f60                binvp
- *fill*         0x000000000010935c        0x4 00
- COMMON         0x0000000000109360    0x10004 processore/gdt.o
-                0x0000000000109360                Gdt_Table
-                0x0000000000119360                current_pos
- *fill*         0x0000000000119364       0x1c 00
- COMMON         0x0000000000119380      0xc00 processore/idt.o
-                0x0000000000119380                IntTable
-                0x0000000000119780                IDT_Table
- COMMON         0x0000000000119f80       0x40 processore/handlers.o
-                0x0000000000119f80                shareHandler
- COMMON         0x0000000000119fc0        0x2 hardware/pic8259.o
-                0x0000000000119fc0                slave_cur_mask
-                0x0000000000119fc1                master_cur_mask
- *fill*         0x0000000000119fc2       0x1e 00
- COMMON         0x0000000000119fe0    0x20008 mem/fismem.o
-                0x0000000000119fe0                mem_bitmap
-                0x0000000000139fe0                tot_mem
-                0x0000000000139fe4                bmp_elements
- COMMON         0x0000000000139fe8        0x4 mem/paging.o
-                0x0000000000139fe8                current_page_dir
- COMMON         0x0000000000139fec        0x4 mem/buddy.o
-                0x0000000000139fec                kbuddy
-                0x0000000000139ff0                end = .
-                0x0000000000139ff0                _end = .
-                0x0000000000139ff0                __end = .
-LOAD bl.img
-LOAD kernel.o
-LOAD io/video.o
-LOAD drivers/keyboard.o
-LOAD libc/ctype.o
-LOAD libc/string.o
-LOAD io/io.o
-LOAD libc/stdio.o
-LOAD hardware/cpuid.o
-LOAD hardware/keyboard.o
-LOAD processore/gdt.o
-LOAD processore/idt.o
-LOAD processore/handlers.o
-LOAD hardware/pic8259.o
-LOAD mem/fismem.o
-LOAD mem/paging.o
-LOAD mem/kheap.o
-LOAD mem/buddy.o
-LOAD misc/ordered_array.o
-LOAD system/syscall.o
-LOAD hardware/8253.o
-LOAD shell/shell.o
-Address of section .text set to 0x100000
-OUTPUT(kernel.bin elf32-i386)
-
-.comment        0x0000000000000000      0x280
- .comment       0x0000000000000000       0x1f bl.img
- .comment       0x000000000000001f       0x1d kernel.o
- .comment       0x000000000000003c       0x1d io/video.o
- .comment       0x0000000000000059       0x1d drivers/keyboard.o
- .comment       0x0000000000000076       0x1d libc/ctype.o
- .comment       0x0000000000000093       0x1d libc/string.o
- .comment       0x00000000000000b0       0x1d io/io.o
- .comment       0x00000000000000cd       0x1d libc/stdio.o
- .comment       0x00000000000000ea       0x1d hardware/cpuid.o
- .comment       0x0000000000000107       0x1d hardware/keyboard.o
- .comment       0x0000000000000124       0x1d processore/gdt.o
- .comment       0x0000000000000141       0x1d processore/idt.o
- .comment       0x000000000000015e       0x1d processore/handlers.o
- .comment       0x000000000000017b       0x1d hardware/pic8259.o
- .comment       0x0000000000000198       0x1d mem/fismem.o
- .comment       0x00000000000001b5       0x1d mem/paging.o
- .comment       0x00000000000001d2       0x1d mem/kheap.o
- .comment       0x00000000000001ef       0x1d mem/buddy.o
- .comment       0x000000000000020c       0x1d misc/ordered_array.o
- .comment       0x0000000000000229       0x1d system/syscall.o
- .comment       0x0000000000000246       0x1d hardware/8253.o
- .comment       0x0000000000000263       0x1d shell/shell.o
-
-.note.GNU-stack
-                0x0000000000000000        0x0
- .note.GNU-stack
-                0x0000000000000000        0x0 kernel.o
- .note.GNU-stack
-                0x0000000000000000        0x0 io/video.o
- .note.GNU-stack
-                0x0000000000000000        0x0 drivers/keyboard.o
- .note.GNU-stack
-                0x0000000000000000        0x0 libc/ctype.o
- .note.GNU-stack
-                0x0000000000000000        0x0 libc/string.o
- .note.GNU-stack
-                0x0000000000000000        0x0 io/io.o
- .note.GNU-stack
-                0x0000000000000000        0x0 libc/stdio.o
- .note.GNU-stack
-                0x0000000000000000        0x0 hardware/cpuid.o
- .note.GNU-stack
-                0x0000000000000000        0x0 hardware/keyboard.o
- .note.GNU-stack
-                0x0000000000000000        0x0 processore/gdt.o
- .note.GNU-stack
-                0x0000000000000000        0x0 processore/idt.o
- .note.GNU-stack
-                0x0000000000000000        0x0 processore/handlers.o
- .note.GNU-stack
-                0x0000000000000000        0x0 hardware/pic8259.o
- .note.GNU-stack
-                0x0000000000000000        0x0 mem/fismem.o
- .note.GNU-stack
-                0x0000000000000000        0x0 mem/paging.o
- .note.GNU-stack
-                0x0000000000000000        0x0 mem/kheap.o
- .note.GNU-stack
-                0x0000000000000000        0x0 mem/buddy.o
- .note.GNU-stack
-                0x0000000000000000        0x0 misc/ordered_array.o
- .note.GNU-stack
-                0x0000000000000000        0x0 system/syscall.o
- .note.GNU-stack
-                0x0000000000000000        0x0 hardware/8253.o
- .note.GNU-stack
-                0x0000000000000000        0x0 shell/shell.o

Modified: trunk/mem/buddy.c
===================================================================
--- trunk/mem/buddy.c	2008-07-27 22:04:48 UTC (rev 16)
+++ trunk/mem/buddy.c	2008-08-07 20:40:19 UTC (rev 17)
@@ -37,7 +37,45 @@
     printf("end: %x | address_cur: %x\n", &end, address_cur);
     temp->start_address = address_cur;
     temp->size = 65536; //da cambiare
+    temp->status = BUDDY_BUSY;
     temp->left = NULL;
     temp->right = NULL;
     return temp;
+}
+
+unsigned int alloc_buddy(int size, buddy_t* tmp_buddy){
+    buddy_t* cur_buddy;    
+    int new_size;
+    cur_buddy = tmp_buddy;
+    if(size>1){
+        new_size = cur_buddy->size/2;
+        if(tmp_buddy->left==NULL && tmp_buddy->right==NULL){
+            new_size = tmp_buddy->size/2;
+            printf("Ok\n");             
+            tmp_buddy->left = create_buddy(new_size);
+            if(new_size/2>=size) alloc_buddy(size,cur_buddy->left);
+            else tmp_buddy->status == BUDDY_BUSY;
+        }
+        else if(tmp_buddy->left!=NULL && tmp_buddy->status==BUDDY_FREE){            
+            alloc_buddy(size, tmp_buddy->left);
+        } else if(tmp_buddy->right!=NULL && tmp_buddy->status==BUDDY_FREE){
+            alloc_buddy(size, tmp_buddy->right);
+        }
+        else{
+            printf("Se sono nell'else allora devo proseguire nella navigazione\n");            
+            alloc_buddy(size/2,tmp_buddy);
+        }      
+    }
+//     else printf("Otherwise ok\n");
+}
+
+buddy_t* create_buddy(int size){    
+    buddy_t* new_buddy;
+    new_buddy = (buddy_t*) kmalloc(sizeof(buddy_t));
+    new_buddy->status = BUDDY_FREE;
+    new_buddy->left = NULL;    
+    new_buddy->right = NULL;
+    new_buddy->size = size;
+    printf("Creating buddy at address: 0x%x with buddy size: %d\n", new_buddy, new_buddy->size);
+    return new_buddy;
 }
\ No newline at end of file

Modified: trunk/mem/fismem.c
===================================================================
--- trunk/mem/fismem.c	2008-07-27 22:04:48 UTC (rev 16)
+++ trunk/mem/fismem.c	2008-08-07 20:40:19 UTC (rev 17)
@@ -274,10 +274,10 @@
 }
 
 /*Da spostare appena termintao il gestore della memoria*/
-void *malloc(const size_t size){
+void *fis_malloc(const size_t size){
     return request_pages(size % 4096 ? size / 4096 + 1 : size / 4096, ADD_LIST);
 }
 
-void free(void *address){
+void fis_free(void *address){
     if(release_pages(address)!=0) printf("Error\n");
 }

Modified: trunk/mem/paging.c
===================================================================
--- trunk/mem/paging.c	2008-07-27 22:04:48 UTC (rev 16)
+++ trunk/mem/paging.c	2008-08-07 20:40:19 UTC (rev 17)
@@ -67,7 +67,7 @@
     }        
     load_pdbr((unsigned int)current_page_dir);
     kheap = make_heap(10,10,10);
-    kbuddy = new_buddy();
+    kbuddy = new_buddy();    
 }
 
 /**

Modified: trunk/shell/shell.c
===================================================================
--- trunk/shell/shell.c	2008-07-27 22:04:48 UTC (rev 16)
+++ trunk/shell/shell.c	2008-08-07 20:40:19 UTC (rev 17)
@@ -36,7 +36,9 @@
 #include <use.h>
 #include <shell.h>
 #include <kheap.h>
+#include <buddy.h>
 
+extern buddy_t* kbuddy;
 void logo()
 {
 	printf("\t-------------------------- \n"
@@ -54,6 +56,7 @@
            "kmalloc  - Test a basic kmalloc function\n"
            "do_fault - Test a page_fault (WARNING: This hang the OS)\n"
            "aalogo - Show an ascii art logo\n"
+           "try_buddy - Try buddy mmu\n"
 		);
 }
 
@@ -98,7 +101,7 @@
 	unsigned char cmd[256];
 	//char *cmd=malloc(256); Dio maiale, Page Fault con il puntatore...
 	int a = 1;
-	logo();
+	aalogo();
 
         shell_mess = 7;
 	for (;;)
@@ -153,7 +156,14 @@
             *prova = 10;
             cmd[a]=NULL;
         }
+        else if (!(_kstrncmp(cmd,"try_buddy",9))){
+             printf("L'indirizzo di kbuddy e': 0x%x\n", kbuddy);
+             alloc_buddy(16, kbuddy);
+             printf("New allocation\n\n");
+             alloc_buddy(8, kbuddy);
+        }
         else if (!(_kstrncmp(cmd,"aalogo",6))) aalogo();        
+        cmd[a]=NULL;
 	}
 
 }
@@ -163,5 +173,5 @@
 printf("\t|    \\ ___ ___ ___ _____|     |   __|\n");
 printf("\t|  |  |  _| -_| = |     |  |  |__   |\n");
 printf("\t|____/|_| |___|__||_|_|_|_____|_____|\n");
-printf("\t Rev16\n\n\n");
-}
\ No newline at end of file
+printf("\t Rev17\n");
+}



From finarfin at mail.berlios.de  Wed Aug 20 16:07:25 2008
From: finarfin at mail.berlios.de (finarfin at mail.berlios.de)
Date: Wed, 20 Aug 2008 16:07:25 +0200
Subject: [Dreamos-dev] r18 - in trunk: . include/mem mem
Message-ID: <200808201407.m7KE7P1J031774@sheep.berlios.de>

Author: finarfin
Date: 2008-08-20 16:07:02 +0200 (Wed, 20 Aug 2008)
New Revision: 18

Modified:
   trunk/dreamos.img
   trunk/include/mem/fismem.h
   trunk/kernel.c
   trunk/mem/fismem.c
Log:
Si tratta di una bugfix.
L'allocazione fisica di pagine non funzionava, in quanto non era stata inizializzata la variabile 
bmp_elements. Ora questa variabile e' inizializzata a un numero di elementi che contiene la ram fisica 
disponibile.


Modified: trunk/dreamos.img
===================================================================
(Binary files differ)

Modified: trunk/include/mem/fismem.h
===================================================================
--- trunk/include/mem/fismem.h	2008-08-07 20:40:19 UTC (rev 17)
+++ trunk/include/mem/fismem.h	2008-08-20 14:07:02 UTC (rev 18)
@@ -69,6 +69,7 @@
 size_t get_numpages();
 size_t get_bmpelements();
 int add_memarea_element(size_t, int);
+void set_memorysize(unsigned int);
 
 void *fis_malloc(const size_t);
 void fis_free(void *);

Modified: trunk/kernel.c
===================================================================
--- trunk/kernel.c	2008-08-07 20:40:19 UTC (rev 17)
+++ trunk/kernel.c	2008-08-20 14:07:02 UTC (rev 18)
@@ -51,7 +51,7 @@
 
 int main_loop(struct multiboot_info *boot_info)
 {    
-
+    unsigned int* provatore;
     _kclear();
     syscall_init();
     _kcolor('\012');
@@ -65,25 +65,22 @@
     _kputs("\n");    
     _kputs(LNG_GDT);
     init_gdt();
-    _kprintOK();
-
+    _kprintOK();    
     outportb(0xFF, MASTER_PORT_1);
     outportb(0xFF, SLAVE_PORT_1);
     _kputs(LNG_IDT);
 
     asm("cli");   
     init_idt();
-    _kprintOK();
-    
-    calcola_memoria();    
+    _kprintOK();    
+//     calcola_memoria();    
+    set_memorysize((boot_info->mem_upper+boot_info->mem_lower)*1024);
     init_mem();    
     _kputs(LNG_PIC8259);
     init_IRQ();
     asm("sti");
     _kprintOK();   
-    printf("End: %d\n", end);
-    init_paging();    
-
+    printf("End: %d\n", end);    
     printf(LNG_PIT8253);
     //configure_PIT ();
     _kprintOK();
@@ -92,6 +89,7 @@
      "movl $37, %ebx\n"
      "int $80");    */
     printf("Memory (upper) amount-> %d kb \n", boot_info->mem_upper);
+    printf("Memory (lower) amount-> %d kb end \n", boot_info->mem_lower);    
     get_cpuid();    
     printf("\n");    
     printf("----\n");

Modified: trunk/mem/fismem.c
===================================================================
--- trunk/mem/fismem.c	2008-08-07 20:40:19 UTC (rev 17)
+++ trunk/mem/fismem.c	2008-08-20 14:07:02 UTC (rev 18)
@@ -41,14 +41,16 @@
 
 void init_mem(){
     int i=0;
+    int remainder=0;
     mem_info = mem_info_root;
     while(i<BITMAP_SIZE){
         if(i<16)mem_bitmap.mem_map[i] = 0xFFFFFFFF;
         else mem_bitmap.mem_map[i] = 0x00000000;
         i++;
     }
-    i=0;
-
+    i=0;    
+    bmp_elements = (tot_mem/4096)/32;    
+    //     printf("bmp_elements: %d\n", bmp_elements);
     //Ho allocato il primo elemento di mem_info, spazio dedicato al kernel
     mem_info->pages_info[0].inizio= 0x00000000;
     mem_info->pages_info[0].num_pagine = 512;
@@ -281,3 +283,15 @@
 void fis_free(void *address){
     if(release_pages(address)!=0) printf("Error\n");
 }
+
+
+/**
+  * Configura una nuova dimensione per la memoria fisica, va chiamata prima di init_mem
+  * @author Ivan Gualandri
+  * @version 1.0
+  * @param new_size La nuova dimensione per la memoria.
+  * @return void. 
+  */
+void set_memorysize(unsigned int new_size){
+    tot_mem = new_size;
+}
\ No newline at end of file



From osiris_h4ck at mail.berlios.de  Tue Aug 26 19:43:49 2008
From: osiris_h4ck at mail.berlios.de (osiris_h4ck at BerliOS)
Date: Tue, 26 Aug 2008 19:43:49 +0200
Subject: [Dreamos-dev] r19 - in trunk: . shell
Message-ID: <200808261743.m7QHhnPQ006249@sheep.berlios.de>

Author: osiris_h4ck
Date: 2008-08-26 19:43:49 +0200 (Tue, 26 Aug 2008)
New Revision: 19

Modified:
   trunk/Makefile
   trunk/kernel.c
   trunk/shell/shell.c
   trunk/start.sh
Log:


Modified: trunk/Makefile
===================================================================
--- trunk/Makefile	2008-08-20 14:07:02 UTC (rev 18)
+++ trunk/Makefile	2008-08-26 17:43:49 UTC (rev 19)
@@ -1,4 +1,5 @@
 CFLAGS = -nostdlib -fomit-frame-pointer -fno-builtin -fno-stack-protector -Wall -march=i686 -m32 -I./include -I./include/io -I./include/drivers -I./include/libc -I./include/processore -I./include/hardware -I./include/mem -I./include/system -I./include/shell -I./include/misc
+
 OBJ = kernel.o io/video.o drivers/keyboard.o libc/ctype.o libc/string.o io/io.o libc/stdio.o hardware/cpuid.o hardware/keyboard.o processore/gdt.o processore/idt.o processore/handlers.o hardware/pic8259.o mem/fismem.o mem/paging.o mem/kheap.o mem/buddy.o misc/ordered_array.o system/syscall.o hardware/8253.o shell/shell.o
 
 dreamos.img: bl.img kernel.bin
@@ -38,7 +39,14 @@
 	mount -o loop boot/grub.img boot/os
 	cp dreamos.img boot/os/boot/grub/
 	umount boot/os
+# End :)
 
+vers: 
+	 #sed -i -e "14d" include/version.h
+	 #echo "#define REV_NUM \"-r`cat .svn/entries | head -n 4 | tail -n 1`"\" >> include/version.h
+	 #echo "-r`cat .svn/entries | head -n 4 | tail -n 1`" > vers.txt
+	 sed -i -e "/^#define REV_NUM/s/\".*\"/\""-r`cat .svn/entries | head -n 4 | tail -n 1`"\"/" include/version.h
+
 .PHONY: clean install qemu
 
 clean:

Modified: trunk/kernel.c
===================================================================
--- trunk/kernel.c	2008-08-20 14:07:02 UTC (rev 18)
+++ trunk/kernel.c	2008-08-26 17:43:49 UTC (rev 19)
@@ -40,6 +40,7 @@
 #include <use.h>
 #include <shell.h>
 
+
 unsigned int *current_page_table;
 extern unsigned int end;
 // multiboot_info_t *boot_informations;
@@ -79,7 +80,8 @@
     _kputs(LNG_PIC8259);
     init_IRQ();
     asm("sti");
-    _kprintOK();   
+    _kprintOK();
+    init_paging();   
     printf("End: %d\n", end);    
     printf(LNG_PIT8253);
     //configure_PIT ();
@@ -88,14 +90,34 @@
     /*asm ("movl $0, %eax\n"
      "movl $37, %ebx\n"
      "int $80");    */
+
     printf("Memory (upper) amount-> %d kb \n", boot_info->mem_upper);
     printf("Memory (lower) amount-> %d kb end \n", boot_info->mem_lower);    
     get_cpuid();    
     printf("\n");    
-    printf("----\n");
-    printf("Loading the shell..\n");
-    printf("[+] Loading complete!!\n\n");    
-    printf("End: %d Address: 0x%x\n", end, &end);
 
-    shell();
+    printf("\n\n[+] It's TODO ok ------------------------------------------>");
+    _kprintOK();
+    printf("Now you can try the OS with the Shell\n\n");
+    printf(" [?] Would you like to load the shell ? [Y/n] ");
+    char choise[16];
+    scanf("%s",choise);
+	if (!(_kstrncmp(choise,"Y",1) ) || !(_kstrncmp(choise,"y",1)))
+   	{
+		printf("\n----\n");
+    		printf("Loading the shell..\n");
+		printf("[+] End: %d \n"
+		       "[+] Address: 0x%x\n", end, &end);
+		printf("[+] Loading complete!!");   
+   	        _kprintOK();
+		printf("\n\n");
+		shell();
+	 }
+		else {
+			printf("\n\n[-] Mmh.. fuck.\n\n");
+			poweroff();
+			
+	        }
+
 }
+

Modified: trunk/shell/shell.c
===================================================================
--- trunk/shell/shell.c	2008-08-20 14:07:02 UTC (rev 18)
+++ trunk/shell/shell.c	2008-08-26 17:43:49 UTC (rev 19)
@@ -37,27 +37,29 @@
 #include <shell.h>
 #include <kheap.h>
 #include <buddy.h>
+#include <version.h>
 
+
+
 extern buddy_t* kbuddy;
 void logo()
 {
-	printf("\t-------------------------- \n"
-	       "\tThe Dream Operating System \n"
-	       "\t      v0.01 pre-alpha      \n"
-	       "\t-------------------------- \n");
-	printf("\n\n\n");
+	printf("\n\n\t\t-------------------------- \n"
+	       "\t\tThe Dream Operating System \n"
+	       "\t\t      v0.01 pre-alpha      \n"
+	       "\t\t-------------------------- \n");
+	printf("\n\n\n\n\n\n");
 }
 
 void help()
 {
-	printf("help     - See the 'help' list to learn the DreamOS command now avaible\n"
-	       "poweroff - Turn off the machine\n"
-	       "info     - See the system info about Memory and other stuffs like that\n"
-           "kmalloc  - Test a basic kmalloc function\n"
-           "do_fault - Test a page_fault (WARNING: This hang the OS)\n"
-           "aalogo - Show an ascii art logo\n"
-           "try_buddy - Try buddy mmu\n"
-		);
+	printf("help      - See the 'help' list to learn the DreamOS command now avaible\n"
+	       "poweroff  - Turn off the machine\n"
+	       "info      - See the system info about Memory and other stuffs like that\n"
+               "kmalloc   - Test a basic kmalloc function\n"
+               "do_fault  - Test a page_fault (WARNING: This hang the OS)\n"
+               "aalogo    - Show an ascii art logo\n"
+               "try_buddy - Try buddy mmu\n");
 }
 
 void poweroff()
@@ -66,7 +68,7 @@
 		"int $0xff\n"
 		: : "g"(1)); // valore di enum*/
     asm("hlt");
-    printf("E' ora possibile spegnere il computer\n");
+    printf("E' ora possibile spegnere il computer.\n");
     while(1);
 }
 
@@ -98,8 +100,9 @@
 
 void shell(void)
 {
-	unsigned char cmd[256];
+	//unsigned char cmd[256];
 	//char *cmd=malloc(256); Dio maiale, Page Fault con il puntatore...
+	char *cmd;
 	int a = 1;
 	aalogo();
 
@@ -107,7 +110,9 @@
 	for (;;)
 	{
 		_kputs("root~# ");
-	        scanf("%s",cmd);
+	        //scanf("%s",cmd);	// scanf non va bene per gli argomenti..
+		gets(cmd); //vulnerabile, da correggere, poi prevvedo na cosa alla volta :P 
+
 		if (!(_kstrncmp(cmd,"help",4) ) )
 		{
 			printf("Available command: \n");
@@ -122,6 +127,12 @@
 			cmd[a]=NULL;
 		}
 		
+		else if (!(_kstrncmp(cmd, "uname",5)))
+		{
+			printf("%s %s.%s.%s%s #1 beta CEST 2008 %s\n",NAME,VERSION,PATCHLEVEL,REV_NUM,EXTRAVERSION,cpu_vendor);
+
+		}
+
 		else if (!(_kstrncmp(cmd,"info",4)))
 		{
 			info();
@@ -169,9 +180,12 @@
 }
 
 void aalogo() {
+//printf("\n\n");
 printf("\t____                     _____ _____\n");
 printf("\t|    \\ ___ ___ ___ _____|     |   __|\n");
 printf("\t|  |  |  _| -_| = |     |  |  |__   |\n");
 printf("\t|____/|_| |___|__||_|_|_|_____|_____|\n");
-printf("\t Rev17\n");
+printf("\t|------rev: \"%s\"|\n",REV_NUM);
+printf("\t|:::::::::::......|\n");
+logo();
 }

Modified: trunk/start.sh
===================================================================
--- trunk/start.sh	2008-08-20 14:07:02 UTC (rev 18)
+++ trunk/start.sh	2008-08-26 17:43:49 UTC (rev 19)
@@ -1,4 +1,6 @@
 make clean 
+make vers
 make 
 make img 
 qemu -fda boot/grub.img
+#bochs boot/grub.img



From osiris_h4ck at mail.berlios.de  Tue Aug 26 19:44:22 2008
From: osiris_h4ck at mail.berlios.de (osiris_h4ck at BerliOS)
Date: Tue, 26 Aug 2008 19:44:22 +0200
Subject: [Dreamos-dev] r20 - trunk/include
Message-ID: <200808261744.m7QHiMQx006348@sheep.berlios.de>

Author: osiris_h4ck
Date: 2008-08-26 19:44:22 +0200 (Tue, 26 Aug 2008)
New Revision: 20

Added:
   trunk/include/version.h
Log:


Added: trunk/include/version.h
===================================================================
--- trunk/include/version.h	2008-08-26 17:43:49 UTC (rev 19)
+++ trunk/include/version.h	2008-08-26 17:44:22 UTC (rev 20)
@@ -0,0 +1,14 @@
+/* 
+* What is the Kernel version ? Bhoo
+*  Here the script..
+*  
+*	Coded by Osiris
+*  at jeek69 [at] katamail d0t com
+*
+*/
+
+#define VERSION "0"
+#define PATCHLEVEL "0"
+#define EXTRAVERSION "-dreamos"
+#define NAME "DreamOS"
+#define REV_NUM "-r18"


Property changes on: trunk/include/version.h
___________________________________________________________________
Name: svn:executable
   + *



From osiris_h4ck at mail.berlios.de  Tue Aug 26 19:46:57 2008
From: osiris_h4ck at mail.berlios.de (osiris_h4ck at BerliOS)
Date: Tue, 26 Aug 2008 19:46:57 +0200
Subject: [Dreamos-dev] r21 - trunk/shell
Message-ID: <200808261746.m7QHkv3u006583@sheep.berlios.de>

Author: osiris_h4ck
Date: 2008-08-26 19:46:57 +0200 (Tue, 26 Aug 2008)
New Revision: 21

Modified:
   trunk/shell/shell.c
Log:
Modified some lines in shell, add auto rev, REMEMBER please use ./start.sh


Modified: trunk/shell/shell.c
===================================================================
--- trunk/shell/shell.c	2008-08-26 17:44:22 UTC (rev 20)
+++ trunk/shell/shell.c	2008-08-26 17:46:57 UTC (rev 21)
@@ -110,8 +110,7 @@
 	for (;;)
 	{
 		_kputs("root~# ");
-	        //scanf("%s",cmd);	// scanf non va bene per gli argomenti..
-		gets(cmd); //vulnerabile, da correggere, poi prevvedo na cosa alla volta :P 
+	        scanf("%s",cmd);	// scanf non va bene per gli argomenti..
 
 		if (!(_kstrncmp(cmd,"help",4) ) )
 		{



From osiris_h4ck at mail.berlios.de  Tue Aug 26 20:24:19 2008
From: osiris_h4ck at mail.berlios.de (osiris_h4ck at BerliOS)
Date: Tue, 26 Aug 2008 20:24:19 +0200
Subject: [Dreamos-dev] r22 - in trunk: . include shell
Message-ID: <200808261824.m7QIOJkS010122@sheep.berlios.de>

Author: osiris_h4ck
Date: 2008-08-26 20:24:18 +0200 (Tue, 26 Aug 2008)
New Revision: 22

Modified:
   trunk/Makefile
   trunk/bl.img
   trunk/dreamos.img
   trunk/include/version.h
   trunk/shell/shell.c
   trunk/start.sh
Log:


Modified: trunk/Makefile
===================================================================
--- trunk/Makefile	2008-08-26 17:46:57 UTC (rev 21)
+++ trunk/Makefile	2008-08-26 18:24:18 UTC (rev 22)
@@ -33,18 +33,12 @@
 hardware/8253.o: hardware/8253.c
 shell/shell.o: shell/shell.c
 
-# Autonomatizzazione aggiornamento file immagine distro
-# Only root
 img:
 	mount -o loop boot/grub.img boot/os
 	cp dreamos.img boot/os/boot/grub/
 	umount boot/os
-# End :)
 
 vers: 
-	 #sed -i -e "14d" include/version.h
-	 #echo "#define REV_NUM \"-r`cat .svn/entries | head -n 4 | tail -n 1`"\" >> include/version.h
-	 #echo "-r`cat .svn/entries | head -n 4 | tail -n 1`" > vers.txt
 	 sed -i -e "/^#define REV_NUM/s/\".*\"/\""-r`cat .svn/entries | head -n 4 | tail -n 1`"\"/" include/version.h
 
 .PHONY: clean install qemu

Modified: trunk/bl.img
===================================================================
(Binary files differ)

Modified: trunk/dreamos.img
===================================================================
(Binary files differ)

Modified: trunk/include/version.h
===================================================================
--- trunk/include/version.h	2008-08-26 17:46:57 UTC (rev 21)
+++ trunk/include/version.h	2008-08-26 18:24:18 UTC (rev 22)
@@ -11,4 +11,4 @@
 #define PATCHLEVEL "0"
 #define EXTRAVERSION "-dreamos"
 #define NAME "DreamOS"
-#define REV_NUM "-r18"
+#define REV_NUM "-r21"

Modified: trunk/shell/shell.c
===================================================================
--- trunk/shell/shell.c	2008-08-26 17:46:57 UTC (rev 21)
+++ trunk/shell/shell.c	2008-08-26 18:24:18 UTC (rev 22)
@@ -100,9 +100,9 @@
 
 void shell(void)
 {
-	//unsigned char cmd[256];
-	//char *cmd=malloc(256); Dio maiale, Page Fault con il puntatore...
-	char *cmd;
+	unsigned char cmd[256];
+	//char *cmd=malloc(256); //Dio maiale, Page Fault con il puntatore...
+	//char *cmd;
 	int a = 1;
 	aalogo();
 
@@ -188,3 +188,5 @@
 printf("\t|:::::::::::......|\n");
 logo();
 }
+
+

Modified: trunk/start.sh
===================================================================
--- trunk/start.sh	2008-08-26 17:46:57 UTC (rev 21)
+++ trunk/start.sh	2008-08-26 18:24:18 UTC (rev 22)
@@ -1,3 +1,17 @@
+#!/bin/sh
+# This script is more important to do a right compilation..
+# REMEMBER: if you don't use qemu, please uncomment bochs and comment qemu :)
+# 
+# Coded by Osiris
+
+
+if test -z "$1" 
+then
+echo "Usage: '$0 qemu' -> if you use Qemu Emulator"
+echo "       '$0 bochs' -> if you use Qemu Emulator"
+exit 1
+
+else
 make clean 
 make vers
 make 
@@ -2,3 +16,14 @@
 make img 
+fi
+
+if [ "$1" == "qemu" ]; then
 qemu -fda boot/grub.img
-#bochs boot/grub.img
+exit
+fi
+
+if [ "$1" == "bochs" ]; then
+bochs boot/grub.img
+exit
+fi
+
+



From finarfin at mail.berlios.de  Tue Aug 26 22:36:28 2008
From: finarfin at mail.berlios.de (finarfin at BerliOS)
Date: Tue, 26 Aug 2008 22:36:28 +0200
Subject: [Dreamos-dev] r23 - in trunk: . include include/mem mem shell
Message-ID: <200808262036.m7QKaSUY026871@sheep.berlios.de>

Author: finarfin
Date: 2008-08-26 22:36:26 +0200 (Tue, 26 Aug 2008)
New Revision: 23

Modified:
   trunk/TODO
   trunk/bl.img
   trunk/dreamos.img
   trunk/include/mem/kheap.h
   trunk/include/version.h
   trunk/kernel.c
   trunk/mem/fismem.c
   trunk/mem/kheap.c
   trunk/mem/paging.c
   trunk/shell/shell.c
Log:
Bugfix della shell.
Modificata funzione make_heap, ora inizializza una struttura dati che e' della dimensione della ram
Piccole pulizie di codice (levate dichiarazioni di funzioni inutili, e affine)


Modified: trunk/TODO
===================================================================
--- trunk/TODO	2008-08-26 18:24:18 UTC (rev 22)
+++ trunk/TODO	2008-08-26 20:36:26 UTC (rev 23)
@@ -2,10 +2,8 @@
 
 PROGETTI IMMEDIATI
 - Revisionare stampa esadecimale. Funzione _kprinthex
-- Implementare syscall handler
-- Routine asm per individuare quantita' ram
+- Implementare syscall handler (controllare/terminare)
 - Le routine di gestione degli irq, devono controllare se effettivamente esiste un IRQ per il device che controllano, in caso affermativo proseguono, in caso negativo si fermano.
-- Logo dreamos in ASCII ART :D
 - MMU
 - Funzioni sullo stato registri EFLAGS e CR*
 - RIVEDERE PRINTF - Forse non stampa i numeri troppo lunghi - problema degli unsigned int.
@@ -13,7 +11,6 @@
 - Fare una mega pulizia del codice
 - Eliminare il maggior numero di messaggi di errore dalla compilazione
 - Script che memorizza nei sorci il numero di revisione (genera un file header)
-- fare in modo che quando stampa "root#~" se premo backspace non cancelli quella scritta.
 - Comandi: echo - clear
 - bitmasks per interpretare errori del pagefault.
 - Rivedere il comando info della shell, probabilmente stampa alcune informazioni sbagliate

Modified: trunk/bl.img
===================================================================
(Binary files differ)

Modified: trunk/dreamos.img
===================================================================
(Binary files differ)

Modified: trunk/include/mem/kheap.h
===================================================================
--- trunk/include/mem/kheap.h	2008-08-26 18:24:18 UTC (rev 22)
+++ trunk/include/mem/kheap.h	2008-08-26 20:36:26 UTC (rev 23)
@@ -28,6 +28,7 @@
 #include <ordered_array.h>
 extern unsigned int address_cur;
 
+//Da eliminare
 typedef struct{
     unsigned int magic;
     unsigned int hole;
@@ -38,23 +39,31 @@
     unsigned int magic;
     unsigned int *header;
 } footer_t;
+//Fino qua
 
+/*!  \struct heap_node_t
+     \brief Struttura dati che mantiene le informazioni su locazioni occupate e libere di memoria
+ */
+typedef struct {
+    unsigned int start_address;/**< L'indirizzo di partenza dell'heap*/
+    unsigned int size;    /**< quanto massimo si puo' espandere*/
+    struct heap_node_t* next;
+}heap_node_t;
+
 /*!  \struct heap_t
      \brief Struttura dati che mantiene le informazioni su un singolo heap
  */
 typedef struct{
-    ordered_array_t hole_index; /**< La lista degli holes controllare il tipo*/
-    unsigned int start_address; /**< L'indirizzo di partenza dell'heap*/
-    unsigned int end_address; /**< Fino a dove arriva l'heap attualmente*/
-    unsigned int max_size; /**< quanto massimo si puo' espandere*/
+    heap_node_t* free_list;/**< Locazioni di memoria libere*/
+    heap_node_t* used_list;/**< Locazioni di memoria occupate*/
+    unsigned int max_size; /**< Massima memoria allocabile */
 } heap_t;
 
+
 heap_t* make_heap(unsigned int, unsigned int, unsigned int); //Rivedere il return value
 void* kmalloc(unsigned int);
 void kfree(unsigned int);
 
 void* alloc(unsigned int);
 
-
-
 #endif
\ No newline at end of file

Modified: trunk/include/version.h
===================================================================
--- trunk/include/version.h	2008-08-26 18:24:18 UTC (rev 22)
+++ trunk/include/version.h	2008-08-26 20:36:26 UTC (rev 23)
@@ -11,4 +11,4 @@
 #define PATCHLEVEL "0"
 #define EXTRAVERSION "-dreamos"
 #define NAME "DreamOS"
-#define REV_NUM "-r21"
+#define REV_NUM "-r22"

Modified: trunk/kernel.c
===================================================================
--- trunk/kernel.c	2008-08-26 18:24:18 UTC (rev 22)
+++ trunk/kernel.c	2008-08-26 20:36:26 UTC (rev 23)
@@ -82,9 +82,9 @@
     asm("sti");
     _kprintOK();
     init_paging();   
-    printf("End: %d\n", end);    
+    printf("End: %x\n", end);    
     printf(LNG_PIT8253);
-    //configure_PIT ();
+    configure_PIT ();
     _kprintOK();
 
     /*asm ("movl $0, %eax\n"

Modified: trunk/mem/fismem.c
===================================================================
--- trunk/mem/fismem.c	2008-08-26 18:24:18 UTC (rev 22)
+++ trunk/mem/fismem.c	2008-08-26 20:36:26 UTC (rev 23)
@@ -31,11 +31,10 @@
 size_t tot_mem;
 size_t num_pages=0;
 size_t bmp_elements;
-// byte master_cur_mask;
-// byte slave_cur_mask;
+
 mem_struct mem_bitmap;
-int prova2 = 35;
 
+
 mem_area_pointer mem_info_root = (mem_area_pointer)0x110000;
 mem_area_pointer mem_info = (mem_area_pointer)0x110000;
 

Modified: trunk/mem/kheap.c
===================================================================
--- trunk/mem/kheap.c	2008-08-26 18:24:18 UTC (rev 22)
+++ trunk/mem/kheap.c	2008-08-26 20:36:26 UTC (rev 23)
@@ -22,10 +22,14 @@
  */
 
 #include <kheap.h>
+#include <fismem.h>
 #include <paging.h>
 #include <ordered_array.h>
+#include <stddef.h>
+#include <stdio.h>
 
 extern unsigned int end;
+extern size_t tot_mem;
 heap_t *kheap = 0;
 unsigned int address_cur = (unsigned int) &end;
 
@@ -36,8 +40,9 @@
     address_cur+=size;
     return (void *) temp;
 }
+
 /**
-  * Crea un nuov heap
+  * Build a new heap
   * @author Ivan Gualandri
   * @version 1.0
   * @param start Indirizzo di inizio del nostro heap
@@ -47,10 +52,18 @@
   */
 heap_t* make_heap(unsigned int start, unsigned int end, unsigned int size){
     heap_t* new_heap;
+    heap_node_t* first_node;
     new_heap = (heap_t*)kmalloc(sizeof(heap_t));
-    new_heap->hole_index = new_array(10,10,10); //decidere i valori
-    new_heap->start_address = start;
-    new_heap->end_address = end;
-    new_heap->max_size = size;
+    first_node = (heap_node_t*)kmalloc(sizeof(heap_node_t));
+    first_node->start_address = (unsigned int)&end;
+    first_node->size = size;
+    new_heap->max_size = tot_mem-(unsigned int) &end;
+    new_heap->free_list = first_node;
+    new_heap->used_list = NULL;
+    printf("First heap created...\n");   
+    printf("Size: %d - Tot mem: %d\n", first_node->size, tot_mem);
     return (heap_t*) new_heap;
+}
+
+void* alloc(unsigned int size){
 }
\ No newline at end of file

Modified: trunk/mem/paging.c
===================================================================
--- trunk/mem/paging.c	2008-08-26 18:24:18 UTC (rev 22)
+++ trunk/mem/paging.c	2008-08-26 20:36:26 UTC (rev 23)
@@ -33,6 +33,8 @@
 
 unsigned int *current_page_dir;
 unsigned int *current_page_table;
+extern size_t tot_mem;
+extern unsigned int end;
 extern heap_t *kheap;
 extern buddy_t *kbuddy;
 
@@ -66,7 +68,7 @@
         i++;
     }        
     load_pdbr((unsigned int)current_page_dir);
-    kheap = make_heap(10,10,10);
+    kheap = make_heap(10,10,tot_mem - ((unsigned int) &end));
     kbuddy = new_buddy();    
 }
 

Modified: trunk/shell/shell.c
===================================================================
--- trunk/shell/shell.c	2008-08-26 18:24:18 UTC (rev 22)
+++ trunk/shell/shell.c	2008-08-26 20:36:26 UTC (rev 23)
@@ -59,6 +59,7 @@
                "kmalloc   - Test a basic kmalloc function\n"
                "do_fault  - Test a page_fault (WARNING: This hang the OS)\n"
                "aalogo    - Show an ascii art logo\n"
+               "uname     - Print kernel version\n"
                "try_buddy - Try buddy mmu\n");
 }
 
@@ -106,7 +107,7 @@
 	int a = 1;
 	aalogo();
 
-        shell_mess = 7;
+    shell_mess = 7;
 	for (;;)
 	{
 		_kputs("root~# ");
@@ -171,8 +172,10 @@
              alloc_buddy(16, kbuddy);
              printf("New allocation\n\n");
              alloc_buddy(8, kbuddy);
+            cmd[a] = NULL;
         }
         else if (!(_kstrncmp(cmd,"aalogo",6))) aalogo();        
+        else printf("Error %s\n", cmd);
         cmd[a]=NULL;
 	}
 



From osiris_h4ck at mail.berlios.de  Wed Aug 27 10:56:23 2008
From: osiris_h4ck at mail.berlios.de (osiris_h4ck at BerliOS)
Date: Wed, 27 Aug 2008 10:56:23 +0200
Subject: [Dreamos-dev] r24 - in trunk: . include include/libc libc shell
Message-ID: <200808270856.m7R8uNih019068@sheep.berlios.de>

Author: osiris_h4ck
Date: 2008-08-27 10:56:22 +0200 (Wed, 27 Aug 2008)
New Revision: 24

Modified:
   trunk/Makefile
   trunk/include/libc/string.h
   trunk/include/version.h
   trunk/kernel.c
   trunk/libc/string.c
   trunk/shell/shell.c
   trunk/start.sh
Log:
# Osiris at jeek69 at katamail.com

- Ho scritto in string.c e string.h la funzione memmove() per permettermi di scrivere nella shell il comando
echo.

- Aggiornate le funzioni di autoversion del kernel e aggiunte funzioni che permettono la personalizzazioni del NAME, EXTRAVERSION, VERSION e PATCHLEVEl

- Aggiornato script start.sh per l'auto compilazione e avviamento dell'OS



Modified: trunk/Makefile
===================================================================
--- trunk/Makefile	2008-08-26 20:36:26 UTC (rev 23)
+++ trunk/Makefile	2008-08-27 08:56:22 UTC (rev 24)
@@ -1,3 +1,12 @@
+# Please set your kernel preference versions..
+# Enjoy your self :)
+# Osiris at jeek69 at katamail.com
+
+VERSION = 0
+PATCHLEVEL = 0
+EXTRAVERSION = -dreamos
+NAME = DreamOS
+
 CFLAGS = -nostdlib -fomit-frame-pointer -fno-builtin -fno-stack-protector -Wall -march=i686 -m32 -I./include -I./include/io -I./include/drivers -I./include/libc -I./include/processore -I./include/hardware -I./include/mem -I./include/system -I./include/shell -I./include/misc
 
 OBJ = kernel.o io/video.o drivers/keyboard.o libc/ctype.o libc/string.o io/io.o libc/stdio.o hardware/cpuid.o hardware/keyboard.o processore/gdt.o processore/idt.o processore/handlers.o hardware/pic8259.o mem/fismem.o mem/paging.o mem/kheap.o mem/buddy.o misc/ordered_array.o system/syscall.o hardware/8253.o shell/shell.o
@@ -39,6 +48,10 @@
 	umount boot/os
 
 vers: 
+	 sed -i -e "/^#define VERSION/s/\".*\"/\"$(VERSION)\"/" include/version.h
+	 sed -i -e "/^#define PATCHLEVEL/s/\".*\"/\"$(PATCHLEVEL)\"/" include/version.h
+	 sed -i -e "/^#define EXTRAVERSION/s/\".*\"/\"$(EXTRAVERSION)\"/" include/version.h
+	 sed -i -e "/^#define NAME/s/\".*\"/\"$(NAME)\"/" include/version.h
 	 sed -i -e "/^#define REV_NUM/s/\".*\"/\""-r`cat .svn/entries | head -n 4 | tail -n 1`"\"/" include/version.h
 
 .PHONY: clean install qemu

Modified: trunk/include/libc/string.h
===================================================================
--- trunk/include/libc/string.h	2008-08-26 20:36:26 UTC (rev 23)
+++ trunk/include/libc/string.h	2008-08-27 08:56:22 UTC (rev 24)
@@ -30,6 +30,7 @@
 
 int _kstrncmp (const char *, const char *, int);
 void *memset(void *, const int, int);
+extern void * memmove(void *,const void *,size_t);
 int strlen (const char *);
 char *strncpy (char *, const char *, size_t);
 char *strchr (const char *, int);

Modified: trunk/include/version.h
===================================================================
--- trunk/include/version.h	2008-08-26 20:36:26 UTC (rev 23)
+++ trunk/include/version.h	2008-08-27 08:56:22 UTC (rev 24)
@@ -11,4 +11,4 @@
 #define PATCHLEVEL "0"
 #define EXTRAVERSION "-dreamos"
 #define NAME "DreamOS"
-#define REV_NUM "-r22"
+#define REV_NUM "-r23"

Modified: trunk/kernel.c
===================================================================
--- trunk/kernel.c	2008-08-26 20:36:26 UTC (rev 23)
+++ trunk/kernel.c	2008-08-27 08:56:22 UTC (rev 24)
@@ -98,12 +98,7 @@
 
     printf("\n\n[+] It's TODO ok ------------------------------------------>");
     _kprintOK();
-    printf("Now you can try the OS with the Shell\n\n");
-    printf(" [?] Would you like to load the shell ? [Y/n] ");
-    char choise[16];
-    scanf("%s",choise);
-	if (!(_kstrncmp(choise,"Y",1) ) || !(_kstrncmp(choise,"y",1)))
-   	{
+
 		printf("\n----\n");
     		printf("Loading the shell..\n");
 		printf("[+] End: %d \n"
@@ -112,12 +107,6 @@
    	        _kprintOK();
 		printf("\n\n");
 		shell();
-	 }
-		else {
-			printf("\n\n[-] Mmh.. fuck.\n\n");
-			poweroff();
-			
-	        }
 
 }
 

Modified: trunk/libc/string.c
===================================================================
--- trunk/libc/string.c	2008-08-26 20:36:26 UTC (rev 23)
+++ trunk/libc/string.c	2008-08-27 08:56:22 UTC (rev 24)
@@ -78,6 +78,26 @@
   return dest;
 }
 
+void *memmove(void * dest,const void *src,size_t count)
+{
+	char *tmp, *s;
+
+	if (dest <= src) {
+		tmp = (char *) dest;
+		s = (char *) src;
+		while (count--)
+			*tmp++ = *s++;
+		}
+	else {
+		tmp = (char *) dest + count;
+		s = (char *) src + count;
+		while (count--)
+			*--tmp = *--s;
+		}
+
+	return dest;
+}
+
 /*
  * Duplicate a string and return the new one
  */

Modified: trunk/shell/shell.c
===================================================================
--- trunk/shell/shell.c	2008-08-26 20:36:26 UTC (rev 23)
+++ trunk/shell/shell.c	2008-08-27 08:56:22 UTC (rev 24)
@@ -60,7 +60,8 @@
                "do_fault  - Test a page_fault (WARNING: This hang the OS)\n"
                "aalogo    - Show an ascii art logo\n"
                "uname     - Print kernel version\n"
-               "try_buddy - Try buddy mmu\n");
+               "try_buddy - Try buddy mmu\n"
+	       "echo      - Print some lines of text\n");
 }
 
 void poweroff()
@@ -99,18 +100,23 @@
 	printf(":==========: :==========: :==========:\n");
 }
 
-void shell(void)
+void shell(int argc, char *argv[])
 {
 	unsigned char cmd[256];
 	//char *cmd=malloc(256); //Dio maiale, Page Fault con il puntatore...
-	//char *cmd;
+	unsigned char text[256];
 	int a = 1;
+	printf("[?] Enter your username: ");
+    	char user[16];
+	scanf ("%s",user);
+	printf("\n\n\n\n\n\n");
 	aalogo();
+	printf("\n\n\n\n");
 
     shell_mess = 7;
 	for (;;)
 	{
-		_kputs("root~# ");
+		printf("%s~# ",user);
 	        scanf("%s",cmd);	// scanf non va bene per gli argomenti..
 
 		if (!(_kstrncmp(cmd,"help",4) ) )
@@ -120,6 +126,16 @@
 			cmd[a]=NULL;
 		}
 
+		if (!(_kstrncmp(cmd, "echo", 4) ) )
+		{
+			char string[256];
+			strncpy(string,cmd, strlen(cmd));
+			memmove(string, string+5, strlen(string));
+			printf("%s\n",string);
+			cmd[a]=NULL;
+			string[a]=NULL;	
+		}
+
 		else if (!(_kstrncmp(cmd,"poweroff",8)))
 		{
 			printf("Poweroff..\n");
@@ -129,7 +145,12 @@
 		
 		else if (!(_kstrncmp(cmd, "uname",5)))
 		{
+			//if (argv[2] == "-a")
+       			//{
 			printf("%s %s.%s.%s%s #1 beta CEST 2008 %s\n",NAME,VERSION,PATCHLEVEL,REV_NUM,EXTRAVERSION,cpu_vendor);
+			cmd[a]=NULL;
+			//}
+			//else { printf("%s\n", NAME); }
 
 		}
 
@@ -182,13 +203,12 @@
 }
 
 void aalogo() {
-//printf("\n\n");
-printf("\t____                     _____ _____\n");
-printf("\t|    \\ ___ ___ ___ _____|     |   __|\n");
-printf("\t|  |  |  _| -_| = |     |  |  |__   |\n");
-printf("\t|____/|_| |___|__||_|_|_|_____|_____|\n");
-printf("\t|------rev: \"%s\"|\n",REV_NUM);
-printf("\t|:::::::::::......|\n");
+printf("\t ____                     _____ _____\n");
+printf("\t |    \\ ___ ___ ___ _____|     |   __|\n");
+printf("\t |  |  |  _| -_| = |     |  |  |__   |\n");
+printf("\t |____/|_| |___|__||_|_|_|_____|_____|\n");
+printf("\t |------rev: \"%s\"|\n",REV_NUM);
+printf("\t |:::::::::::......|\n");
 logo();
 }
 

Modified: trunk/start.sh
===================================================================
--- trunk/start.sh	2008-08-26 20:36:26 UTC (rev 23)
+++ trunk/start.sh	2008-08-27 08:56:22 UTC (rev 24)
@@ -1,6 +1,5 @@
 #!/bin/sh
 # This script is more important to do a right compilation..
-# REMEMBER: if you don't use qemu, please uncomment bochs and comment qemu :)
 # 
 # Coded by Osiris
 
@@ -8,7 +7,7 @@
 if test -z "$1" 
 then
 echo "Usage: '$0 qemu' -> if you use Qemu Emulator"
-echo "       '$0 bochs' -> if you use Qemu Emulator"
+echo "       '$0 bochs' -> if you use Bochs Emulator"
 exit 1
 
 else



From osiris_h4ck at mail.berlios.de  Sun Aug 31 11:33:32 2008
From: osiris_h4ck at mail.berlios.de (osiris_h4ck at BerliOS)
Date: Sun, 31 Aug 2008 11:33:32 +0200
Subject: [Dreamos-dev] r25 - in trunk: . shell
Message-ID: <200808310933.m7V9XWCM016939@sheep.berlios.de>

Author: osiris_h4ck
Date: 2008-08-31 11:33:31 +0200 (Sun, 31 Aug 2008)
New Revision: 25

Modified:
   trunk/Makefile
   trunk/kernel.c
   trunk/shell/shell.c
Log:
- Implementazione argomenti argv e argc, un po rozza come cosa adesso, vedr?\195?\178 subito di scrivere una libreria etc..
	* comando per testare: 'uname' e 'uname -a'
- Organizzazione varia del Makefile e kernel.c

Osiris, jeek69 [at] katamail.com


Modified: trunk/Makefile
===================================================================
--- trunk/Makefile	2008-08-27 08:56:22 UTC (rev 24)
+++ trunk/Makefile	2008-08-31 09:33:31 UTC (rev 25)
@@ -60,8 +60,9 @@
 	rm -f *.img *.bin *.map
 	rm -f $(OBJ)
 
-install: dreamos.img
-	dd if=dreamos.img of=/dev/fd0
+install:
+	mkfs.ext2 /dev/fd0
+	dd if=boot/grub.img of=/dev/fd0
 
 qemu: dreamos.img
 	dd if=/dev/zero bs=$(shell let bs=1474560 -$(shell stat --format=%s dreamos.img); echo $$bs) count=1 2>/dev/null | cat dreamos.img - > dreamos_padded.img

Modified: trunk/kernel.c
===================================================================
--- trunk/kernel.c	2008-08-27 08:56:22 UTC (rev 24)
+++ trunk/kernel.c	2008-08-31 09:33:31 UTC (rev 25)
@@ -96,8 +96,8 @@
     get_cpuid();    
     printf("\n");    
 
-    printf("\n\n[+] It's TODO ok ------------------------------------------>");
-    _kprintOK();
+    //printf("\n\n[+] It's TODO ok ------------------------------------------>");
+    //_kprintOK();
 
 		printf("\n----\n");
     		printf("Loading the shell..\n");

Modified: trunk/shell/shell.c
===================================================================
--- trunk/shell/shell.c	2008-08-27 08:56:22 UTC (rev 24)
+++ trunk/shell/shell.c	2008-08-31 09:33:31 UTC (rev 25)
@@ -14,8 +14,10 @@
 */
 
 /* 
-  Shell Coded by
-	Osiris 
+*  Shell Coded by
+*	Osiris 
+*
+*   jeek69 [at] katamail dot com
 */
 
 #include <multiboot.h>
@@ -38,9 +40,9 @@
 #include <kheap.h>
 #include <buddy.h>
 #include <version.h>
+//#include <stdlib.h>
 
 
-
 extern buddy_t* kbuddy;
 void logo()
 {
@@ -69,7 +71,7 @@
 	/*asm(	"movl %0, %%eax\n"
 		"int $0xff\n"
 		: : "g"(1)); // valore di enum*/
-    asm("hlt");
+    asm("sti");
     printf("E' ora possibile spegnere il computer.\n");
     while(1);
 }
@@ -103,37 +105,69 @@
 void shell(int argc, char *argv[])
 {
 	unsigned char cmd[256];
-	//char *cmd=malloc(256); //Dio maiale, Page Fault con il puntatore...
-	unsigned char text[256];
-	int a = 1;
+	//char *cmd=kmalloc(sizeof(cmd));
+	//char *string=kmalloc(sizeof(string));
+	unsigned char string[256];
+	int a = 1, flag = 1;
+	char *str1;
+
 	printf("[?] Enter your username: ");
-    	char user[16];
+    	char user[24];
 	scanf ("%s",user);
+
 	printf("\n\n\n\n\n\n");
 	aalogo();
 	printf("\n\n\n\n");
 
     shell_mess = 7;
+    argc=1;
+
 	for (;;)
 	{
-		printf("%s~# ",user);
-	        scanf("%s",cmd);	// scanf non va bene per gli argomenti..
+	    printf("%s~# ",user);
+	    scanf("%s",cmd);
 
+	    // Inizio funzione argc e argv --->
+
+	   while (1)
+	   {
+		if (flag) {
+			str1 = strtok(cmd, " ");
+			flag = 0;
+		} 
+		else 
+		{
+			str1 = strtok(NULL, " ");
+		}
+
+		if (str1 == NULL)
+		{
+			break;
+		}
+
+		argv[argc] = (char *)kmalloc(strlen(str1) + 1); // Qui ho usato kmalloc() perch? non c'? malloc() 
+
+		strncpy(argv[argc], str1, strlen(str1));
+		argc++;
+	    }
+	    // fine argomentazione.. facile no ? :) --> Osiris r0x :P
+
+
 		if (!(_kstrncmp(cmd,"help",4) ) )
 		{
 			printf("Available command: \n");
 			help();
 			cmd[a]=NULL;
+			memset(cmd, 0, strlen(cmd));
 		}
 
 		if (!(_kstrncmp(cmd, "echo", 4) ) )
 		{
-			char string[256];
-			strncpy(string,cmd, strlen(cmd));
+			strncpy(string,cmd,strlen(cmd));
 			memmove(string, string+5, strlen(string));
 			printf("%s\n",string);
-			cmd[a]=NULL;
-			string[a]=NULL;	
+			memset(string+5, 0, strlen(string));
+			memset(cmd, 0, strlen(cmd));
 		}
 
 		else if (!(_kstrncmp(cmd,"poweroff",8)))
@@ -141,29 +175,45 @@
 			printf("Poweroff..\n");
 			poweroff();
 			cmd[a]=NULL;
+			memset(cmd, 0, strlen(cmd));
 		}
 		
+		else if (!(_kstrncmp(cmd, "clear", 5)))
+		{
+			_kclear();
+			cmd[a]=NULL;
+			memset(cmd, 0, strlen(cmd));
+		}
+
 		else if (!(_kstrncmp(cmd, "uname",5)))
 		{
-			//if (argv[2] == "-a")
-       			//{
-			printf("%s %s.%s.%s%s #1 beta CEST 2008 %s\n",NAME,VERSION,PATCHLEVEL,REV_NUM,EXTRAVERSION,cpu_vendor);
-			cmd[a]=NULL;
+			//if (_kstrncmp(argv[2], NULL,0) == -1)
+			//{
+				memmove(argv[2], argv[2]+6, strlen(argv[2]));
+				//printf("%s\n", argv[2]);
 			//}
-			//else { printf("%s\n", NAME); }
 
+			if (!(_kstrncmp(argv[2], "-a", 2)))
+       			{
+			printf("%s %s.%s.%s%s #1 beta CEST 2008 %s\n",NAME,VERSION,PATCHLEVEL,REV_NUM,EXTRAVERSION,cpu_vendor);
+			}
+			else { printf("%s\n", NAME); }
+			memset(cmd, 0, strlen(cmd));
+
 		}
 
 		else if (!(_kstrncmp(cmd,"info",4)))
 		{
 			info();
 			cmd[a]=NULL;
+			memset(cmd, 0, strlen(cmd));
 		}
 		else if (!(_kstrncmp(cmd,"answer",6)))
-        {
-            printf("42\n");
-            cmd[a]=NULL;
-        }
+      		  {
+          		  printf("42\n");
+          		  cmd[a]=NULL;
+			  memset(cmd, 0, strlen(cmd));
+        	}
         else if (!(_kstrncmp(cmd,"kmalloc",7)))
         {
             printf("kmalloc try: ...\n");
@@ -181,12 +231,16 @@
             }
             printf("Address of a: %d\n", b);
             cmd[a]=NULL;
+        	memset(cmd, 0, strlen(cmd));
+
         }
         else if (!(_kstrncmp(cmd,"do_fault",8))){  
             char *prova;
             prova = 0xa0000000;
             *prova = 10;
             cmd[a]=NULL;
+	    memset(cmd, 0, strlen(cmd));
+
         }
         else if (!(_kstrncmp(cmd,"try_buddy",9))){
              printf("L'indirizzo di kbuddy e': 0x%x\n", kbuddy);
@@ -194,12 +248,15 @@
              printf("New allocation\n\n");
              alloc_buddy(8, kbuddy);
             cmd[a] = NULL;
+	    memset(cmd, 0, strlen(cmd));
+
         }
         else if (!(_kstrncmp(cmd,"aalogo",6))) aalogo();        
-        else printf("Error %s\n", cmd);
+        //else printf("Error %s\n", cmd);
         cmd[a]=NULL;
+	memset(cmd, 0, strlen(cmd));
+
 	}
-
 }
 
 void aalogo() {
@@ -207,8 +264,7 @@
 printf("\t |    \\ ___ ___ ___ _____|     |   __|\n");
 printf("\t |  |  |  _| -_| = |     |  |  |__   |\n");
 printf("\t |____/|_| |___|__||_|_|_|_____|_____|\n");
-printf("\t |------rev: \"%s\"|\n",REV_NUM);
-printf("\t |:::::::::::......|\n");
+printf("\t -.rev: \"%s\"\n",REV_NUM);
 logo();
 }
 



