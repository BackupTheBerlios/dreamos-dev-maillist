From finarfin at mail.berlios.de  Fri Jan  1 14:03:02 2010
From: finarfin at mail.berlios.de (finarfin at BerliOS)
Date: Fri, 1 Jan 2010 14:03:02 +0100
Subject: [Dreamos-dev] r157 - in trunk: . boot shell utils utils/include
Message-ID: <201001011303.o01D3280023612@sheep.berlios.de>

Author: finarfin
Date: 2010-01-01 14:02:22 +0100 (Fri, 01 Jan 2010)
New Revision: 157

Added:
   trunk/boot/grub.img
Removed:
   trunk/boot/grub.img
Modified:
   trunk/dreamos.img
   trunk/shell/testing.c
   trunk/utils/include/initfscp.h
   trunk/utils/initfscp.c
Log:
Prima di salvare sul fs gli header mette un campo di preambolo per 
salvare il numero di files.
La funzione tester try_module ora salva in una struttura dati il valore 
del numero dei files, in modo che si possa usare nei cicli di scansione 
del vettore files.
Aggiornato grub.img con il nuovo fs.


Deleted: trunk/boot/grub.img
===================================================================
(Binary files differ)

Added: trunk/boot/grub.img
===================================================================
(Binary files differ)


Property changes on: trunk/boot/grub.img
___________________________________________________________________
Name: svn:executable
   + *
Name: svn:mime-type
   + application/octet-stream

Modified: trunk/dreamos.img
===================================================================
(Binary files differ)

Modified: trunk/shell/testing.c
===================================================================
--- trunk/shell/testing.c	2009-12-30 22:33:43 UTC (rev 156)
+++ trunk/shell/testing.c	2010-01-01 13:02:22 UTC (rev 157)
@@ -113,14 +113,17 @@
 }
 
 void try_module(){
+	initrd_t *fs_head;
 	initrd_file_t* headers;
 	int i;
 	i=0;
-	headers = (initrd_file_t *) module_start;
-	while(i<2){
+	fs_head = (initrd_t *)module_start;
+	headers = (initrd_file_t *) (module_start + sizeof(initrd_t));
+	while(i<fs_head->nfiles){
 		printf("%s\t%d\n", headers[i].fileName, headers[i].length);
 		i++;
 	}
+	printf("Total Files: %d\n", fs_head->nfiles);
 	int j=0;
 	/*char* mod_address;
 	mod_address = module_start;	

Modified: trunk/utils/include/initfscp.h
===================================================================
--- trunk/utils/include/initfscp.h	2009-12-30 22:33:43 UTC (rev 156)
+++ trunk/utils/include/initfscp.h	2010-01-01 13:02:22 UTC (rev 157)
@@ -1,6 +1,6 @@
 //      initfscp.h
 //      
-//      Copyright 2009  <crowley at azraphel>
+//      Copyright 2009  Ivan Gualandri 
 //      
 //      This program is free software; you can redistribute it and/or modify
 //      it under the terms of the GNU General Public License as published by

Modified: trunk/utils/initfscp.c
===================================================================
--- trunk/utils/initfscp.c	2009-12-30 22:33:43 UTC (rev 156)
+++ trunk/utils/initfscp.c	2010-01-01 13:02:22 UTC (rev 157)
@@ -29,14 +29,16 @@
 		else if(!strcmp(argv[1], "--help") || !strcmp(argv[1], "-h")) usage(argv[0]);
 		else{
 			initrd_file_t headers[MAX_FILES];
+			int nfiles;
+			nfiles = argc - 2;
 			int i=0;
 			FILE *fsdest;
 			fsdest = fopen(argv[argc-1], "w");
 			if(fsdest == NULL) printf("Could not create FileSystem\n");
 			printf("Welcome to Dreamos initfs file copier tool\n");
-			printf("Size of headers: %d\n\n", sizeof(struct initrd_file_t)*32);
+			printf("Size of headers: %d %d\n\n", sizeof(struct initrd_file_t)*32, sizeof(initrd_file_t));
 			printf("Clearing headers structures ");
-			offset = sizeof(struct initrd_file_t) * 32;
+			offset = sizeof(struct initrd_file_t) * 32 + sizeof(int);
 			for (i=0; i<MAX_FILES; i++){
 				headers[i].magic = 0xBF;
 				strcpy(headers[i].fileName, "");
@@ -45,7 +47,7 @@
 				headers[i].length = 0;
 			}			
 			printf("\e[33,44mDONE\e[0m\n\n");			
-			printf("Number of files to copy %d\n", argc - 2);
+			printf("Number of files to copy %d\n", nfiles);
 			printf("FileSystem name: %s\n\n", argv[argc-1]);
 			printf("Creating File headers\n");			
 			i=0;
@@ -69,6 +71,7 @@
 			printf("\e[33,44mDONE\e[0m\n\n");
 			i=0;
 			printf("Copying headers to %s filesystem  ", argv[argc-1]);		
+			fwrite(&nfiles, sizeof(int), 1, fsdest);
 			fwrite(headers, sizeof(struct initrd_file_t), 32, fsdest);
 			printf("\e[33,44mDONE\e[0m\n\n");			
 			printf("Copying data to %s filesystem\n", argv[argc-1]);		



From finarfin at mail.berlios.de  Sat Jan  2 15:16:24 2010
From: finarfin at mail.berlios.de (finarfin at BerliOS)
Date: Sat, 2 Jan 2010 15:16:24 +0100
Subject: [Dreamos-dev] r158 - in trunk: . boot fs include include/fs shell
	utils
Message-ID: <201001021416.o02EGOgG002870@sheep.berlios.de>

Author: finarfin
Date: 2010-01-02 15:16:23 +0100 (Sat, 02 Jan 2010)
New Revision: 158

Added:
   trunk/utils/initfs
Removed:
   trunk/boot/grub.img
Modified:
   trunk/dreamos.img
   trunk/fs/initrd.c
   trunk/include/fs/initrd.h
   trunk/include/version.h
   trunk/shell/testing.c
Log:
Aggiunte variabili globali per puntare al fs.
Modificata la funzione initfs_init, che ora dice il numero di files 
presenti.
Aggiornato grub.img, con altre prove.
Aggiornato numero versione


Deleted: trunk/boot/grub.img
===================================================================
(Binary files differ)

Modified: trunk/dreamos.img
===================================================================
(Binary files differ)

Modified: trunk/fs/initrd.c
===================================================================
--- trunk/fs/initrd.c	2010-01-01 13:02:22 UTC (rev 157)
+++ trunk/fs/initrd.c	2010-01-02 14:16:23 UTC (rev 158)
@@ -24,20 +24,18 @@
 #include <types.h>
 
 extern char *module_start;
+initrd_t *fs_specs;
+initrd_file_t* fs_headers;
 
-initrd_t fs_specs;
-
 void dummy(){
 	printf("Qui solo per una prova\n");
 }	
 
-int initfs_init(){
-	char *module_var;
-	module_var = module_start;
+int initfs_init(){	
+	fs_specs = (initrd_t *) module_start;
+	//module_var = module_start;
 	
-	printf("Number of files present: ");
-	putchar(module_var[0]);
-	printf("\n");
+	printf("Number of files present: %d\n", fs_specs->nfiles);		
 }
 
 DIR *initfs_opendir(const char *path){

Modified: trunk/include/fs/initrd.h
===================================================================
--- trunk/include/fs/initrd.h	2010-01-01 13:02:22 UTC (rev 157)
+++ trunk/include/fs/initrd.h	2010-01-02 14:16:23 UTC (rev 158)
@@ -40,7 +40,8 @@
 typedef struct initrd_t initrd_t;
 typedef struct initrd_file_t initrd_file_t;
 
-extern initrd_t fs_specs;
+extern initrd_t* fs_specs;
+extern initrd_file_t* fs_headers;
 void dummy();
 int initfs_init();
 DIR *initfs_opendir(const char *);

Modified: trunk/include/version.h
===================================================================
--- trunk/include/version.h	2010-01-01 13:02:22 UTC (rev 157)
+++ trunk/include/version.h	2010-01-02 14:16:23 UTC (rev 158)
@@ -24,4 +24,4 @@
 #define PATCHLEVEL "2.0"
 #define EXTRAVERSION "-trunk"
 #define NAME "DreamOS"
-#define REV_NUM "-r144"
+#define REV_NUM "-r158"

Modified: trunk/shell/testing.c
===================================================================
--- trunk/shell/testing.c	2010-01-01 13:02:22 UTC (rev 157)
+++ trunk/shell/testing.c	2010-01-02 14:16:23 UTC (rev 158)
@@ -124,7 +124,7 @@
 		i++;
 	}
 	printf("Total Files: %d\n", fs_head->nfiles);
-	int j=0;
+	//int j=0;
 	/*char* mod_address;
 	mod_address = module_start;	
 	while(j<74){

Added: trunk/utils/initfs
===================================================================
(Binary files differ)


Property changes on: trunk/utils/initfs
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream



From finarfin at mail.berlios.de  Sat Jan  2 15:17:44 2010
From: finarfin at mail.berlios.de (finarfin at BerliOS)
Date: Sat, 2 Jan 2010 15:17:44 +0100
Subject: [Dreamos-dev] r159 - trunk/boot
Message-ID: <201001021417.o02EHilm002935@sheep.berlios.de>

Author: finarfin
Date: 2010-01-02 15:17:04 +0100 (Sat, 02 Jan 2010)
New Revision: 159

Added:
   trunk/boot/grub.img
Log:
Riaggiunto grub.img erroneamente eliminato nella rev precedente.


Added: trunk/boot/grub.img
===================================================================
(Binary files differ)


Property changes on: trunk/boot/grub.img
___________________________________________________________________
Name: svn:executable
   + *
Name: svn:mime-type
   + application/octet-stream



From finarfin at mail.berlios.de  Sun Jan  3 00:17:37 2010
From: finarfin at mail.berlios.de (finarfin at BerliOS)
Date: Sun, 3 Jan 2010 00:17:37 +0100
Subject: [Dreamos-dev] r160 - in trunk: . fs include include/fs include/lng
	shell
Message-ID: <201001022317.o02NHbaY021875@sheep.berlios.de>

Author: finarfin
Date: 2010-01-03 00:17:36 +0100 (Sun, 03 Jan 2010)
New Revision: 160

Modified:
   trunk/dreamos.img
   trunk/fs/fcntl.c
   trunk/fs/initrd.c
   trunk/fs/vfs.c
   trunk/include/fs/vfs.h
   trunk/include/lng/en.h
   trunk/include/lng/it.h
   trunk/include/use.h
   trunk/include/version.h
   trunk/kernel.c
   trunk/shell/testing.c
Log:
Aggiunta define di LNG_VFS ai files della lingua
Corretta open, non passava il path relativo alla open del fs, bensi 
quello intero.
La chiamata a initfs_init e' stata aggiunta in fase di boot del sistema. 
Modificata initfs_init, ora torna il numero di files presenti.
AGgiornato numero versione.
Modificata try_fsinit


Modified: trunk/dreamos.img
===================================================================
(Binary files differ)

Modified: trunk/fs/fcntl.c
===================================================================
--- trunk/fs/fcntl.c	2010-01-02 14:17:04 UTC (rev 159)
+++ trunk/fs/fcntl.c	2010-01-02 23:17:36 UTC (rev 160)
@@ -35,6 +35,7 @@
   */
 int open(const char *path, int oflags,  ...){
 	int prova;
+	int mpid;
 	va_list ap;
 	va_start(ap, oflags);
 	
@@ -42,8 +43,10 @@
 	printf("Prova vale: %d e il path: %s e cur_fd: %d\n", prova,path,cur_fd);
 	if(cur_fd >= _SC_OPEN_MAX) cur_fd=0;
 	else {		
-		fd_list[cur_fd].mountpoint_id = get_mountpoint_id(path);
-		printf("Mpoint id: %d\n", fd_list[cur_fd].mountpoint_id);
+		mpid = get_mountpoint_id(path);
+		fd_list[cur_fd].mountpoint_id = mpid;				
+		path = get_rel_path(mpid, path);
+		printf("Mpoint id: %d %s\n", mpid, path);
 		if(mountpoint_list[fd_list[cur_fd].mountpoint_id].operations.open != NULL)
 			mountpoint_list[fd_list[cur_fd].mountpoint_id].operations.open(path, oflags);
 		else 

Modified: trunk/fs/initrd.c
===================================================================
--- trunk/fs/initrd.c	2010-01-02 14:17:04 UTC (rev 159)
+++ trunk/fs/initrd.c	2010-01-02 23:17:36 UTC (rev 160)
@@ -22,6 +22,7 @@
 #include <multiboot.h>
 #include <unistd.h>
 #include <types.h>
+#include <string.h>
 
 extern char *module_start;
 initrd_t *fs_specs;
@@ -33,9 +34,9 @@
 
 int initfs_init(){	
 	fs_specs = (initrd_t *) module_start;
-	//module_var = module_start;
-	
-	printf("Number of files present: %d\n", fs_specs->nfiles);		
+	fs_headers = (initrd_file_t *)(module_start + sizeof(initrd_t));
+	return fs_specs->nfiles;
+	//printf("Number of files present: %d\n", fs_specs->nfiles);		
 }
 
 DIR *initfs_opendir(const char *path){
@@ -44,17 +45,15 @@
 }
 
 int initfs_open(const char *path, int flags, ...){
-	char *module_var;
+	initrd_file_t *module_var;
 	int ifs_fd;
 	ifs_fd = 0;
 	int j = 0;
-	module_var = module_start;
-	printf("Hi, i'm a dummy open. And i do nothing!!! path: %s\n", path);
-	while (j < 74) {
-		putchar(module_var[j]);
+	module_var = fs_headers;	
+	while (j < fs_specs->nfiles) {
+		if(!strcmp(path, module_var[j].fileName)) printf("%s Found. Size: %d\n", path, module_var[j].length);
 		j++;
 	}
-	_kputs("\n");
 	return ifs_fd;
 }
 

Modified: trunk/fs/vfs.c
===================================================================
--- trunk/fs/vfs.c	2010-01-02 14:17:04 UTC (rev 159)
+++ trunk/fs/vfs.c	2010-01-02 23:17:36 UTC (rev 160)
@@ -38,7 +38,7 @@
 	j=0;
 	cur_fd=0;
 	
-	printf("\nPreparing VFS\n"); 	
+	printf(LNG_VFS); 	
 
 	while (j<_SC_OPEN_MAX){
 		fd_list[j].fs_spec_id = 0;
@@ -109,7 +109,7 @@
                        }					   					   
                        i++;
                }               
-			   if(last!=-1) printf("Changing dir %s\n", mountpoint_list[last].mountpoint, last);			   
+			   //if(last!=-1) printf("Changing dir %s\n", mountpoint_list[last].mountpoint, last);			   
                return last;
 }
 

Modified: trunk/include/fs/vfs.h
===================================================================
--- trunk/include/fs/vfs.h	2010-01-02 14:17:04 UTC (rev 159)
+++ trunk/include/fs/vfs.h	2010-01-02 23:17:36 UTC (rev 160)
@@ -21,6 +21,7 @@
 #include <dirent.h>
 #include <stddef.h>
 #include <unistd.h>
+#include <use.h>
 
 #define MAX_MOUNTPOINT 10
 #define MAX_FD 255

Modified: trunk/include/lng/en.h
===================================================================
--- trunk/include/lng/en.h	2010-01-02 14:17:04 UTC (rev 159)
+++ trunk/include/lng/en.h	2010-01-02 23:17:36 UTC (rev 160)
@@ -37,6 +37,7 @@
 #define LNG_MOUSE_RIGHT  "\n[+] Mouse driver: right key pressed!"
 #define LNG_MOUSE_LEFT  "\n[+] Mouse driver: left key pressed!"
 #define LNG_WELCOME "\t\t.: Welcome to DreamOS :.\n\n"
+#define LNG_VFS "\nPreparing VFS\n"
 
 // DATE ME NOE!
 // MONTHS

Modified: trunk/include/lng/it.h
===================================================================
--- trunk/include/lng/it.h	2010-01-02 14:17:04 UTC (rev 159)
+++ trunk/include/lng/it.h	2010-01-02 23:17:36 UTC (rev 160)
@@ -38,6 +38,7 @@
 #define LNG_MOUSE_RIGHT "\n[+] Mouse driver: rilevato tasto destro premuto!"
 #define LNG_MOUSE_LEFT "\n[+] Mouse driver: rilevato tasto sinistro premuto!"
 #define LNG_WELCOME "\t\t.: Benvenuto in DreamOS :.\n\n"
+#define LNG_VFS "\nInizializzo VFS\n"
 
 // DATE ME NOE!
 // MESI: sereno variabile in tutto il nord Italia

Modified: trunk/include/use.h
===================================================================
--- trunk/include/use.h	2010-01-02 14:17:04 UTC (rev 159)
+++ trunk/include/use.h	2010-01-02 23:17:36 UTC (rev 160)
@@ -38,6 +38,7 @@
 #define LNG_MOUSE_RIGHT "\n[+] Mouse driver: rilevato tasto destro premuto!"
 #define LNG_MOUSE_LEFT "\n[+] Mouse driver: rilevato tasto sinistro premuto!"
 #define LNG_WELCOME "\t\t.: Benvenuto in DreamOS :.\n\n"
+#define LNG_VFS "\nInizializzo VFS\n"
 
 // DATE ME NOE!
 // MESI: sereno variabile in tutto il nord Italia

Modified: trunk/include/version.h
===================================================================
--- trunk/include/version.h	2010-01-02 14:17:04 UTC (rev 159)
+++ trunk/include/version.h	2010-01-02 23:17:36 UTC (rev 160)
@@ -24,4 +24,4 @@
 #define PATCHLEVEL "2.0"
 #define EXTRAVERSION "-trunk"
 #define NAME "DreamOS"
-#define REV_NUM "-r158"
+#define REV_NUM "-r160"

Modified: trunk/kernel.c
===================================================================
--- trunk/kernel.c	2010-01-02 14:17:04 UTC (rev 159)
+++ trunk/kernel.c	2010-01-02 23:17:36 UTC (rev 160)
@@ -43,6 +43,7 @@
 #include <kheap.h>
 #include <debug.h>
 #include <vfs.h>
+#include <initrd.h>
 
 unsigned int *current_page_table;
 extern unsigned int end;
@@ -99,6 +100,7 @@
     get_cpuid (sinfo);
         
     vfs_init();
+    initfs_init();
 	if(boot_info->mods_count > 0) printf("Found n. %d Modules\n", boot_info->mods_count);		
 	printf("Address of module: 0x%x - 0x%d\n", *((unsigned int*)boot_info->mods_addr),module_end-(unsigned int) module_start);
     printf("\n");

Modified: trunk/shell/testing.c
===================================================================
--- trunk/shell/testing.c	2010-01-02 14:17:04 UTC (rev 159)
+++ trunk/shell/testing.c	2010-01-02 23:17:36 UTC (rev 160)
@@ -144,12 +144,12 @@
 		i++;
 	}
 	printf("Please insert a path: ");
-	//appoggio = gets();
+	
 	scanf("%s", appoggio);	
 	i = open(appoggio, O_RDONLY, 42);
 	read(i, prova, 1);
 }
 
 void try_fsinit(){
-	initfs_init();
+	printf("Number of files present: %d\n", initfs_init());
 }



From osiris_h4ck at mail.berlios.de  Sun Jan  3 12:54:32 2010
From: osiris_h4ck at mail.berlios.de (osiris_h4ck at BerliOS)
Date: Sun, 3 Jan 2010 12:54:32 +0100
Subject: [Dreamos-dev] r161 - in trunk: . files utils
Message-ID: <201001031154.o03BsW1h029728@sheep.berlios.de>

Author: osiris_h4ck
Date: 2010-01-03 12:54:25 +0100 (Sun, 03 Jan 2010)
New Revision: 161

Added:
   trunk/files/
   trunk/files/test1.txt
   trunk/files/test2.txt
   trunk/files/test3.txt
   trunk/files/test4.txt
   trunk/files/test5.txt
Modified:
   trunk/Makefile
   trunk/dreamos.img
   trunk/start.sh
   trunk/utils/Makefile
   trunk/utils/initfscp.c
Log:
- Modificati i Makefile e migliorati
- Sistemato lo initscp, ora i file presenti in files/ vengono aggiunti automaticamente al filesystem
- Aggiunta la cartella files/ appunto quel il punto di prima
- Aggiunta funzione 'create_fs' che permette di creare il filesystem in automatico durante la compilazione
  e che pu?\195?\178 essere usata per aggiornare il filesystem di DreamOS con l'aggiunta di altri files.

Greez, Working in Progress :)




Modified: trunk/Makefile
===================================================================
--- trunk/Makefile	2010-01-02 23:17:36 UTC (rev 160)
+++ trunk/Makefile	2010-01-03 11:54:25 UTC (rev 161)
@@ -1,6 +1,6 @@
 # Please set your kernel preference versions..
 # Enjoy your self :)
-# Osiris at jeek69 at katamail.com
+# Osiris at osiris at Devils.com
 
 NAME = DreamOS
 VERSION = 0
@@ -115,7 +115,7 @@
 .PHONY: clean install qemu
 
 clean:
-	rm -f *.img *.bin *.map
+	rm -f *.img *.bin *.map initfs
 	rm -f $(OBJ)
 
 install:
@@ -130,3 +130,6 @@
 
 en:
 	cp include/lng/en.h include/use.h
+	
+initfs:
+	su -c "mount -o loop boot/grub.img boot/os && rm -rf boot/os/initfs && cp initfs boot/os/initfs && umount boot/os"

Modified: trunk/dreamos.img
===================================================================
(Binary files differ)

Added: trunk/files/test1.txt
===================================================================
--- trunk/files/test1.txt	2010-01-02 23:17:36 UTC (rev 160)
+++ trunk/files/test1.txt	2010-01-03 11:54:25 UTC (rev 161)
@@ -0,0 +1 @@
+ciao mondo

Added: trunk/files/test2.txt
===================================================================
--- trunk/files/test2.txt	2010-01-02 23:17:36 UTC (rev 160)
+++ trunk/files/test2.txt	2010-01-03 11:54:25 UTC (rev 161)
@@ -0,0 +1 @@
+come va ?

Added: trunk/files/test3.txt
===================================================================
--- trunk/files/test3.txt	2010-01-02 23:17:36 UTC (rev 160)
+++ trunk/files/test3.txt	2010-01-03 11:54:25 UTC (rev 161)
@@ -0,0 +1 @@
+bho, io credo bene eh eh eh

Added: trunk/files/test4.txt
===================================================================
--- trunk/files/test4.txt	2010-01-02 23:17:36 UTC (rev 160)
+++ trunk/files/test4.txt	2010-01-03 11:54:25 UTC (rev 161)
@@ -0,0 +1 @@
+tanto questa ? solo una prova :\

Added: trunk/files/test5.txt
===================================================================
--- trunk/files/test5.txt	2010-01-02 23:17:36 UTC (rev 160)
+++ trunk/files/test5.txt	2010-01-03 11:54:25 UTC (rev 161)
@@ -0,0 +1 @@
+io ti vi bi!

Modified: trunk/start.sh
===================================================================
--- trunk/start.sh	2010-01-02 23:17:36 UTC (rev 160)
+++ trunk/start.sh	2010-01-03 11:54:25 UTC (rev 161)
@@ -3,21 +3,17 @@
 # 
 # Coded by Osiris
 # For any question about this or other, mail me to
-# diego.stamigni at linux.com
+# osiris at Devils.com
 # greez ;
 
 VERS="make vers"
 CLEAN="make clean"
 MAKE="make"
 MAKE_IMG="make img"
+MAKE_FS="make initfs"
 
 if [ "$1" != "--compile" ]; then
 
-#  if [ $UID != "0" ]; then
-#      echo "[-] You need to run this install script as root!"
-#     exit
-#  fi
-
 if [ "$1" == "help" ]; then
 echo ""
 echo "	    The DreamOS Operating System"
@@ -48,7 +44,7 @@
 echo "script, something like that:"
 echo ""
 echo "Usage: '$0' '--compile' 'emulator' 'language'"
-echo "where now language supported is 'it' or 'en'"
+echo "where, now, language supported is 'it' or 'en'"
 echo "------------------------------------------------------"
 echo ""
 echo "If you want, you can install DreamOS on your floppy"
@@ -72,6 +68,16 @@
 echo ""
 echo "Usage: '$0' 'create_iso'"
 echo "------------------------------------------------------"
+echo ""
+echo "If you want, you can create a DreamOS FileSystem"
+echo "You know, this is *VERY* important :)"
+echo "To add the file and then re-create the FS, put you files"
+echo "into files/ and do:"
+echo ""
+echo "Usage: '$0' 'create_fs'"
+echo "Also you should know that this process is do during the"
+echo "compilation of DreamOS."
+echo "------------------------------------------------------"
 exit 1
 
 elif [ "$1" == "qemu" ] || [ "$1" == "bochs" ]; then
@@ -118,6 +124,20 @@
   echo "---------------------------------------------"
   exit
 
+elif [ "$1" == "create_fs" ]; then
+
+  echo "--------------------------------------------- "
+  echo "Launching FS Creating script in progress.."
+  echo ""
+  utils/initfscp `find files/* -exec echo {} +;` initfs
+  echo "done."
+  #$MAKE_FS
+  su -c "mount -o loop boot/grub.img boot/os && rm -rf boot/os/initfs && cp initfs boot/os/initfs && umount boot/os"
+  echo "--------------------------------------------- "
+  echo "FS Created and added to boot/grub.img"
+  echo "---------------------------------------------"
+  exit
+
 elif [ "$1" == "" ]; then
   echo "Error: No command inserted!"
   echo "----------------------->"
@@ -135,10 +155,6 @@
 
 else
 
-#  if [ $UID != "0" ]; then
-#      echo "[-] You need to run this install script as root!"
-#      exit
-#  fi
 
 if [ "$2" == "qemu" ] || [ "$2" == "bochs" ]; then
 
@@ -158,7 +174,20 @@
 		  echo "Warning: No language translation declared!"
 		  echo "----------------------->"                 
 	  fi   
+	  
 	 $VERS && $CLEAN && $MAKE && $MAKE_IMG
+	  
+	 echo "--------------------------------------------- "
+  	 echo "Launching FS Creating script in progress.."
+	 echo ""
+         utils/initfscp `find files/* -exec echo {} +;` initfs
+         echo "done."
+         #$MAKE_FS
+         su -c "mount -o loop boot/grub.img boot/os && rm -rf boot/os/initfs && cp initfs boot/os/initfs && umount boot/os"
+         echo "--------------------------------------------- "
+         echo "FS Created and added to boot/grub.img"
+         echo "---------------------------------------------"
+         
 	 qemu -fda boot/grub.img
 	 exit
 
@@ -225,7 +254,7 @@
   exit
 
 else
-  echo "Uhm? What the hell did you insert ? Lool! '$2' ?? I don't know what is it!"
+  echo "Uhm? What the hell did you insert ? '$2' ?? I don't know what is it!"
   echo "Please, read the help!!!"
   echo "----------------------->"
   echo "Usage: '$0 help'"

Modified: trunk/utils/Makefile
===================================================================
--- trunk/utils/Makefile	2010-01-02 23:17:36 UTC (rev 160)
+++ trunk/utils/Makefile	2010-01-03 11:54:25 UTC (rev 161)
@@ -1,2 +1,10 @@
+CC = gcc
+FILE = initfscp.c
+OUTPUT = initfscp
+
 all:
-	gcc -o initfscp initfscp.c -I./include
+	$(CC) $(FILE) -I./include -o $(OUTPUT)
+
+clean:
+	rm -rf $(OUTPUT)
+

Modified: trunk/utils/initfscp.c
===================================================================
--- trunk/utils/initfscp.c	2010-01-02 23:17:36 UTC (rev 160)
+++ trunk/utils/initfscp.c	2010-01-03 11:54:25 UTC (rev 161)
@@ -56,6 +56,8 @@
 				fd = fopen(argv[i+1], "r+");
 				if(fd == NULL){
 					 printf("Error one or more files not found\n");
+					 // Debug
+      					 printf("Nome del file: -->%s<--\n",argv[i+1]);
 					 return -1;
 				 }
 				else {



From osiris_h4ck at mail.berlios.de  Sun Jan  3 13:02:25 2010
From: osiris_h4ck at mail.berlios.de (osiris_h4ck at BerliOS)
Date: Sun, 3 Jan 2010 13:02:25 +0100
Subject: [Dreamos-dev] r162 - trunk/boot
Message-ID: <201001031202.o03C2Ppl006405@sheep.berlios.de>

Author: osiris_h4ck
Date: 2010-01-03 13:02:15 +0100 (Sun, 03 Jan 2010)
New Revision: 162

Modified:
   trunk/boot/grub.img
Log:
- Aggiornato grub.img 



Modified: trunk/boot/grub.img
===================================================================
(Binary files differ)



From osiris_h4ck at mail.berlios.de  Sun Jan  3 17:06:24 2010
From: osiris_h4ck at mail.berlios.de (osiris_h4ck at BerliOS)
Date: Sun, 3 Jan 2010 17:06:24 +0100
Subject: [Dreamos-dev] r163 - in trunk: . utils
Message-ID: <201001031606.o03G6OhD024617@sheep.berlios.de>

Author: osiris_h4ck
Date: 2010-01-03 17:06:24 +0100 (Sun, 03 Jan 2010)
New Revision: 163

Modified:
   trunk/Makefile
   trunk/start.sh
   trunk/utils/Makefile
   trunk/utils/initfscp.c
Log:
- Apportate varie modifiche ai Makefile per renderli piu` performanti e inglobare il programma utils/initfscp per la creazione del filesystem
- Aggiornato lo start.sh e sistemato con le nuove funzioni dei Makefile



Modified: trunk/Makefile
===================================================================
--- trunk/Makefile	2010-01-03 12:02:15 UTC (rev 162)
+++ trunk/Makefile	2010-01-03 16:06:24 UTC (rev 163)
@@ -69,6 +69,7 @@
 
 kernel.bin: $(OBJ)
 	ld -static --oformat elf32-i386 --output=kernel.bin --script=kernel.lds bl.img $(OBJ) -Ttext 0x100000 -Map kernel.map
+	make -f utils/Makefile
 
 kernel.o: kernel.c
 fs/vfs.o: fs/vfs.c
@@ -102,6 +103,12 @@
 sys/utsname.o: sys/utsname.c
 sys/dirent.o: sys/dirent.c
 
+utils:
+	make -f utils/Makefile
+	
+filesystem:
+	su -c "mount -o loop boot/grub.img boot/os && cp initfs boot/os/initfs && umount boot/os"
+	
 img:
 	su -c "mount -o loop boot/grub.img boot/os && cp dreamos.img boot/os/boot/grub/ && umount boot/os"
 
@@ -117,6 +124,7 @@
 clean:
 	rm -f *.img *.bin *.map initfs
 	rm -f $(OBJ)
+	rm -rf utils/initfscp
 
 install:
 	mkfs.ext2 /dev/fd0
@@ -131,5 +139,3 @@
 en:
 	cp include/lng/en.h include/use.h
 	
-initfs:
-	su -c "mount -o loop boot/grub.img boot/os && rm -rf boot/os/initfs && cp initfs boot/os/initfs && umount boot/os"

Modified: trunk/start.sh
===================================================================
--- trunk/start.sh	2010-01-03 12:02:15 UTC (rev 162)
+++ trunk/start.sh	2010-01-03 16:06:24 UTC (rev 163)
@@ -10,7 +10,7 @@
 CLEAN="make clean"
 MAKE="make"
 MAKE_IMG="make img"
-MAKE_FS="make initfs"
+MAKE_FS="make filesystem"
 
 if [ "$1" != "--compile" ]; then
 
@@ -131,8 +131,8 @@
   echo ""
   utils/initfscp `find files/* -exec echo {} +;` initfs
   echo "done."
-  #$MAKE_FS
-  su -c "mount -o loop boot/grub.img boot/os && rm -rf boot/os/initfs && cp initfs boot/os/initfs && umount boot/os"
+  $MAKE_FS
+  #su -c "mount -o loop boot/grub.img boot/os && rm -rf boot/os/initfs && cp initfs boot/os/initfs && umount boot/os"
   echo "--------------------------------------------- "
   echo "FS Created and added to boot/grub.img"
   echo "---------------------------------------------"
@@ -182,8 +182,7 @@
 	 echo ""
          utils/initfscp `find files/* -exec echo {} +;` initfs
          echo "done."
-         #$MAKE_FS
-         su -c "mount -o loop boot/grub.img boot/os && rm -rf boot/os/initfs && cp initfs boot/os/initfs && umount boot/os"
+         $MAKE_FS
          echo "--------------------------------------------- "
          echo "FS Created and added to boot/grub.img"
          echo "---------------------------------------------"
@@ -207,7 +206,7 @@
 		  echo "----------------------->"                 
 	  fi  
 
-	$VERS && $CLEAN && $MAKE && $MAKE_IMG
+	$VERS && $CLEAN && $MAKE && $MAKE_IMG && $MAKE_FS
 	bochs -f .bochsrc -q
 	exit
 
@@ -215,7 +214,7 @@
 
 elif [ "$2" == "floppy_install" ]; then
 
-  $VERS && $CLEAN && $MAKE && $MAKE_IMG
+  $VERS && $CLEAN && $MAKE && $MAKE_IMG && $MAKE_FS
   echo "---------------------- "
   echo "Installation in progres.."
   su -c "make install"
@@ -225,7 +224,7 @@
 
 elif [ "$2" == "grub" ]; then
 
-  $VERS && $CLEAN && $MAKE && $MAKE_IMG
+  $VERS && $CLEAN && $MAKE && $MAKE_IMG && $MAKE_FS
   echo "--------------------------------------------- "
   echo "Launching grub installer script in progress.."
   su -c "python grub.py"
@@ -242,7 +241,7 @@
 
 
 elif [ "$2" == "create_iso" ]; then
-  $VERS && $CLEAN && $MAKE && $MAKE_IMG
+  $VERS && $CLEAN && $MAKE && $MAKE_IMG && $MAKE_FS
   echo "--------------------------------------------- "
   echo "Launching ISO Creation script in progress.."
   echo ""

Modified: trunk/utils/Makefile
===================================================================
--- trunk/utils/Makefile	2010-01-03 12:02:15 UTC (rev 162)
+++ trunk/utils/Makefile	2010-01-03 16:06:24 UTC (rev 163)
@@ -1,9 +1,9 @@
 CC = gcc
-FILE = initfscp.c
-OUTPUT = initfscp
+FILE = utils/initfscp.c
+OUTPUT = utils/initfscp
 
 all:
-	$(CC) $(FILE) -I./include -o $(OUTPUT)
+	$(CC) $(FILE) -I./utils/include -o $(OUTPUT)
 
 clean:
 	rm -rf $(OUTPUT)

Modified: trunk/utils/initfscp.c
===================================================================
--- trunk/utils/initfscp.c	2010-01-03 12:02:15 UTC (rev 162)
+++ trunk/utils/initfscp.c	2010-01-03 16:06:24 UTC (rev 163)
@@ -39,6 +39,7 @@
 			printf("Size of headers: %d %d\n\n", sizeof(struct initrd_file_t)*32, sizeof(initrd_file_t));
 			printf("Clearing headers structures ");
 			offset = sizeof(struct initrd_file_t) * 32 + sizeof(int);
+			
 			for (i=0; i<MAX_FILES; i++){
 				headers[i].magic = 0xBF;
 				strcpy(headers[i].fileName, "");
@@ -46,7 +47,7 @@
 				headers[i].offset = 0;
 				headers[i].length = 0;
 			}			
-			printf("\e[33,44mDONE\e[0m\n\n");			
+			printf("[ \033[1;33mDONE\e[0m ]\n\n");	
 			printf("Number of files to copy %d\n", nfiles);
 			printf("FileSystem name: %s\n\n", argv[argc-1]);
 			printf("Creating File headers\n");			
@@ -57,7 +58,7 @@
 				if(fd == NULL){
 					 printf("Error one or more files not found\n");
 					 // Debug
-      					 printf("Nome del file: -->%s<--\n",argv[i+1]);
+      					 printf("Name of file: -->%s<--\n",argv[i+1]);
 					 return -1;
 				 }
 				else {
@@ -70,12 +71,13 @@
 					offset += headers[i].length;
 				}				
 			}
-			printf("\e[33,44mDONE\e[0m\n\n");
+
+			printf("[ \033[1;33mDONE\e[0m ]\n\n");		
 			i=0;
 			printf("Copying headers to %s filesystem  ", argv[argc-1]);		
 			fwrite(&nfiles, sizeof(int), 1, fsdest);
 			fwrite(headers, sizeof(struct initrd_file_t), 32, fsdest);
-			printf("\e[33,44mDONE\e[0m\n\n");			
+			printf("[ \033[1;33mDONE\e[0m ]\n\n");	
 			printf("Copying data to %s filesystem\n", argv[argc-1]);		
 			for(i=0; i<argc - 2; i++){
 				FILE *fd2;
@@ -86,7 +88,7 @@
 				fwrite(buffer, 1, headers[i].length, fsdest);
 				printf("\t\tFileName: %s Length: %d offset: %d\n", headers[i].fileName, headers[i].length, headers[i].offset);
 			}
-			printf("\e[33,44mDONE\e[0m\n\n");
+			printf("[ \033[1;33mDONE\e[0m ]\n\n");	
 			fclose(fsdest);
 		}		
 	}	



From finarfin at mail.berlios.de  Thu Jan  7 00:21:55 2010
From: finarfin at mail.berlios.de (finarfin at BerliOS)
Date: Thu, 7 Jan 2010 00:21:55 +0100
Subject: [Dreamos-dev] r164 - trunk/utils
Message-ID: <201001062321.o06NLtPY032318@sheep.berlios.de>

Author: finarfin
Date: 2010-01-07 00:21:54 +0100 (Thu, 07 Jan 2010)
New Revision: 164

Added:
   trunk/utils/README.initfscp
Log:
Aggiunto file README.initfscp dentro utils.


Added: trunk/utils/README.initfscp
===================================================================
--- trunk/utils/README.initfscp	2010-01-03 16:06:24 UTC (rev 163)
+++ trunk/utils/README.initfscp	2010-01-06 23:21:54 UTC (rev 164)
@@ -0,0 +1,17 @@
+----
+README
+initfscp
+----
+
+initfscp e' un programma che serve per creare un'immagine contenente il file system utilizzato da DreamOS.
+Consente di inserirci dei files (massimo 32) all'interno. 
+Per far ci? digitare il comando "initfscp file1 file2 ... nomefs" dove:
+- "file1 file2 ..." sono i files che inseriremo nel filesystem,
+- "nomefs" ? il nome che daremo all'immagine.
+Ad esempio vogliamo inserire i file topolino, pippo e paperino nell'immagine che chiameremo disney, quindi digitiamo:
+  initfscp topolino pippo paperino disney
+cos? facendo initfscp generer? l'immagine disney.
+
+Altri comandi disponibili:
+--help (-h) per visualizzare una guida pi? sintetica.
+--version (-v) per visualizzare la versione utilizzata di initfscp.



From finarfin at mail.berlios.de  Thu Jan  7 21:11:13 2010
From: finarfin at mail.berlios.de (finarfin at BerliOS)
Date: Thu, 7 Jan 2010 21:11:13 +0100
Subject: [Dreamos-dev] r165 - in trunk: . files fs include include/fs
Message-ID: <201001072011.o07KBDGp003853@sheep.berlios.de>

Author: finarfin
Date: 2010-01-07 21:11:12 +0100 (Thu, 07 Jan 2010)
New Revision: 165

Modified:
   trunk/dreamos.img
   trunk/files/test4.txt
   trunk/fs/fcntl.c
   trunk/fs/initrd.c
   trunk/include/fs/initrd.h
   trunk/include/version.h
Log:
Aggiunta struttura dati per la gestione dei File Descriptor di initrd.
Modificata la initfs_open, ora torna il suo file_descriptor.
Aggiornato numero versione.
Aggiornata initfs_init.


Modified: trunk/dreamos.img
===================================================================
(Binary files differ)

Modified: trunk/files/test4.txt
===================================================================
--- trunk/files/test4.txt	2010-01-06 23:21:54 UTC (rev 164)
+++ trunk/files/test4.txt	2010-01-07 20:11:12 UTC (rev 165)
@@ -1 +1 @@
-tanto questa ? solo una prova :\
+tanto questa e' solo una prova :\

Modified: trunk/fs/fcntl.c
===================================================================
--- trunk/fs/fcntl.c	2010-01-06 23:21:54 UTC (rev 164)
+++ trunk/fs/fcntl.c	2010-01-07 20:11:12 UTC (rev 165)
@@ -46,7 +46,7 @@
 		mpid = get_mountpoint_id(path);
 		fd_list[cur_fd].mountpoint_id = mpid;				
 		path = get_rel_path(mpid, path);
-		printf("Mpoint id: %d %s\n", mpid, path);
+		printf("Mpoint id: %d %s\n", fd_list[cur_fd].mountpoint_id, path);		
 		if(mountpoint_list[fd_list[cur_fd].mountpoint_id].operations.open != NULL)
 			mountpoint_list[fd_list[cur_fd].mountpoint_id].operations.open(path, oflags);
 		else 

Modified: trunk/fs/initrd.c
===================================================================
--- trunk/fs/initrd.c	2010-01-06 23:21:54 UTC (rev 164)
+++ trunk/fs/initrd.c	2010-01-07 20:11:12 UTC (rev 165)
@@ -27,14 +27,22 @@
 extern char *module_start;
 initrd_t *fs_specs;
 initrd_file_t* fs_headers;
+initrd_fd ird_descriptors[MAX_INITRD_DESCRIPTORS];
+unsigned int cur_irdfd;
 
 void dummy(){
 	printf("Qui solo per una prova\n");
 }	
 
 int initfs_init(){	
+	int i=0;
 	fs_specs = (initrd_t *) module_start;
 	fs_headers = (initrd_file_t *)(module_start + sizeof(initrd_t));
+	while (i<MAX_INITRD_DESCRIPTORS) {
+		ird_descriptors[i].file_descriptor = -1;
+		i++;
+	}
+	cur_irdfd = 0;
 	return fs_specs->nfiles;
 	//printf("Number of files present: %d\n", fs_specs->nfiles);		
 }
@@ -46,15 +54,18 @@
 
 int initfs_open(const char *path, int flags, ...){
 	initrd_file_t *module_var;
-	int ifs_fd;
-	ifs_fd = 0;
+	int ifs_fd;	
 	int j = 0;
 	module_var = fs_headers;	
 	while (j < fs_specs->nfiles) {
-		if(!strcmp(path, module_var[j].fileName)) printf("%s Found. Size: %d\n", path, module_var[j].length);
+		if(!strcmp(path, module_var[j].fileName)){
+				ird_descriptors[cur_irdfd].file_descriptor	= j;
+				printf("%s Found. Size: %d FS fd val: %d - ID File val: %d\n", path, module_var[j].length, cur_irdfd, ird_descriptors[cur_irdfd].file_descriptor);
+				return cur_irdfd++;
+		}
 		j++;
 	}
-	return ifs_fd;
+	return -1;	
 }
 
 ssize_t initfs_read(int fildes, void *buf, size_t nbyte){

Modified: trunk/include/fs/initrd.h
===================================================================
--- trunk/include/fs/initrd.h	2010-01-06 23:21:54 UTC (rev 164)
+++ trunk/include/fs/initrd.h	2010-01-07 20:11:12 UTC (rev 165)
@@ -24,21 +24,33 @@
 
 #define FILENAME_LENGTH 64
 #define MAX_FILES 32
+#define MAX_INITRD_DESCRIPTORS 10
 
+/*! Contiene il numero dei files contenuti nel filesystem initrd.
+ */
 struct initrd_t{
-	int nfiles;
+	int nfiles; /*!< Numero Files letti*/
 };
 
+/*! Contiene le informazioni relative ai singoli files contenuti in initrd
+ */
 struct initrd_file_t{
-	int magic;
-	char fileName[FILENAME_LENGTH];
-	int  uid;
-	unsigned int offset;
-	unsigned int length;
+	int magic; /*!< Numero usato come delimitatore da settare a 0xBF*/
+	char fileName[FILENAME_LENGTH]; /*!< Nome del file*/
+	int  uid; /*!< User id del proprietario del file */
+	unsigned int offset; /*!< indirizzo relativo di partenza */
+	unsigned int length; /*!< Dimensione del File */
 };
 
+/*! File Descriptor relativo ai files aperti.
+ */
+struct initrd_fd{
+	int file_descriptor;
+};
+
 typedef struct initrd_t initrd_t;
 typedef struct initrd_file_t initrd_file_t;
+typedef struct initrd_fd initrd_fd;
 
 extern initrd_t* fs_specs;
 extern initrd_file_t* fs_headers;

Modified: trunk/include/version.h
===================================================================
--- trunk/include/version.h	2010-01-06 23:21:54 UTC (rev 164)
+++ trunk/include/version.h	2010-01-07 20:11:12 UTC (rev 165)
@@ -24,4 +24,4 @@
 #define PATCHLEVEL "2.0"
 #define EXTRAVERSION "-trunk"
 #define NAME "DreamOS"
-#define REV_NUM "-r160"
+#define REV_NUM "-r164"



From n3mes1s at mail.berlios.de  Thu Jan  7 22:56:09 2010
From: n3mes1s at mail.berlios.de (n3mes1s at mail.berlios.de)
Date: Thu, 7 Jan 2010 22:56:09 +0100
Subject: [Dreamos-dev] r166 - in trunk: . fs include libc sys utils
Message-ID: <201001072156.o07Lu9d8013294@sheep.berlios.de>

Author: n3mes1s
Date: 2010-01-07 22:55:44 +0100 (Thu, 07 Jan 2010)
New Revision: 166

Modified:
   trunk/dreamos.img
   trunk/fs/initrd.c
   trunk/include/version.h
   trunk/libc/stdio.c
   trunk/sys/dirent.c
   trunk/utils/initfs
   trunk/utils/initfscp.c
Log:


Modified: trunk/dreamos.img
===================================================================
(Binary files differ)

Modified: trunk/fs/initrd.c
===================================================================
--- trunk/fs/initrd.c	2010-01-07 20:11:12 UTC (rev 165)
+++ trunk/fs/initrd.c	2010-01-07 21:55:44 UTC (rev 166)
@@ -17,7 +17,6 @@
  */
 
 #include <stdio.h>
-#include <stddef.h>
 #include <initrd.h>
 #include <multiboot.h>
 #include <unistd.h>

Modified: trunk/include/version.h
===================================================================
--- trunk/include/version.h	2010-01-07 20:11:12 UTC (rev 165)
+++ trunk/include/version.h	2010-01-07 21:55:44 UTC (rev 166)
@@ -24,4 +24,4 @@
 #define PATCHLEVEL "2.0"
 #define EXTRAVERSION "-trunk"
 #define NAME "DreamOS"
-#define REV_NUM "-r164"
+#define REV_NUM "-r165"

Modified: trunk/libc/stdio.c
===================================================================
--- trunk/libc/stdio.c	2010-01-07 20:11:12 UTC (rev 165)
+++ trunk/libc/stdio.c	2010-01-07 21:55:44 UTC (rev 166)
@@ -31,7 +31,6 @@
 #include <keyboard.h>
 #include <kheap.h>
 #include <debug.h>
-#include <string.h>
 
 #define LEFT 1
 #define RIGHT 0

Modified: trunk/sys/dirent.c
===================================================================
--- trunk/sys/dirent.c	2010-01-07 20:11:12 UTC (rev 165)
+++ trunk/sys/dirent.c	2010-01-07 21:55:44 UTC (rev 166)
@@ -20,7 +20,6 @@
 #include <sys/types.h>
 #include <stdio.h>
 #include <string.h>
-#include <stddef.h>
 #include <vfs.h>
 #include <kheap.h>
 

Modified: trunk/utils/initfs
===================================================================
(Binary files differ)

Modified: trunk/utils/initfscp.c
===================================================================
--- trunk/utils/initfscp.c	2010-01-07 20:11:12 UTC (rev 165)
+++ trunk/utils/initfscp.c	2010-01-07 21:55:44 UTC (rev 166)
@@ -54,7 +54,7 @@
 			i=0;
 			for(i=0; i< argc - 2; i++){
 				FILE *fd;
-				fd = fopen(argv[i+1], "r+");
+				fd = fopen(argv[i+1],"r+");
 				if(fd == NULL){
 					 printf("Error one or more files not found\n");
 					 // Debug
@@ -62,7 +62,10 @@
 					 return -1;
 				 }
 				else {
-					strcpy(headers[i].fileName, argv[i+1]);
+					if ((strpbrk(argv[i+1], "/")) != NULL)
+						strcpy(headers[i].fileName, strtok(strrchr(argv[i+1],'/'), "/"));
+					else
+						strcpy(headers[i].fileName, argv[i+1]);
 					fseek(fd, 0, SEEK_END);
 					printf("\tFile %s Found! Size: %d\n", argv[i+1], ftell(fd));				
 					headers[i].length = ftell(fd);



From finarfin at mail.berlios.de  Thu Jan  7 23:40:21 2010
From: finarfin at mail.berlios.de (finarfin at BerliOS)
Date: Thu, 7 Jan 2010 23:40:21 +0100
Subject: [Dreamos-dev] r167 - in trunk: . fs include include/fs shell sys
Message-ID: <201001072240.o07MeLDF016477@sheep.berlios.de>

Author: finarfin
Date: 2010-01-07 23:40:20 +0100 (Thu, 07 Jan 2010)
New Revision: 167

Added:
   trunk/Makefile.am
Modified:
   trunk/Makefile
   trunk/dreamos.img
   trunk/fs/fcntl.c
   trunk/fs/initrd.c
   trunk/include/fs/vfs.h
   trunk/include/version.h
   trunk/shell/commands.c
   trunk/shell/shell.c
   trunk/shell/testing.c
   trunk/sys/dirent.c
Log:
Modificata initfs_open
Aggiornata la open (ora assegna al campo fs_spec_id di fd_list
il valore ritornato dalla initfs_open
Aggiunto Makefile.am per dare una compilazione piu pulita.
Eliminati alcuni warning.


Modified: trunk/Makefile
===================================================================
--- trunk/Makefile	2010-01-07 21:55:44 UTC (rev 166)
+++ trunk/Makefile	2010-01-07 22:40:20 UTC (rev 167)
@@ -7,6 +7,8 @@
 PATCHLEVEL = 2.0
 EXTRAVERSION = -trunk
 
+include Makefile.am
+
 CFLAGS = -nostdlib\
 	 -nostdinc\
 	 -fomit-frame-pointer\
@@ -65,10 +67,10 @@
 	mv kernel.bin dreamos.img
 
 bl.img : boot/multicatcher.S
-	nasm -f elf ./boot/multicatcher.S -o bl.img
+	$(ASM) -f elf ./boot/multicatcher.S -o bl.img
 
 kernel.bin: $(OBJ)
-	ld -static --oformat elf32-i386 --output=kernel.bin --script=kernel.lds bl.img $(OBJ) -Ttext 0x100000 -Map kernel.map
+	$(LD) -static --oformat elf32-i386 --output=kernel.bin --script=kernel.lds bl.img $(OBJ) -Ttext 0x100000 -Map kernel.map
 	make -f utils/Makefile
 
 kernel.o: kernel.c

Added: trunk/Makefile.am
===================================================================
--- trunk/Makefile.am	2010-01-07 21:55:44 UTC (rev 166)
+++ trunk/Makefile.am	2010-01-07 22:40:20 UTC (rev 167)
@@ -0,0 +1,17 @@
+ARCH = x86
+
+
+PROMPT = " -> " 
+
+LD = @echo "   " $(PROMPT) LD "    " $ && ld
+CC = @echo "   " $(PROMPT) CC "    " $< && gcc
+ASM = @echo "   " $(PROMPT) ASM "   " $< && nasm
+AR = @echo "   " $(PROMPT) AR "    " $ && ar
+CD = @echo  $(PROMPT) CD "        " $(DIR) && cd
+
+
+.c.o: 
+	$(CC) -c $(CFLAGS) -o "$@" "$<"
+
+.s.o:
+	$(ASM) $(ASFLAGS) $<

Modified: trunk/dreamos.img
===================================================================
(Binary files differ)

Modified: trunk/fs/fcntl.c
===================================================================
--- trunk/fs/fcntl.c	2010-01-07 21:55:44 UTC (rev 166)
+++ trunk/fs/fcntl.c	2010-01-07 22:40:20 UTC (rev 167)
@@ -45,12 +45,15 @@
 	else {		
 		mpid = get_mountpoint_id(path);
 		fd_list[cur_fd].mountpoint_id = mpid;				
-		path = get_rel_path(mpid, path);
-		printf("Mpoint id: %d %s\n", fd_list[cur_fd].mountpoint_id, path);		
-		if(mountpoint_list[fd_list[cur_fd].mountpoint_id].operations.open != NULL)
-			mountpoint_list[fd_list[cur_fd].mountpoint_id].operations.open(path, oflags);
-		else 
+		path = get_rel_path(mpid, path);		
+		if(mountpoint_list[fd_list[cur_fd].mountpoint_id].operations.open != NULL){
+			fd_list[cur_fd].fs_spec_id = (int) mountpoint_list[fd_list[cur_fd].mountpoint_id].operations.open(path, oflags);
+			printf("Mpoint id: %d %s fs_spec_fd: %d\n", fd_list[cur_fd].mountpoint_id, path, fd_list[cur_fd].fs_spec_id);		
+		}
+		else {
 			printf("No OPEN services found here\n");		
+			return -1;
+		}
 	}	
 	va_end(ap);
 	return cur_fd++;

Modified: trunk/fs/initrd.c
===================================================================
--- trunk/fs/initrd.c	2010-01-07 21:55:44 UTC (rev 166)
+++ trunk/fs/initrd.c	2010-01-07 22:40:20 UTC (rev 167)
@@ -53,7 +53,6 @@
 
 int initfs_open(const char *path, int flags, ...){
 	initrd_file_t *module_var;
-	int ifs_fd;	
 	int j = 0;
 	module_var = fs_headers;	
 	while (j < fs_specs->nfiles) {

Modified: trunk/include/fs/vfs.h
===================================================================
--- trunk/include/fs/vfs.h	2010-01-07 21:55:44 UTC (rev 166)
+++ trunk/include/fs/vfs.h	2010-01-07 22:40:20 UTC (rev 167)
@@ -38,7 +38,7 @@
 
 struct super_node_operations {
 	/*Qui vanno i puntatori alle funzioni sul supernode*/
-	void (*open)(const char *, int );
+	int (*open)(const char *, int );
 	void (*close)(int);
 	int (*read)(int, void*, size_t);
 	int (*write)(int, void*, size_t);

Modified: trunk/include/version.h
===================================================================
--- trunk/include/version.h	2010-01-07 21:55:44 UTC (rev 166)
+++ trunk/include/version.h	2010-01-07 22:40:20 UTC (rev 167)
@@ -24,4 +24,4 @@
 #define PATCHLEVEL "2.0"
 #define EXTRAVERSION "-trunk"
 #define NAME "DreamOS"
-#define REV_NUM "-r165"
+#define REV_NUM "-r167"

Modified: trunk/shell/commands.c
===================================================================
--- trunk/shell/commands.c	2010-01-07 21:55:44 UTC (rev 166)
+++ trunk/shell/commands.c	2010-01-07 22:40:20 UTC (rev 167)
@@ -422,7 +422,7 @@
 		return;
 	} else { 
 		for ( i = 0 ; i <= MAX_TEST ; i++) {
-			if ( (strcmp(argv[1], testing[i].cmd_testname) ) == NULL ) {
+			if ( (strcmp(argv[1], testing[i].cmd_testname) ) == (int) NULL ) {
 				 (testing[i].func)();
 				break;
 			} 

Modified: trunk/shell/shell.c
===================================================================
--- trunk/shell/shell.c	2010-01-07 21:55:44 UTC (rev 166)
+++ trunk/shell/shell.c	2010-01-07 22:40:20 UTC (rev 167)
@@ -72,7 +72,7 @@
 {
   char cmd[CMD_LEN];
   char *cmd_ptr;
-  char *user = kmalloc(USER_LEN);
+  //char *user = kmalloc(USER_LEN);
   
   static struct cmd shell_cmd[NUM_COM] = {
 	{ "aalogo",   aalogo      },
@@ -127,7 +127,7 @@
         goto end;
 
     for (i = NUM_COM; i >= 0; --i) {
-        if(strcmp(argv[0], shell_cmd[i].cmdname) == NULL) {
+        if(strcmp(argv[0], shell_cmd[i].cmdname) == (int) NULL) {
             (*shell_cmd[i].h_func)();
             break;
         }

Modified: trunk/shell/testing.c
===================================================================
--- trunk/shell/testing.c	2010-01-07 21:55:44 UTC (rev 166)
+++ trunk/shell/testing.c	2010-01-07 22:40:20 UTC (rev 167)
@@ -139,6 +139,7 @@
 	char *prova;
 	int i;
 	i=0;
+	prova = NULL;
 	while(i<50){
 		appoggio[i] = '\0';
 		i++;

Modified: trunk/sys/dirent.c
===================================================================
--- trunk/sys/dirent.c	2010-01-07 21:55:44 UTC (rev 166)
+++ trunk/sys/dirent.c	2010-01-07 22:40:20 UTC (rev 167)
@@ -29,7 +29,7 @@
 	int mpoint_id = 0;
 	char* rel_path;
 
-	mpoint_id = get_mountpoint_id(path);
+	mpoint_id = get_mountpoint_id((char*)path);
 	rel_path = get_rel_path(mpoint_id, path);	
 	printf("%d - %s\n", mpoint_id, rel_path);
 	if(mountpoint_list[mpoint_id].dir_op.opendir_f!=NULL) {
@@ -39,13 +39,16 @@
 		printf("Could not open_dir no function found\n");
 		return NULL;
 	}
+	return NULL;
 }
 
 int closedir(DIR *dirp){
 	printf("Closing directory\n");
 	free(dirp);
+	return 0;
 }
 
 DIR* fake_opendir (const char *path){
 	printf("One day, when i will grow up, i could open that path: %s\n", path);
+	return NULL;
 }



From finarfin at mail.berlios.de  Fri Jan  8 18:53:15 2010
From: finarfin at mail.berlios.de (finarfin at BerliOS)
Date: Fri, 8 Jan 2010 18:53:15 +0100
Subject: [Dreamos-dev] r168 - in trunk: . fs include/fs include/libc
Message-ID: <201001081753.o08HrFas002847@sheep.berlios.de>

Author: finarfin
Date: 2010-01-08 18:53:08 +0100 (Fri, 08 Jan 2010)
New Revision: 168

Modified:
   trunk/dreamos.img
   trunk/fs/initrd.c
   trunk/fs/unistd.c
   trunk/include/fs/initrd.h
   trunk/include/libc/stdio.h
Log:
Aggiunto EOF in stdio.h
Completata una bozza di initfs_read (Da pulire e sistemare)
Sistemati alcuni valori nella open.
Ora dreamOS legge i FILES


Modified: trunk/dreamos.img
===================================================================
(Binary files differ)

Modified: trunk/fs/initrd.c
===================================================================
--- trunk/fs/initrd.c	2010-01-07 22:40:20 UTC (rev 167)
+++ trunk/fs/initrd.c	2010-01-08 17:53:08 UTC (rev 168)
@@ -23,7 +23,7 @@
 #include <types.h>
 #include <string.h>
 
-extern char *module_start;
+char *module_start;
 initrd_t *fs_specs;
 initrd_file_t* fs_headers;
 initrd_fd ird_descriptors[MAX_INITRD_DESCRIPTORS];
@@ -59,7 +59,7 @@
 		if(!strcmp(path, module_var[j].fileName)){
 				ird_descriptors[cur_irdfd].file_descriptor	= j;
 				printf("%s Found. Size: %d FS fd val: %d - ID File val: %d\n", path, module_var[j].length, cur_irdfd, ird_descriptors[cur_irdfd].file_descriptor);
-				return cur_irdfd++;
+				return cur_irdfd++; 
 		}
 		j++;
 	}
@@ -67,6 +67,18 @@
 }
 
 ssize_t initfs_read(int fildes, void *buf, size_t nbyte){
-	printf("Hi i'm a dummy read... do you like me?\n");
+	char *file_start;
+	int lfd, file_size;	
+	int j=0;
+	lfd = ird_descriptors[fildes].file_descriptor;
+	file_size = fs_headers[lfd].length;
+	file_start = (char *) (module_start	+ fs_headers[lfd].offset);
+	printf("Hi i'm a dummy read... The file id is: %d\n", ird_descriptors[fildes].file_descriptor);
+	printf("try to read something...\n");
+	while(j<file_size){
+		putchar(file_start[j]);
+		j++;
+	}
+	putchar('\n');	
 	return nbyte;
 }

Modified: trunk/fs/unistd.c
===================================================================
--- trunk/fs/unistd.c	2010-01-07 22:40:20 UTC (rev 167)
+++ trunk/fs/unistd.c	2010-01-08 17:53:08 UTC (rev 168)
@@ -26,10 +26,12 @@
 
 ssize_t read(int fildes, void *buf, size_t nbyte){
 	int mp_id = 0;
+	int fs_fd;
 	mp_id = fd_list[fildes].mountpoint_id;
-	printf("Mpoint id: %d\n", mp_id);
+	fs_fd = fd_list[fildes].fs_spec_id;
+	printf("Mpoint id: %d Fs_fd: %d\n", mp_id, fs_fd);
 	if (mountpoint_list[mp_id].operations.read != NULL)
-		mountpoint_list[mp_id].operations.read(mp_id, buf, 1);
+		mountpoint_list[mp_id].operations.read(fs_fd, buf, 1);
 	else
 		printf("No READ Found for that file system\n");
 }

Modified: trunk/include/fs/initrd.h
===================================================================
--- trunk/include/fs/initrd.h	2010-01-07 22:40:20 UTC (rev 167)
+++ trunk/include/fs/initrd.h	2010-01-08 17:53:08 UTC (rev 168)
@@ -26,13 +26,15 @@
 #define MAX_FILES 32
 #define MAX_INITRD_DESCRIPTORS 10
 
-/*! Contiene il numero dei files contenuti nel filesystem initrd.
+/*! \struct initrd_t
+    \brief Contiene il numero dei files contenuti nel filesystem initrd.
  */
 struct initrd_t{
 	int nfiles; /*!< Numero Files letti*/
 };
 
-/*! Contiene le informazioni relative ai singoli files contenuti in initrd
+/*! \struct initrd_file_t 
+    \brief Contiene le informazioni relative ai singoli files contenuti in initrd
  */
 struct initrd_file_t{
 	int magic; /*!< Numero usato come delimitatore da settare a 0xBF*/
@@ -42,7 +44,8 @@
 	unsigned int length; /*!< Dimensione del File */
 };
 
-/*! File Descriptor relativo ai files aperti.
+/*! \struct initrd_fd 
+    \brief File Descriptor relativo ai files aperti.
  */
 struct initrd_fd{
 	int file_descriptor;

Modified: trunk/include/libc/stdio.h
===================================================================
--- trunk/include/libc/stdio.h	2010-01-07 22:40:20 UTC (rev 167)
+++ trunk/include/libc/stdio.h	2010-01-08 17:53:08 UTC (rev 168)
@@ -28,6 +28,10 @@
 
 #define MAX_DIGITS_IN_INTEGER 11
 
+#ifndef EOF
+#define EOF (-1)
+#endif
+
 void putchar (char ch);
 int atoi (const char *);
 int printf (const char *, ...);



From finarfin at mail.berlios.de  Fri Jan  8 19:15:15 2010
From: finarfin at mail.berlios.de (finarfin at BerliOS)
Date: Fri, 8 Jan 2010 19:15:15 +0100
Subject: [Dreamos-dev] r169 - trunk/boot
Message-ID: <201001081815.o08IFFBu000284@sheep.berlios.de>

Author: finarfin
Date: 2010-01-08 19:14:31 +0100 (Fri, 08 Jan 2010)
New Revision: 169

Added:
   trunk/boot/grub.img
Removed:
   trunk/boot/grub.img
Log:
Aggiornato grub.img levando il percorso relativo nel nome dei files.
Per testare la lettura dei files:
   tester try_open
e ai nomi files disponibili ricordare di anteporre: / (p.es: /test1.txt)



Deleted: trunk/boot/grub.img
===================================================================
(Binary files differ)

Added: trunk/boot/grub.img
===================================================================
(Binary files differ)


Property changes on: trunk/boot/grub.img
___________________________________________________________________
Name: svn:executable
   + *
Name: svn:mime-type
   + application/octet-stream



From finarfin at mail.berlios.de  Sat Jan  9 01:24:45 2010
From: finarfin at mail.berlios.de (finarfin at BerliOS)
Date: Sat, 9 Jan 2010 01:24:45 +0100
Subject: [Dreamos-dev] r170 - in trunk: . fs shell
Message-ID: <201001090024.o090OjeX020633@sheep.berlios.de>

Author: finarfin
Date: 2010-01-09 01:24:38 +0100 (Sat, 09 Jan 2010)
New Revision: 170

Modified:
   trunk/dreamos.img
   trunk/fs/fcntl.c
   trunk/fs/initrd.c
   trunk/fs/unistd.c
   trunk/shell/testing.c
Log:
Pulizia di alcune stampe di debug relative all'initfs.


Modified: trunk/dreamos.img
===================================================================
(Binary files differ)

Modified: trunk/fs/fcntl.c
===================================================================
--- trunk/fs/fcntl.c	2010-01-08 18:14:31 UTC (rev 169)
+++ trunk/fs/fcntl.c	2010-01-09 00:24:38 UTC (rev 170)
@@ -40,7 +40,7 @@
 	va_start(ap, oflags);
 	
 	prova = va_arg(ap, int);
-	printf("Prova vale: %d e il path: %s e cur_fd: %d\n", prova,path,cur_fd);
+	//printf("Magic value: %d e il path: %s e cur_fd: %d\n", prova,path,cur_fd);
 	if(cur_fd >= _SC_OPEN_MAX) cur_fd=0;
 	else {		
 		mpid = get_mountpoint_id(path);
@@ -48,14 +48,15 @@
 		path = get_rel_path(mpid, path);		
 		if(mountpoint_list[fd_list[cur_fd].mountpoint_id].operations.open != NULL){
 			fd_list[cur_fd].fs_spec_id = (int) mountpoint_list[fd_list[cur_fd].mountpoint_id].operations.open(path, oflags);
-			printf("Mpoint id: %d %s fs_spec_fd: %d\n", fd_list[cur_fd].mountpoint_id, path, fd_list[cur_fd].fs_spec_id);		
+			//printf("Mpoint id: %d %s fs_spec_fd: %d\n", fd_list[cur_fd].mountpoint_id, path, fd_list[cur_fd].fs_spec_id);			
 		}
 		else {
 			printf("No OPEN services found here\n");		
+			va_end(ap);
 			return -1;
 		}
 	}	
-	va_end(ap);
+	va_end(ap)
 	return cur_fd++;
 }
 

Modified: trunk/fs/initrd.c
===================================================================
--- trunk/fs/initrd.c	2010-01-08 18:14:31 UTC (rev 169)
+++ trunk/fs/initrd.c	2010-01-09 00:24:38 UTC (rev 170)
@@ -73,12 +73,11 @@
 	lfd = ird_descriptors[fildes].file_descriptor;
 	file_size = fs_headers[lfd].length;
 	file_start = (char *) (module_start	+ fs_headers[lfd].offset);
-	printf("Hi i'm a dummy read... The file id is: %d\n", ird_descriptors[fildes].file_descriptor);
-	printf("try to read something...\n");
+	//printf("Hi i'm a dummy read... The file id is: %d\n", ird_descriptors[fildes].file_descriptor);
+	//printf("try to read something...\n");
 	while(j<file_size){
 		putchar(file_start[j]);
 		j++;
-	}
-	putchar('\n');	
+	}	
 	return nbyte;
 }

Modified: trunk/fs/unistd.c
===================================================================
--- trunk/fs/unistd.c	2010-01-08 18:14:31 UTC (rev 169)
+++ trunk/fs/unistd.c	2010-01-09 00:24:38 UTC (rev 170)
@@ -29,7 +29,7 @@
 	int fs_fd;
 	mp_id = fd_list[fildes].mountpoint_id;
 	fs_fd = fd_list[fildes].fs_spec_id;
-	printf("Mpoint id: %d Fs_fd: %d\n", mp_id, fs_fd);
+	//printf("Mpoint id: %d Fs_fd: %d\n", mp_id, fs_fd);
 	if (mountpoint_list[mp_id].operations.read != NULL)
 		mountpoint_list[mp_id].operations.read(fs_fd, buf, 1);
 	else

Modified: trunk/shell/testing.c
===================================================================
--- trunk/shell/testing.c	2010-01-08 18:14:31 UTC (rev 169)
+++ trunk/shell/testing.c	2010-01-09 00:24:38 UTC (rev 170)
@@ -148,7 +148,8 @@
 	
 	scanf("%s", appoggio);	
 	i = open(appoggio, O_RDONLY, 42);
-	read(i, prova, 1);
+	if(i>-1) read(i, prova, 1);
+	printf("\n");
 }
 
 void try_fsinit(){



From finarfin at mail.berlios.de  Sat Jan  9 14:31:59 2010
From: finarfin at mail.berlios.de (finarfin at BerliOS)
Date: Sat, 9 Jan 2010 14:31:59 +0100
Subject: [Dreamos-dev] r171 - in trunk: . fs shell
Message-ID: <201001091331.o09DVx4o011317@sheep.berlios.de>

Author: finarfin
Date: 2010-01-09 14:31:58 +0100 (Sat, 09 Jan 2010)
New Revision: 171

Modified:
   trunk/dreamos.img
   trunk/fs/fcntl.c
   trunk/fs/vfs.c
   trunk/shell/testing.c
Log:
Aggiornati alcuni controlli in open.
Inserita al comando tester try_open la chiamata a close. 
Aggiunto il controllo sul valore di mpid in open


Modified: trunk/dreamos.img
===================================================================
(Binary files differ)

Modified: trunk/fs/fcntl.c
===================================================================
--- trunk/fs/fcntl.c	2010-01-09 00:24:38 UTC (rev 170)
+++ trunk/fs/fcntl.c	2010-01-09 13:31:58 UTC (rev 171)
@@ -43,15 +43,16 @@
 	//printf("Magic value: %d e il path: %s e cur_fd: %d\n", prova,path,cur_fd);
 	if(cur_fd >= _SC_OPEN_MAX) cur_fd=0;
 	else {		
-		mpid = get_mountpoint_id(path);
+		mpid = get_mountpoint_id(path);		
 		fd_list[cur_fd].mountpoint_id = mpid;				
 		path = get_rel_path(mpid, path);		
-		if(mountpoint_list[fd_list[cur_fd].mountpoint_id].operations.open != NULL){
+		if( mpid > -1 && mountpoint_list[fd_list[cur_fd].mountpoint_id].operations.open > NULL){
 			fd_list[cur_fd].fs_spec_id = (int) mountpoint_list[fd_list[cur_fd].mountpoint_id].operations.open(path, oflags);
 			//printf("Mpoint id: %d %s fs_spec_fd: %d\n", fd_list[cur_fd].mountpoint_id, path, fd_list[cur_fd].fs_spec_id);			
 		}
 		else {
-			printf("No OPEN services found here\n");		
+			if(mpid>-1) printf("No OPEN services found here\n");		
+			else printf("That path doesn't exist\n");
 			va_end(ap);
 			return -1;
 		}

Modified: trunk/fs/vfs.c
===================================================================
--- trunk/fs/vfs.c	2010-01-09 00:24:38 UTC (rev 170)
+++ trunk/fs/vfs.c	2010-01-09 13:31:58 UTC (rev 171)
@@ -41,8 +41,8 @@
 	printf(LNG_VFS); 	
 
 	while (j<_SC_OPEN_MAX){
-		fd_list[j].fs_spec_id = 0;
-		fd_list[j].mountpoint_id =0;
+		fd_list[j].fs_spec_id = -1;
+		fd_list[j].mountpoint_id =-1;
 		j++;
 	}
  	

Modified: trunk/shell/testing.c
===================================================================
--- trunk/shell/testing.c	2010-01-09 00:24:38 UTC (rev 170)
+++ trunk/shell/testing.c	2010-01-09 13:31:58 UTC (rev 171)
@@ -149,6 +149,7 @@
 	scanf("%s", appoggio);	
 	i = open(appoggio, O_RDONLY, 42);
 	if(i>-1) read(i, prova, 1);
+	close(i);
 	printf("\n");
 }
 



From osiris_h4ck at mail.berlios.de  Sat Jan  9 16:19:57 2010
From: osiris_h4ck at mail.berlios.de (osiris_h4ck at BerliOS)
Date: Sat, 9 Jan 2010 16:19:57 +0100
Subject: [Dreamos-dev] r172 - in trunk: . drivers include include/drivers
	include/io include/shell shell
Message-ID: <201001091519.o09FJv4i019708@sheep.berlios.de>

Author: osiris_h4ck
Date: 2010-01-09 16:19:54 +0100 (Sat, 09 Jan 2010)
New Revision: 172

Modified:
   trunk/.bochsrc
   trunk/Makefile
   trunk/drivers/keyboard.c
   trunk/grub.py
   trunk/include/drivers/keyboard.h
   trunk/include/io/video.h
   trunk/include/shell/shell.h
   trunk/include/version.h
   trunk/shell/shell.c
   trunk/shell/testing.c
   trunk/start.sh
Log:
- Effettuate diverse ottimizzazioni
- Aggiunti diversi scancode nel driver per la keyboard
- Scritto primo abbozzo di History per la shell, avviabile tramite KEY_ARROWUP della tastiera
- Corretto piccolo problema con grub.py



Modified: trunk/.bochsrc
===================================================================
--- trunk/.bochsrc	2010-01-09 13:31:58 UTC (rev 171)
+++ trunk/.bochsrc	2010-01-09 15:19:54 UTC (rev 172)
@@ -16,8 +16,8 @@
 # NOTE: if you use the "wx" configuration interface, you must also use
 # the "wx" display library.
 #=======================================================================
-#config_interface: textconfig
-config_interface: wx
+config_interface: textconfig
+#config_interface: wx
 
 #=======================================================================
 # DISPLAY_LIBRARY
@@ -59,9 +59,9 @@
 #display_library: sdl, options="fullscreen" # startup in fullscreen mode
 #display_library: term
 #display_library: win32, options="legacyF12" # use F12 to toggle mouse
-display_library: wx
+#display_library: wx
 #display_library: x, options="gui_debug"
-#display_library: x
+display_library: x
 #=======================================================================
 # ROMIMAGE:
 # The ROM BIOS controls what the PC does when it first powers on.
@@ -541,7 +541,7 @@
 #   mouse: enabled=1, type=serial
 #   mouse: enabled=0
 #=======================================================================
-mouse: enabled=1, type=ps2
+#mouse: enabled=1, type=ps2
 
 #=======================================================================
 # private_colormap: Request that the GUI create and use it's own

Modified: trunk/Makefile
===================================================================
--- trunk/Makefile	2010-01-09 13:31:58 UTC (rev 171)
+++ trunk/Makefile	2010-01-09 15:19:54 UTC (rev 172)
@@ -70,7 +70,7 @@
 	$(ASM) -f elf ./boot/multicatcher.S -o bl.img
 
 kernel.bin: $(OBJ)
-	$(LD) -static --oformat elf32-i386 --output=kernel.bin --script=kernel.lds bl.img $(OBJ) -Ttext 0x100000 -Map kernel.map
+	$(LD) -melf_i386 -static --oformat elf32-i386 --output=kernel.bin --script=kernel.lds bl.img $(OBJ) -Ttext 0x100000 -Map kernel.map
 	make -f utils/Makefile
 
 kernel.o: kernel.c

Modified: trunk/drivers/keyboard.c
===================================================================
--- trunk/drivers/keyboard.c	2010-01-09 13:31:58 UTC (rev 171)
+++ trunk/drivers/keyboard.c	2010-01-09 15:19:54 UTC (rev 172)
@@ -29,6 +29,7 @@
 #include <ctype.h>
 #include <io.h>
 #include <pic8259.h>
+#include <shell.h>
 
 #define LSHIFT_BREAK 0x10E
 #define RSHIFT_BREAK 0x11A
@@ -194,16 +195,33 @@
 	last_tab++;
 	break;
 
-    /*case KEY_PGUP:
-        _kputs ("Tada");
-         _kscrollup();
-	break;*/
+    case KEY_UPARROW:
+	history_start();
+    	_ksetcursauto();
+	break;
 
-    /*case 813:
-        _kputs ("tutu");
-	_kscrolldown();
-	break;*/
+    case KEY_DOWNARROW:
+	break;
+	
+    case KEY_LEFTARROW:
+    	//_ksetcursor((_kgetline()), (_kgetcolumn() - 1));
+	break;
+	
+    case KEY_RIGHTARROW:
+    	//_ksetcursor((_kgetline()), (_kgetcolumn() + 1));
+	break;
 
+// Presente un bug qui che non permette il fix dei relativi tasti
+// se si decommenta, il sistema all'avvio va in panic e si riavvia
+/*    case KEY_ALT:
+	break;
+
+    case KEY_ALTGR:
+	break;
+*/	
+    case KEY_CTRL:
+	break;
+	
     default:
 	if (isdigit(key_it_map[sc]) && is_tab_pressed == 1)
 	    curmap = key_it_map;

Modified: trunk/grub.py
===================================================================
--- trunk/grub.py	2010-01-09 13:31:58 UTC (rev 171)
+++ trunk/grub.py	2010-01-09 15:19:54 UTC (rev 172)
@@ -4,7 +4,8 @@
 import sys
 import os
 import commands
-trunk = commands.getoutput("cat .svn/entries | head -n 4 | tail -n 1")
+#trunk = commands.getoutput("cat .svn/entries | head -n 4 | tail -n 1")
+trunk = "-svn"
 patchlevel = commands.getoutput("cat include/version.h | grep PATCHLEVEL | cut -b 21-23")
 
 if os.getuid() != 0:
@@ -47,7 +48,7 @@
 answer2 = raw_input()
 
 if answer2 == 'y':
-
+	os.system("su -c 'cp boot/grub2.xpm.gz /boot/grub/grub2.xpm.gz'")
 	print "+--------------------------- INFO ------------------------------+"
 	print "| splashimage=" + partition + "/boot/grub/grub2.xpm.gz 			|"
 	print "| Title: DreamOS v0." + patchlevel + "-" + trunk +"                                     |"

Modified: trunk/include/drivers/keyboard.h
===================================================================
--- trunk/include/drivers/keyboard.h	2010-01-09 13:31:58 UTC (rev 171)
+++ trunk/include/drivers/keyboard.h	2010-01-09 15:19:54 UTC (rev 172)
@@ -36,6 +36,8 @@
 #define KEY_TAB        0xf
 #define KEY_UPARROW    0x48
 #define KEY_DOWNARROW  0x50
+#define KEY_LEFTARROW  0x4B
+#define KEY_RIGHTARROW 0x4D
 #define KEY_PGUP       0x49
 #define KEY_PGDOWN     0x51
 #define EXTENDED       0xE0
@@ -46,6 +48,7 @@
 #define KEY_RSHIFT     0x36
 #define KEY_CTRL       0x1d
 #define KEY_ALT        0x38
+#define KEY_ALTGR      0x39
 
 #define NUM_LED        0x45
 #define SCROLL_LED     0x46

Modified: trunk/include/io/video.h
===================================================================
--- trunk/include/io/video.h	2010-01-09 13:31:58 UTC (rev 171)
+++ trunk/include/io/video.h	2010-01-09 15:19:54 UTC (rev 172)
@@ -50,6 +50,7 @@
 void _kscrollup();
 void _kscrolldown();
 void _kntohex (char *, unsigned int);
+void _kclear_line();
 
 unsigned short shell_mess_col, shell_mess_line;
 

Modified: trunk/include/shell/shell.h
===================================================================
--- trunk/include/shell/shell.h	2010-01-09 13:31:58 UTC (rev 171)
+++ trunk/include/shell/shell.h	2010-01-09 15:19:54 UTC (rev 172)
@@ -22,6 +22,7 @@
 #define CMD_LEN 256
 #define CURPATH_LEN 256
 
+
 struct cmd {
 	const char cmdname[CMD_LEN];
 	void (*h_func)(void);
@@ -34,9 +35,9 @@
 
 //extern char cur_path[256];
 typedef struct user_env userenv_t;
-
 extern userenv_t current_user;
-
 void shell(void);
+void history (char *);
+void history_start(void);
 
 #endif

Modified: trunk/include/version.h
===================================================================
--- trunk/include/version.h	2010-01-09 13:31:58 UTC (rev 171)
+++ trunk/include/version.h	2010-01-09 15:19:54 UTC (rev 172)
@@ -24,4 +24,4 @@
 #define PATCHLEVEL "2.0"
 #define EXTRAVERSION "-trunk"
 #define NAME "DreamOS"
-#define REV_NUM "-r167"
+#define REV_NUM "-r170"

Modified: trunk/shell/shell.c
===================================================================
--- trunk/shell/shell.c	2010-01-09 13:31:58 UTC (rev 171)
+++ trunk/shell/shell.c	2010-01-09 15:19:54 UTC (rev 172)
@@ -40,7 +40,6 @@
 #include <sys/utsname.h>
 
 #define NUM_COM 30
-
 userenv_t current_user;
 /*
  * Inserisce gli argomenti di un comando in un array di stringhe
@@ -48,6 +47,10 @@
  * argv[0] = nome del comando
  * argv[n] = opzioni successive
  */
+
+int count = 9, posiz = 9, c = 10;
+char *lastcmd[10] = {};
+    
 void options(char *com)
 {
   int i=0;
@@ -114,11 +117,16 @@
   
   for (;;)
   {
+    for (c = 1 ; c <= 10 ; c++) {
+    	    lastcmd[c] = (char *)kmalloc(sizeof(char) * 30); 
+    }	    
     printf("%s~:%s# ", current_user.username, 
 				  current_user.cur_path,
 				  current_user.username);
     scanf("%254s",cmd);
-        
+    
+    history(cmd);
+   
     /* elimina eventuali spazi all'inizio del comando */
     for (i = 0, cmd_ptr = cmd; cmd[i] == ' '; i++, cmd_ptr++);
     
@@ -132,6 +140,7 @@
             break;
         }
     }
+
     if (i<0)
       printf(LNG_UNKNOWN_CMD " %s\n", argv[0]);
 
@@ -140,5 +149,32 @@
     for (--argc; argc>=0; argc--) {      
         free (argv[argc]);
     }
+    for (c = 1 ; c <= 10 ; c++) {
+    	    free(lastcmd[c]); 
+    }
   }
 }
+
+// History
+void history(char *cmd_pass) {
+    if ( count == 0 ) {
+		count = 10; 
+	}
+
+    strncpy(lastcmd[count], cmd_pass, strlen(cmd_pass));
+    
+    posiz = count;
+    count--;
+}
+
+void history_start(void) { 
+    static int sc;
+    count++;
+    if ( count == 0 || count > 9 ) {
+    	count = posiz;
+    }
+    if( (sc = inportb (0x60) ) == KEY_UPARROW ) {
+   		printf("\n%s", lastcmd[count]);
+    }  
+}
+

Modified: trunk/shell/testing.c
===================================================================
--- trunk/shell/testing.c	2010-01-09 13:31:58 UTC (rev 171)
+++ trunk/shell/testing.c	2010-01-09 15:19:54 UTC (rev 172)
@@ -108,7 +108,7 @@
 		"  -> try_printmem      - Print used locations of memory\n"
 		"  -> try_module        - Read the content of the memory zone loaded in module, aka initfs \n"
 		"  -> try_open          - Function to test open() & stdarg() \n"
-		"  -> try_fsinit          - Function to test the initialization of initrd\n"
+		"  -> try_fsinit        - Function to test the initialization of initrd\n"
 		);	
 }
 

Modified: trunk/start.sh
===================================================================
--- trunk/start.sh	2010-01-09 13:31:58 UTC (rev 171)
+++ trunk/start.sh	2010-01-09 15:19:54 UTC (rev 172)
@@ -206,7 +206,18 @@
 		  echo "----------------------->"                 
 	  fi  
 
-	$VERS && $CLEAN && $MAKE && $MAKE_IMG && $MAKE_FS
+	 $VERS && $CLEAN && $MAKE && $MAKE_IMG
+	  
+	 echo "--------------------------------------------- "
+  	 echo "Launching FS Creating script in progress.."
+	 echo ""
+         utils/initfscp `find files/* -exec echo {} +;` initfs
+         echo "done."
+         $MAKE_FS
+         echo "--------------------------------------------- "
+         echo "FS Created and added to boot/grub.img"
+         echo "---------------------------------------------"
+         
 	bochs -f .bochsrc -q
 	exit
 



From osiris_h4ck at mail.berlios.de  Sat Jan  9 16:29:26 2010
From: osiris_h4ck at mail.berlios.de (osiris_h4ck at BerliOS)
Date: Sat, 9 Jan 2010 16:29:26 +0100
Subject: [Dreamos-dev] r173 - in trunk: . boot include
Message-ID: <201001091529.o09FTQj5020264@sheep.berlios.de>

Author: osiris_h4ck
Date: 2010-01-09 16:28:46 +0100 (Sat, 09 Jan 2010)
New Revision: 173

Added:
   trunk/boot/grub.img
Removed:
   trunk/boot/grub.img
Modified:
   trunk/dreamos.img
   trunk/include/version.h
Log:
- Aggiornati dreamos.img e grub.img

--Questa linea, e quelle sotto di essa, saranno ignorate

M    include/version.h
RM   boot/grub.img
M    dreamos.img


Deleted: trunk/boot/grub.img
===================================================================
(Binary files differ)

Added: trunk/boot/grub.img
===================================================================
(Binary files differ)


Property changes on: trunk/boot/grub.img
___________________________________________________________________
Name: svn:executable
   + *
Name: svn:mime-type
   + application/octet-stream

Modified: trunk/dreamos.img
===================================================================
(Binary files differ)

Modified: trunk/include/version.h
===================================================================
--- trunk/include/version.h	2010-01-09 15:19:54 UTC (rev 172)
+++ trunk/include/version.h	2010-01-09 15:28:46 UTC (rev 173)
@@ -24,4 +24,4 @@
 #define PATCHLEVEL "2.0"
 #define EXTRAVERSION "-trunk"
 #define NAME "DreamOS"
-#define REV_NUM "-r170"
+#define REV_NUM "-r172"



From osiris_h4ck at mail.berlios.de  Sat Jan  9 16:29:48 2010
From: osiris_h4ck at mail.berlios.de (osiris_h4ck at BerliOS)
Date: Sat, 9 Jan 2010 16:29:48 +0100
Subject: [Dreamos-dev] r174 - trunk/include/io
Message-ID: <201001091529.o09FTmaq020295@sheep.berlios.de>

Author: osiris_h4ck
Date: 2010-01-09 16:29:48 +0100 (Sat, 09 Jan 2010)
New Revision: 174

Modified:
   trunk/include/io/video.h
Log:
- Applicate modiche a video.h



Modified: trunk/include/io/video.h
===================================================================
--- trunk/include/io/video.h	2010-01-09 15:28:46 UTC (rev 173)
+++ trunk/include/io/video.h	2010-01-09 15:29:48 UTC (rev 174)
@@ -50,7 +50,6 @@
 void _kscrollup();
 void _kscrolldown();
 void _kntohex (char *, unsigned int);
-void _kclear_line();
 
 unsigned short shell_mess_col, shell_mess_line;
 



From blackz at mail.berlios.de  Sat Jan  9 17:13:35 2010
From: blackz at mail.berlios.de (blackz at mail.berlios.de)
Date: Sat, 9 Jan 2010 17:13:35 +0100
Subject: [Dreamos-dev] r175 - trunk
Message-ID: <201001091613.o09GDZxJ024535@sheep.berlios.de>

Author: blackz
Date: 2010-01-09 17:11:26 +0100 (Sat, 09 Jan 2010)
New Revision: 175

Modified:
   trunk/start.sh
Log:


Modified: trunk/start.sh
===================================================================
--- trunk/start.sh	2010-01-09 15:29:48 UTC (rev 174)
+++ trunk/start.sh	2010-01-09 16:11:26 UTC (rev 175)
@@ -145,8 +145,8 @@
   exit
 
 else
-  echo "Uhm? What the hell did you insert ? Lool! '$1' ?? I don't know what is it!"
-  echo "Please, read the help!!!"
+  echo "'$1' is not a command known to me."
+  echo "Please, read the help!"
   echo "----------------------->"
   echo "Usage: '$0 help'"
   exit
@@ -264,8 +264,8 @@
   exit
 
 else
-  echo "Uhm? What the hell did you insert ? '$2' ?? I don't know what is it!"
-  echo "Please, read the help!!!"
+  echo "'$2' is not a command known to me."
+  echo "Please, read the help!"
   echo "----------------------->"
   echo "Usage: '$0 help'"
   exit



From finarfin at mail.berlios.de  Sun Jan 10 00:14:05 2010
From: finarfin at mail.berlios.de (finarfin at BerliOS)
Date: Sun, 10 Jan 2010 00:14:05 +0100
Subject: [Dreamos-dev] r176 - in trunk: . fs
Message-ID: <201001092314.o09NE5KF022130@sheep.berlios.de>

Author: finarfin
Date: 2010-01-10 00:14:05 +0100 (Sun, 10 Jan 2010)
New Revision: 176

Modified:
   trunk/dreamos.img
   trunk/fs/fcntl.c
Log:
Aggiunti controlli in open nel caso di non esistenza del mountpoint.


Modified: trunk/dreamos.img
===================================================================
(Binary files differ)

Modified: trunk/fs/fcntl.c
===================================================================
--- trunk/fs/fcntl.c	2010-01-09 16:11:26 UTC (rev 175)
+++ trunk/fs/fcntl.c	2010-01-09 23:14:05 UTC (rev 176)
@@ -36,6 +36,7 @@
 int open(const char *path, int oflags,  ...){
 	int prova;
 	int mpid;
+	int ret_fd;
 	va_list ap;
 	va_start(ap, oflags);
 	
@@ -44,20 +45,27 @@
 	if(cur_fd >= _SC_OPEN_MAX) cur_fd=0;
 	else {		
 		mpid = get_mountpoint_id(path);		
-		fd_list[cur_fd].mountpoint_id = mpid;				
-		path = get_rel_path(mpid, path);		
+		if(mpid >-1) {
+			fd_list[cur_fd].mountpoint_id = mpid;				
+			path = get_rel_path(mpid, path);		
+		} else {
+			printf("That path doesn't exist\n");
+			va_end(ap);
+			return -1;
+		}
 		if( mpid > -1 && mountpoint_list[fd_list[cur_fd].mountpoint_id].operations.open > NULL){
 			fd_list[cur_fd].fs_spec_id = (int) mountpoint_list[fd_list[cur_fd].mountpoint_id].operations.open(path, oflags);
 			//printf("Mpoint id: %d %s fs_spec_fd: %d\n", fd_list[cur_fd].mountpoint_id, path, fd_list[cur_fd].fs_spec_id);			
 		}
 		else {
-			if(mpid>-1) printf("No OPEN services found here\n");		
-			else printf("That path doesn't exist\n");
+			if(mpid>-1) printf("No OPEN services found here\n");					
 			va_end(ap);
 			return -1;
 		}
 	}	
 	va_end(ap)
+	/*TODO: fare controlo dopo cur_fd del prossimo libero*/
+	ret_fd = cur_fd;	
 	return cur_fd++;
 }
 



From osiris_h4ck at mail.berlios.de  Sun Jan 10 11:02:45 2010
From: osiris_h4ck at mail.berlios.de (osiris_h4ck at BerliOS)
Date: Sun, 10 Jan 2010 11:02:45 +0100
Subject: [Dreamos-dev] r177 - in trunk: boot include include/shell shell
Message-ID: <201001101002.o0AA2j7T003890@sheep.berlios.de>

Author: osiris_h4ck
Date: 2010-01-10 11:02:21 +0100 (Sun, 10 Jan 2010)
New Revision: 177

Added:
   trunk/boot/grub.img
Removed:
   trunk/boot/grub.img
Modified:
   trunk/include/shell/commands.h
   trunk/include/shell/shell.h
   trunk/include/use.h
   trunk/include/version.h
   trunk/shell/commands.c
   trunk/shell/shell.c
Log:
- Aggiornata funzione history() e history_start(): ora cancella il buffer e non va a capo



Deleted: trunk/boot/grub.img
===================================================================
(Binary files differ)

Added: trunk/boot/grub.img
===================================================================
(Binary files differ)


Property changes on: trunk/boot/grub.img
___________________________________________________________________
Name: svn:executable
   + *
Name: svn:mime-type
   + application/octet-stream

Modified: trunk/include/shell/commands.h
===================================================================
--- trunk/include/shell/commands.h	2010-01-09 23:14:05 UTC (rev 176)
+++ trunk/include/shell/commands.h	2010-01-10 10:02:21 UTC (rev 177)
@@ -53,7 +53,7 @@
 void whoami();
 void tester();
 
-struct a_b {
+struct devel {
 	const char cmd_testname[CMD_LEN];
 	void (*func)(void);
 };

Modified: trunk/include/shell/shell.h
===================================================================
--- trunk/include/shell/shell.h	2010-01-09 23:14:05 UTC (rev 176)
+++ trunk/include/shell/shell.h	2010-01-10 10:02:21 UTC (rev 177)
@@ -21,6 +21,7 @@
 #define USER_LEN 24
 #define CMD_LEN 256
 #define CURPATH_LEN 256
+#define NUM_COM 30
 
 
 struct cmd {

Modified: trunk/include/use.h
===================================================================
--- trunk/include/use.h	2010-01-09 23:14:05 UTC (rev 176)
+++ trunk/include/use.h	2010-01-10 10:02:21 UTC (rev 177)
@@ -1,5 +1,5 @@
 /*
- * It.h
+ * En.h
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
  *  the Free Software Foundation; either version 2 of the License, or
@@ -14,59 +14,57 @@
  *  along with this program; if not, write to the Free Software
  *  Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA
  */
+#ifndef _EN_H_
+#define _EN_H_
 
-#ifndef _IT_H_
-#define _IT_H_
+#define LNG_SITE "\nSite: "
+#define LNG_GDT "Initialize GDT   "
+#define LNG_IDT "Initialize IDT   "
+#define LNG_PAGING "Enabling Paging: "
+#define LNG_PIT8253 "Initialize PIT    "
+#define LNG_PIC8259 "Initialize PIC8259    "
+#define LNG_CPU "\nCPU: "
+#define LNG_FREERAM "Free RAM:"
+#define LNG_FREEPAGE "\t- Number free page:"
+#define LNG_BITMAP "\t- Number bitmap's elements:"
+#define LNG_SHELL "Loading the shell"
+#define LNG_USER "[?] Enter your username: "
+#define LNG_USER_R "[x] Please, insert your username :)\n"
+#define LNG_UNKNOWN_CMD "Unknown command:"
+#define LNG_MOUSE_SETUP "Setting up mouse driver.."
+#define LNG_MOUSE_REMOVE "Setting down mouse driver.."
+#define LNG_MOUSE_MID "\n[+] Mouse driver: central key pressed!"
+#define LNG_MOUSE_RIGHT  "\n[+] Mouse driver: right key pressed!"
+#define LNG_MOUSE_LEFT  "\n[+] Mouse driver: left key pressed!"
+#define LNG_WELCOME "\t\t.: Welcome to DreamOS :.\n\n"
+#define LNG_VFS "\nPreparing VFS\n"
 
-#define LNG_SITE "\nSito: "
-#define LNG_GDT "Inizializzo GDT   "
-#define LNG_IDT "Inizializzo IDT   "
-#define LNG_PAGING "Abilito Paging: "
-#define LNG_PIT8253 "Inizializzo PIT    "
-#define LNG_PIC8259 "Inizializzo PIC8259    "
-#define LNG_CPU "\nProcessore: "
-#define LNG_FREERAM "Ram Disposizione:"
-#define LNG_FREEPAGE "\t- Numero Pagine a disposizione:"
-#define LNG_BITMAP "\t- Numero elementi della bitmap:"
-#define LNG_SHELL "Carico la shell"
-#define LNG_USER "[?] Inserisci il nome utente: "
-#define LNG_USER_R "[x] Per favore, inserisci il nome utente :)\n"
-#define LNG_UNKNOWN_CMD "Comando sconosciuto:"
-#define LNG_MOUSE_SETUP "Inizializzo il driver del mouse.."
-#define LNG_MOUSE_REMOVE "Disattivo il driver del mouse.."
-#define LNG_MOUSE_MID "\n[+] Mouse driver: rilevato tasto centrale premuto!"
-#define LNG_MOUSE_RIGHT "\n[+] Mouse driver: rilevato tasto destro premuto!"
-#define LNG_MOUSE_LEFT "\n[+] Mouse driver: rilevato tasto sinistro premuto!"
-#define LNG_WELCOME "\t\t.: Benvenuto in DreamOS :.\n\n"
-#define LNG_VFS "\nInizializzo VFS\n"
-
 // DATE ME NOE!
-// MESI: sereno variabile in tutto il nord Italia
-#define LNG_DATE_JAN "Gennaio"
-#define LNG_DATE_FEB "Febbraio"
-#define LNG_DATE_MAR "Marzo"
-#define LNG_DATE_APR "Aprile"
-#define LNG_DATE_MAY "Maggio"
-#define LNG_DATE_JUN "Giugno"
-#define LNG_DATE_JUL "Luglio"
-#define LNG_DATE_AUG "Agosto"
-#define LNG_DATE_SEP "Settembre"
-#define LNG_DATE_OCT "Ottobre"
-#define LNG_DATE_NOV "Novembre"
-#define LNG_DATE_DEC "Dicembre"
-// GIORNI: Foschia in Sardegna e coste tirreniche
-#define LNG_DAY_SUN "Domenica"
-#define LNG_DAY_MON "Lunedi"
-#define LNG_DAY_TUE "Martedi"
-#define LNG_DAY_WED "Mercoledi"
-#define LNG_DAY_THU "Giovedi"
-#define LNG_DAY_FRI "Venerdi"
-#define LNG_DAY_SAT "Sabato"
-// ORE: Tutto il resto si becca un bel maltempo.
-#define LNG_HOUR_SUMM "Ora legale"
-#define LNG_HOUR_WINT "Ora solare"
-#define LNG_TIMESTAMP "Sono le "
-#define LNG_TIMESTAMP2 " del "
-#define LNG_TIMESTAMP3 " di "
-
+// MONTHS
+#define LNG_DATE_JAN "January"
+#define LNG_DATE_FEB "February"
+#define LNG_DATE_MAR "March"
+#define LNG_DATE_APR "April"
+#define LNG_DATE_MAY "May"
+#define LNG_DATE_JUN "June"
+#define LNG_DATE_JUL "July"
+#define LNG_DATE_AUG "August"
+#define LNG_DATE_SEP "September"
+#define LNG_DATE_OCT "October"
+#define LNG_DATE_NOV "November"
+#define LNG_DATE_DEC "December"
+// DAYS
+#define LNG_DAY_SUN "Sunday"
+#define LNG_DAY_MON "Monday"
+#define LNG_DAY_TUE "Tuesday"
+#define LNG_DAY_WED "Wednesday"
+#define LNG_DAY_THU "Thursday"
+#define LNG_DAY_FRI "Friday"
+#define LNG_DAY_SAT "Saturday"
+// HOURS
+#define LNG_HOUR_SUMM "Summer hour"
+#define LNG_HOUR_WINT "Winter hour"
+#define LNG_TIMESTAMP "It's "
+#define LNG_TIMESTAMP2 " of "
+#define LNG_TIMESTAMP3 " of "
 #endif

Modified: trunk/include/version.h
===================================================================
--- trunk/include/version.h	2010-01-09 23:14:05 UTC (rev 176)
+++ trunk/include/version.h	2010-01-10 10:02:21 UTC (rev 177)
@@ -24,4 +24,4 @@
 #define PATCHLEVEL "2.0"
 #define EXTRAVERSION "-trunk"
 #define NAME "DreamOS"
-#define REV_NUM "-r172"
+#define REV_NUM "-r175"

Modified: trunk/shell/commands.c
===================================================================
--- trunk/shell/commands.c	2010-01-09 23:14:05 UTC (rev 176)
+++ trunk/shell/commands.c	2010-01-10 10:02:21 UTC (rev 177)
@@ -407,7 +407,7 @@
 
 void tester(){
 	int i = 0;
-	struct a_b testing[MAX_TEST] = { 
+	struct devel testing[MAX_TEST] = { 
 					{ "try_kmalloc", try_kmalloc },
 					{ "try_strtok", try_strtok },
 					{ "do_fault", do_fault },

Modified: trunk/shell/shell.c
===================================================================
--- trunk/shell/shell.c	2010-01-09 23:14:05 UTC (rev 176)
+++ trunk/shell/shell.c	2010-01-10 10:02:21 UTC (rev 177)
@@ -48,9 +48,9 @@
  * argv[n] = opzioni successive
  */
 
-int count = 9, posiz = 9, c = 10;
+int count = 9, posiz = 9, c = 10, limit = 1;
 char *lastcmd[10] = {};
-    
+
 void options(char *com)
 {
   int i=0;
@@ -75,8 +75,7 @@
 {
   char cmd[CMD_LEN];
   char *cmd_ptr;
-  //char *user = kmalloc(USER_LEN);
-  
+ 
   static struct cmd shell_cmd[NUM_COM] = {
 	{ "aalogo",   aalogo      },
 	{ "clear",    _kclear     },
@@ -94,7 +93,7 @@
 	{ "cd",       cd},
 	{ "whoami",   whoami},
 	{ "tester", tester},
-        };
+  };
 
   int i = 0;
 
@@ -168,13 +167,26 @@
 }
 
 void history_start(void) { 
-    static int sc;
+    static int sc_uparrow, sc_enter;
     count++;
+    int delete = 0, max_limit = strlen(lastcmd[count]);
+	
     if ( count == 0 || count > 9 ) {
     	count = posiz;
     }
-    if( (sc = inportb (0x60) ) == KEY_UPARROW ) {
-   		printf("\n%s", lastcmd[count]);
-    }  
+    
+    if (limit < max_limit) {
+		limit = max_limit;
+	}
+	
+    while ( delete <= limit) {
+		_kbackspace();
+		delete++;
+	}
+
+    if( (sc_uparrow = inportb (0x60) ) == KEY_UPARROW ) {
+   		printf("%s", lastcmd[count]); 
+	}
+       
 }
 



From finarfin at mail.berlios.de  Sun Jan 10 12:07:45 2010
From: finarfin at mail.berlios.de (finarfin at BerliOS)
Date: Sun, 10 Jan 2010 12:07:45 +0100
Subject: [Dreamos-dev] r178 - in trunk: . boot fs include shell
Message-ID: <201001101107.o0AB7jrg008116@sheep.berlios.de>

Author: finarfin
Date: 2010-01-10 12:06:59 +0100 (Sun, 10 Jan 2010)
New Revision: 178

Added:
   trunk/boot/grub.img
Removed:
   trunk/boot/grub.img
Modified:
   trunk/dreamos.img
   trunk/fs/fcntl.c
   trunk/include/version.h
   trunk/shell/commands.c
   trunk/shell/testing.c
Log:
Aggiunti controlli sui valori di ritorno delle varie open.
In try_open ora la close viene chiamata solo se il file viene trovato.
Eliminato comando di tester: try_fsinit.
Aggiornato grub.img


Deleted: trunk/boot/grub.img
===================================================================
(Binary files differ)

Added: trunk/boot/grub.img
===================================================================
(Binary files differ)


Property changes on: trunk/boot/grub.img
___________________________________________________________________
Name: svn:executable
   + *
Name: svn:mime-type
   + application/octet-stream

Modified: trunk/dreamos.img
===================================================================
(Binary files differ)

Modified: trunk/fs/fcntl.c
===================================================================
--- trunk/fs/fcntl.c	2010-01-10 10:02:21 UTC (rev 177)
+++ trunk/fs/fcntl.c	2010-01-10 11:06:59 UTC (rev 178)
@@ -55,6 +55,10 @@
 		}
 		if( mpid > -1 && mountpoint_list[fd_list[cur_fd].mountpoint_id].operations.open > NULL){
 			fd_list[cur_fd].fs_spec_id = (int) mountpoint_list[fd_list[cur_fd].mountpoint_id].operations.open(path, oflags);
+			if(fd_list[cur_fd].fs_spec_id == -1){
+				printf("No file's Found\n");
+				return -1;
+			}
 			//printf("Mpoint id: %d %s fs_spec_fd: %d\n", fd_list[cur_fd].mountpoint_id, path, fd_list[cur_fd].fs_spec_id);			
 		}
 		else {
@@ -65,7 +69,14 @@
 	}	
 	va_end(ap)
 	/*TODO: fare controlo dopo cur_fd del prossimo libero*/
-	ret_fd = cur_fd;	
+	ret_fd = cur_fd;
+	/*while(fd_list[++cur_fd].mountpoint_id != -1) {
+		if(cur_fd >= _SC_OPEN_MAX) cur_fd = 0;
+		else if(cur_fd == ret_fd) {
+			printf("No more file descriptors available\n");
+			return -1;
+		}
+	}*/
 	return cur_fd++;
 }
 

Modified: trunk/include/version.h
===================================================================
--- trunk/include/version.h	2010-01-10 10:02:21 UTC (rev 177)
+++ trunk/include/version.h	2010-01-10 11:06:59 UTC (rev 178)
@@ -24,4 +24,4 @@
 #define PATCHLEVEL "2.0"
 #define EXTRAVERSION "-trunk"
 #define NAME "DreamOS"
-#define REV_NUM "-r175"
+#define REV_NUM "-r177"

Modified: trunk/shell/commands.c
===================================================================
--- trunk/shell/commands.c	2010-01-10 10:02:21 UTC (rev 177)
+++ trunk/shell/commands.c	2010-01-10 11:06:59 UTC (rev 178)
@@ -413,8 +413,7 @@
 					{ "do_fault", do_fault },
 					{ "try_printmem", try_printmem },
 					{ "try_module", try_module },
-					{ "try_open", try_open},
-					{ "try_fsinit", try_fsinit},
+					{ "try_open", try_open},					
 					{ "--help", help_tester },
 					};
 	if (argc != 2) {

Modified: trunk/shell/testing.c
===================================================================
--- trunk/shell/testing.c	2010-01-10 10:02:21 UTC (rev 177)
+++ trunk/shell/testing.c	2010-01-10 11:06:59 UTC (rev 178)
@@ -107,8 +107,7 @@
 		"  -> try_strtok        - Test strtok() function in string.h\n"
 		"  -> try_printmem      - Print used locations of memory\n"
 		"  -> try_module        - Read the content of the memory zone loaded in module, aka initfs \n"
-		"  -> try_open          - Function to test open() & stdarg() \n"
-		"  -> try_fsinit        - Function to test the initialization of initrd\n"
+		"  -> try_open          - Function to test open() & stdarg() \n"		
 		);	
 }
 
@@ -148,8 +147,10 @@
 	
 	scanf("%s", appoggio);	
 	i = open(appoggio, O_RDONLY, 42);
-	if(i>-1) read(i, prova, 1);
-	close(i);
+	if(i>-1) {
+		read(i, prova, 1);	
+		close(i);
+	}
 	printf("\n");
 }
 



From finarfin at mail.berlios.de  Sun Jan 10 17:55:52 2010
From: finarfin at mail.berlios.de (finarfin at BerliOS)
Date: Sun, 10 Jan 2010 17:55:52 +0100
Subject: [Dreamos-dev] r179 - trunk/utils
Message-ID: <201001101655.o0AGtqYp017361@sheep.berlios.de>

Author: finarfin
Date: 2010-01-10 17:55:52 +0100 (Sun, 10 Jan 2010)
New Revision: 179

Modified:
   trunk/utils/README.initfscp
Log:
AGgiornate informazioni nel README.initfscp


Modified: trunk/utils/README.initfscp
===================================================================
--- trunk/utils/README.initfscp	2010-01-10 11:06:59 UTC (rev 178)
+++ trunk/utils/README.initfscp	2010-01-10 16:55:52 UTC (rev 179)
@@ -1,9 +1,9 @@
 ----
 README
-initfscp
+initfscp - Autore: Aleksej
 ----
 
-initfscp e' un programma che serve per creare un'immagine contenente il file system utilizzato da DreamOS.
+initfscp e' un programma che serve a creare un'immagine contenente il file system utilizzato da DreamOS.
 Consente di inserirci dei files (massimo 32) all'interno. 
 Per far ci? digitare il comando "initfscp file1 file2 ... nomefs" dove:
 - "file1 file2 ..." sono i files che inseriremo nel filesystem,
@@ -14,4 +14,4 @@
 
 Altri comandi disponibili:
 --help (-h) per visualizzare una guida pi? sintetica.
---version (-v) per visualizzare la versione utilizzata di initfscp.
+--version (-v) per visualizzare la versione utilizzata attualmente di initfscp.



From finarfin at mail.berlios.de  Mon Jan 11 00:06:29 2010
From: finarfin at mail.berlios.de (finarfin at BerliOS)
Date: Mon, 11 Jan 2010 00:06:29 +0100
Subject: [Dreamos-dev] r180 - in trunk: . fs include/fs
Message-ID: <201001102306.o0AN6TJF032480@sheep.berlios.de>

Author: finarfin
Date: 2010-01-11 00:06:29 +0100 (Mon, 11 Jan 2010)
New Revision: 180

Modified:
   trunk/dreamos.img
   trunk/fs/initrd.c
   trunk/fs/unistd.c
   trunk/fs/vfs.c
   trunk/include/fs/initrd.h
Log:
Aggiunta initrd_close
Inserita anche nella struttura dati che gestiste il mountpoint / (che 
contiene l'initrd)
Ora la close chiama l'omonima funzione relativa al mountpoint ove si 
trova il file aperto.
Entrambe le close sono da terinare. 


Modified: trunk/dreamos.img
===================================================================
(Binary files differ)

Modified: trunk/fs/initrd.c
===================================================================
--- trunk/fs/initrd.c	2010-01-10 16:55:52 UTC (rev 179)
+++ trunk/fs/initrd.c	2010-01-10 23:06:29 UTC (rev 180)
@@ -54,11 +54,21 @@
 int initfs_open(const char *path, int flags, ...){
 	initrd_file_t *module_var;
 	int j = 0;
-	module_var = fs_headers;	
+	int ret_fd = -1;
+	module_var = fs_headers;
+	if(cur_irdfd >= MAX_INITRD_DESCRIPTORS) cur_irdfd=0;
 	while (j < fs_specs->nfiles) {
 		if(!strcmp(path, module_var[j].fileName)){
 				ird_descriptors[cur_irdfd].file_descriptor	= j;
 				printf("%s Found. Size: %d FS fd val: %d - ID File val: %d\n", path, module_var[j].length, cur_irdfd, ird_descriptors[cur_irdfd].file_descriptor);
+				ret_fd = cur_irdfd;
+				/*while(ird_descriptors[++cur_irdfd].file_descriptor != -1){
+					if(cur_irdfd >= MAX_INITRD_DESCRIPTORS) cur_irdfd = 0;
+					else if(cur_irdfd == ret_fd) {
+						printf("No more file descriptors available\n");
+						return -1;
+					}
+				}*/
 				return cur_irdfd++; 
 		}
 		j++;
@@ -81,3 +91,7 @@
 	}	
 	return nbyte;
 }
+
+int initrd_close(int fildes){
+	ird_descriptors[fildes].file_descriptor = -1;
+}

Modified: trunk/fs/unistd.c
===================================================================
--- trunk/fs/unistd.c	2010-01-10 16:55:52 UTC (rev 179)
+++ trunk/fs/unistd.c	2010-01-10 23:06:29 UTC (rev 180)
@@ -37,9 +37,15 @@
 }
 
 int close(int fildes){
+	int mp_id;
+	int fs_fd;
+	mp_id = fd_list[fildes].mountpoint_id;
+	fs_fd = fd_list[fildes].fs_spec_id;
 	if (fd_list[fildes].fs_spec_id >= 0){
+		if(mountpoint_list[mp_id].operations.close !=NULL)
+			mountpoint_list[mp_id].operations.close(fs_fd);		
 		fd_list[fildes].fs_spec_id = -1;
-		fd_list[fildes].mountpoint_id = -1;
+		fd_list[fildes].mountpoint_id = -1;				
 		return 0;
 	}
 	else

Modified: trunk/fs/vfs.c
===================================================================
--- trunk/fs/vfs.c	2010-01-10 16:55:52 UTC (rev 179)
+++ trunk/fs/vfs.c	2010-01-10 23:06:29 UTC (rev 180)
@@ -69,6 +69,7 @@
  	mountpoint_list[0].start_address = module_start;
  	mountpoint_list[0].dir_op.opendir_f = initfs_opendir;
  	mountpoint_list[0].operations.open = initfs_open;
+ 	mountpoint_list[0].operations.close = initrd_close;
  	mountpoint_list[0].operations.read = initfs_read;
  	//mountpoint_list[0].operations = kmalloc(sizeof(struct super_node_operations));
 

Modified: trunk/include/fs/initrd.h
===================================================================
--- trunk/include/fs/initrd.h	2010-01-10 16:55:52 UTC (rev 179)
+++ trunk/include/fs/initrd.h	2010-01-10 23:06:29 UTC (rev 180)
@@ -62,4 +62,5 @@
 DIR *initfs_opendir(const char *);
 int initfs_open(const char *, int, ...);
 ssize_t initfs_read(int, void *, size_t);
+int initrd_close(int);
 #endif



From blackz at mail.berlios.de  Mon Jan 11 14:32:15 2010
From: blackz at mail.berlios.de (blackz at mail.berlios.de)
Date: Mon, 11 Jan 2010 14:32:15 +0100
Subject: [Dreamos-dev] r181 - trunk
Message-ID: <201001111332.o0BDWFB0021454@sheep.berlios.de>

Author: blackz
Date: 2010-01-11 14:32:13 +0100 (Mon, 11 Jan 2010)
New Revision: 181

Modified:
   trunk/grub.py
Log:


Modified: trunk/grub.py
===================================================================
--- trunk/grub.py	2010-01-10 23:06:29 UTC (rev 180)
+++ trunk/grub.py	2010-01-11 13:32:13 UTC (rev 181)
@@ -31,11 +31,11 @@
 # Manca il controllo errori
 fd = open("/boot/grub/menu.lst", "a")
 
-print "Inserire la partizione dei sorgenti (ex. hda2):",
+print "Insert the source partition (ex. hda2):",
 pn = raw_input()
 partition = grub_hd(pn)
 
-print "Inserire il mountpoint:",
+print "Insert the mountpoint:",
 mp = raw_input()
 cwd = os.getcwd() + "/dreamos.img"
 initFS = os.getcwd() + "fs/initfs"
@@ -44,7 +44,7 @@
 else:
 	cwd = sub_mount(mp, cwd)
 	
-print "Vuoi lo splash di DreamOS nel tuo Grub? (y/n):",
+print "Do you want the DreamOS splash in your grub? (y/n):",
 answer2 = raw_input()
 
 if answer2 == 'y':
@@ -57,7 +57,7 @@
 	print "| Module: " + initFS +" |"
 	print "+---------------------------------------------------------------+"
 
-	print "Procedere alla scrittura? (y/n):",
+	print "Proceed to the writing? (y/n):",
 answer = raw_input()
 
 if answer == 'y':
@@ -77,7 +77,7 @@
 
 
 elif answer == 'n':
-	print "Ok, bye :)"
+	print "Ok, aborting."
 	
 elif answer2 == 'n':
 	print "+--------------------------- INFO ------------------------------+"
@@ -87,7 +87,7 @@
 	print "| Module: " + initFS +"          |"
 	print "+---------------------------------------------------------------+"
 
-	print "Procedere alla scrittura? (y/n):",
+	print "Proceed to the writing? (y/n):",
 answer3 = raw_input()
 
 if answer3 == 'y':
@@ -105,4 +105,4 @@
         print "[+] Done."
 
 elif answer3 == 'n':
-	print "Ok, ahahah :)"
+	print "Ok, aborting."



From finarfin at mail.berlios.de  Tue Jan 12 00:17:47 2010
From: finarfin at mail.berlios.de (finarfin at BerliOS)
Date: Tue, 12 Jan 2010 00:17:47 +0100
Subject: [Dreamos-dev] r182 - in trunk: . boot fs shell
Message-ID: <201001112317.o0BNHliU030678@sheep.berlios.de>

Author: finarfin
Date: 2010-01-12 00:17:01 +0100 (Tue, 12 Jan 2010)
New Revision: 182

Added:
   trunk/boot/grub.img
Removed:
   trunk/boot/grub.img
Modified:
   trunk/dreamos.img
   trunk/fs/fcntl.c
   trunk/fs/unistd.c
   trunk/shell/testing.c
Log:
Aggiunti controlli su cur_fd di open.
Ora se si raggiunge il numero massimo di file descriptor disponibili
il controllo ricomincia dalla prima posizione.
Questo controllo e' ancora da terminare, infatti manca da gestire
il caso in cui la ricerca del primo file descriptor disponibile 
raggiunga la fine.


Deleted: trunk/boot/grub.img
===================================================================
(Binary files differ)

Added: trunk/boot/grub.img
===================================================================
(Binary files differ)


Property changes on: trunk/boot/grub.img
___________________________________________________________________
Name: svn:executable
   + *
Name: svn:mime-type
   + application/octet-stream

Modified: trunk/dreamos.img
===================================================================
(Binary files differ)

Modified: trunk/fs/fcntl.c
===================================================================
--- trunk/fs/fcntl.c	2010-01-11 13:32:13 UTC (rev 181)
+++ trunk/fs/fcntl.c	2010-01-11 23:17:01 UTC (rev 182)
@@ -41,42 +41,46 @@
 	va_start(ap, oflags);
 	
 	prova = va_arg(ap, int);
-	//printf("Magic value: %d e il path: %s e cur_fd: %d\n", prova,path,cur_fd);
-	if(cur_fd >= _SC_OPEN_MAX) cur_fd=0;
-	else {		
-		mpid = get_mountpoint_id(path);		
-		if(mpid >-1) {
-			fd_list[cur_fd].mountpoint_id = mpid;				
-			path = get_rel_path(mpid, path);		
-		} else {
-			printf("That path doesn't exist\n");
+	if(!(cur_fd < _SC_OPEN_MAX)) cur_fd=0;
+	//printf("Cur_fd: %d ",cur_fd);
+	while(fd_list[cur_fd].mountpoint_id != -1 && cur_fd < _SC_OPEN_MAX ) {				
+		if(cur_fd == ret_fd) {
+			printf("No more file descriptors available\n");
+			return -1;
+		}		
+		cur_fd++;
+	}
+	/*if(cur_fd == _SC_OPEN_MAX) {
+		printf("Error\n");
+		return -1;
+	}*/
+	mpid = get_mountpoint_id(path);		
+	if(mpid >-1) {
+		fd_list[cur_fd].mountpoint_id = mpid;				
+		path = get_rel_path(mpid, path);		
+	} else {
+		printf("That path doesn't exist\n");
+		va_end(ap);
+		return -1;
+	}
+	if( mpid > -1 && mountpoint_list[fd_list[cur_fd].mountpoint_id].operations.open > NULL){
+		fd_list[cur_fd].fs_spec_id = (int) mountpoint_list[fd_list[cur_fd].mountpoint_id].operations.open(path, oflags);
+		if(fd_list[cur_fd].fs_spec_id == -1){
+			printf("No file's Found\n");
 			va_end(ap);
 			return -1;
 		}
-		if( mpid > -1 && mountpoint_list[fd_list[cur_fd].mountpoint_id].operations.open > NULL){
-			fd_list[cur_fd].fs_spec_id = (int) mountpoint_list[fd_list[cur_fd].mountpoint_id].operations.open(path, oflags);
-			if(fd_list[cur_fd].fs_spec_id == -1){
-				printf("No file's Found\n");
-				return -1;
-			}
 			//printf("Mpoint id: %d %s fs_spec_fd: %d\n", fd_list[cur_fd].mountpoint_id, path, fd_list[cur_fd].fs_spec_id);			
-		}
-		else {
-			if(mpid>-1) printf("No OPEN services found here\n");					
-			va_end(ap);
-			return -1;
-		}
-	}	
-	va_end(ap)
-	/*TODO: fare controlo dopo cur_fd del prossimo libero*/
+	}
+	else {
+		if(mpid>-1) printf("No OPEN services found here\n");					
+		va_end(ap);
+		return -1;
+	}
+	va_end(ap)	
 	ret_fd = cur_fd;
-	/*while(fd_list[++cur_fd].mountpoint_id != -1) {
-		if(cur_fd >= _SC_OPEN_MAX) cur_fd = 0;
-		else if(cur_fd == ret_fd) {
-			printf("No more file descriptors available\n");
-			return -1;
-		}
-	}*/
-	return cur_fd++;
+	cur_fd++;
+	//printf("ret_fd: %d\n",ret_fd);
+	return ret_fd;
 }
 

Modified: trunk/fs/unistd.c
===================================================================
--- trunk/fs/unistd.c	2010-01-11 13:32:13 UTC (rev 181)
+++ trunk/fs/unistd.c	2010-01-11 23:17:01 UTC (rev 182)
@@ -45,7 +45,7 @@
 		if(mountpoint_list[mp_id].operations.close !=NULL)
 			mountpoint_list[mp_id].operations.close(fs_fd);		
 		fd_list[fildes].fs_spec_id = -1;
-		fd_list[fildes].mountpoint_id = -1;				
+		fd_list[fildes].mountpoint_id = -1;
 		return 0;
 	}
 	else

Modified: trunk/shell/testing.c
===================================================================
--- trunk/shell/testing.c	2010-01-11 13:32:13 UTC (rev 181)
+++ trunk/shell/testing.c	2010-01-11 23:17:01 UTC (rev 182)
@@ -123,13 +123,6 @@
 		i++;
 	}
 	printf("Total Files: %d\n", fs_head->nfiles);
-	//int j=0;
-	/*char* mod_address;
-	mod_address = module_start;	
-	while(j<74){
-		putchar(mod_address[j]);
-		j++;
-	}*/
 	_kputs("\n");
 }
 



From blackz at mail.berlios.de  Tue Jan 12 15:52:30 2010
From: blackz at mail.berlios.de (blackz at mail.berlios.de)
Date: Tue, 12 Jan 2010 15:52:30 +0100
Subject: [Dreamos-dev] r183 - trunk/shell
Message-ID: <201001121452.o0CEqUwl023401@sheep.berlios.de>

Author: blackz
Date: 2010-01-12 15:52:29 +0100 (Tue, 12 Jan 2010)
New Revision: 183

Modified:
   trunk/shell/commands.c
Log:


Modified: trunk/shell/commands.c
===================================================================
--- trunk/shell/commands.c	2010-01-11 23:17:01 UTC (rev 182)
+++ trunk/shell/commands.c	2010-01-12 14:52:29 UTC (rev 183)
@@ -94,7 +94,7 @@
   printf ("Poweroff...\n");
   
   asm("cli");
-  printf("E' ora possibile spegnere il computer.\n");
+  printf("Now you can shut down the PC.\n");
   while(1);
 }
 



From finarfin at mail.berlios.de  Wed Jan 13 00:33:05 2010
From: finarfin at mail.berlios.de (finarfin at BerliOS)
Date: Wed, 13 Jan 2010 00:33:05 +0100
Subject: [Dreamos-dev] r184 - in trunk: . fs include include/shell libc
	shell utils
Message-ID: <201001122333.o0CNX5Pm027512@sheep.berlios.de>

Author: finarfin
Date: 2010-01-13 00:33:03 +0100 (Wed, 13 Jan 2010)
New Revision: 184

Added:
   trunk/initfs
Removed:
   trunk/fs/initfs
   trunk/utils/initfs
Modified:
   trunk/dreamos.img
   trunk/grub.py
   trunk/include/shell/commands.h
   trunk/include/version.h
   trunk/libc/stdio.c
   trunk/libc/string.c
   trunk/shell/shell.c
Log:
Eliminati files:
 fs/initfs
 utils/initfs
perche non piu utilizzati e ridondanti.
Modificata strncpy
Disabilitata temporaneamente la history per  alcune prove.
Verra riabilitata al piu presto.
Corretto errore in creazione path in grub.py



Modified: trunk/dreamos.img
===================================================================
(Binary files differ)

Deleted: trunk/fs/initfs
===================================================================
--- trunk/fs/initfs	2010-01-12 14:52:29 UTC (rev 183)
+++ trunk/fs/initfs	2010-01-12 23:33:03 UTC (rev 184)
@@ -1,106 +0,0 @@
-?
-
-
-
-
-  ?
- * initfscp
- *  This program is free software; you can redistribute it and/or modify
- *  it under the terms of the GNU General Public License as published by
- *  the Free Software Foundation; either version 2 of the License, or
- *  (at your option) any later version.
- *
- *  This program is distributed in the hope that it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  GNU General Public License for more details.
- *
- *  You should have received a copy of the GNU General Public License
- *  along with this program; if not, write to the Free Software
- *  Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA
- */
-
-#include <stdio.h>
-#include <stdlib.h>
-#include <string.h>
-#include <initfscp.h>
-
-
-int main(int argc, char* argv[]){
-	unsigned int offset;
-	if(argc <= 1) usage(argv[0]);
-	else {
-		if(!strcmp(argv[1], "--version") || !strcmp(argv[1], "-v")) version(argv[0]+2);
-		else if(!strcmp(argv[1], "--help") || !strcmp(argv[1], "-h")) usage(argv[0]);
-		else{
-			initrd_file_t headers[MAX_FILES];
-			int i=0;
-			FILE *fsdest;
-			fsdest = fopen(argv[argc-1], "w");
-			if(fsdest == NULL) printf("Could not create FileSystem\n");
-			printf("Welcome to Dreamos initfs file copier tool\n");
-			printf("Size of headers: %d\n\n", sizeof(struct initrd_file_t)*32);
-			printf("Clearing headers structures ");
-			offset = sizeof(struct initrd_file_t) * 32;
-			for (i=0; i<MAX_FILES; i++){
-				headers[i].magic = 0xBF;
-				strcpy(headers[i].fileName, "");
-				headers[i].uid = 0;
-				headers[i].offset = 0;
-				headers[i].length = 0;
-			}			
-			printf("\e[33,44mDONE\e[0m\n\n");			
-			printf("Number of files to copy %d\n", argc - 2);
-			printf("FileSystem name: %s\n\n", argv[argc-1]);
-			printf("Creating File headers\n");			
-			i=0;
-			for(i=0; i< argc - 2; i++){
-				FILE *fd;
-				fd = fopen(argv[i+1], "r+");
-				if(fd == NULL){
-					 printf("Error one or more files not found\n");
-					 return -1;
-				 }
-				else {
-					strcpy(headers[i].fileName, argv[i+1]);
-					fseek(fd, 0, SEEK_END);
-					printf("\tFile %s Found! Size: %d\n", argv[i+1], ftell(fd));				
-					headers[i].length = ftell(fd);
-					headers[i].offset = offset;
-					fclose(fd);
-					offset += headers[i].length;
-				}				
-			}
-			printf("\e[33,44mDONE\e[0m\n\n");
-			i=0;
-			printf("Copying headers to %s filesystem  ", argv[argc-1]);		
-			fwrite(headers, sizeof(struct initrd_file_t), 32, fsdest);
-			printf("\e[33,44mDONE\e[0m\n\n");			
-			printf("Copying data to %s filesystem\n", argv[argc-1]);		
-			for(i=0; i<argc - 2; i++){
-				FILE *fd2;
-				char *buffer;
-				fd2=fopen(argv[i+1], "r+");
-				buffer = (unsigned char*) malloc(headers[i].length);
-				fread(buffer, 1, headers[i].length, fd2);
-				fwrite(buffer, 1, headers[i].length, fsdest);
-				printf("\t\tFileName: %s Length: %d offset: %d\n", headers[i].fileName, headers[i].length, headers[i].offset);
-			}
-			printf("\e[33,44mDONE\e[0m\n\n");
-			fclose(fsdest);
-		}		
-	}	
-}
-
-void usage(char *prgname){
-	printf("Usage:\n %s --help for this screen\n", prgname);
-	printf(" %s file1 file2 ... fsname\n", prgname);
-	printf("      file1 file2 ... are source files\n");
-	printf("      and fsname is the file that contains the initfs\n");
-}
-
-void version(char *prgname){
-	printf("%s version: %s\n", prgname, INITFSCP_VER);
-}
-all:
-	gcc -o initfscp initfscp.c -I./include

Modified: trunk/grub.py
===================================================================
--- trunk/grub.py	2010-01-12 14:52:29 UTC (rev 183)
+++ trunk/grub.py	2010-01-12 23:33:03 UTC (rev 184)
@@ -38,7 +38,7 @@
 print "Insert the mountpoint:",
 mp = raw_input()
 cwd = os.getcwd() + "/dreamos.img"
-initFS = os.getcwd() + "fs/initfs"
+initFS = os.getcwd() + "/initfs"
 if mp == "/":
 	path = cwd
 else:
@@ -93,7 +93,7 @@
 if answer3 == 'y':
 	fd.write("\ntitle\tDreamOS v0." + patchlevel + "-" + trunk +"")
 	fd.write("\nroot\t" + partition)
-	fd.write("\nkernel\t" + cwd + "\tmodule\t" + initFS)
+	fd.write("\nkernel\t" + cwd + "\nmodule\t" + initFS)
 	fd.write("\nboot\n")
 	fd.close()
 	print ""

Modified: trunk/include/shell/commands.h
===================================================================
--- trunk/include/shell/commands.h	2010-01-12 14:52:29 UTC (rev 183)
+++ trunk/include/shell/commands.h	2010-01-12 23:33:03 UTC (rev 184)
@@ -27,8 +27,8 @@
 #include <kheap.h>
 #define MAX_TEST 10
 
-int argc;
-char **argv;
+extern int argc;
+extern char **argv;
 extern heap_t *kheap;
 
 void aalogo();

Modified: trunk/include/version.h
===================================================================
--- trunk/include/version.h	2010-01-12 14:52:29 UTC (rev 183)
+++ trunk/include/version.h	2010-01-12 23:33:03 UTC (rev 184)
@@ -24,4 +24,4 @@
 #define PATCHLEVEL "2.0"
 #define EXTRAVERSION "-trunk"
 #define NAME "DreamOS"
-#define REV_NUM "-r177"
+#define REV_NUM "-r182"

Added: trunk/initfs
===================================================================
(Binary files differ)


Property changes on: trunk/initfs
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Modified: trunk/libc/stdio.c
===================================================================
--- trunk/libc/stdio.c	2010-01-12 14:52:29 UTC (rev 183)
+++ trunk/libc/stdio.c	2010-01-12 23:33:03 UTC (rev 184)
@@ -258,9 +258,9 @@
 		s_ptr = va_arg (scan, char *);
 
                 if (nmax == 0 || strlen(input) <= nmax)
-		  s_ptr = strncpy (s_ptr, input, strlen (input));
+					s_ptr = strncpy (s_ptr, input, strlen (input));
                 else
-                  s_ptr = strncpy (s_ptr, input, nmax);
+					s_ptr = strncpy (s_ptr, input, nmax);
 		break;
 
 	    case 'd':

Modified: trunk/libc/string.c
===================================================================
--- trunk/libc/string.c	2010-01-12 14:52:29 UTC (rev 183)
+++ trunk/libc/string.c	2010-01-12 23:33:03 UTC (rev 184)
@@ -37,13 +37,13 @@
 	do {
 		if ((*d++ = *s++) == 0) {
 			while (--n != 0)
-				*d++ = 0;
+				*d++ = '\0';
 				break;
 			}
 		} while (--n != 0);
 	}
 	return dest;
-}
+ }
 
 char *strcpy (char *dest, const char *src)
 {

Modified: trunk/shell/shell.c
===================================================================
--- trunk/shell/shell.c	2010-01-12 14:52:29 UTC (rev 183)
+++ trunk/shell/shell.c	2010-01-12 23:33:03 UTC (rev 184)
@@ -41,6 +41,8 @@
 
 #define NUM_COM 30
 userenv_t current_user;
+int argc;
+char **argv;
 /*
  * Inserisce gli argomenti di un comando in un array di stringhe
  * argc = numero degli argomenti
@@ -52,7 +54,7 @@
 char *lastcmd[10] = {};
 
 void options(char *com)
-{
+{  
   int i=0;
   argc=0;
 
@@ -62,7 +64,7 @@
     while (*com != ' ') {
       *(argv[argc] + i) = *com++;
       i++;
-    }
+    } 
     *(argv[argc] + i) = '\0';
     argc++;
     i=0;
@@ -116,15 +118,15 @@
   
   for (;;)
   {
-    for (c = 1 ; c <= 10 ; c++) {
+    /*for (c = 1 ; c <= 10 ; c++) {
     	    lastcmd[c] = (char *)kmalloc(sizeof(char) * 30); 
-    }	    
+    }*/	    
     printf("%s~:%s# ", current_user.username, 
 				  current_user.cur_path,
 				  current_user.username);
     scanf("%254s",cmd);
     
-    history(cmd);
+    //history(cmd);
    
     /* elimina eventuali spazi all'inizio del comando */
     for (i = 0, cmd_ptr = cmd; cmd[i] == ' '; i++, cmd_ptr++);
@@ -148,9 +150,9 @@
     for (--argc; argc>=0; argc--) {      
         free (argv[argc]);
     }
-    for (c = 1 ; c <= 10 ; c++) {
+    /*for (c = 1 ; c <= 10 ; c++) {
     	    free(lastcmd[c]); 
-    }
+    }*/
   }
 }
 

Deleted: trunk/utils/initfs
===================================================================
(Binary files differ)



From finarfin at mail.berlios.de  Sun Jan 17 00:40:42 2010
From: finarfin at mail.berlios.de (finarfin at BerliOS)
Date: Sun, 17 Jan 2010 00:40:42 +0100
Subject: [Dreamos-dev] r185 - in trunk: . include/io io mem shell
Message-ID: <201001162340.o0GNegbe022273@sheep.berlios.de>

Author: finarfin
Date: 2010-01-17 00:40:40 +0100 (Sun, 17 Jan 2010)
New Revision: 185

Modified:
   trunk/dreamos.img
   trunk/include/io/video.h
   trunk/io/video.c
   trunk/kernel.c
   trunk/mem/kheap.c
   trunk/shell/commands.c
   trunk/shell/shell.c
Log:
Modificati i colori della shell, ditemi che ne pensate.
Eliminate alcune stampe del boot.
AGgiunte per i colori standard delle #define NOMECOLORE. 
Consultate il file include/video.h per i colori disponibili.
Ditemi cosa ve ne pare dei nuovi colori.


Modified: trunk/dreamos.img
===================================================================
(Binary files differ)

Modified: trunk/include/io/video.h
===================================================================
--- trunk/include/io/video.h	2010-01-12 23:33:03 UTC (rev 184)
+++ trunk/include/io/video.h	2010-01-16 23:40:40 UTC (rev 185)
@@ -28,6 +28,24 @@
 #define _SCR_W 80
 #define _SCR_H 25
 
+#define BLACK 0
+#define BLUE 1
+#define GREEN 2
+#define CYAN 3
+#define RED 4
+#define MAGENTA 5
+#define BROWN 6
+#define GREY 7
+#define DARK_GREY 8
+#define BRIGHT_BLUE 9
+#define BRIGHT_GREEN 10
+#define BRIGHT_CYAN 11
+#define BRIGHT_RED 12
+#define BRIGHT_MAGENTA 13
+#define YELLOW 14
+#define WHITE 15
+
+
 #define OK_POS 70
 
 void _kntos(char*,unsigned int, int);

Modified: trunk/io/video.c
===================================================================
--- trunk/io/video.c	2010-01-12 23:33:03 UTC (rev 184)
+++ trunk/io/video.c	2010-01-16 23:40:40 UTC (rev 185)
@@ -219,6 +219,7 @@
 void _kprintOK() {
     _kgoto(60, _kgetline());
     _kputs("\033\001 [\033\012OK\033\001]\033\007\n");
+    _kcolor(WHITE);
 }
 
 /*

Modified: trunk/kernel.c
===================================================================
--- trunk/kernel.c	2010-01-12 23:33:03 UTC (rev 184)
+++ trunk/kernel.c	2010-01-16 23:40:40 UTC (rev 185)
@@ -63,14 +63,14 @@
     syscall_init();
     module_start = *((unsigned int*)boot_info->mods_addr);
 	module_end = *((unsigned int*)(boot_info->mods_addr+4));
-    _kcolor('\012');
+    _kcolor(BRIGHT_GREEN);
     _kputs(DREAMOS_VER);
-    _kcolor('\007');
+    _kcolor(WHITE);
     _kputs(LNG_SITE);
-    _kcolor('\011');
+    _kcolor(BRIGHT_BLUE);
     _kputs(SITEURL);
     _kputs("\n");
-    _kcolor('\007');
+    _kcolor(WHITE);
     _kputs("\n");    
     _kputs(LNG_GDT);
     init_gdt();

Modified: trunk/mem/kheap.c
===================================================================
--- trunk/mem/kheap.c	2010-01-12 23:33:03 UTC (rev 184)
+++ trunk/mem/kheap.c	2010-01-16 23:40:40 UTC (rev 185)
@@ -104,9 +104,8 @@
     new_heap->used_list = NULL;
     new_heap->free_nodes = NULL;
     printf("  First heap created...\n");   
-    printf("  Size: %d\n"
-	   "  Tot mem: %d\n"
-	   "  Start address: %x\n", (new_heap->free_list)->size, tot_mem, new_heap);	    
+    printf("  Size: %d "
+	   "  Tot mem: %d\n", (new_heap->free_list)->size, tot_mem);	    
 	apic_node = alloc_node();
 	apic_node->start_address = 0xFEC00000;
 	apic_node->size = 4096;

Modified: trunk/shell/commands.c
===================================================================
--- trunk/shell/commands.c	2010-01-12 23:33:03 UTC (rev 184)
+++ trunk/shell/commands.c	2010-01-16 23:40:40 UTC (rev 185)
@@ -29,20 +29,20 @@
 
 void aalogo()
 {
-  _kcolor (4);
+  _kcolor (BRIGHT_GREEN);
   printf("\t\t ____           _____          _____ _____\n");
   printf("\t\t|    \\ ___ ___ |  _  | _______|     |   __|\n");
   printf("\t\t|  |  |  _| -_|| |_| ||       |  |  |__   |\n");
   printf("\t\t|____/|_| |___||_| |_||_|\134_/|_|_____|_____|\n");
-  _kcolor (6);
+  _kcolor (WHITE);
   printf("\t\tVersion: \"%s %s.%s%s\"\n", NAME, VERSION, PATCHLEVEL, EXTRAVERSION);
-  _kcolor(7);
+  //_kcolor(WHITE);
   logo();
 }
 
 void logo()
 {
-  _kcolor (5);
+  _kcolor (BRIGHT_BLUE);
   printf("\n");
   printf("\t\t\t The Dream Operating System \n"
 	 "\t\t           v%s.%s%s %s      \n\n"
@@ -52,7 +52,7 @@
 	 VERSION, PATCHLEVEL, EXTRAVERSION, REV_NUM);
 	
   printf("\n\n\n\n");
-  _kcolor(7);
+  _kcolor(WHITE);
 }
 
 void help()
@@ -138,10 +138,10 @@
 
   // CPU Info
   _kputs (LNG_CPU);
-  _kcolor (4);
+  _kcolor (BRIGHT_RED);
   _kgoto (61, _kgetline());
   _kputs (cpu_vendor);
-  _kcolor(7);
+  _kcolor(WHITE);
   printf("\n");
 
   // Memory RAM Info
@@ -187,19 +187,21 @@
 */
 void credits(void)
 {
-  _kcolor('\011');
+  _kcolor(BRIGHT_BLUE);
   _kputs("DreamOS Credits\n\n");                
   _kputs("Main Developers:\n");
-  _kcolor('\012');
+  _kcolor(GREEN);
    printf(  "Finarfin - Ivan (Founder)\n\n");
-  _kcolor('\011');
+  _kcolor(BRIGHT_BLUE);
   _kputs("Developers:\n");
-  _kcolor('\012');
+  _kcolor(GREEN);
   _kputs("Lord Osiris - Diego Stamigni \n\n");
-  _kcolor('\011');
+  _kcolor(BRIGHT_BLUE);
   _kputs("Contributors:\n");
-  _kcolor('\012');
-  _kputs("vinc94\n"
+  _kcolor(GREEN);
+  _kputs("N3m3s1s\n"
+			"Blackz\n"
+		    "vinc94\n"
 	  		"tk0\n"
 	  		"DT\n"
          	"Celeron\n"
@@ -207,7 +209,7 @@
          	"m0nt0\n"
 			"shainer\n"
          	"and many others (3 or 4 :P)\n\n");
-  _kcolor('\007');
+  _kcolor(WHITE);
 }
 
 void sleep_cmd(void)
@@ -357,7 +359,7 @@
 	i = 0;
 	while( i < j ) {
 		if (argc == 1) {
-			_kcolor(1);
+			_kcolor(BRIGHT_BLUE);
 			printf("%s   ", mountpoint_list[i].mountpoint);
 		}
 		else {
@@ -367,13 +369,13 @@
 							current_user.username,
 							mountpoint_list[i].gid, 
 							current_user.username);
-				_kcolor(1);
+				_kcolor(BRIGHT_BLUE);
 				printf("%s\n", mountpoint_list[i].mountpoint);
-				_kcolor(7);
+				_kcolor(WHITE);
 		}
 		i++; 
 	}
-	_kcolor(7);
+	_kcolor(WHITE);
 	printf(" -->   Total: %d\n", j);
 }
 

Modified: trunk/shell/shell.c
===================================================================
--- trunk/shell/shell.c	2010-01-12 23:33:03 UTC (rev 184)
+++ trunk/shell/shell.c	2010-01-16 23:40:40 UTC (rev 185)
@@ -102,7 +102,9 @@
   memset(cmd, '\0', CMD_LEN);
   memset(current_user.username, '\0', USER_LEN);
   memset(current_user.cur_path, '\0', CURPATH_LEN);
+  _kcolor(BRIGHT_BLUE);
   printf(LNG_WELCOME);
+  _kcolor(WHITE);
   
   do {		
     printf(LNG_USER);
@@ -120,10 +122,11 @@
   {
     /*for (c = 1 ; c <= 10 ; c++) {
     	    lastcmd[c] = (char *)kmalloc(sizeof(char) * 30); 
-    }*/	    
-    printf("%s~:%s# ", current_user.username, 
-				  current_user.cur_path,
-				  current_user.username);
+    }*/
+    _kcolor(9);	    
+    printf("%s", current_user.username);
+    _kcolor(15);
+	printf("~:%s# ", current_user.cur_path);
     scanf("%254s",cmd);
     
     //history(cmd);



From finarfin at mail.berlios.de  Thu Jan 28 23:25:36 2010
From: finarfin at mail.berlios.de (finarfin at BerliOS)
Date: Thu, 28 Jan 2010 23:25:36 +0100
Subject: [Dreamos-dev] r186 - in trunk: . fs
Message-ID: <201001282225.o0SMPauw008044@sheep.berlios.de>

Author: finarfin
Date: 2010-01-28 23:25:35 +0100 (Thu, 28 Jan 2010)
New Revision: 186

Modified:
   trunk/dreamos.img
   trunk/fs/fcntl.c
Log:
Piccola modifica in open per gestione files aperti.


Modified: trunk/dreamos.img
===================================================================
(Binary files differ)

Modified: trunk/fs/fcntl.c
===================================================================
--- trunk/fs/fcntl.c	2010-01-16 23:40:40 UTC (rev 185)
+++ trunk/fs/fcntl.c	2010-01-28 22:25:35 UTC (rev 186)
@@ -41,7 +41,7 @@
 	va_start(ap, oflags);
 	
 	prova = va_arg(ap, int);
-	if(!(cur_fd < _SC_OPEN_MAX)) cur_fd=0;
+	//if(!(cur_fd < _SC_OPEN_MAX)) cur_fd=0;
 	//printf("Cur_fd: %d ",cur_fd);
 	while(fd_list[cur_fd].mountpoint_id != -1 && cur_fd < _SC_OPEN_MAX ) {				
 		if(cur_fd == ret_fd) {
@@ -79,7 +79,7 @@
 	}
 	va_end(ap)	
 	ret_fd = cur_fd;
-	cur_fd++;
+	if(cur_fd++ >= _SC_OPEN_MAX) cur_fd=0;
 	//printf("ret_fd: %d\n",ret_fd);
 	return ret_fd;
 }



From finarfin at mail.berlios.de  Sun Jan 31 00:19:24 2010
From: finarfin at mail.berlios.de (finarfin at BerliOS)
Date: Sun, 31 Jan 2010 00:19:24 +0100
Subject: [Dreamos-dev] r187 - in trunk: . fs include/sys shell
Message-ID: <201001302319.o0UNJOdT015668@sheep.berlios.de>

Author: finarfin
Date: 2010-01-31 00:19:14 +0100 (Sun, 31 Jan 2010)
New Revision: 187

Modified:
   trunk/dreamos.img
   trunk/fs/fcntl.c
   trunk/fs/vfs.c
   trunk/include/sys/unistd.h
   trunk/shell/testing.c
Log:
Modificata open per gestire meglio i valori dei file descriptor.


Modified: trunk/dreamos.img
===================================================================
(Binary files differ)

Modified: trunk/fs/fcntl.c
===================================================================
--- trunk/fs/fcntl.c	2010-01-28 22:25:35 UTC (rev 186)
+++ trunk/fs/fcntl.c	2010-01-30 23:19:14 UTC (rev 187)
@@ -39,22 +39,27 @@
 	int ret_fd;
 	va_list ap;
 	va_start(ap, oflags);
-	
+	ret_fd = 0;
+	while(ret_fd < _SC_OPEN_MAX){
+		if(fd_list[ret_fd].mountpoint_id == -1) printf("%d ", ret_fd);		
+		ret_fd++;
+	}
 	prova = va_arg(ap, int);
-	//if(!(cur_fd < _SC_OPEN_MAX)) cur_fd=0;
-	//printf("Cur_fd: %d ",cur_fd);
-	while(fd_list[cur_fd].mountpoint_id != -1 && cur_fd < _SC_OPEN_MAX ) {				
-		if(cur_fd == ret_fd) {
-			printf("No more file descriptors available\n");
-			return -1;
-		}		
+	if(cur_fd == _SC_OPEN_MAX) {
+		printf("Cur_fd reset\n");
+		cur_fd = 0;
+		//printf("No more file descriptors available\n");
+		//return -1;
+	}
+	while(fd_list[cur_fd].mountpoint_id != -1 && cur_fd < _SC_OPEN_MAX){
 		cur_fd++;
 	}
-	/*if(cur_fd == _SC_OPEN_MAX) {
-		printf("Error\n");
+	if(cur_fd == _SC_OPEN_MAX) {
+		printf("No more file descriptors available\n");
 		return -1;
-	}*/
+	}
 	mpid = get_mountpoint_id(path);		
+	printf("Cur_fd: %d\n",cur_fd);
 	if(mpid >-1) {
 		fd_list[cur_fd].mountpoint_id = mpid;				
 		path = get_rel_path(mpid, path);		
@@ -79,8 +84,8 @@
 	}
 	va_end(ap)	
 	ret_fd = cur_fd;
-	if(cur_fd++ >= _SC_OPEN_MAX) cur_fd=0;
-	//printf("ret_fd: %d\n",ret_fd);
+	cur_fd++;
+	
 	return ret_fd;
 }
 

Modified: trunk/fs/vfs.c
===================================================================
--- trunk/fs/vfs.c	2010-01-28 22:25:35 UTC (rev 186)
+++ trunk/fs/vfs.c	2010-01-30 23:19:14 UTC (rev 187)
@@ -40,9 +40,9 @@
 	
 	printf(LNG_VFS); 	
 
-	while (j<_SC_OPEN_MAX){
+	while (j < _SC_OPEN_MAX){
 		fd_list[j].fs_spec_id = -1;
-		fd_list[j].mountpoint_id =-1;
+		fd_list[j].mountpoint_id = -1;
 		j++;
 	}
  	

Modified: trunk/include/sys/unistd.h
===================================================================
--- trunk/include/sys/unistd.h	2010-01-28 22:25:35 UTC (rev 186)
+++ trunk/include/sys/unistd.h	2010-01-30 23:19:14 UTC (rev 187)
@@ -22,7 +22,7 @@
 #include <types.h>
 #include <stddef.h>
 
-#define _SC_OPEN_MAX 10
+#define _SC_OPEN_MAX 4
 
 ssize_t read(int , void *, size_t);
 int close(int);

Modified: trunk/shell/testing.c
===================================================================
--- trunk/shell/testing.c	2010-01-28 22:25:35 UTC (rev 186)
+++ trunk/shell/testing.c	2010-01-30 23:19:14 UTC (rev 187)
@@ -142,7 +142,7 @@
 	i = open(appoggio, O_RDONLY, 42);
 	if(i>-1) {
 		read(i, prova, 1);	
-		close(i);
+		//if(i!=2)close(i);
 	}
 	printf("\n");
 }



From finarfin at mail.berlios.de  Sun Jan 31 10:21:23 2010
From: finarfin at mail.berlios.de (finarfin at BerliOS)
Date: Sun, 31 Jan 2010 10:21:23 +0100
Subject: [Dreamos-dev] r188 - in trunk: . fs shell
Message-ID: <201001310921.o0V9LNds021326@sheep.berlios.de>

Author: finarfin
Date: 2010-01-31 10:21:22 +0100 (Sun, 31 Jan 2010)
New Revision: 188

Modified:
   trunk/dreamos.img
   trunk/fs/fcntl.c
   trunk/fs/initrd.c
   trunk/shell/testing.c
Log:
Commentate alcune stampe di debug. 
Piccole correzioni sulle funzioni VFS.


Modified: trunk/dreamos.img
===================================================================
(Binary files differ)

Modified: trunk/fs/fcntl.c
===================================================================
--- trunk/fs/fcntl.c	2010-01-30 23:19:14 UTC (rev 187)
+++ trunk/fs/fcntl.c	2010-01-31 09:21:22 UTC (rev 188)
@@ -45,12 +45,10 @@
 		ret_fd++;
 	}
 	prova = va_arg(ap, int);
-	if(cur_fd == _SC_OPEN_MAX) {
-		printf("Cur_fd reset\n");
-		cur_fd = 0;
+	if(cur_fd == _SC_OPEN_MAX) cur_fd = 0;
+		//printf("Cur_fd reset\n");
 		//printf("No more file descriptors available\n");
 		//return -1;
-	}
 	while(fd_list[cur_fd].mountpoint_id != -1 && cur_fd < _SC_OPEN_MAX){
 		cur_fd++;
 	}
@@ -59,7 +57,7 @@
 		return -1;
 	}
 	mpid = get_mountpoint_id(path);		
-	printf("Cur_fd: %d\n",cur_fd);
+	//printf("Cur_fd: %d\n",cur_fd);
 	if(mpid >-1) {
 		fd_list[cur_fd].mountpoint_id = mpid;				
 		path = get_rel_path(mpid, path);		

Modified: trunk/fs/initrd.c
===================================================================
--- trunk/fs/initrd.c	2010-01-30 23:19:14 UTC (rev 187)
+++ trunk/fs/initrd.c	2010-01-31 09:21:22 UTC (rev 188)
@@ -87,6 +87,7 @@
 	//printf("try to read something...\n");
 	while(j<file_size){
 		putchar(file_start[j]);
+		//buf[j] = file_start[j];		
 		j++;
 	}	
 	return nbyte;

Modified: trunk/shell/testing.c
===================================================================
--- trunk/shell/testing.c	2010-01-30 23:19:14 UTC (rev 187)
+++ trunk/shell/testing.c	2010-01-31 09:21:22 UTC (rev 188)
@@ -142,7 +142,7 @@
 	i = open(appoggio, O_RDONLY, 42);
 	if(i>-1) {
 		read(i, prova, 1);	
-		//if(i!=2)close(i);
+		close(i);
 	}
 	printf("\n");
 }



